#    MYSQLå­¦ä¹ 

> ä»å…¥é—¨åˆ°æ”¾å¼ƒã€‚å¥¥åŠ›ç»™â›½ï¸â›½ï¸



# ä¸€ã€åŸºç¡€å­¦ä¹ 

## 1ã€é€šç”¨è¯­æ³•åŠåˆ†ç±»

### SQLåˆ†ç±»

SQLè¯­å¥ï¼Œæ ¹æ®å…¶åŠŸèƒ½ï¼Œä¸»è¦åˆ†ä¸ºå››ç±»:DDLã€DMLã€DQLã€DCLã€‚

| åˆ†ç±» |            å…¨ç§°            |                          è¯´æ˜                          |
| :--: | :------------------------: | :----------------------------------------------------: |
| DDL  |  Data Definition Language  |    æ•°æ®å®šä¹‰è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡(æ•°æ®åº“ï¼Œè¡¨å­—æ®µ)    |
| DML  | Data Manipulation Language |     æ•°æ®æ“ä½œè¯­è¨€ï¼Œç”¨æ¥å¯¹æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹     |
| DQL  |     Query LanguageData     |         æ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•         |
| DCL  |   Data Control Language    | æ•°æ®æ§åˆ¶è¯­è¨€ï¼Œç”¨æ¥åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™ |



#### DDLè¯­å¥



##### æ•°æ®åº“æ“ä½œ-CRUD

```mysql
// æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“
show Database;
// æŸ¥è¯¢å½“å‰æ•°æ®åº“
select database();
// åˆ›å»ºæ•°æ®åº“
Create database [if not exists] æ•°æ®åº“å [default charset utf8mb4][collate æ’åºè§„åˆ™];
// åˆ é™¤æ•°æ®åº“
drop database  if exists test_database;
// ä½¿ç”¨æ•°æ®åº“
use test_database;

```



##### è¡¨æ“ä½œ-æŸ¥è¯¢

```mysql
// æŸ¥è¯¢æ•°æ®åº“æ‰€æœ‰çš„è¡¨
show tables;
// æŸ¥è¯¢æ‰€æœ‰è¡¨çš„çŠ¶æ€
show table status;
// æŸ¥è¯¢è¡¨ç»“æ„
desc table_name;
// æŸ¥è¯¢æŒ‡å®šè¡¨çš„å»ºè¡¨è¯­å¥
show create table table_name;
```



##### è¡¨æ“ä½œ-åˆ›å»º

```mysql
// åˆ›å»ºè¡¨--ç»“æ„
CREATE TABLE table_name (
'id' varchar(50) [comment æ³¨é‡Š],
'id' varchar(50) [comment æ³¨é‡Š],
'id' varchar(50) [comment æ³¨é‡Š],
)[comment è¡¨æ³¨é‡Š];

// åˆ›å»ºè¡¨
CREATE TABLE `employ` (
  `id` varchar(50) NOT NULL COMMENT 'ä¸»å¥id',
  `name` varchar(5) DEFAULT NULL COMMENT 'name',
  `time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `age` int DEFAULT NULL COMMENT 'å¹´çºª',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='å‘˜å·¥è¡¨';
```



##### è¡¨æ•°æ®ç±»å‹åŠæ¡ˆä¾‹

###### **æ•°å€¼ç±»å‹**

| ç±»å‹         | å¤§å°     | æœ‰ç¬¦å·(SIGNED)èŒƒå›´                                    | æ— ç¬¦å·(UNSIGNED)èŒƒå›´                                       | æè¿°               |
| ------------ | -------- | ----------------------------------------------------- | ---------------------------------------------------------- | ------------------ |
| TINYINT      | 1  byte  | (-128ï¼Œ127)                                           | (0ï¼Œ255)                                                   | å°æ•´æ•°å€¼           |
| SMALLINT     | 2  bytes | (-32768ï¼Œ32767)                                       | (0ï¼Œ65535)                                                 | å¤§æ•´æ•°å€¼           |
| MEDIUMINT    | 3  bytes | (-8388608ï¼Œ8388607)                                   | (0ï¼Œ16777215)                                              | å¤§æ•´æ•°å€¼           |
| INTæˆ–INTEGER | 4  bytes | (-2147483648ï¼Œ2147483647)                             | (0ï¼Œ4294967295)                                            | å¤§æ•´æ•°å€¼           |
| BIGINT       | 8  bytes | (-2^63ï¼Œ2^63-1)                                       | (0ï¼Œ2^64-1)                                                | æå¤§æ•´æ•°å€¼         |
| FLOAT        | 4  bytes | (-3.402823466 E+38ï¼Œ3.402823466351  E+38)             | 0 å’Œ (1.175494351  E-38ï¼Œ3.402823466 E+38)                 | å•ç²¾åº¦æµ®ç‚¹æ•°å€¼     |
| DOUBLE       | 8  bytes | (-1.7976931348623157 E+308ï¼Œ1.7976931348623157 E+308) | 0 å’Œ  (2.2250738585072014 E-308ï¼Œ1.7976931348623157 E+308) | åŒç²¾åº¦æµ®ç‚¹æ•°å€¼     |
| DECIMAL      |          | ä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)çš„å€¼                            | ä¾èµ–äºM(ç²¾åº¦)å’ŒD(æ ‡åº¦)çš„å€¼                                 | å°æ•°å€¼(ç²¾ç¡®å®šç‚¹æ•°) |



###### å­—ç¬¦ä¸²ç±»å‹

| ç±»å‹       | å¤§å°                  | æè¿°                         |
| ---------- | --------------------- | ---------------------------- |
| CHAR       | 0-255 bytes           | å®šé•¿å­—ç¬¦ä¸²                   |
| VARCHAR    | 0-65535 bytes         | å˜é•¿å­—ç¬¦ä¸²                   |
| TINYBLOB   | 0-255 bytes           | ä¸è¶…è¿‡255ä¸ªå­—ç¬¦çš„äºŒè¿›åˆ¶æ•°æ®  |
| TINYTEXT   | 0-255 bytes           | çŸ­æ–‡æœ¬å­—ç¬¦ä¸²                 |
| BLOB       | 0-65 535 bytes        | äºŒè¿›åˆ¶å½¢å¼çš„é•¿æ–‡æœ¬æ•°æ®       |
| TEXT       | 0-65 535 bytes        | é•¿æ–‡æœ¬æ•°æ®                   |
| MEDIUMBLOB | 0-16 777 215 bytes    | äºŒè¿›åˆ¶å½¢å¼çš„ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ® |
| MEDIUMTEXT | 0-16 777 215 bytes    | ä¸­ç­‰é•¿åº¦æ–‡æœ¬æ•°æ®             |
| LONGBLOB   | 0-4 294 967 295 bytes | äºŒè¿›åˆ¶å½¢å¼çš„æå¤§æ–‡æœ¬æ•°æ®     |
| LONGTEXT   | 0-4 294 967 295 bytes | æå¤§æ–‡æœ¬æ•°æ®                 |



| explain                          | example                       |
| :------------------------------- | ----------------------------- |
| char(10)  -----------> æ€§èƒ½å¥½    | ç”¨æˆ·å username   varchar(50) |
| varchar(10)  ---------> æ€§èƒ½è¾ƒå·® | æ€§åˆ« gender   char(1)         |



###### **æ—¶é—´ç±»å‹**

| ç±»å‹      | å¤§å° | èŒƒå›´                                       | æ ¼å¼                | æè¿°                     |
| --------- | ---- | ------------------------------------------ | ------------------- | ------------------------ |
| DATE      | 3    | 1000-01-01 è‡³  9999-12-31                  | YYYY-MM-DD          | æ—¥æœŸå€¼                   |
| TIME      | 3    | -838:59:59 è‡³  838:59:59                   | HH:MM:SS            | æ—¶é—´å€¼æˆ–æŒç»­æ—¶é—´         |
| YEAR      | 1    | 1901 è‡³ 2155                               | YYYY                | å¹´ä»½å€¼                   |
| DATETIME  | 8    | 1000-01-01 00:00:00 è‡³ 9999-12-31 23:59:59 | YYYY-MM-DD HH:MM:SS | æ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼         |
| TIMESTAMP | 4    | 1970-01-01 00:00:01 è‡³ 2038-01-19 03:14:07 | YYYY-MM-DD HH:MM:SS | æ··åˆæ—¥æœŸå’Œæ—¶é—´å€¼ï¼Œæ—¶é—´æˆ³ |



##### è¡¨ç»“æ„-ä¿®æ”¹

```mysql
// æ–°å¢å­—æ®µ
alter table table_name add å­—æ®µ ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// åªä¿®æ”¹æ•°æ®ç±»å‹
alter table table_name modify å­—æ®µ ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// ä¿®æ”¹å­—æ®µåå’Œå­—æ®µç±»å‹
Alter table table_name change æ—§å­—æ®µå æ–°å­—æ®µå ç±»å‹(é•¿åº¦) [comment æ³¨é‡Š] [çº¦æŸ];
// åˆ é™¤å­—æ®µ
alter table table_name drop å­—æ®µå;
// ä¿®æ”¹è¡¨å
alter table table_name rename to new_table_name;
// åˆ é™¤è¡¨
drop table if exists table_name;
// åˆ é™¤(æˆªæ–­)æŒ‡å®šè¡¨ å¹¶é‡æ–°åˆ›å»ºè¯¥è¡¨
truncate table table_name;
```



#### DMLè¯­å¥

##### æ·»åŠ æ•°æ®

```mysql
// ç»™æŒ‡å®šå­—æ®µæ·»åŠ æ•°æ®
insert into table_name (å­—æ®µ1,å­—æ®µ2) values (å€¼1,å€¼2......);
// ç»™å…¨éƒ¨å­—æ®µæ·»åŠ æ•°æ®
insert into table_name values (å€¼1,å€¼2......);
// æ‰¹é‡æ·»åŠ æ•°æ®
insert into table_name (å­—æ®µ1,å­—æ®µ2) values (å€¼1,å€¼2......),(å€¼1,å€¼2......),(å€¼1,å€¼2......);
insert into table_name values (å€¼1,å€¼2......),(å€¼1,å€¼2......),(å€¼1,å€¼2......);
// ä»åˆ«çš„è¡¨å–æ•° æ’å…¥åˆ°è¿™ä¸ªè¡¨
insert into table_name select * from table_name2;
```

Notesï¼š

- æ’å…¥æ•°æ®æ—¶ï¼ŒæŒ‡å®šçš„å­—æ®µé¡ºåºéœ€è¦ä¸å€¼çš„é¡ºåºä¸€ä¸€å¯¹åº”çš„
- **å­—ç¬¦ä¸²å’Œæ—¥æœŸç±»å‹åº”è¯¥åŒ…å«åœ¨å¼•å·ä¸­**
- æ’å…¥çš„æ•°æ®å¤§å° åº”è¯¥åœ¨å­—æ®µçš„è§„å®šèŒƒå›´å†…



##### ä¿®æ”¹æ•°æ®

```mysql
// æ›´æ–°æ•°æ®
update table_name set å­—æ®µ1=å€¼1,å­—æ®µ2=å€¼2	.... [where æ¡ä»¶];
// åˆ é™¤æ•°æ®
delete from table_name  [where æ¡ä»¶];
```



#### DQLè¯­å¥

**åŸºæœ¬è¯­æ³•ï¼š**

```mysql
// ç»“æ„
select 
	å­—æ®µåˆ—è¡¨ 
from 
	table_name 
where æ¡ä»¶åˆ—è¡¨ 
group by åˆ†ç»„å­—æ®µåˆ—è¡¨ 
having åˆ†ç»„åæ¡ä»¶æŸ¥è¯¢ 
order by æ’åºå­—æ®µåˆ—è¡¨ 
limit åˆ†é¡µå‚æ•° ;
```



**æŸ¥è¯¢å­¦ä¹ ï¼š**

- åŸºæœ¬æŸ¥è¯¢
- æ¡ä»¶æŸ¥è¯¢ where
- èšåˆå‡½æ•° ï¼ˆcountã€maxã€minã€avgã€sumï¼‰
- åˆ†ç»„æŸ¥è¯¢ group by
- æ’åºæŸ¥è¯¢ order by
- åˆ†é¡µæŸ¥è¯¢ limit



##### åŸºæœ¬æŸ¥è¯¢

```mysql
// æŸ¥è¯¢å…¨éƒ¨
select * from table_name;
// è®¾ç½®å­—æ®µåˆ«å  as å¯ä»¥çœç•¥
select name as userName from table_name;
// å»é™¤é‡å¤ distinct
select distinct name from table_name;

```



##### æ¡ä»¶æŸ¥è¯¢

```mysql
select * from table_name where æ¡ä»¶åˆ—è¡¨;
// æŸ¥è¯¢åå­—ä¸ºä¸¤ä¸ªå­—çš„å‘˜å·¥ä¿¡æ¯---ä½¿ç”¨like æˆ–è€…ä½¿ç”¨length
select * from emp where name like '__';
```

**æ¡ä»¶åˆ—è¡¨ï¼š**

å¸¸ç”¨çš„æ¯”è¾ƒè¿ç®—ç¬¦å¦‚ä¸‹:

|    æ¯”è¾ƒè¿ç®—ç¬¦    |                  åŠŸèƒ½                  |
| :--------------: | :------------------------------------: |
|        >         |                  å¤§äº                  |
|        >=        |                å¤§äºç­‰äº                |
|        <         |                  å°äº                  |
|        <=        |                å°äºç­‰äº                |
|        =         |                  ç­‰äº                  |
|     <> æˆ– !=     |                 ä¸ç­‰äº                 |
| BETWEEN...AND. . |     åœ¨æŸä¸ªèŒƒå›´ä¹‹å†…(å«æœ€å°ã€æœ€å¤§å€¼      |
|     IN(...)      |      åœ¨inä¹‹åçš„åˆ—è¡¨ä¸­çš„å€¼ï¼Œå¤šé€‰ä¸€      |
|   LIKE å ä½ç¬¦    | æ¨¡ç³ŠåŒ¹é…(åŒ¹é…å•ä¸ªå­—ç¬¦ï¼ŒåŒ¹é…ä»»æ„ä¸ªå­—ç¬¦) |
|      ISNULL      |                 æ˜¯NULL                 |



å¸¸ç”¨çš„é€»è¾‘è¿ç®—ç¬¦å¦‚ä¸‹:

| é€»è¾‘è¿ç®—ç¬¦ |            åŠŸèƒ½             |
| :--------: | :-------------------------: |
| AND æˆ– &&  |   å¹¶ä¸” (å¤šä¸ªæ¡ä»¶åŒæ—¶æˆç«‹)   |
| OR æˆ– \|\| | æˆ–è€… (å¤šä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªæˆç«‹) |
| NOT æˆ– ï¼  |          é , ä¸æ˜¯          |



---



##### èšåˆå‡½æ•°

> å°†**ä¸€åˆ—**æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘è®¡ç®—
>
> **æ‰€æœ‰çš„nullå€¼æ˜¯ä¸å‚ä¸èšåˆå‡½æ•°çš„**

| å‡½æ•°  |   åŠŸèƒ½   |
| :---: | :------: |
| count | ç»Ÿè®¡æ•°é‡ |
|  max  |  æœ€å¤§å€¼  |
|  min  |  æœ€å°å€¼  |
|  avg  |  å¹³å‡å€¼  |
|  sum  |   æ±‚å’Œ   |

```mysql
// è¯­æ³•
select max(age) from table_name;
```

---



##### åˆ†ç»„æŸ¥è¯¢

```mysql
// è¯­æ³•
select å­—æ®µåˆ—è¡¨ from table_name where æ¡ä»¶  group by åˆ†ç»„å­—æ®µå having  åˆ†ç»„è¿‡æ»¤æ¡ä»¶;
```



**WHEREä¸HAVINGçš„åŒºåˆ«ï¼š**

- æ‰§è¡Œæ—¶æœºä¸åŒï¼š**where æ˜¯åˆ†ç»„ä¹‹å‰**è¿›è¡Œè¿‡æ»¤çš„ ä¸æ»¡è¶³whereæ¡ä»¶ ä¸å‚ä¸åˆ†ç»„ï¼›**havingæ˜¯åˆ†ç»„ä¹‹å**å¯¹ç»“æœè¿›è¡Œè¿‡æ»¤
- åˆ¤æ–­æ¡ä»¶ä¸åŒï¼šwhereä¸èƒ½å¯¹èšåˆå‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼Œè€Œhavingå¯ä»¥



**Notesï¼š**

- æ‰§è¡Œé¡ºåºï¼šwhere>èšåˆå‡½æ•°>having
- åˆ†ç»„ä¹‹åï¼ŒæŸ¥è¯¢çš„å­—æ®µä¸€èˆ¬ä¸ºèšåˆå‡½æ•°å’Œåˆ†ç»„å­—æ®µï¼ŒæŸ¥è¯¢å…¶ä»–å­—æ®µæ— ä»»ä½•æ„ä¹‰

***



##### æ’åºæŸ¥è¯¢

```mysql
// è¯­æ³•  é»˜è®¤asc  
Select å­—æ®µåˆ—è¡¨ from table_name  order by å­—æ®µ1 asc,å­—æ®µ2 desc;
```

---



##### åˆ†é¡µæŸ¥è¯¢

```mysql
// è¯­æ³•
select * from table_name limit èµ·å§‹ç´¢å¼•,æŸ¥è¯¢è®°å½•æ•°;

```

**Notes:**

- èµ·å§‹ç´¢å¼• ä»0å¼€å§‹ èµ·å§‹ç´¢å¼•= æŸ¥è¯¢é¡µç -1  * æ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°
- åˆ†é¡µæŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æ–¹è¨€ï¼Œä¸åŒçš„æ•°æ®åº“æœ‰ä¸åŒçš„å®ç° Mysqlæ˜¯Limit
- å¦‚æœæŸ¥è¯¢çš„æ˜¯ç¬¬ä¸€é¡µæ•°æ®ï¼Œèµ·å§‹ç´¢å¼•å¯ä»¥çœç•¥ï¼Œç›´æ¥ç®€å†™ä¸º limit 10

---



##### æ‰§è¡Œé¡ºåº

![image-20240229232208302](./img/1.png)



---



#### DCLè¯­å¥

> Data Control Language ï¼Œç”¨æ¥ç®¡ç†æ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™ç­‰ç­‰

##### åŸºç¡€CRUD

```mysql
// ä½¿ç”¨mysql åº“
use mysql;
// æŸ¥è¯¢ç”¨æˆ·
select * from user;

// åˆ›å»ºç”¨æˆ· test_user
create user 'test_user'@'ä¸»æœºåï¼šlocalhost' identified  by '123456';

// ä¿®æ”¹ç”¨æˆ·å¯†ç 
alter user 'test_user ç”¨æˆ·å'@'ä¸»æœºå: localhost' identified  with mysql_native_password By 'æ–°å¯†ç ';

// åˆ é™¤ç”¨æˆ·
drop user 'test_user ç”¨æˆ·å'@'ä¸»æœºå: localhost';
```

---



##### æƒé™æ§åˆ¶

**æƒé™åˆ—è¡¨**

> MySQLä¸­å®šä¹‰äº†å¾ˆå¤šç§æƒé™ï¼Œä½†æ˜¯å¸¸ç”¨çš„å°±ä»¥ä¸‹å‡ ç§:
>
> |        æƒé™         |        è¯´æ˜        |
> | :-----------------: | :----------------: |
> | ALLï¼ŒALL PRIVILEGES |      æ‰€æœ‰æƒé™      |
> |       SELECT        |      æŸ¥è¯¢æ•°æ®      |
> |       INSERT        |      æ’å…¥æ•°æ®      |
> |       UPDATE        |      ä¿®æ”¹æ•°æ®      |
> |       DELETE        |      åˆ é™¤æ•°æ®      |
> |        ALTER        |       ä¿®æ”¹è¡¨       |
> |        DROP         | åˆ é™¤æ•°æ®åº“/è¡¨/è§†å›¾ |
> |       CREATE        |   åˆ›å»ºæ•°æ®åº“/è¡¨    |



```mysql
// æŸ¥è¯¢æƒé™
SHOW GRANTS FOR 'root'@'%';

// æˆäºˆæƒé™ å¦‚æœæˆäºˆæ‰€æœ‰çš„ å°±ä½¿ç”¨*.*
GRANTS æƒé™åˆ—è¡¨ ON æ•°æ®åº“.è¡¨å TO 'ç”¨æˆ·åï¼štest_user'@'ä¸»æœºåï¼šlocalhost';
grant all on *.* to 'test_user'@'localhost';

//æ’¤é”€æƒé™
REVOKE æƒé™åˆ—è¡¨ ON æ•°æ®åº“.è¡¨å FROM 'ç”¨æˆ·åï¼štest_user'@'ä¸»æœºåï¼šlocalhost';
REVOKE all ON *.* FROM 'test_user'@'localhost';

```



### 2ã€å‡½æ•°

> å¯ä»¥ç›´æ¥è¢«è°ƒç”¨çš„ç¨‹åºæˆ–ä»£ç 



#### å­—ç¬¦ä¸²å‡½æ•°

![image-20240229232548803](./img/2.png)



```mysql
// å­—ç¬¦ä¸²æ‹¼æ¥
select concat('aaaa', name) from employ where id = 1;
select concat('hello', 'world');
// è½¬å¤§å°å†™
select lower('hello');
select upper('hello');
// å·¦å³å¡«å……
select  lpad('aaa',10,'___');
select  rpad('aaa',10,'___');
// å»æ‰ç©ºæ ¼
select  trim(' hello world  ');
// æˆªå–å­—ç¬¦ä¸²
select  substr('11aaaaaa',1,5);
```



**æ¡ˆä¾‹ï¼šä½¿å¾—å‘˜å·¥ç¼–å·å°äº5ä½çš„å‰é¢è‡ªåŠ¨è¡¥0ï¼Œä¾‹å¦‚ 1å˜æˆ00001ï¼›**

```mysql
update employ set  id = lpad(id,5,'0');
```

---



#### æ•°å€¼å‡½æ•°

![image-20240229232813754](./img/3.png)

```mysql
// å‘ä¸Šå–æ•´ --13
select ceil(12.1);
// å‘ä¸‹å–æ•´  --1
select floor(1.1);
//è¿”å›x/yçš„æ¨¡ --20
select mod(20,100);
// è¿”å›0-1çš„éšæœºæ•°
select rand();
// å‚æ•°xçš„å››èˆäº”å…¥ï¼Œä¿ç•™æŒ‡å®šå°æ•° ----1.2222
select round(1.222222,4);
```

**ç”Ÿæˆ6ä½éšæœºæ•°**

```mysql
select lpad(round((select rand()*1000000),0),6,'0');
```

---



#### æ—¥æœŸå‡½æ•°

![image-20240229232917075](./img/4.png)

```mysql
-- å½“å‰æ—¥æœŸ  2022-03-15
select curdate();
-- å½“å‰æ—¶é—´  21:04:07
select curtime();
-- å½“å‰æ—¥æœŸå’Œæ—¶é—´2022-03-15 21:04:32
select now();
// è·å–dataçš„å¹´ä»½
select year(now());
// è·å–dataçš„æœˆä»½
select month(now());
// è·å–dataçš„æ—¥ä»½
select day(now());
// æ˜¯æ—¶é—´ç›¸åŠ 
select date_add(now(),INTERVAL 100 YEAR );
select date_add(now(),INTERVAL 100 day );
select date_add(now(),INTERVAL 100 month );
// æ—¶é—´å·®
select datediff(now(),now());
```

---



#### æµç¨‹å‡½æ•°

![image-20240229232950824](./img/5.png)



```mysql
-- IFNULL
select ifnull('',111);
select ifnull('2222',111);
select ifnull(null,'22');
-- IF
select if(true,'1','0');
-- CASE WHEN
select name, (case age when 10 then '10å²' when 11 then '11å²' else 'ä¸æ˜¯è¿™ä¸ªå¹´çºª' end) as age
from employ;

```

---



### 3ã€çº¦æŸ

> **ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œç”¨äºé™åˆ¶å­˜å‚¨åœ¨è¡¨ä¸­çš„æ•°æ®** 

#### æ¦‚è¿°

![image-20240229233024143](./img/6.png)

Notesï¼š

**çº¦æŸæ˜¯ä½œç”¨äºè¡¨å­—æ®µä¸Šçš„ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨/ä¿®æ”¹è¡¨çš„æ—¶å€™æ·»åŠ çº¦æŸ**

 

#### çº¦æŸæ¼”ç¤º

id ä¸»é”®ã€è‡ªåŠ¨å¢é•¿

name ä¸ä¸ºç©º å”¯ä¸€

age >0 å°äºç­‰äº120

status å¦‚æœæ²¡æœ‰æŒ‡å®šå€¼ï¼Œé»˜è®¤ä¸º1

```mysql
CREATE TABLE `table_user` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'id',
  `name` varchar(10) NOT NULL COMMENT 'name',
  `age` int DEFAULT NULL COMMENT 'å¹´çºª',
  `status` char(1) DEFAULT '1' COMMENT 'status',
  `gender` char(1) NOT NULL COMMENT 'gender',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`),
  CONSTRAINT `table_user_chk_1` CHECK (((`age` > (0 & `age`)) <= 120))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ç”¨æˆ·è¡¨';
```



#### å¤–é”®çº¦æŸ

> ç›®å‰ä¸åœ¨ä½¿ç”¨å¼ºå…³è”ç‰©ç†å¤–é”®çº¦æŸ

```mssql
-- æ·»åŠ å¤–é”®
alter table  employ add constraint  foreign_key_id foreign key (id) references table_user(id);
-- åˆ é™¤å¤–é”®
alter table  employ drop foreign key  foreign_key_id;
```



##### åˆ é™¤/æ›´æ–°è¡Œä¸º

> æ·»åŠ äº†å¤–é”®ä¹‹åï¼Œå†åˆ é™¤çˆ¶è¡¨æ•°æ®æ—¶äº§ç”Ÿçš„çº¦æŸè¡Œä¸ºï¼Œæˆ‘ä»¬å°±ç§°ä¸ºåˆ é™¤/æ›´æ–°è¡Œä¸ºã€‚å…·ä½“çš„åˆ é™¤/æ›´æ–°è¡Œ

ä¸ºæœ‰ä»¥ä¸‹å‡ ç§:

![image-20240229233119704](./img/7.png)



### 4ã€å¤šè¡¨æŸ¥è¯¢



#### å¤šè¡¨å…³ç³»

*å…³ç³»åˆ†ä¸ºï¼š*

- ä¸€å¯¹ä¸€**ï¼ˆå•è¡¨æ‹†åˆ†ï¼Œåœ¨ä»»æ„ä¸€æ–¹åŠ å…¥å¤–é”®ç›˜ï¼Œå…³è”å¦ä¸€æ–¹çš„å¤–é”®ï¼Œå¹¶è®¾ç½®å¤–é”®ä¸ºuniqueï¼‰**
- ä¸€å¯¹å¤š
- å¤šå¯¹å¤š**ï¼ˆéœ€è¦ä¸­é—´è¡¨ç»´æŠ¤å…³ç³»ï¼‰**



#### å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°

```mysql
-- ä¸¤ä¸ªè¡¨å…³è” éšå¼å†…è¿æ¥ å½¢æˆç¬›å¡å°”ç§¯
select * from employ,table_user;
```

---



#### å†…è¿æ¥

> **æŸ¥è¯¢ABäº¤é›†çš„éƒ¨åˆ†æ•°æ®**

##### éšå¼å†…è¿æ¥

```mysql
select * from employ e,gift_history g where e.id =g.id;
```

  

##### æ˜¾å¼å†…è¿æ¥

```mysql
select * from employ e inner join  gift_history g on  e.id =g.id;
```

---



#### å¤–è¿æ¥

##### å·¦å¤–è¿æ¥

> **æŸ¥è¯¢å·¦è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®**

```mysql
select * from employ  e left join table_user P on e.id = P.id where e.name is not null ;
```



##### å³å¤–è¿æ¥

> **æŸ¥è¯¢å³è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®**

```mysql
select * from employ  e right outer join  table_user P on e.id = P.id where e.name is not null ;
```



#### è‡ªè¿æ¥

> **è‡ªå·±ä¸è‡ªå·±å…³è”æŸ¥è¯¢**

```mysql
-- æ˜¾ç¤ºè‡ªè¿æ¥
select * from employ  e1 join employ e2 on e1.id = e2.id;
-- éšå¼è‡ªè¿æ¥
select * from employ  e1 , employ e2 on e1.id = e2.id;
```

ä¸šåŠ¡åœºæ™¯ï¼šæ¯”å¦‚å‘˜å·¥è¡¨ï¼Œéœ€è¦æŸ¥è¯¢å‘˜å·¥çš„ä¸Šçº§é¢†å¯¼æ˜¯è°ï¼Œé‚£ä¹ˆå°±è‡ªè¿æ¥ï¼Œæ ¹æ®è‡ªå·±çš„manager_id ç­‰äºè‡ªå·±è¡¨çš„id ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŸ¥è¯¢å¯¹åº”çš„ä¿¡æ¯å‡ºæ¥

Notesï¼šè‡ªè¿æ¥æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯å†…è¿æ¥æŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–è¿æ¥æŸ¥è¯¢

---



#### è”åˆæŸ¥è¯¢

> **å¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†**

unionï¼Œunion all

å¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†

```mysql
select * from employ where age>10
union
select * from employ where age<10
union
select a.id,a.age,a.name,a.status
from table_user a where a.id>1;
```

Notesï¼š

- å¯¹äºè”åˆæŸ¥è¯¢çš„å¤šå¼ è¡¨çš„æ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå­—æ®µç±»å‹ä¹Ÿéœ€è¦ä¿æŒä¸€è‡´
- union all ä¼šå°†å…¨éƒ¨çš„æ•°æ®ç›´æ¥åˆå¹¶åœ¨ä¸€èµ·**ï¼ˆä¸åšä»»ä½•æ“ä½œï¼‰**ï¼Œ**unionä¼šå¯¹åˆå¹¶ä¹‹åçš„æ•°æ®å»é‡ã€æ’åº**

---



#### å­æŸ¥è¯¢

> sqlä¸­åµŒå¥—selectè¯­å¥

```mysql
select * from table_name where column =(select id form table_name2 where ....);
```



##### æ ‡é‡å­æŸ¥è¯¢

æŸ¥è¯¢ç»“æœä¸ºå•ä¸ªå€¼ ---ä¸€ç§æ¡ä»¶ ç¡®å®š

```mysql
select * from employ where id > (select id from employ where age ='11');
```



##### åˆ—å­æŸ¥è¯¢

æŸ¥è¯¢ç»“æœä¸ºä¸€åˆ—--- inã€not in 

```mysql
select * from employ where id in (select id from employ where age >1);
-- all ç”¨æ³• æ»¡è¶³æŸ¥è¯¢å‡ºæ¥çš„æ‰€æœ‰æ¡ä»¶ğŸ®ğŸº
select * from employ where id > all (select id from employ where age ='1');
-- some ç”¨æ³• æ»¡è¶³æŸ¥è¯¢å‡ºæ¥çš„å…¶ä¸­ä¸€ä¸ªæ¡ä»¶  ğŸ®ğŸº
select * from employ where id > some (select id from employ where age ='1');
```



##### è¡Œå­æŸ¥è¯¢

æŸ¥è¯¢ç»“æœä¸ºä¸€è¡Œ

```mysql
-- æ–°è¯­æ³•ğŸ®ğŸº
select * from employ where  (name,age)!=(select name,age from employ where id =00011);

```



##### è¡¨å­æŸ¥è¯¢

æŸ¥è¯¢ç»“æœä¸ºå¤šè¡Œå¤šåˆ—

```mysql
-- å¤šæ¡ä»¶in ğŸ®ğŸº
select * from employ where  (name,age) in(select name,age from employ where id is not null);
-- å­æŸ¥è¯¢å½“ä¸€ä¸ªè¡¨
select * from (select * from employ where time<now()) as a;
```



---



### 5ã€äº‹åŠ¡

#### äº‹åŠ¡ç®€ä»‹

> è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¼šæŠŠæ‰€æœ‰çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»ç»Ÿæäº¤æˆ–è€…æ’¤é”€æ“ä½œè¯·æ±‚

 é»˜è®¤mysqlçš„äº‹åŠ¡æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**å½“æ‰§è¡Œä¸€æ¡dmlè¯­å¥ï¼Œmysqlä¼šç«‹å³éšå¼çš„æäº¤äº‹åŠ¡**



#### äº‹åŠ¡æ“ä½œ

```mysql
-- é“¶è¡Œè½¬è´¦ä¾‹å­
-- æŸ¥çœ‹å½“å‰äº‹åŠ¡æ˜¯å¦è‡ªåŠ¨æäº¤  1å°±æ˜¯è‡ªåŠ¨æäº¤  åŸºäºsessionçº§åˆ«
select @@autocommit;
-- è®¾ç½®ä¸ºæ‰‹åŠ¨æäº¤
set @@autocommit = 0;
-- å¼€å¯äº‹åŠ¡
start transaction æˆ–è€… begin;

-- å¼€å§‹å¤„ç†ä¸šåŠ¡é€»è¾‘
update account set money = money-1000 where name = 'Jack';
update account set money = money+1000 where name = 'Tony';
-- æäº¤æ“ä½œ
commit;
-- å¼‚å¸¸å›æ»šæ“ä½œ
rollback;

```

  

#### äº‹åŠ¡å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰ğŸŒŸ

â­ï¸é‡ç‚¹æ³¨æ„âš ï¸

```
AIDéƒ½æ˜¯ä¸ºCåšå‡†å¤‡å·¥ä½œçš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦çš„æ˜¯æ•°æ®ä¸€è‡´æ€§
```

**åŸå­æ€§ï¼ˆatomicityï¼‰**ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°å•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

**ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰**ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œå¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€

**éš”ç¦»æ€§ï¼ˆisolationï¼‰**ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œ

**æŒä¹…æ€§ï¼ˆdurabilityï¼‰**ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ“ä½œçš„æ”¹å˜æ—¶æ°¸ä¹…çš„



---



#### å¹¶å‘äº‹åŠ¡é—®é¢˜ğŸŒŸ

- **è„è¯»**ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤çš„æ•°æ®
- **ä¸å¯é‡å¤è¯»**ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†æ˜¯ä¸¤æ¬¡è¯»å–åˆ°æ•°æ®ä¸åŒï¼Œç§°ä¹‹ä¸ºä¸å¯é‡å¤è¯»
- **å¹»è¯»**ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®è¡Œï¼Œä½†æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²ç»å­˜åœ¨ï¼Œå¥½åƒå‡ºç°äº†å¹»è§‰
- **å¯é‡å¤è¯»ï¼š**MySQLçš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ã€‚è¿™æ„å‘³ç€åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œå¯¹åŒä¸€æ•°æ®çš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ã€‚**è¿™å¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚**

é—®é¢˜ï¼šä¸å¯é‡å¤è¯»å’Œå¹»è¯»æœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ

```
ä¸å¯èƒ½é‡å¤è¯»ï¼šä¸»è¦æ˜¯å‰åä¸¤æ¬¡æŸ¥è¯¢æ—¶ä¸¤æ¬¡çš„æ•°æ®ä¸ä¸€æ ·ã€‚
å¹»è¯»ï¼šä¸»è¦æ˜¯æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢å’Œç¬¬äºŒæ¬¡æŸ¥è¯¢æ•°é‡ä¸ä¸€æ ·äº†ï¼›æˆ–è€…æ˜¯é¦–å…ˆåˆ¤æ–­æ²¡æ•°æ®ï¼Œæ’å…¥çš„æ—¶å€™ï¼Œæ•°æ®å­˜åœ¨æŠ¥é”™äº†ã€‚
```



é¢è¯•é—®é¢˜ï¼šREPEATABLE-READå¯ä»¥è§£å†³å¹»è¯»é—®é¢˜å˜›ï¼Ÿ

```
å¯ä»¥éƒ¨åˆ†è§£å†³ã€‚
REPEATABLE-READ éš”ç¦»çº§åˆ«ï¼š
åœ¨ REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡åœ¨æ‰§è¡ŒæœŸé—´ä¼šåˆ›å»ºä¸€ä¸ªå¿«ç…§è§†å›¾ï¼Œç”¨äºè¯»å–æ•°æ®ã€‚è¿™ä¸ªå¿«ç…§è§†å›¾ä¼šä¿æŒä¸€è‡´ï¼Œå³ä½¿å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ã€‚å› æ­¤ï¼ŒREPEATABLE-READ éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢å¹»è¯»ã€‚

ä½†æ˜¯ï¼ŒREPEATABLE-READ ä¸èƒ½å®Œå…¨è§£å†³å¹»è¯»ï¼š
è™½ç„¶ REPEATABLE-READ éš”ç¦»çº§åˆ«å¯ä»¥é˜²æ­¢åŒä¸€ä¸ªäº‹åŠ¡å†…çš„å¹»è¯»ï¼Œä½†å®ƒæ— æ³•é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ–°æ•°æ®å¯¼è‡´çš„å¹»è¯»ã€‚å¦‚æœå…¶ä»–äº‹åŠ¡åœ¨åŒä¸€ä¸ªèŒƒå›´å†…æ’å…¥äº†æ–°æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ REPEATABLE-READ éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡ä»ç„¶å¯èƒ½é‡åˆ°å¹»è¯»é—®é¢˜ã€‚
```

**éƒ¨åˆ†æƒ…å†µæŒ‡çš„æ˜¯ï¼š**

```
- **å¿«ç…§è¯»**ï¼šç”± MVCC æœºåˆ¶æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ã€‚
- **å½“å‰è¯»**ï¼šä½¿ç”¨ Next-Key Lock è¿›è¡ŒåŠ é”æ¥ä¿è¯ä¸å‡ºç°å¹»è¯»ï¼ŒNext-Key Lock æ˜¯è¡Œé”ï¼ˆRecord Lockï¼‰å’Œé—´éš™é”ï¼ˆGap Lockï¼‰çš„ç»“åˆï¼Œè¡Œé”åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è¡Œï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è¡Œï¼Œéœ€è¦ä¾èµ–é—´éš™é”ã€‚
```



#### äº‹åŠ¡éš”ç¦»çº§åˆ«ğŸŒŸ

å„ä¸ªçº§åˆ«ä¼šå‡ºç°çš„æƒ…å†µï¼š

|              éš”ç¦»çº§åˆ«               | è„è¯» | ä¸å¯é‡å¤è¯» | å¹»è¯» |
| :---------------------------------: | :--: | :--------: | :--: |
|      Read uncommitted è¯»æœªæäº¤      |  âˆš   |     âˆš      |  âˆš   |
|       Read committed è¯»å·²æäº¤       |  âˆš   |     âˆš      |  âˆš   |
| **Repeatable Readï¼ˆé»˜è®¤ï¼‰**å¯é‡å¤è¯» |  Ã—   |     Ã—      |  âˆš   |
|            Serializable             |  Ã—   |     Ã—      |  Ã—   |



**MySQL çš„éš”ç¦»çº§åˆ«æ˜¯åŸºäºé”å®ç°çš„å—ï¼Ÿ**

```
MySQLçš„éš”ç¦»çº§åˆ«åŸºäºé”å’Œ MVCC æœºåˆ¶å…±åŒå®ç°çš„ã€‚
SERIALIZABLE éš”ç¦»çº§åˆ«æ˜¯é€šè¿‡é”æ¥å®ç°çš„ï¼ŒREAD-COMMITTED å’Œ REPEATABLE-READ éš”ç¦»çº§åˆ«æ˜¯åŸºäº MVCC å®ç°çš„ã€‚ä¸è¿‡SERIALIZABLE ä¹‹å¤–çš„å…¶ä»–éš”ç¦»çº§åˆ«å¯èƒ½ä¹Ÿéœ€è¦ç”¨åˆ°é”æœºåˆ¶ï¼Œå°±æ¯”å¦‚ REPEATABLE-READ åœ¨å½“å‰è¯»æƒ…å†µä¸‹éœ€è¦ä½¿ç”¨åŠ é”è¯»æ¥ä¿è¯ä¸ä¼šå‡ºç°å¹»è¯»ã€‚
```

```mysql
-- æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«
select @@transaction_isolation;

-- è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
set session  transaction isolation level read uncommitted ;
set session  transaction isolation level read committed ;
set session  transaction isolation level repeatable read ;
set session  transaction isolation level serializable ;
```



#### MVCCç®€ä»‹ğŸŒŸ

**å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCC multi version concurrent controllï¼‰**æ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­ä¸€ç§ç”¨äºç®¡ç†å¹¶å‘äº‹åŠ¡çš„æœºåˆ¶ï¼Œæ—¨åœ¨è§£å†³è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ç­‰é—®é¢˜ã€‚

##### 1. MVCCçš„åŸºæœ¬åŸç†

- åœ¨ä»‹ç»MVCCæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æƒ³ä¸€ä¸‹æ•°æ®åº“ç³»ç»Ÿé‡Œçš„ä¸€ä¸ªé—®é¢˜ï¼šå‡è®¾æœ‰å¤šä¸ªç”¨æˆ·åŒæ—¶è¯»å†™æ•°æ®åº“é‡Œçš„ä¸€è¡Œè®°å½•ï¼Œé‚£ä¹ˆæ€ä¹ˆä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ
- ä¸€ä¸ªåŸºæœ¬çš„è§£å†³æ–¹æ³•æ˜¯å¯¹è¿™ä¸€è¡Œè®°å½•åŠ ä¸Šä¸€æŠŠé”ï¼Œå°†ä¸åŒç”¨æˆ·å¯¹åŒä¸€è¡Œè®°å½•çš„è¯»å†™æ“ä½œå®Œå…¨ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œç”±äºåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªç”¨æˆ·åœ¨æ“ä½œï¼Œå› æ­¤ä¸€è‡´æ€§ä¸å­˜åœ¨é—®é¢˜ã€‚
- ä½†æ˜¯ï¼Œå®ƒå­˜åœ¨æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜ï¼šè¯»ä¼šé˜»å¡å†™ï¼Œå†™ä¹Ÿä¼šé˜»å¡è¯»ï¼Œæ•´ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å°†å¤§æ‰“æŠ˜æ‰£ã€‚

##### 2. MVCCçš„å®ç°æ–¹å¼

- MVCCä½¿ç”¨ä»¥ä¸‹æœºåˆ¶æ¥è§£å†³å¹¶å‘é—®é¢˜ï¼š
  - **ç‰ˆæœ¬å·**ï¼šæ¯ä¸ªæ•°æ®åº“è®°å½•éƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ã€‚
  - **å¿«ç…§è§†å›¾**ï¼šæ¯ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶åˆ›å»ºä¸€ä¸ªå¿«ç…§è§†å›¾ï¼Œç”¨äºè¯»å–æ•°æ®ã€‚è¿™ä¸ªè§†å›¾åŒ…å«äº†å½“å‰äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„æ•°æ®çŠ¶æ€ã€‚
  - **éšè—å­—æ®µ**ï¼šæ•°æ®åº“è®°å½•ä¸­ä¼šæ·»åŠ éšè—å­—æ®µï¼Œå¦‚è¡ŒIDã€äº‹åŠ¡IDå’Œå›æ»šæŒ‡é’ˆã€‚
  - **è¯»æ“ä½œ**ï¼šå¹¶å‘è¯»æ“ä½œä¼šæ ¹æ®å¿«ç…§è§†å›¾å’Œç‰ˆæœ¬å·æ¥è·å–ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚
  - **å†™æ“ä½œ**ï¼šå†™æ“ä½œä¼šåœ¨è®°å½•çš„å‰¯æœ¬ä¸Šè¿›è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹åŸå§‹è®°å½•ã€‚

##### 3. MVCCçš„å¥½å¤„

- **å¹¶å‘æ€§**ï¼šè¯»å†™ä¹‹é—´ä¸å†²çªï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚
- **ä¸€è‡´æ€§**ï¼šæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚
- **æŒä¹…æ€§**ï¼šå·²æäº¤çš„æ•°æ®å˜æ›´å¯ä»¥é‡åšï¼Œä¿è¯äº†æŒä¹…æ€§ã€‚

##### 4. MVCCçš„å±€é™æ€§

- è™½ç„¶MVCCæä¾›äº†è®¸å¤šå¥½å¤„ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸¤ä¸ªä¸»è¦å±€é™æ€§ï¼š
  - **å¹¶å‘æ›´æ–°æ§åˆ¶æ–¹æ³•éš¾ä»¥å®ç°**ã€‚
  - **æ•°æ®åº“å¤§å°å¢åŠ **ï¼šç”±äºå¯èƒ½åˆ›å»ºå¤šä¸ªè®°å½•ç‰ˆæœ¬ï¼Œæ•°æ®åº“ä¼šå˜å¾—è‡ƒè‚¿ã€‚

æ€»ä¹‹ï¼ŒMVCCé€šè¿‡å¿«ç…§è§†å›¾ã€éšè—å­—æ®µå’Œç‰ˆæœ¬å·æ¥ç®¡ç†å¹¶å‘äº‹åŠ¡ï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œéš”ç¦»æ€§ã€‚





# äºŒã€è¿›é˜¶å­¦ä¹ 



## 1ã€å­˜å‚¨å¼•æ“

### MYSQLä½“ç³»ç»“æ„

![image-20240229234544057](./img/8.png)



- **è¿æ¥å±‚**ï¼šæœ€ä¸Šå±‚æ˜¯ä¸€äº›å®¢æˆ·ç«¯å’Œè¿æ¥æœåŠ¡ï¼Œä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼è¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆã€‚æœåŠ¡å™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸€ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™
- **æœåŠ¡å±‚**ï¼šç¬¬äºŒå±‚æ¶æ„ä¸»è¦å®Œæˆå¤§å¤šæ•°çš„æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œæ¯”å¦‚sqlæ¥å£ï¼Œå¹¶å®Œæˆç¼“å­˜çš„æŸ¥è¯¢ï¼ŒSQLçš„åˆ†æå’Œä¼˜åŒ–ï¼Œéƒ¨åˆ†å†…ç½®å‡½æ•°çš„æ‰§è¡Œï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚è¿‡ç¨‹ã€å‡½æ•°ç­‰
- **å¼•æ“å±‚**ï¼šå­˜å‚¨å¼•æ“çœŸæ­£çš„è´Ÿè´£mysqlä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼ŒæœåŠ¡å™¨é€šè¿‡APIå’Œå­˜å‚¨å¼•æ“è¿›è¡Œé€šè¡Œã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ï¼Œæ¥é€‰å»åˆé€‚çš„å­˜å‚¨å¼•æ“
- **å­˜å‚¨å±‚**ï¼šä¸»è¦æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’



#### å­˜å‚¨å¼•æ“ç®€ä»‹

 å­˜å‚¨å¼•æ“å°±æ˜¯å­˜å‚¨æ•°æ®ã€å»ºç«‹ç´¢å¼•ã€æ›´æ–°/æŸ¥è¯¢æ•°æ®ç­‰æŠ€æœ¯ç­‰å®ç°æ–¹å¼ï¼Œ**å­˜å‚¨å¼•æ“æ˜¯åŸºäºè¡¨çš„**ï¼Œè€Œä¸æ˜¯åŸºäºåº“çš„ï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“ä¹Ÿå¯ä»¥è¢«ç§°ä¸ºè¡¨ç±»å‹ã€‚

```mysql
-- é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯InnoDB
-- æŸ¥è¯¢æ‰€æœ‰çš„æ”¯æŒçš„å­˜å‚¨å¼•æ“
 show engines;
-- æŒ‡å®šå¼•æ“æ˜¯åœ¨åˆ›å»ºè¡¨ä¸­åˆ›å»º
```

| Engine              | Support | Comment                                                      | Transactions | XA   | Savepoints |
| :------------------ | :------ | :----------------------------------------------------------- | :----------- | :--- | :--------- |
| **InnoDB**          | DEFAULT | Supports transactions, row-level locking, and foreign keys   | YES          | YES  | YES        |
| MRG\_MYISAM         | YES     | Collection of identical MyISAM tables                        | NO           | NO   | NO         |
| MEMORY              | YES     | Hash based, stored in memory, useful for temporary tables    | NO           | NO   | NO         |
| BLACKHOLE           | YES     | /dev/null storage engine \(anything you write to it disappears\) | NO           | NO   | NO         |
| MyISAM              | YES     | MyISAM storage engine                                        | NO           | NO   | NO         |
| CSV                 | YES     | CSV storage engine                                           | NO           | NO   | NO         |
| ARCHIVE             | YES     | Archive storage engine                                       | NO           | NO   | NO         |
| PERFORMANCE\_SCHEMA | YES     | Performance Schema                                           | NO           | NO   | NO         |
| FEDERATED           | NO      | Federated MySQL storage engine                               | NULL         | NULL | NULL       |





#### å­˜å‚¨å¼•æ“ç‰¹ç‚¹

##### InnoDB

###### **InnoDBç‰¹ç‚¹**

- DMLæ“ä½œéµå¾ªACIDæ¨¡å‹ï¼Œæ”¯æŒäº‹åŠ¡
- **è¡Œçº§é”**ï¼Œæé«˜å¹¶å‘è®¿é—®æ€§èƒ½
- **æ”¯æŒå¤–é”®** FOREIGN KEYçº¦æŸï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§

###### **æ–‡ä»¶**

```
xxx.ibdï¼šä»£è¡¨æ˜¯çš„æ˜¯è¡¨åï¼ŒinnoDBå¼•æ“çš„æ¯å¼ è¡¨éƒ½ä¼šå¯¹åº”è¿™æ ·ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶ï¼Œå­˜å‚¨è¯¥è¡¨çš„è¡¨ç»“æ„ï¼ˆfrmã€sdiï¼‰ã€æ•°æ®å’Œç´¢å¼•ã€‚
å‚æ•°ï¼šinnodb_file_per_table  è¯¥å‚æ•°æ˜¯ç½®é¡¶æ˜¯æ¯ä¸ªè¡¨æ”¾ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶å’Œå¤šä¸ªè¡¨å…¬ç”¨ä¸€ä¸ªè¡¨ç©ºé—´æ–‡ä»¶
```

```mysql
-- æŸ¥çœ‹è®¾ç½®
show variables like '%innodb_file_per_table%';
```

| Variable\_name           | Value |
| :----------------------- | :---- |
| innodb\_file\_per\_table | ON    |



###### é€»è¾‘å­˜å‚¨ç»“æ„

![image-20240229234839931](./img/9.png)

**è¡¨ç©ºé—´- Tablespace**

è¡¨ç©ºé—´å¯ä»¥çœ‹åšæ—¶InnoDBå­˜å‚¨å¼•æ“é€»è¾‘ç»“æ„çš„æœ€é«˜å±‚ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½å­˜æ”¾åœ¨è¡¨ç©ºé—´ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹InnoDBåªæœ‰ä¸€ä¸ªå…±äº«è¡¨ç©ºé—´ibdata1ï¼Œå³æ‰€æœ‰çš„æ•°æ®éƒ½å­˜æ”¾åœ¨è¿™ä¸ªè¡¨ç©ºé—´ä¸­ã€‚å¦‚æœç”¨æˆ·å¯ç”¨äº†innodb_file_per_tableï¼Œåˆ™æ¯å¼ è¡¨å†…çš„æ•°æ®å¯ä»¥å•ç‹¬æ”¾åˆ°ä¸€ä¸ªè¡¨ç©ºé—´å†…ã€‚

**Notesï¼š**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯ç”¨äº†**innodb_file_per_table**å‚æ•°ï¼Œæ¯å¼ è¡¨çš„è¡¨ç©ºé—´å†…å­˜æ”¾çš„åªæ˜¯æ•°æ®ã€ç´¢å¼•å’Œæ’å…¥ç¼“å†²Bitmapé¡µï¼Œå…¶ä»–ç±»çš„æ•°æ®ï¼Œå¦‚å›æ»šä¿¡æ¯ï¼Œæ’å…¥ç¼“å†²ç´¢å¼•é¡µã€ç³»ç»Ÿäº‹åŠ¡ä¿¡æ¯ï¼ŒäºŒæ¬¡å†™ç¼“å†²ç­‰è¿˜æ˜¯å­˜æ”¾åœ¨åŸæ¥çš„å…±äº«è¡¨ç©ºé—´å†…ã€‚

**æ®µ- Segment**

è¡¨ç©ºé—´æ˜¯ç”±å„ä¸ªæ®µç»„æˆçš„ï¼Œå¸¸è§çš„æ®µæœ‰æ•°æ®æ®µã€ç´¢å¼•æ®µã€å›æ»šæ®µç­‰ã€‚å› ä¸ºInnoDBå¼•æ“è¡¨æ˜¯ç´¢å¼•ç»„ç»‡çš„ï¼Œå› æ­¤**æ•°æ®å³ç´¢å¼•ï¼Œç´¢å¼•å³æ•°æ®**ã€‚é‚£ä¹ˆæ•°æ®æ®µå³ä¸ºB+æ ‘çš„å¶å­ç»“ç‚¹ï¼Œ**ç´¢å¼•æ®µå³ä¸ºB+æ ‘çš„éå¶å­ç»“ç‚¹**ã€‚

**åŒº-Extend**

åŒºæ˜¯ç”±**è¿ç»­é¡µç»„æˆçš„ç©ºé—´**ï¼Œåœ¨ä»»ä½•æƒ…å†µä¸‹æ¯ä¸ªåŒºçš„å¤§å°**éƒ½ä¸º1MB**ã€‚ä¸ºäº†ä¿è¯åŒºä¸­é¡µçš„è¿ç»­æ€§ï¼ŒInnoDBä¸€æ¬¡ä»ç£ç›˜ç”³è¯·4-5ä¸ªåŒºã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBå­˜å‚¨**å¼•æ“é¡µçš„å¤§å°ä¸º16KB**ï¼Œå³ä¸€ä¸ªåŒºä¸­ä¸€å…±æœ‰64ä¸ªè¿ç»­çš„é¡µã€‚

InnoDB 1.0ç‰ˆæœ¬å¼€å§‹å¼•å…¥å‹ç¼©é¡µï¼Œæ¯ä¸ªé¡µçš„å¤§å°å¯ä»¥è®¾ç½®ä¸º2Kã€4Kã€8Kã€‚

InnoDB 1.2ç‰ˆæœ¬æ–°å¢å‚æ•°innodb_page_sizeï¼Œå¯å°†é»˜è®¤é¡µçš„å¤§å°è®¾ç½®ä¸º4Kã€8Kã€‚

**é¡µ-Page**

é¡µæ˜¯InnoDBç£ç›˜ç®¡ç†çš„æœ€å°å•ä½ï¼Œåœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œ**é»˜è®¤æ¯ä¸ªé¡µçš„å¤§å°ä¸º16KB**ã€‚

åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œå¸¸è§çš„é¡µç±»å‹æœ‰ï¼š

> **æ•°æ®é¡µ**
>
> **undoé¡µ**
>
> **ç³»ç»Ÿé¡µ**
>
> **äº‹åŠ¡æ•°æ®é¡µ**
>
> **æ’å…¥ç¼“å†²ä½å›¾é¡µ**
>
> **æ’å…¥ç¼“å†²ç©ºé—²åˆ—è¡¨é¡µ**
>
> **æœªå‹ç¼©çš„äºŒè¿›åˆ¶å¤§å¯¹è±¡é¡µ**
>
> **å‹ç¼©çš„äºŒè¿›åˆ¶å¤§å¯¹è±¡é¡µ**

**è¡Œ-Row**

InnoDBæ•°æ®æ˜¯æŒ‰ç…§è¡Œè¿›è¡Œå­˜æ”¾çš„ã€‚æ¯ä¸ªé¡µå­˜æ”¾çš„è¡Œè®°å½•ä¹Ÿæ˜¯æœ‰ç¡¬æ€§å®šä¹‰çš„ï¼Œæœ€å¤šå…è®¸å­˜æ”¾**16KB/ 2 - 200**è¡Œçš„è®°å½•ï¼Œå³7992è¡Œè®°å½•ã€‚



##### MyISAM

ä»‹ç»ï¼šæ˜¯æ—©æœŸçš„é»˜è®¤å­˜å‚¨å¼•æ“

###### ç‰¹ç‚¹ï¼š

- ä¸æ”¯æŒäº‹åŠ¡ï¼Œä¸æ”¯æŒå¤–é”®
- æ”¯æŒè¡¨é”ï¼Œä¸æ”¯æŒè¡Œé”
- è®¿é—®é€Ÿåº¦å¿«

###### æ–‡ä»¶ï¼š

xxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯

xxx.MYDï¼šå­˜å‚¨æ•°æ®

xxx.MYIï¼šå­˜å‚¨ç´¢å¼•



##### Memory

ä»‹ç»ï¼šMemoryå¼•æ“çš„è¡¨æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œç”±äºæ”¶åˆ°ç¡¬ä»¶é—®é¢˜ã€æ–­ç”µçš„å½±å“ï¼Œåªèƒ½å°†è¿™äº›è¡¨ä½œä¸ºä¸´æ—¶è¡¨æˆ–è€…ç¼“å­˜ä½¿ç”¨ã€‚

###### ç‰¹ç‚¹ï¼š

- å†…å­˜å­˜æ”¾
- hashç´¢å¼•ï¼ˆé»˜è®¤ï¼‰

###### æ–‡ä»¶ï¼š

xxx.sdiï¼šå­˜å‚¨è¡¨ç»“æ„ä¿¡æ¯



##### åŒºåˆ«ï¼š

|     ç‰¹ç‚¹     |      InnoDB       | MyISAM | Memory |
| :----------: | :---------------: | :----: | :----: |
|   å­˜å‚¨é™åˆ¶   |       64TB        |   æœ‰   |   æœ‰   |
|   äº‹åŠ¡å®‰å…¨   |       æ”¯æŒ        |   -    |   -    |
|    é”æœºåˆ¶    |       è¡Œé”        |  è¡¨é”  |  è¡¨é”  |
|  B+treeç´¢å¼•  |       æ”¯æŒ        |  æ”¯æŒ  |  æ”¯æŒ  |
|   Hashç´¢å¼•   |         -         |   -    |  æ”¯æŒ  |
|   å…¨æ–‡ç´¢å¼•   | æ”¯æŒ(5.6ç‰ˆæœ¬ä¹‹å) |  æ”¯æŒ  |   -    |
|   ç©ºé—´ä½¿ç”¨   |        é«˜         |   ä½   |  N/A   |
|   å†…å­˜ä½¿ç”¨   |        é«˜         |   ä½   |  ä¸­ç­‰  |
| æ‰¹é‡æ’å…¥é€Ÿåº¦ |        ä½         |   é«˜   |   é«˜   |
|   æ”¯æŒå¤–é”®   |       æ”¯æŒ        |   -    |   -    |

---





##### å­˜å‚¨å¼•æ“é€‰æ‹©

**MyISAMè¢«mongoDBæ›¿æ¢**

**Memoryè¢«Redisæ›¿æ¢**

åœ¨é€‰æ‹©å­˜å‚¨å¼•æ“æ—¶ï¼Œåº”è¯¥æ ¹æ®åº”ç”¨ç³»ç»Ÿçš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚å¯¹äºå¤æ‚çš„åº”ç”¨ç³»ç»Ÿï¼Œè¿˜å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å¤šç§å­˜å‚¨å¼•æ“è¿›è¡Œç»„åˆã€‚

- **InnoDB**ï¼šæ˜¯Mysqlçš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡ã€å¤–é”®ã€‚å¦‚æœåº”ç”¨å¯¹äº‹åŠ¡çš„å®Œæ•´æ€§æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘æ¡ä»¶ä¸‹è¦æ±‚æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ•°æ®æ“ä½œé™¤äº†æ’å…¥å’ŒæŸ¥è¯¢ä¹‹å¤–ï¼Œè¿˜åŒ…å«å¾ˆå¤šçš„æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆInnoDBå­˜å‚¨å¼•æ“æ˜¯æ¯”è¾ƒåˆé€‚çš„é€‰æ‹©ã€‚
- **MyISAM** ï¼š å¦‚æœåº”ç”¨æ˜¯ä»¥è¯»æ“ä½œå’Œæ’å…¥æ“ä½œä¸ºä¸»ï¼Œåªæœ‰å¾ˆå°‘çš„æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œå¹¶ä¸”å¯¹äº‹åŠ¡çš„å®Œã€‚æ•´æ€§ã€å¹¶å‘æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œé‚£ä¹ˆé€‰æ‹©è¿™ä¸ªå­˜å‚¨å¼•æ“æ˜¯éå¸¸åˆé€‚çš„,
- **MEMORY**ï¼šå°†æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè®¿é—®é€Ÿåº¦å¿«ï¼Œé€šå¸¸ç”¨äºä¸´æ—¶è¡¨åŠç¼“å­˜ã€‚MEMORYçš„ç¼ºé™·å°±æ˜¯å¯¹è¡¨çš„å¤§å°æœ‰é™åˆ¶ï¼Œå¤ªå¤§çš„è¡¨æ— æ³•ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸”æ— æ³•ä¿éšœæ•°æ®çš„å®‰å…¨æ€§ã€‚



### 2ã€ç´¢å¼•

##### ç´¢å¼•æ¦‚è¿°

> **ç´¢å¼•ï¼ˆindexï¼‰æ˜¯å¸®åŠ©MYSQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ï¼ˆæœ‰åºï¼‰ã€‚åœ¨æ•°æ®ä¹‹å¤–ï¼Œæ•°æ®åº“ç³»ç»Ÿè¿˜ç»´æŠ¤ç€æ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼å¼•ç”¨ï¼ˆæŒ‡å‘ï¼‰æ•°æ®ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„ä¸Šå®ç°é«˜çº§æŸ¥æ‰¾ç®—æ³•ï¼Œè¿™ç§æ•°æ®ç»“æ„å°±æ˜¯ç´¢å¼•ã€‚**

***ç”¨äºŒå‰æ ‘åšä¸ªç¤ºæ„å›¾ï¼ŒéçœŸå®çš„ç´¢å¼•ç»“æ„***

![image-20240301174933329](./img/10.png)



###### ä¼˜ç¼ºç‚¹ï¼š

| ä¼˜åŠ¿                                                         | åŠ£åŠ¿                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| æé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬                       | ç´¢å¼•ä¹Ÿæ˜¯è¦å ç”¨ç©ºé—´                                           |
| é€šè¿‡ç´¢å¼•åˆ—å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½CPUçš„æ¶ˆè€—ã€‚ | ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢æ•ˆç‡ï¼ŒåŒæ—¶å´ä¹Ÿé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡Œäº†INSERTã€UPDATEã€DELETEæ—¶ï¼Œæ•ˆç‡é™ä½ã€‚ |



##### ç´¢å¼•ç»“æ„

###### ä¸»è¦ç»“æ„ï¼š

| ç´¢å¼•ç»“æ„                | æè¿°                                                         |
| ----------------------- | ------------------------------------------------------------ |
| **B+Treeç´¢å¼•**          | æœ€å¸¸è§çš„ç´¢å¼•ç±»å‹ï¼Œå¤§éƒ¨åˆ†å¼•æ“éƒ½æ”¯æŒ                           |
| **Hashç´¢å¼•**            | åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”¨å“ˆå¸Œè¡¨å®ç°çš„ï¼Œåªæœ‰ç²¾ç¡®åŒ¹é…ç´¢å¼•åˆ—çš„æŸ¥è¯¢æ‰æœ‰æ•ˆï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ |
| **R-tree(ç©ºé—´ç´¢å¼•)**    | ç©ºé—´ç´¢å¼•æ˜¯MyISAMç´¢å¼•çš„ä¸€ä¸ªç‰¹æ®Šç´¢å¼•ç±»å‹ï¼Œä¸»è¦ç”¨äºåœ°ç†ç©ºé—´æ•°æ®ç±»å‹ï¼Œé€šå¸¸ä½¿ç”¨è¾ƒå°‘ |
| **Full-text(å…¨æ–‡ç´¢å¼•)** | æ˜¯ä¸€ç§å»ºç«‹ç´¢å¼•å€’æ’ç´¢å¼•ï¼Œå¿«é€ŸåŒ¹é…æ–‡æ¡£çš„æ–¹å¼ã€‚ç±»ä¼¼Luceneã€Solrã€ES |



**ç´¢å¼•æ”¯æŒï¼š**

|          ç´¢å¼•           |     InnoDB      | MyISAM | Memory |
| :---------------------: | :-------------: | :----: | :----: |
|     **B+Treeç´¢å¼•**      |    **æ”¯æŒ**     |  æ”¯æŒ  |  æ”¯æŒ  |
|      **Hashç´¢å¼•**       |     ä¸æ”¯æŒ      | ä¸æ”¯æŒ |  æ”¯æŒ  |
|  **R-tree(ç©ºé—´ç´¢å¼•)**   |     ä¸æ”¯æŒ      |  æ”¯æŒ  | ä¸æ”¯æŒ |
| **Full-text(å…¨æ–‡ç´¢å¼•)** | **5.6ä»¥åæ”¯æŒ** |  æ”¯æŒ  | ä¸æ”¯æŒ |





######  äºŒå‰æ ‘

> äºŒå‰æ ‘ç¼ºç‚¹ï¼šé¡ºåºæ’å…¥æ—¶ï¼Œä¼šå½¢æˆä¸€ä¸ª**é“¾è¡¨**ï¼ŒæŸ¥è¯¢æ€§èƒ½å¤§å¤§é™ä½ã€‚å¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ã€‚

<img src="./img/11.png" alt="image-20240301175135932" style="zoom:50%;" />

---



###### çº¢é»‘æ ‘

> **è§£å†³å•å‘é“¾è¡¨é—®é¢˜**
>
> **ç¼ºç‚¹ï¼šå¤§æ•°æ®é‡æƒ…å†µä¸‹ï¼Œå±‚çº§è¾ƒæ·±ï¼Œæ£€ç´¢é€Ÿåº¦æ…¢ã€‚**

![image-20240301175238387](./img/12.png)

---

###### B-Treeï¼ˆå¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼‰

B+æ ‘æ˜¯ä¸€ç§æ ‘æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºæ•°æ®åº“å’Œæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚B+æ ‘çš„ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿä¿æŒæ•°æ®ç¨³å®šæœ‰åºï¼Œå…¶æ’å…¥ä¸ä¿®æ”¹æ‹¥æœ‰è¾ƒç¨³å®šçš„å¯¹æ•°æ—¶é—´å¤æ‚åº¦ã€‚B+æ ‘çš„ç»“æ„å¦‚ä¸‹ï¼š

- B+æ ‘æ˜¯ä¸€é¢—å¤šè·¯æœç´¢æ ‘ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
  - æ¯ä¸ªèŠ‚ç‚¹è‡³å¤šæœ‰mä¸ªå­å¥³ã€‚
  - éæ ¹èŠ‚ç‚¹å…³é”®å€¼ä¸ªæ•°èŒƒå›´ï¼šâŒˆm/2âŒ‰ - 1 <= k <= m-1ã€‚
  - ç›¸é‚»å¶å­èŠ‚ç‚¹æ˜¯é€šè¿‡æŒ‡é’ˆè¿èµ·æ¥çš„ï¼Œå¹¶ä¸”æ˜¯å…³é”®å­—å¤§å°æ’åºçš„ã€‚
  - æ‰€æœ‰çš„å¶å­ç»“ç‚¹åœ¨åŒä¸€å±‚ã€‚

B+æ ‘çš„ç»“æ„ä½¿å¾—å®ƒé€‚ç”¨äºèŒƒå›´æŸ¥è¯¢å’Œæœ‰åºæ•°æ®çš„å­˜å‚¨

ä¸¾ä¾‹

ä»¥ä¸€é¢—æœ€å¤§åº¦æ•°ï¼ˆmax-degreeï¼‰ ä¸º5ï¼ˆ5é˜¶ï¼‰çš„b-treeä¸ºä¾‹ï¼ˆ**æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå­˜æ”¾å››ä¸ªkeyï¼Œ5ä¸ªæŒ‡é’ˆ**ï¼‰

æ ‘çš„åº¦æ•°æŒ‡çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ªæ•°

![image-20240301175329399](./img/13.png)

æŸ¥çœ‹bæ ‘æ¼”å˜è¿‡ç¨‹ç½‘ç«™**ğŸ®ğŸº**

```
https://www.cs.usfca.edu/~galles/visualization/Algorithms.html
```



**é¢è¯•ï¼šä¸ºä»€ä¹ˆb+Treeæœ€å¤šåªæœ‰3/4å±‚**

**B+ æ ‘**åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸åªæœ‰ **3 åˆ° 4 å±‚**çš„é«˜åº¦ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬åœ¨è¿™ä¸ªé«˜åº¦èŒƒå›´å†…å¯ä»¥æœ‰æ•ˆåœ°å­˜å‚¨å¤§é‡æ•°æ®ï¼ŒåŒæ—¶ä¿æŒè¾ƒä½çš„ç£ç›˜ I/O æ¬¡æ•°ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ã€‚

1. **B+ æ ‘çš„ç»“æ„**ï¼š
   - B+ æ ‘æ˜¯ä¸€ç§å¤šå‰æ ‘ï¼Œç”¨äºç»„ç»‡å’Œç®¡ç†æ•°æ®åº“ç´¢å¼•ã€‚
   - å®ƒçš„å¶å­èŠ‚ç‚¹å­˜å‚¨å®é™…æ•°æ®ï¼Œè€Œéå¶å­èŠ‚ç‚¹å­˜å‚¨é”®å€¼å’ŒæŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚
   - æ•°æ®åº“ä¸­çš„æ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªä¸»é”®ç´¢å¼• B+ æ ‘ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾æ•°æ®ã€‚
2. **æœ€å°å­˜å‚¨å•å…ƒ**ï¼š
   - åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼ŒB+ æ ‘çš„æœ€å°å­˜å‚¨å•å…ƒæ˜¯ **é¡µï¼ˆPageï¼‰**ï¼Œå¤§å°é€šå¸¸ä¸º **16KB**ã€‚
   - ä¸€ä¸ªé¡µä¸­å¯ä»¥å­˜å‚¨å¤šè¡Œæ•°æ®ï¼Œå‡è®¾ä¸€è¡Œæ•°æ®çš„å¤§å°æ˜¯ **1KB**ï¼Œé‚£ä¹ˆä¸€ä¸ªé¡µå¯ä»¥å®¹çº³ **16 è¡Œæ•°æ®**ã€‚
3. **B+ æ ‘çš„é«˜åº¦è®¡ç®—**ï¼š
   - å‡è®¾ B+ æ ‘çš„é«˜åº¦ä¸º **2**ï¼Œå³å­˜åœ¨ä¸€ä¸ªæ ¹èŠ‚ç‚¹å’Œè‹¥å¹²ä¸ªå¶å­èŠ‚ç‚¹ã€‚
   - éå¶å­èŠ‚ç‚¹å­˜æ”¾é”®å€¼å’ŒæŒ‡å‘æ•°æ®é¡µçš„æŒ‡é’ˆï¼Œä¸€ä¸ªé¡µä¸­èƒ½å­˜æ”¾å¤šå°‘è¿™æ ·çš„å•å…ƒå–å†³äºé¡µçš„å¤§å°ã€‚
   - å‡è®¾ä¸»é”® ID ä¸º **bigint** ç±»å‹ï¼Œé•¿åº¦ä¸º **8 å­—èŠ‚**ï¼Œè€ŒæŒ‡é’ˆå¤§å°åœ¨ InnoDB ä¸­è®¾ç½®ä¸º **6 å­—èŠ‚**ï¼Œä¸€ä¸ªé¡µä¸­èƒ½å­˜æ”¾çš„æŒ‡é’ˆæ•°é‡ä¸º **1170**ã€‚
4. **æ•°æ®é‡ä¼°ç®—**ï¼š
   - ä¸€æ£µé«˜åº¦ä¸º **2** çš„ B+ æ ‘å¯ä»¥å­˜æ”¾çº¦ **18720 æ¡æ•°æ®è®°å½•**ã€‚
   - ä¸€æ£µé«˜åº¦ä¸º **3** çš„ B+ æ ‘å¯ä»¥å­˜æ”¾çº¦ **21902400 æ¡æ•°æ®è®°å½•**ã€‚
   - å› æ­¤ï¼Œé€šå¸¸åœ¨ InnoDB ä¸­ï¼ŒB+ æ ‘çš„é«˜åº¦ä¸º **1 åˆ° 3 å±‚**ï¼Œè¶³ä»¥æ»¡è¶³åƒä¸‡çº§åˆ«çš„æ•°æ®å­˜å‚¨éœ€æ±‚ã€‚
5. **æŸ¥è¯¢æ•ˆç‡**ï¼š
   - åœ¨æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œä¸€æ¬¡é¡µçš„æŸ¥æ‰¾ä»£è¡¨ä¸€æ¬¡ I/O æ“ä½œã€‚
   - é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢é€šå¸¸åªéœ€è¦ **1 åˆ° 3 æ¬¡ I/O æ“ä½œ**å³å¯æŸ¥æ‰¾åˆ°æ•°æ®ã€‚

æ€»ä¹‹ï¼ŒB+ æ ‘çš„è®¾è®¡åœ¨å¹³è¡¡æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢æ•ˆç‡æ–¹é¢å–å¾—äº†è‰¯å¥½çš„ç»“æœï¼Œä½¿å¾—å®ƒæˆä¸ºæ•°æ®åº“ç´¢å¼•çš„é¦–é€‰ç»“æ„ã€‚

è¯·æ³¨æ„ï¼Œè¿™é‡Œçš„æ•°æ®é‡ä¼°ç®—å’Œé«˜åº¦è®¡ç®—æ˜¯åŸºäºç®€åŒ–çš„å‡è®¾ï¼Œå®é™…æƒ…å†µå¯èƒ½å› æ•°æ®åº“é…ç½®ã€æ•°æ®å¤§å°å’ŒæŸ¥è¯¢æ¨¡å¼è€Œæœ‰æ‰€ä¸åŒã€‚

---



###### B+Tree

**ç‰¹ç‚¹ï¼š**

- æ‰€æœ‰å…ƒç´ éƒ½ä¼šå­˜åœ¨å¶å­èŠ‚ç‚¹ä¸­

- å¶å­èŠ‚ç‚¹å½¢æˆå•å‘é“¾è¡¨

![image-20240301175722125](./img/14.png)

- ç»¿è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯ç´¢å¼•éƒ¨åˆ†ï¼Œä»…ä»…èµ·åˆ°ç´¢å¼•æ•°æ®çš„ä½œç”¨ï¼Œä¸å­˜å‚¨æ•°æ®ã€‚
-  çº¢è‰²æ¡†æ¡†èµ·æ¥çš„éƒ¨åˆ†ï¼Œæ˜¯æ•°æ®å­˜å‚¨éƒ¨åˆ†ï¼Œåœ¨å…¶å¶å­èŠ‚ç‚¹ä¸­è¦å­˜å‚¨å…·ä½“çš„æ•°æ®ã€‚





###### B+Treeï¼ˆMysqlç‰ˆæœ¬ï¼‰

MYSQLç´¢å¼•æ•°æ®ç»“æ„å¯¹ç»å…¸çš„B+Treeè¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨åŸæ¥çš„B+Treeçš„åŸºç¡€ä¸Šï¼Œ**å¢åŠ äº†ä¸€ä¸ªæŒ‡å‘ç›¸é‚»å¶å­èŠ‚ç‚¹çš„é“¾è¡¨æŒ‡é’ˆ**ï¼Œå°±å½¢æˆäº†å¸¦æœ‰é¡ºåºçš„B+Treeï¼Œæé«˜äº†åŒºé—´è®¿é—®çš„æ€§èƒ½ã€‚ 

![image-20240301175859689](./img/15.png)



###### Hashç´¢å¼•

> **hashç´¢å¼•å°±æ˜¯é€šè¿‡ä¸€å®šçš„hashç®—æ³•ï¼Œå°†é”®ä½æ¢ç®—æˆæ–°çš„hashå€¼ï¼Œç„¶åæ˜ å°„åˆ°å¯¹åº”çš„æ§½ä½ä¸Šï¼Œç„¶åå­˜åœ¨hashè¡¨ä¸­ã€‚å¦‚æœä¸¤ä¸ªæˆ–è€…å¤šä¸ªé”®å€¼æ˜ å°„åˆ°åŒä¸€ä¸ªæ§½ä½ä¸Šï¼Œé‚£ä¹ˆå°±äº§ç”Ÿäº†hashå†²çªï¼ˆhashç¢°æ’ğŸ’¥ï¼‰ï¼Œå¯ä»¥é€šè¿‡é“¾è¡¨æ¥è§£å†³ã€‚**

![image-20240301180124964](./img/17.png)

ç‰¹ç‚¹ï¼š

- hashç´¢å¼•åªèƒ½ç”¨äº**å¯¹ç­‰æ¯”è¾ƒ**ï¼ˆ=ï¼Œinï¼‰ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼ˆbetweenï¼Œ>,<ï¼‰
- **æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºæ“ä½œ**
- æŸ¥è¯¢æ•ˆç‡é«˜ï¼Œé€šå¸¸åªéœ€è¦ä¸€æ¬¡æ£€ç´¢å°±å¯ä»¥ï¼Œæ•ˆç‡é€šå¸¸é«˜äºb+Tree

å­˜å‚¨å¼•æ“æ”¯æŒï¼š

åœ¨MYSQLä¸­ï¼Œæ”¯æŒhashç´¢å¼•çš„æ˜¯Memoryå¼•æ“ï¼Œè€ŒInnoDBä¸­å…·æœ‰è‡ªé€‚åº”hashåŠŸèƒ½ï¼Œhashç´¢å¼•æ˜¯å­˜å‚¨å¼•æ“æ ¹æ®B+Treeç´¢å¼•åœ¨æŒ‡å®šæ¡ä»¶ä¸‹è‡ªåŠ¨æ„å»ºçš„ã€‚

---



###### **é¢è¯•é¢˜ï¼š**

ä¸ºä»€ä¹ˆInnoDBå­˜å‚¨å¼•æ“é€‰æ‹©ä½¿ç”¨B+treeç´¢å¼•ç»“æ„ï¼Ÿ

- **ç›¸å¯¹äºäºŒå‰æ ‘ï¼Œå±‚çº§æ›´å°‘ï¼Œæœç´ æ•ˆç‡æ›´é«˜**
- **B+æ ‘æ”¯æŒèŒƒå›´åŒ¹é…åŠæ’åºæ“ä½œ**
- **B+æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ›´åŠ ç¨³å®š**ï¼šå› ä¸ºB+æ ‘çš„æ¯æ¬¡æŸ¥è¯¢è¿‡ç¨‹ä¸­ï¼Œ**éƒ½éœ€è¦éå†ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„æŸæ¡è·¯å¾„**ã€‚æ‰€æœ‰å…³é”®å­—çš„æŸ¥è¯¢è·¯å¾„é•¿åº¦ç›¸åŒï¼Œå¯¼è‡´**æ¯ä¸€æ¬¡æŸ¥è¯¢çš„æ•ˆç‡ç›¸å½“**ã€‚

- **å¢åˆ æ–‡ä»¶ï¼ˆèŠ‚ç‚¹ï¼‰æ—¶ï¼Œæ•ˆç‡æ›´é«˜**ï¼šå› ä¸ºB+æ ‘çš„å¶å­èŠ‚ç‚¹åŒ…å«æ‰€æœ‰å…³é”®å­—ï¼Œå¹¶ä»¥æœ‰åºçš„é“¾è¡¨ç»“æ„å­˜å‚¨ï¼Œè¿™æ ·å¯å¾ˆå¥½æé«˜å¢åˆ æ•ˆç‡ï¼ŒåŸºäºèŒƒå›´æŸ¥è¯¢æ›´å¥½ã€‚
- **B+æ ‘ç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œå¯å‡å°‘I/Oæ¬¡æ•°**ï¼šç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—ã€‚è€Œå› ä¸ºB+æ ‘çš„å†…éƒ¨èŠ‚ç‚¹åªæ˜¯ä½œä¸ºç´¢å¼•ä½¿ç”¨ï¼Œè€Œä¸åƒBæ ‘é‚£æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦å­˜å‚¨ç¡¬ç›˜æŒ‡é’ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šB+æ ‘ä¸­æ¯ä¸ªéå¶èŠ‚ç‚¹æ²¡æœ‰æŒ‡å‘æŸä¸ªå…³é”®å­—å…·ä½“ä¿¡æ¯çš„æŒ‡é’ˆï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜æ”¾æ›´å¤šçš„å…³é”®å­—æ•°é‡ï¼Œå³ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜æ‰€éœ€è¦æŸ¥æ‰¾çš„å…³é”®å­—ä¹Ÿå°±è¶Šå¤šï¼Œå‡å°‘äº†I/Oæ“ä½œ1ã€‚



##### ç´¢å¼•åˆ†ç±»

| åˆ†ç±»         | **å«ä¹‰**                                             | ç‰¹ç‚¹                     | å…³é”®å­—       |
| ------------ | ---------------------------------------------------- | ------------------------ | ------------ |
| **ä¸»é”®ç´¢å¼•** | é’ˆå¯¹äºè¡¨ä¸­ä¸»é”®åˆ›å»ºçš„ç´¢å¼•                             | é»˜è®¤è‡ªåŠ¨åˆ›å»ºï¼Œåªèƒ½æœ‰ä¸€ä¸ª | **PRIMARY**  |
| **å”¯ä¸€ç´¢å¼•** | é¿å…åŒä¸€ä¸ªè¡¨ä¸­æŸæ•°æ®åˆ—ä¸­çš„å€¼é‡å¤                     | å¯ä»¥æœ‰å¤šä¸ª               | **UNIQUE**   |
| **å¸¸è§„ç´¢å¼•** | å¿«é€Ÿå®šä½ç‰¹å®šæ•°æ®                                     | å¯ä»¥æœ‰å¤šä¸ª               |              |
| **å…¨æ–‡ç´¢å¼•** | å…¨æ–‡ç´¢å¼•æŸ¥æ‰¾çš„æ˜¯æ–‡æœ¬ä¸­çš„å…³é”®å­—ï¼Œè€Œä¸æ˜¯æ¯”è¾ƒç´¢å¼•ä¸­çš„å€¼ | å¯ä»¥æœ‰å¤šä¸ª               | **FULLTEXT** |

***å½“æ–°å»ºå”¯ä¸€çº¦æŸçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•***



**æ ¹æ®ç´¢å¼•çš„å­˜å‚¨å½¢å¼ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š**

|              åˆ†ç±»               |                             å«ä¹‰                             |           ç‰¹ç‚¹           |
| :-----------------------------: | :----------------------------------------------------------: | :----------------------: |
| **èšé›†ç´¢å¼•ï¼ˆClustered indexï¼‰** | **å°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œç´¢å¼•ç»“æ„çš„å¶å­ç»“ç‚¹ä¿å­˜äº†è¡Œæ•°æ®** | **å¿…é¡»æœ‰ï¼Œè€Œä¸”åªæœ‰ä¸€ä¸ª** |
| **äºŒçº§ç´¢å¼•ï¼ˆSecondary indexï¼‰** | **å°†æ•°æ®ä¸ç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼Œç´¢å¼•ç»“æ„çš„å¶å­ç»“ç‚¹å…³è”çš„æ˜¯å¯¹åº”çš„ä¸»é”®** |     **å¯ä»¥å­˜åœ¨å¤šä¸ª**     |

###### **èšé›†ç´¢å¼•é€‰å–è§„åˆ™ï¼š**

- å¦‚æœå­˜åœ¨ä¸»é”®ï¼Œä¸»é”®ç´¢å¼•å°±æ˜¯èšé›†ç´¢å¼•
- å¦‚æœä¸å­˜åœ¨ä¸»é”®ï¼Œå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªå”¯ä¸€uniqueç´¢å¼•ä½œä¸ºèšé›†ç´¢å¼•
- å¦‚æœè¡¨æ²¡æœ‰ä¸»é”®ï¼Œæˆ–è€…æ²¡æœ‰åˆé€‚çš„å”¯ä¸€ç´¢å¼•ï¼Œ**åˆ™InnoDBä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªrowidä½œä¸ºéšè—çš„èšé›†ç´¢å¼•**



###### **èšé›†ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•çš„åŒºåˆ«ï¼š**

**èšé›†ç´¢å¼•**å¶å­ä¸­æŒ‚çš„æ˜¯**ä¸€è¡Œçš„æ•°æ®**

**äºŒçº§ç´¢å¼•**å¶å­èŠ‚ç‚¹ä¸­æŒ‚çš„å€¼**è¿™ä¸€è¡Œçš„id**

![image-20240301181120656](./img/18.png)



###### å›è¡¨æŸ¥è¯¢

> **å¦‚æœæ‹¿äºŒçº§ç´¢å¼•çš„å­—æ®µæŸ¥è¯¢ï¼Œå¦‚æœå­˜åœ¨ï¼Œå…ˆæŸ¥è¯¢åˆ°idï¼Œç„¶ååœ¨æ ¹æ®èšé›†ç´¢å¼•å»è¡¨ä¸­æŸ¥è¿™ä¸€è¡Œçš„æ•°æ®ã€‚**

![image-20240301181208597](./img/19.png)



###### ğŸŒŸé¢è¯•é¢˜ğŸŒŸï¼š

InnoDBä¸»é”®ç´¢å¼•çš„B+Treeé«˜åº¦ä¸ºå¤šé«˜ï¼Ÿ

![image-20240301181311675](./img/20.png)

å‡è®¾ï¼šä¸€è¡Œæ•°æ®å¤§å°ä¸º1Kï¼Œä¸€é¡µï¼ˆPageå›ºå®šå¤§å°16Kï¼‰ä¸­å¯ä»¥å­˜å‚¨16è¡Œè¿™æ ·çš„æ•°æ®ã€‚InnoDBçš„æŒ‡é’ˆå ç”¨6ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œä¸»é”®å‡è®¾æ˜¯ä¸ºbigintï¼Œå ç”¨å­—èŠ‚æ•°ä¸º8ã€‚

**é«˜åº¦ä¸º2:**

ä¸€é¡µ16k*1024å­—èŠ‚==ä¸»é”®æ•°é‡ * ä¸»é”®å¤§å°8å­—èŠ‚ + æŒ‡é’ˆæ•°é‡ï¼ˆä¸»é”®æ•°é‡+1ï¼‰* æŒ‡é’ˆå¤§å° 6 å­—èŠ‚ 

n*8 :ä¸»é”®çš„å¤§å°   (n+1) ï¼šæŒ‡é’ˆçš„æ•°é‡ 

n*8 + (n+1) *6 =16 * 1024ï¼Œè®¡ç®—nçº¦ç­‰äº1170ï¼Œ

å­˜å‚¨çš„æ•°é‡é‡ä¸º1171*16=18736

**é«˜åº¦ä¸º3:** 

**æ¯ä¸ªé¡µæœ€å¤š1171ä¸ª** 

1171 * 1171*16=21939856

---



##### ç´¢å¼•è¯­æ³•

###### åˆ›å»ºç´¢å¼•

```mysql
create unique index index_name ON table_name (index_col_name...);
create fulltext index index_name ON table_name (index_col_name...);
```

ä¸€ä¸ªç´¢å¼•å¯ä»¥å…³è”å¤šä¸ªå­—æ®µçš„ã€‚



###### å•åˆ—ç´¢å¼•

> ä¸€ä¸ªç´¢å¼•å…³è”ä¸€ä¸ªå­—æ®µ



###### è”åˆç´¢å¼•

> ä¸€ä¸ªç´¢å¼•å…³è”å¤šä¸ªå­—æ®µ***ï¼ˆé¡ºåºæ˜¯æœ‰è®²ç©¶çš„ï¼‰***

###### æŸ¥çœ‹ç´¢å¼•

```mysql
show index from table_name;
```



###### åˆ é™¤ç´¢å¼•

```mysql
drop index index_name ON table_name;
```



##### SQLæ€§èƒ½åˆ†æ

###### SQLæ‰§è¡Œé¢‘ç‡

æŸ¥è¯¢CRUDçš„è®¿é—®é¢‘æ¬¡

```mysql
show global status like 'Com_______';
```

**CRUD æŸ¥è¯¢çš„æ¬¡æ•°**

| Variable\_name | Value     |
| :------------- | :-------- |
| Com\_binlog    | 0         |
| Com\_commit    | 5726128   |
| Com\_delete    | 423666    |
| Com\_insert    | 40890232  |
| Com\_repair    | 0         |
| Com\_revoke    | 0         |
| Com\_select    | 110377358 |
| Com\_signal    | 0         |
| Com\_update    | 3358246   |
| Com\_xa\_end   | 0         |



###### æ…¢æŸ¥è¯¢æ—¥å¿—

æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•äº†æ‰€æœ‰çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šå‚æ•°ï¼ˆlong_query_timeï¼Œå•ä½ï¼šsï¼Œé»˜è®¤10sï¼‰çš„æ‰€æœ‰SQLè¯­å¥çš„æ—¥å¿—ã€‚

MYSQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤æ²¡æœ‰å¼€å¯ï¼Œéœ€è¦åœ¨MYSQLçš„é…ç½®æ–‡ä»¶ï¼ˆ/etc/my.confï¼‰ä¸­é…ç½®å¦‚ä¸‹ä¿¡æ¯

```properties
# å¼€å¯MYSQLæ…¢æ—¥å¿—æŸ¥è¯¢å¼€å…³
show_query_log=1
# è®¾ç½®æ…¢æ—¥å¿—æŸ¥è¯¢çš„æ—¶é—´ä¸º2sï¼ŒSQLè¯­å¥æ‰§è¡Œæ—¶é—´è¶…è¿‡2sï¼Œå°±ä¼šè§†ä¸ºæ…¢æŸ¥è¯¢ï¼Œè®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—
long_query_time=2
```

æŸ¥è¯¢æ…¢æŸ¥è¯¢å¼€å‘æ˜¯å¦å¼€å¯ï¼ŒæŸ¥è¯¢å˜é‡

```mysql
show variables like '%slow_query_log%';
show variables like '%long_query_time%';
```



æ…¢æŸ¥è¯¢logä½ç½®

```shell
cat  /var/lib/mysql/localhost-slow.log
```



###### profileè¯¦æƒ…

show profiles èƒ½å¤Ÿåœ¨åšSQLä¼˜åŒ–æ—¶å¸®åŠ©æˆ‘ä»¬äº†è§£æ—¶é—´éƒ½è€—è´¹åˆ°å“ªé‡Œå»äº†ã€‚é€šè¿‡hava_profilingå‚æ•°æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒprofileæ“ä½œï¼š

```mysql
SELECT @@have_profiling;
```

å¼€å¯profilingå¼€å…³ï¼Œå¯ä»¥åœ¨sessionçº§åˆ«ï¼Œä¹Ÿå¯ä»¥åœ¨globalçº§åˆ«

```mysql
-- æŸ¥çœ‹ç¯å¢ƒå˜é‡
show variables  like '%profiling%';
-- æ‰“å¼€å¼€å…³
set profiling =1;
```



æŸ¥è¯¢ä¸€ç³»åˆ—çš„ä¸šåŠ¡SQLçš„æ“ä½œï¼Œç„¶åé€šè¿‡å¦‚ä¸‹æŒ‡ä»¤æŸ¥è¯¢æŒ‡ä»¤çš„æ‰§è¡Œè€—æ—¶ï¼š

```mysql
-- æŸ¥è¯¢æ¯ä¸€æ¡sqlçš„è€—æ—¶åŸºæœ¬æƒ…å†µ
show profiles;
-- æŸ¥çœ‹æŒ‡å®šçš„query_id çš„sqlè¯­å¥å„ä¸ªé˜¶æ®µçš„è€—æ—¶æƒ…å†µ
show profile  for query 121;

-- æŸ¥çœ‹æŒ‡å®šquery_idçš„sqlè¯­å¥CPUä½¿ç”¨æƒ…å†µ
show profile cpu for query 121;

```

###### explainæ€§èƒ½åˆ†æ

explainæˆ–è€…descå‘½ä»¤è·å–Mysqlå¦‚ä½•æ‰§è¡ŒSELECTè¯­å¥çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬SELECTè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­è¡¨å¦‚ä½•è¿æ¥å’Œè¿æ¥çš„é¡ºåºã€‚

```mysql
-- è¯­æ³•
explain select * from table_user;
desc select * from table_user;
```



**Explainæˆªå›¾**

| id   | select\_type | table               | partitions | type | possible\_keys           | key                      | key\_len | ref               | rows  | filtered | Extra                           |
| :--- | :----------- | :------------------ | :--------- | :--- | :----------------------- | :----------------------- | :------- | :---------------- | :---- | :------- | :------------------------------ |
| 1    | PRIMARY      | &lt;derived2&gt;    | NULL       | ALL  | NULL                     | NULL                     | NULL     | NULL              | 7281  | 100      | NULL                            |
| 1    | PRIMARY      | web\_ply\_base      | NULL       | ref  | idx\_plybase\_plyno      | idx\_plybase\_plyno      | 203      | base01.c\_ply\_no | 1     | 100      | Using index                     |
| 2    | DERIVED      | &lt;derived3&gt;    | NULL       | ALL  | NULL                     | NULL                     | NULL     | NULL              | 7281  | 100      | Using temporary; Using filesort |
| 3    | DERIVED      | web\_ply\_applicant | NULL       | ref  | idx\_ply\_certf\_cde     | idx\_ply\_certf\_cde     | 83       | const             | 39    | 100      | NULL                            |
| 4    | UNION        | web\_ply\_insured   | NULL       | ref  | idx\_ply\_insured\_certf | idx\_ply\_insured\_certf | 83       | const             | 39    | 100      | NULL                            |
| 5    | UNION        | web\_ply\_bnfc      | NULL       | ALL  | NULL                     | NULL                     | NULL     | NULL              | 72038 | 10       | Using where                     |
| NULL | UNION RESULT | &lt;union3,4,5&gt;  | NULL       | ALL  | NULL                     | NULL                     | NULL     | NULL              | NULL  | NULL     | Using temporary                 |



**å„å­—æ®µå®šä¹‰ï¼š**

|       å­—æ®µ       | å«ä¹‰                                                         |
| :--------------: | :----------------------------------------------------------- |
|      **id**      | selectæŸ¥è¯¢çš„åºåˆ—å·ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œçš„selectå­å¥æˆ–è€…æ˜¯æ“ä½œè¡¨çš„é¡ºåºï¼ˆ**idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œidä¸åŒï¼Œå€¼è¶Šå¤§ï¼Œè¶Šå…ˆæ‰§è¡Œ**ï¼‰ |
| **select_type**  | è¡¨ç¤ºselectçš„ç±»å‹ï¼Œå¸¸è§çš„å–å€¼æœ‰SIMPLEï¼ˆç®€å•è¡¨ï¼Œä¸ç”¨è¡¨è¿æ¥æˆ–è€…å­æŸ¥è¯¢ï¼‰ã€PRIMARYï¼ˆä¸»æŸ¥è¯¢ï¼Œå³å¤–å±‚çš„æŸ¥è¯¢ï¼‰ã€UNIONï¼ˆUNIONä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„æŸ¥è¯¢è¯­å¥ï¼‰ã€SUBQUERYï¼ˆSELECT/WHEREä¹‹ååŒ…å«äº†å­æŸ¥è¯¢ï¼‰ç­‰ |
|     **type**     | è¡¨ç¤ºè¿æ¥ç±»å‹ï¼Œæ€§èƒ½ç”±å¥½åˆ°å·®çš„è¿æ¥ç±»å‹ä¸ºNULLã€SYSTEMã€const(ä¸»é”® å”¯ä¸€ç´¢å¼•)ã€eq_refã€refï¼ˆéå”¯ä¸€ç´¢å¼•ï¼‰ã€rangeã€indexã€all |
| **possible_key** | æ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸Šçš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ª                     |
|     **key**      | æ˜¾ç¤ºä½¿ç”¨çš„ç´¢å¼•                                               |
|   **Key_len**    | è¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨åˆ°å­—èŠ‚æ•°ï¼Œè¯¥å€¼ä¸ºç´¢å¼•å­—æ®µæœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œåœ¨ä¸æŸå¤±ç²¾åº¦åˆ°å‰æä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ |
|     **rows**     | MYSQL è®¤ä¸ºè¦æ‰§è¡ŒæŸ¥è¯¢åˆ°è¡Œæ ‘ï¼Œåœ¨innoDBå¼•æ“ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå¯èƒ½å¹¶ä¸æ€»æ˜¯å‡†ç¡® |
|   **filtered**   | è¡¨ç¤ºè¿”å›ç»“æœçš„è¡Œæ•°å éœ€è¦è¯»å–è¡Œæ•°åˆ°ç™¾åˆ†æ¯”ï¼Œå€¼è¶Šå¤§è¶Šå¥½         |
|    **Extra**     | é¢å¤–å±•ç¤ºçš„ä¿¡æ¯                                               |




##### ç´¢å¼•ä½¿ç”¨

###### æœ€å·¦å‰ç¼€æ³•åˆ™

å¦‚æœç´¢å¼•äº†ï¼ˆè”åˆç´¢å¼•ï¼‰ï¼Œè¦éµå®ˆ**æœ€å·¦å‰ç¼€æ³•åˆ™**ã€‚æœ€å·¦å‰ç¼€æ³•åˆ™æŒ‡çš„æ˜¯æŸ¥è¯¢ä»ç´¢å¼•çš„æœ€å·¦åˆ—å¼€å§‹ï¼Œå¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚
å¦‚æœè·³è·ƒæŸä¸€åˆ—ç´¢å¼•å°†éƒ¨åˆ†å¤±æ•ˆï¼ˆåé¢çš„å­—æ®µç´¢å¼•å¤±æ•ˆï¼‰ã€‚
**èšåˆç´¢å¼•ä¸­æœ€å·¦è¾¹çš„ç´¢å¼•å¿…é¡»å­˜åœ¨å³å¯ï¼Œåªè¦æœ€å·¦è¾¹çš„ç´¢å¼•å‡ºç°äº†ï¼Œå°±ä¼šèµ°ç´¢å¼•ã€‚ä¸ä½ç½®æ— å…³**

###### èŒƒå›´æŸ¥è¯¢

 èšåˆç´¢å¼•ä¸­ï¼Œå‡ºç°èŒƒå›´æŸ¥è¯¢ï¼ˆ<,>ï¼‰ï¼ŒèŒƒå›´æŸ¥è¯¢å³ä¾§çš„åˆ—ç´¢å¼•å¤±æ•ˆ

```mysql
-- ä¸‰ä¸ªå­—æ®µæ˜¯èšåˆç´¢å¼•ï¼Œä½†æ˜¯ statusç´¢å¼•å¤±æ•ˆ
select * from table_name where name='a' and age>10 and status =0;
-- è§„é¿æ–¹æ³• ä½¿ç”¨>= æˆ–è€…<=
select * from table_name where name='a' and age>=10 and status =0;

```

###### ç´¢å¼•åˆ—è¿ç®—

ä¸è¦åœ¨ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè¿ç®—æ“ä½œï¼Œç´¢å¼•å°†å¤±æ•ˆ
```mysql
-- å‡½æ•°è¿ç®— ç´¢å¼•å¤±æ•ˆ
select * from table_name where substring(phone,10,2) ='15';
```

###### å­—ç¬¦ä¸²ä¸åŠ å¼•å·

å­—ç¬¦ä¸²ç±»å‹å­—æ®µä½¿ç”¨æ—¶ï¼Œä¸åŠ å¼•å·ï¼Œç´¢å¼•å°†å¤±æ•ˆã€‚
```mysql
-- å­—ç¬¦ä¸²ç±»å‹ä¸åŠ å¼•å· ç´¢å¼•å¤±æ•ˆ
select * from table_name where phone =15;
```

###### æ¨¡ç³ŠæŸ¥è¯¢

å¦‚æœä»…ä»…æ˜¯å°¾éƒ¨æ¨¡ç³ŠæŸ¥è¯¢åŒ¹é…ï¼Œç´¢å¼•ä¸ä¼šå¤±æ•ˆã€‚å¦‚æœæ˜¯å¤´éƒ¨æ¨¡ç³ŠåŒ¹é…ï¼Œç´¢å¼•å°†å¤±æ•ˆã€‚

```mysql
-- å¤´éƒ¨æ¨¡ç³ŠæŸ¥è¯¢ ç´¢å¼•å¤±æ•ˆ
select * from table_name where phone like '%15';
```

###### orçš„è¿æ¥æ¡ä»¶

ç”¨oråˆ†éš”å¼€çš„æ¡ä»¶ï¼Œå¦‚æœorå‰çš„æ¡ä»¶ä¸­çš„åˆ—æœ‰ç´¢å¼•ï¼Œè€Œåé¢çš„åˆ—ä¸­æ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆè®¾è®¡åˆ°çš„ç´¢å¼•éƒ½ä¸ä¼šè¢«ç”¨åˆ°

```mysql
-- orå‰åå¿…é¡»éƒ½æœ‰ç´¢å¼• æ‰å¯ä»¥ç”Ÿæ•ˆ
 explain select * from table_name where phone = '1509999999' or type=1;
```

###### æ•°æ®åˆ†å¸ƒå½±å“

å¦‚æœMYSQLè¯„ä¼°ä½¿ç”¨ç´¢å¼•æ¯”å…¨è¡¨æ›´æ…¢ï¼Œåˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚

```mysql
-- å‡å¦‚ æ‰‹æœºå·ä»0å¼€å§‹é€’å¢ é‚£ä¹ˆä¸ä¼šèµ°ç´¢å¼• ç›´æ¥å…¨è¡¨æ‰«æ
 explain select * from table_name where phone >= '15000000000' ;

-- å‡å¦‚ æ‰‹æœºå·ä»0å¼€å§‹é€’å¢ ä¸€å…±100æ¡ é‚£ä¹ˆä¸ä¼šèµ°ç´¢å¼• ç›´æ¥å…¨è¡¨æ‰«æ
 explain select * from table_name where phone >= '15000000050' ;

-- å‡å¦‚æ‰‹æœºå·å¤§å¤šæ•°ä¸ä¸ºç©º is not null å’Œ null å–å†³äºå­—æ®µæ•°æ®åˆ†å¸ƒæƒ…å†µ---ä¸èµ°ç´¢å¼•
 explain select * from table_name where phone is not null ;

-- å‡å¦‚æ‰‹æœºå·å¤§å¤šæ•°éƒ½ä¸ºç©º null å–å†³äºå­—æ®µæ•°æ®åˆ†å¸ƒæƒ…å†µ---ä¸èµ°ç´¢å¼•
 explain select * from table_name where phone is null ;
```

###### SQLæç¤º

SQLæç¤ºï¼Œæ˜¯ä¼˜åŒ–æ•°æ®åº“çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨SQLè¯­å¥ä¸­åŠ å…¥ä¸€äº›è®¤ä¸ºçš„æç¤ºæ¥è¾¾åˆ°ä¼˜åŒ–æ“ä½œçš„ç›®çš„ã€‚

```mysql
-- å¦‚æœphoneæ˜¯å•åˆ—ç´¢å¼•ï¼Œä¹Ÿæ˜¯èšåˆç´¢å¼•ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨èšåˆç´¢å¼•ï¼Œæ²¡èµ°å•åˆ—ç´¢å¼•
 explain select * from table_name where phone >= '15000000000' ;
```

ä¼˜åŒ–æç¤ºï¼š
ä½¿ç”¨use indexï¼š

```mysql
-- å»ºè®®ä½¿ç”¨è¿™ä¸ªç´¢å¼•ï¼Œä½†æ˜¯mysqlè¿˜æ˜¯è¦å»æ¯”è¾ƒåˆ°åº•æ˜¯å¦æ¥å— 
 explain select * from table_name use index(index_phone) where phone >= '15000000000' ;
```

ä½¿ç”¨ignore index

```mysql
-- å¿½ç•¥ç´¢å¼•ï¼Œä½†æ˜¯mysqlè¿˜æ˜¯è¦å»æ¯”è¾ƒåˆ°åº•æ˜¯å¦æ¥å— 
 explain select * from table_name ignore index(index_phone) where phone >= '15000000000' ;
```

å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼š
force index()
```mysql
-- å¼ºåˆ¶ä½¿ç”¨è¿™ä¸ªç´¢å¼• 
 explain select * from table_name force index(index_phone) where phone >= '15000000000' ;
```





###### è¦†ç›–ç´¢å¼• 

å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆç´¢å¼•ä½¿ç”¨äº†ç´¢å¼•ï¼Œå¹¶ä¸”éœ€è¦è¿”å›çš„åˆ—ï¼Œåœ¨è¯¥ç´¢å¼•ä¸­å·²ç»å…¨éƒ¨èƒ½å¤Ÿæ‰¾åˆ°ï¼‰ï¼Œå‡å°‘select

```mysql
-- å¦‚æœname,id,age éƒ½æ˜¯ç´¢å¼• --è¿™äº›éƒ½æ˜¯ç´¢å¼•ï¼Œä¸éœ€è¦å›è¡¨ æ•ˆç‡é«˜
 explain select id, name,age from table_name where phone >= '15000000000' ;

-- status æ²¡æœ‰ç´¢å¼•ï¼Œéœ€è¦å›è¡¨ï¼Œæ•ˆç‡æ²¡æœ‰ä¸Šé¢çš„é«˜
 explain select id, name,status from table_name where phone >= '15000000000' ;
```



| id   | select\_type | table         | partitions | type  | possible\_keys | key         | key\_len | ref  | rows | filtered | Extra                    |
| :--- | :----------- | :------------ | :--------- | :---- | :------------- | :---------- | :------- | :--- | :--- | :------- | :----------------------- |
| 1    | SIMPLE       | test\_varchar | NULL       | index | name\_index    | name\_index | 403      | NULL | 2    | 100      | Using where; Using index |

**Tipsï¼Œå½“extraå†…å®¹æ˜¯ï¼š**

- **Using where; Using index**çš„æ—¶å€™ï¼Œä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦çš„æ•°æ®éƒ½åœ¨ç´¢å¼•åˆ—ä¸­èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥ä¸éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®
- **Using index condition**ï¼šä½¿ç”¨äº†ç´¢å¼•ï¼Œä½†æ˜¯éœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®



###### å‰ç¼€ç´¢å¼•

å½“å­—æ®µç±»å‹ä¸ºå­—ç¬¦ä¸²(varchar,textç­‰)æ—¶ï¼Œæœ‰æ—¶å€™éœ€è¦ç´¢å¼•å¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¼šè®©ç´¢å¼•å˜å¾—å¾ˆå¤§ï¼ŒæŸ¥è¯¢æ—¶ï¼Œæµªè´¹äº†å¤§é‡çš„ç£ç›˜IOï¼Œå½±å“æŸ¥è¯¢æ•ˆç‡ã€‚

æ­¤æ—¶å¯ä»¥åªå°†å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†å‰ç¼€ï¼Œå»ºç«‹ç´¢å¼•ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§èŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚

```mysql
-- è¯­æ³•
 create  index index_name ON employ (name(3));
```

å‰ç¼€é•¿åº¦

å¯ä»¥æ ¹æ®ç´¢å¼•çš„é€‰æ‹©æ€§æ¥å†³å®šï¼Œè€Œé€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼ï¼ˆåŸºæ•°ï¼‰å’Œæ•°æ®è¡¨çš„è®°å½•æ€»æ•°çš„æ¯”å€¼ï¼Œ

ç´¢å¼•é€‰æ‹©æ€§è¶Šé«˜åˆ™æŸ¥è¯¢çš„æ•ˆç‡è¶Šé«˜ï¼Œå”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚

```mysql
-- æ‰¾å¯¹åº”çš„ä¸´ç•Œç‚¹ï¼Œé€‚å½“é€‰æ‹©
select count(distinct email) from employ;

select count(distinct substring(email,1,6) )/count(distinct email) from employ;
```

**å‰ç¼€æŸ¥è¯¢æµç¨‹**

![image-20240301202207495](./img/21.png)



###### å•åˆ—ç´¢å¼•å’Œè”åˆç´¢å¼•

å•åˆ—ç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•å€¼åŒ…å«å•ä¸ªåˆ—

è”åˆç´¢å¼•ï¼šä¸€ä¸ªç´¢å¼•åŒ…å«äº†å¤šä¸ªåˆ—

åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œè€ƒè™‘é’ˆå¯¹äºæŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•æ—¶ï¼Œå»ºè®®å»ºç«‹è”åˆç´¢å¼•ï¼Œè€Œéå•åˆ—ç´¢å¼•ã€‚



**è”åˆç´¢å¼•æƒ…å†µï¼š**

![image-20240301202522235](./img/22.png)



##### ç´¢å¼•è®¾è®¡åŸåˆ™

1ã€é’ˆå¯¹äºæ•°æ®é‡è¾ƒå¤§ï¼Œä¸”æŸ¥è¯¢æ¯”è¾ƒé¢‘ç¹çš„è¡¨å»ºç«‹ç´¢å¼•

2ã€é’ˆå¯¹äºå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼ˆwhereï¼‰ã€æ’åºï¼ˆorder byï¼‰ã€åˆ†ç»„ï¼ˆgroup byï¼‰æ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼•

3ã€å°½é‡é€‰æ‹©åŒºåˆ†è¯»åº¦é«˜çš„å­—æ®µä½œä¸ºç´¢å¼•ï¼Œå°½é‡å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œä½¿ç”¨çš„æ•ˆç‡è¶Šé«˜

4ã€å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µï¼Œå­—æ®µçš„é•¿åº¦è¾ƒé•¿ï¼Œå¯ä»¥é’ˆå¯¹äºå­—æ®µçš„ç‰¹ç‚¹ï¼Œå»ºç«‹å‰ç¼€ç´¢å¼•

5ã€å°½é‡ä½¿ç”¨è”åˆç´¢å¼•ï¼Œå‡å°‘å•åˆ—ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶ï¼Œè”åˆç´¢å¼•å¾ˆå¤šæ—¶å€™å¯ä»¥è¦†ç›–ç´¢å¼•ï¼ŒèŠ‚çº¦å­˜å‚¨ç©ºé—´ï¼Œé¿å…å›è¡¨æŸ¥è¯¢ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

6ã€è¦æ§åˆ¶ç´¢å¼•çš„æ•°é‡ï¼Œç´¢å¼•å¹¶ä¸æ˜¯å¤šå¤šç›Šå–„ï¼Œç´¢å¼•è¶Šå¤šï¼Œç»´æŠ¤ç´¢å¼•çš„ç»“æ„çš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼Œä¼šå½±å“CDUçš„æ•ˆç‡

7ã€å¦‚æœç´¢å¼•åˆ—ä¸èƒ½å­˜å‚¨NULLå€¼ï¼Œè¯·åœ¨åˆ›å»ºè¡¨æ—¶ä½¿ç”¨NOT NULLçº¦æŸå®ƒã€‚å½“ä¼˜åŒ–å™¨çŸ¥é“æ¯åˆ—æ˜¯å¦åŒ…å«NULLå€¼æ—¶ï¼Œä»–å¯ä»¥æ›´å¥½åœ°ç¡®å®šå“ªä¸ªç´¢å¼•æœ€æœ‰æ•ˆåœ°ç”¨äºæŸ¥è¯¢



### 3ã€SQLä¼˜åŒ–



##### æ’å…¥æ•°æ®

###### insertæ’å…¥

**æ‰¹é‡æ’å…¥**

```mysql
-- å¤šæ¬¡æ’å…¥ï¼Œå°½é‡æ§åˆ¶åœ¨1000æ¡ä»¥å†…
insert into employ values ('1','Jack1',current_timestamp(),1,'1111@88.com'),('2','Jack2',current_timestamp(),1,'1111@88.com')
```

**æ‰‹åŠ¨æäº¤äº‹åŠ¡**

```mysql
start transaction ;
insert into employ values ('3','Jack1',current_timestamp(),1,'1111@88.com');
insert into employ values ('4','Jack2',current_timestamp(),1,'1111@88.com');
commit ;
```

**ä¸»é”®é¡ºåºæ’å…¥**

```mysql
-- ä¸»é”®é¡ºåºæ’å…¥é€Ÿåº¦å¿«äºä¹±åº
-- é¡ºåºæ’å…¥
1 2 3 4 6 78 99 100 190 200
```

###### æ’å…¥å¤§é‡æ•°æ®

å¦‚æœä¸€æ¬¡æ€§éœ€è¦å¤§æ‰¹é‡æ•°æ®ï¼Œä½¿ç”¨insertè¯­å¥æ’å…¥æ€§èƒ½ä½ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨mysqlæ•°æ®åº“æä¾›çš„loadæŒ‡ä»¤

```mysql
-- å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨æ—¶ï¼ŒåŠ ä¸Šå‚æ•° ---local-infile
mysql --local-infile -u root -p
-- è®¾ç½®å…¨å±€å‚æ•°localâ€”â€”infile ä¸º1 å¼€å¯ä»æœ¬åœ°åŠ è½½æ–‡ä»¶å¯¼å…¥æ•°æ®çš„å¼€å…³
set global local_infile = 1;
-- æ‰§è¡ŒloadæŒ‡ä»¤å°†å‡†å¤‡å¥½çš„æ•°æ® åŠ è½½åˆ°è¡¨ç»“æ„å½“ä¸­  
-- files terminated by ',' å­—æ®µæ ¹æ®â€˜,â€™åˆ†éš”å¼€ 
-- lines terminated by '\n' ä¸€è¡Œæ ¹æ®æ¢è¡Œç¬¦éš”å¼€
load data local infile '/root/sql.log' into 'table_name' files terminated by ',' lines terminated by '\n';
```



##### ä¸»é”®ä¼˜åŒ–

###### æ•°æ®ç»„ç»‡æ–¹å¼

åœ¨innoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œè¡¨æ•°æ®éƒ½æ˜¯æ ¹æ®ä¸»é”®é¡ºåºç»„ç»‡å­˜æ”¾çš„ï¼Œè¿™ç§å­˜å‚¨æ–¹å¼çš„è¡¨ç§°ä¸ºç´¢å¼•ç»„ç»‡è¡¨ï¼ˆindex organized table IOTï¼‰

![image-20240301203538673](./img/23.png)

è¡Œæ•°æ®ï¼Œéƒ½æ˜¯å­˜å‚¨åœ¨èšé›†ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸Šçš„ã€‚è€Œæˆ‘ä»¬ä¹‹å‰ä¹Ÿè®²è§£è¿‡InnoDBçš„é€»è¾‘ç»“æ„å›¾:

![image-20240301203648083](./img/24.png)

åœ¨InnoDBå¼•æ“ä¸­ï¼Œæ•°æ®è¡Œæ˜¯è®°å½•åœ¨é€»è¾‘ç»“æ„ page é¡µä¸­çš„ï¼Œè€Œæ¯ä¸€ä¸ªé¡µçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œé»˜è®¤16Kã€‚ é‚£ä¹Ÿå°±æ„å‘³ç€ï¼Œ ä¸€ä¸ªé¡µä¸­æ‰€å­˜å‚¨çš„è¡Œä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå¦‚æœæ’å…¥çš„æ•°æ®è¡Œrowåœ¨è¯¥é¡µå­˜å‚¨ä¸å°ï¼Œå°†ä¼šå­˜å‚¨ åˆ°ä¸‹ä¸€ä¸ªé¡µä¸­ï¼Œé¡µä¸é¡µä¹‹é—´ä¼šé€šè¿‡æŒ‡é’ˆè¿æ¥ã€‚



###### é¡µåˆ†è£‚

é¡µå¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥å¡«å……ä¸€åŠï¼Œä¹Ÿå¯ä»¥å¡«å……100%ã€‚æ¯ä¸ªé¡µåŒ…å«äº†2-Nè¡Œæ•°æ®ï¼ˆå¦‚æœä¸€è¡Œæ•°æ®è¿‡å¤§ï¼Œä¼šè¡Œæº¢å‡ºï¼‰ï¼Œæ ¹æ®ä¸»é”®æ’åºã€‚

**ä¸»é”®é¡ºåºæ’å…¥ï¼š**

![image-20240301203758226](./img/25.png)

![image-20240301203842977](./img/26.png)



**ä¸»é”®ä¹±åºæ’å…¥**

**åˆå§‹**

![image-20240301204057741](./img/27.png)

**ç§»åŠ¨æ–°å¼€å¯çš„é¡µ**

![image-20240301204128405](./img/28.png)

**æ’å…¥æ•°æ®åˆ°æ•°æ®é¡µ**

![image-20240301204206155](./img/29.png)

**é‡æ–°è®¾ç½®é“¾è¡¨**

![image-20240301204319032](./img/30.png)





###### é¡µåˆå¹¶

å½“åˆ é™¤ä¸€è¡Œè®°å½•æ—¶ï¼Œå®é™…ä¸Šè®°å½•å¹¶æ²¡æœ‰è¢«ç‰©ç†åˆ é™¤ï¼Œåªæ˜¯è®°å½•è¢«æ ‡è®°ï¼ˆflagedï¼‰ä¸ºåˆ é™¤å¹¶ä¸”å®ƒçš„ç©ºé—´å˜å¾—å…è®¸è¢«å…¶ä»–è®°å½•å£°æ˜ä½¿ç”¨ã€‚

å½“é¡µä¸­åˆ é™¤çš„è®°å½•è¾¾åˆ°**merge_threshold**(é»˜è®¤é¡µçš„50%)ï¼ŒInnoDBä¼šå¼€å§‹å¯»æ‰¾æœ€é è¿‘çš„é¡µï¼ˆå‰æˆ–è€…åï¼‰çœ‹çœ‹æ˜¯å¦å¯ä»¥å°†ä¸¤ä¸ªé¡µåˆå¹¶ä»¥ä¼˜åŒ–ç©ºé—´ä½¿ç”¨ã€‚

**åˆ é™¤éƒ¨åˆ†è¡Œè®°å½•**

![image-20240301204429292](./img/31.png)

> å½“é¡µä¸­åˆ é™¤çš„è®°å½•è¾¾åˆ° MERGE_THRESHOLD(é»˜è®¤ä¸ºé¡µçš„50%)ï¼ŒInnoDBä¼šå¼€å§‹å¯»æ‰¾æœ€é è¿‘çš„é¡µ(å‰ æˆ–å)çœ‹çœ‹æ˜¯å¦å¯ä»¥å°†ä¸¤ä¸ªé¡µåˆå¹¶ä»¥ä¼˜åŒ–ç©ºé—´ä½¿ç”¨ã€‚

**åˆå¹¶é¡µ**

![image-20240301204628783](./img/34.png)



**æ’å…¥æ–°æ•°æ®**

![image-20240301204608056](./img/33.png)

**Tipsï¼š**

merge_thresholdï¼šåˆå¹¶é¡µçš„é˜€å€¼ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®ï¼Œåœ¨åˆ›å»ºè¡¨æˆ–è€…åˆ›å»ºç´¢å¼•æ—¶æŒ‡å®šã€‚



###### ä¸»é”®è®¾è®¡åŸåˆ™

æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œå°½é‡é™ä½ä¸»é”®çš„é•¿åº¦

æ’å…¥æ•°æ®æ—¶ï¼Œ**å°½é‡é€‰æ‹©é¡ºåºæ’å…¥**ï¼Œé€‰æ‹©ä½¿ç”¨AUTO_INCREMENT è‡ªå¢ä¸»é”®

å°½é‡ä¸è¦ä½¿ç”¨UUIDåšä¸»é”®æˆ–è€…æ˜¯å…¶ä»–çš„è‡ªç„¶ä¸»é”®ï¼Œå¦‚èº«ä»½è¯å·

ä¸šåŠ¡æ“ä½œæ—¶ï¼Œé¿å…å¯¹ä¸»é”®çš„ä¿®æ”¹

![image-20240301204737815](./img/35.png)



##### order byä¼˜åŒ–

Using filesortï¼šé€šè¿‡è¡¨çš„ç´¢å¼•æˆ–å…¨è¡¨æ‰«æï¼Œè¯»å–æ»¡è¶³æ¡ä»¶çš„æ•°æ®è¡Œï¼Œç„¶å**åœ¨æ’åºç¼“å†²åŒºsort bufferä¸­å®Œæˆæ’åºæ“ä½œ**ï¼Œæ‰€æœ‰ä¸æ˜¯é€šè¿‡ç´¢å¼•ç›´æ¥è¿”å›æ’åºç»“æœçš„æ’åºéƒ½å«**FileSortæ’åº**ã€‚

**Using index**ï¼šé€šè¿‡æœ‰åºç´¢å¼•é¡ºåºæ‰«æç›´æ¥è¿”å›æœ‰åºæ•°æ®ï¼Œè¿™ç§æƒ…å†µå³ä¸ºusing indexï¼Œä¸éœ€è¦é¢å¤–æ’åºï¼Œæ“ä½œæ•ˆç‡é«˜ã€‚

```mysql
-- åˆ›å»ºç´¢å¼•ï¼Œä¸€ä¸ªå€’åºï¼Œä¸€ä¸ªé¡ºåºæ’
-- é»˜è®¤æ˜¯asc 
create index index_age_phone on table_name(age desc,phone asc);
-- æ ¹æ®group by æ’åº  å¦‚æœæ ¹æ®ç´¢å¼•å­—æ®µæ’åº  ä¹Ÿéœ€è¦éµå¾ªæœ€å·¦åŸåˆ™ ï¼Œå¹¶ä¸”æŸ¥è¯¢çš„å­—æ®µä¹Ÿéœ€è¦è¦†ç›–ç´¢å¼•
select id ,name,age,phone from table_user order by age desc,phone asc;
select id ,name,age,phone from table_user order by age ,phone;


```



**é¡ºåº/å€’åºæŸ¥è¯¢ç¤ºæ„å›¾ï¼ˆç´¢å¼•è¦†ç›–æƒ…å†µä¸‹ï¼‰ï¼š**

å¦‚æœæ˜¯é¡ºåºï¼Œä»é“¾è¡¨çš„å·¦è¾¹æŸ¥è¯¢èµ°ï¼Œå¦‚æœæ˜¯å€’åºï¼Œä»é“¾è¡¨çš„å³è¾¹å¼€å§‹æŸ¥è¯¢

![image-20240301205023288](./img/36.png)

**é¡ºåºã€å€’åºæŸ¥è¯¢ç¤ºæ„å›¾ï¼ˆç´¢å¼•è¦†ç›–æƒ…å†µä¸‹ï¼‰ï¼š**



###### Notesï¼š

å¦‚æœæŸ¥è¯¢çš„å­—æ®µä¸éƒ½æ˜¯ç´¢å¼•è¦†ç›–çš„ï¼Œé‚£ä¹ˆä¼šå›è¡¨æŸ¥è¯¢

æ ¹æ®æ’åºå­—æ®µå»ºç«‹åˆé€‚çš„ç´¢å¼•ï¼Œå¤šå­—æ®µæ’åºæ—¶ï¼Œä¹Ÿéµå¾ªæœ€å·¦å‰ç¼€æ³•åˆ™

**å°½é‡ä½¿ç”¨ç´¢å¼•è¦†ç›–**

å¤šå­—æ®µæ’åºæ—¶å€™ï¼Œä¸€ä¸ªå‡åºä¸€ä¸ªé™åºï¼Œéœ€è¦æ³¨æ„è”åˆç´¢å¼•åœ¨åˆ›å»ºæ—¶å¤šå®šä¹‰ï¼ˆASC/DESCï¼‰

å¦‚æœä¸å¯é¿å…çš„å‡ºç°filesortï¼Œå¤§æ•°æ®é‡æ’åºæ—¶ï¼Œå¯ä»¥é€‚å½“å¢åŠ æ’åºç¼“å†²åŒºå¤§å° **sort_buffer_sizeï¼ˆé»˜è®¤256Kï¼‰**

```mysql
-- æŸ¥è¯¢æ’åºç¼“å†²åŒºå¤§å°
show variables like '%sort_buffer_size%';
```



##### group byä¼˜åŒ–

é€‚å½“å¢åŠ groupçš„ç´¢å¼•ï¼Œå°½é‡ç´¢å¼•è¦†ç›–

ä¹Ÿéœ€è¦éµå¾ªæœ€å·¦å‰ç¼€æ³•åˆ™



##### limitä¼˜åŒ–

ä¸€ä¸ªå¸¸è§åˆå¤´ç–¼çš„é—®é¢˜å°±æ˜¯ limit 2000000,10ï¼Œæ­¤æ—¶éœ€è¦MYSQLæ’åºå‰2000010è®°å½•ï¼Œä»…è¿”å›2000000åˆ°2000010çš„è®°å½•ï¼Œå…¶ä»–è®°å½•æ”¾å¼ƒï¼ŒæŸ¥è¯¢çš„ä»£ä»·éå¸¸å¤§ã€‚

###### ä¼˜åŒ–æ€è·¯

ä¸€èˆ¬åˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œé€šè¿‡åˆ›å»º è¦†ç›–ç´¢å¼•èƒ½å¤Ÿè¾ƒå¥½çš„æé«˜æ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡è¦†ç›–ç´¢å¼•åŠ å­æŸ¥è¯¢çš„å½¢å¼è¿›è¡Œä¼˜åŒ–

```mysql
-- å­æŸ¥è¯¢1 ---æŠ¥é”™ ä¸æ”¯æŒè¿™ç§è¯­æ³•
select * from employ where  id in (select id from employ limit 0,10);
```

åªèƒ½é€šè¿‡å…³è”æŸ¥è¯¢

```mysql
select a.* from employ a ,(select id from employ limit 0,10) t1 where  a.id =t1.id;
```



##### countä¼˜åŒ–

**MyISAMå¼•æ“æ˜¯æŠŠä¸€ä¸ªè¡¨çš„æ€»è¡Œæ•°å­˜åœ¨äº†ç£ç›˜ä¸Š**ï¼Œå› æ­¤æ‰§è¡Œcount(*) çš„æ—¶å€™ä¼šç›´æ¥è¿”å›è¿™ä¸ªæ•°ï¼Œæ•ˆç‡é«˜ï¼›

InnoDBå¼•æ“å°±éº»çƒ¦äº†ï¼Œä»–æ‰§è¡Œcount(*) çš„æ—¶å€™ï¼Œ**éœ€è¦æŠŠæ•°æ®ä¸€è¡Œä¸€è¡Œçš„ä»å¼•æ“ä¸­è¯»å–å‡ºæ¥ï¼Œç„¶åç´¯è®¡è®¡æ•°ã€‚**

###### ä¼˜åŒ–æ€è·¯

è‡ªå·±æ‹¿redisè®¡æ•°

###### countç”¨æ³•

count()æ˜¯ä¸€ä¸ªèšåˆå‡½æ•°ï¼Œå¯¹äºè¿”å›çš„ç»“æœé›†ï¼Œä¸€è¡Œè¡Œçš„åˆ¤æ–­ï¼Œå¦‚æœcountå‡½æ•°çš„å‚æ•°**ä¸æ˜¯NULL**ï¼Œç´¯è®¡å€¼å°±åŠ 1ï¼Œå¦åˆ™ä¸åŠ ï¼Œæœ€åè¿”å›ç´¯è®¡å€¼ã€‚

**Count(*)**

InnoDBå¼•æ“**å¹¶ä¸ä¼šæŠŠå…¨éƒ¨å­—æ®µå–å‡ºæ¥**ï¼Œè€Œæ˜¯ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ï¼ŒæœåŠ¡å±‚ç›´æ¥æŒ‰è¡Œç´¯åŠ ã€‚

**Count(ä¸»é”®)**

InnoDBå¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼ŒæŠŠæ¯ä¸€è¡Œçš„ ä¸»é”®id å€¼éƒ½å–å‡ºæ¥ï¼Œè¿”å›ç»™æœåŠ¡å±‚ã€‚æœåŠ¡å±‚æ‹¿åˆ°ä¹‹åï¼Œç›´æ¥æŒ‰è¡Œè¿›è¡Œç´¯åŠ **ï¼ˆä¸»é”®ä¸å¯èƒ½ä¸ºnullï¼‰**

**Count(å­—æ®µ)**

å¦‚æœæ²¡æœ‰not null çº¦æŸï¼šInnoDBå¼•æ“ä¼šéå†æ•´å¼ è¡¨æŠŠæ¯ä¸€ä¸ªè¡Œçš„å­—æ®µå€¼éƒ½å–å‡ºæ¥ï¼Œè¿”å›ç»™æœåŠ¡å±‚ï¼ŒæœåŠ¡å±‚åˆ¤æ–­æ˜¯å¦ä¸ºnullï¼Œä¸ä¸ºnullï¼Œè®¡æ•°ç´¯åŠ ã€‚åªä¼šç´¯ç§¯è¡Œæ•°ä¸­è¿™ä¸ªå­—æ®µ**ä¸ä¸ºNULL**çš„è¡Œæ•°

æœ‰not nullçº¦æŸï¼šInnoDBå¼•æ“ä¼šéå†æ•´å¼ è¡¨æŠŠæ¯ä¸€ä¸ªè¡Œçš„å­—æ®µå€¼éƒ½å–å‡ºæ¥ï¼Œè¿”å›ç»™æœåŠ¡å±‚ã€‚ç›´æ¥æŒ‰è¡Œç´¯åŠ ã€‚

**Count(1)**

InnoDBå¼•æ“ä¼šéå†æ•´å¼ è¡¨ï¼Œä½†æ˜¯ä¸å–å€¼ã€‚æœåŠ¡å±‚å¯¹äºè¿”å›çš„æ¯ä¸€è¡Œï¼Œæ”¾ä¸€ä¸ªæ•°å­—â€˜1â€™è¿›å»ï¼Œç›´æ¥æŒ‰è¡Œç´¯åŠ ã€‚

###### æ‰§è¡Œæ•ˆç‡

**Count(å­—æ®µ) < Count(ä¸»é”®) < Count(1) çº¦ç­‰äº Count(*)**



##### updateä¼˜åŒ–

è¡Œé”ï¼Œè¡¨é”é—®é¢˜

```mysql
-- æ›´æ–°sqlçš„æ—¶å€™ï¼Œæ¡ä»¶å¿…é¡»æ˜¯ç´¢å¼• --- statusæ²¡æœ‰ç´¢å¼•---è¡¨é”
update employ set id ='1111' where status =1000;

```

æ³¨æ„âš ï¸âš ï¸ï¼š

**InnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹B+Treeç´¢å¼•indexåŠ çš„é”ï¼Œ ä¸æ˜¯é’ˆå¯¹è®°å½•åŠ çš„é”ï¼Œå¹¶ä¸”è¯¥ç´¢å¼•ä¸èƒ½å¤±æ•ˆï¼Œå¦åˆ™ä¼šä»è¡Œé”å‡çº§ä¸ºè¡¨é”ã€‚**

**å¿…é¡»æ ¹æ®ç´¢å¼•å­—æ®µæ›´æ–°**





### 4ã€è§†å›¾/å­˜å‚¨è¿‡ç¨‹/è§¦å‘å™¨

##### è§†å›¾

###### ä»‹ç»

è§†å›¾ï¼ˆviewï¼‰æ˜¯ä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„è¡¨ã€‚è§†å›¾ä¸­çš„æ•°æ®å¹¶ä¸åœ¨æ•°æ®åº“ä¸­å®é™…å­˜åœ¨ï¼Œè¡Œå’Œåˆ—æ•°æ®æ¥è‡ªå®šä¹‰è§†å›¾çš„æŸ¥è¯¢ä¸­ä½¿ç”¨çš„è¡¨ï¼Œå¹¶ä¸”æ˜¯åœ¨è§†å›¾æ—¶åŠ¨æ€ç”Ÿæˆ çš„ã€‚

é€šä¿—çš„è®²ï¼Œè§†å›¾å€¼ä¿å­˜äº†æŸ¥è¯¢çš„sqlé€»è¾‘ï¼Œä¸ä¿å­˜æŸ¥è¯¢çš„ç»“æœã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œä¸»è¦çš„å·¥ä½œå°±è½åœ¨äº†åˆ›å»ºè¿™æ¡SQLçš„æŸ¥è¯¢è¯­å¥ä¸Šã€‚

**è¯­æ³•**

```mysql
-- åˆ›å»ºè§†å›¾
CREATE [OR REPLACE ] VIEW  VIEW_NAME AS SELECT name,id from employ where id <100 [WITH[CASCADED|LOCAL] CHECK OPTION];
CREATE VIEW  employ_view AS SELECT name,id from employ where id <100;
-- æŸ¥è¯¢è§†å›¾-- å»ºè§†å›¾è¯­å¥
show create view table_name;
-- æŸ¥è¯¢è§†å›¾-- è§†å›¾å†…å®¹
select * from employ_view;
-- ä¿®æ”¹è§†å›¾
-- æ–¹å¼ä¸€
ALTER VIEW  employ_view as select age,name,id from  employ;
-- æ–¹å¼äºŒ
CREATE OR REPLACE VIEW  employ_view AS SELECT name,id ,age from employ where id <100;
-- åˆ é™¤è§†å›¾
DROP VIEW  IF EXISTS  employ_view;

```

###### è§†å›¾æ£€æŸ¥é€‰é¡¹

å½“ä½¿ç”¨WITH CHECK OPTIONå­å¥åˆ›å»ºè§†å›¾æ—¶ï¼ŒMYSQLä¼šé€šè¿‡è§†å›¾æ£€æŸ¥æ­£åœ¨æ›´æ”¹çš„æ¯ä¸ªè¡Œï¼Œä¾‹å¦‚æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼Œä»¥ä½¿å…¶ç¬¦åˆè§†å›¾çš„å®šä¹‰ã€‚MYSQLå…è®¸åŸºäºå¦ä¸€ä¸ªè§†å›¾åˆ›å»ºè§†å›¾ï¼Œä»–è¿˜ä¼šæ£€æŸ¥ä¾èµ–è§†å›¾ä¸­çš„è§„åˆ™ä»¥ä¿æŒä¸€è‡´æ€§ã€‚ä¸ºäº†ç¡®å®šæ£€æŸ¥çš„èŒƒå›´ï¼Œmysqlæä¾›äº†ä¸¤ä¸ªé€‰é¡¹ï¼šCASCADED å’ŒLOCALï¼Œé»˜è®¤ä¸ºCASCADEDã€‚

```mysql
-- ä¸åŠ æ£€æŸ¥é¡¹ï¼Œæ’å…¥æ•°æ®ä¸ä¼šåšæ£€æŸ¥--ä¸åšä»»ä½•æ ¡éªŒã€‚å¤§äº100ä¹Ÿèƒ½æ’å…¥ ä¸ä¼šå¼‚å¸¸
CREATE OR REPLACE VIEW  employ_view AS SELECT name,id ,age from employ where id <100;
insert into employ_view values ('1000',10000);

-- å¢åŠ æ£€æŸ¥é¡¹--- æ–°å¢idå¤§äº100çš„æ—¶å€™ï¼Œä¼šå‡ºç°æ£€æŸ¥æŠ¥é”™
CREATE OR REPLACE VIEW  employ_view AS SELECT name,id ,age from employ where id <100 with cascaded  check option;
-- æ’å…¥æ•°æ®  æ£€æŸ¥æŠ¥é”™--[HY000][1369] CHECK OPTION failed 'redis_lock.employ_view'
insert into employ_view values ('1000',10000,10000);

```

LOCAL

ä¼šå¾ªç¯é€’å½’çš„å»æ‰¾ç›¸å…³ä¾èµ–çš„åˆ¤æ–­æ¡ä»¶

```mysql
CREATE OR REPLACE VIEW  employ_view_1 AS SELECT name,id ,age from employ where id ='999' with local  check option;

```



###### è§†å›¾çš„æ›´æ–°

è¦æƒ³è§†å›¾å¯æ›´æ–°ï¼Œ**è§†å›¾ä¸­çš„è¡Œä¸åŸºç¡€è¡¨ä¸­çš„è¡Œä¹‹é—´å¿…é¡»å­˜åœ¨ä¸€å¯¹ä¸€çš„å…³ç³»**ã€‚å¦‚æœè§†å›¾åŒ…å«ä»¥ä¸‹ä»»æ„ä¸€é¡¹ï¼Œåˆ™è§†å›¾ä¸å¯æ›´æ–°ï¼š

1ã€èšåˆå‡½æ•°æˆ–çª—å£å‡½æ•°ï¼ˆsum(),min(),max(),count()ç­‰ï¼‰

2ã€DISTINCTã€Group Byã€Havingã€Unionæˆ–è€…Union All



###### ä½œç”¨

**ç®€å•**

è§†å›¾ä¸ä»…å¯ä»¥ç®€åŒ–ç”¨æˆ·å¯¹æ•°æ®å¯¹ç†è§£ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–ä»–ä»¬çš„æ“ä½œã€‚é‚£äº›è¢«ç»å¸¸ä½¿ç”¨çš„æŸ¥è¯¢å¯ä»¥è¢«å®šä¹‰ä¸ºè§†å›¾ï¼Œä»è€Œä½¿å¾—ç”¨æˆ·ä¸å¿…ä¸ºä»¥åçš„æ“ä½œæ¯æ¬¡æŒ‡å®šå…¨éƒ¨çš„æ¡ä»¶

**å®‰å…¨**

æ•°æ®åº“å¯ä»¥æˆæƒï¼Œä½†ä¸èƒ½æˆæƒåˆ°æ•°æ®åº“ç‰¹å®šè¡Œå’Œç‰¹å®šçš„åˆ—ä¸Šã€‚é€šè¿‡è§†å›¾ç”¨æˆ·å¯ä»¥åªèƒ½æŸ¥è¯¢å’Œä¿®æ”¹ä»–ä»¬æ‰€èƒ½è§åˆ°çš„æ•°æ®

**æ•°æ®ç‹¬ç«‹**

è§†å›¾å¯ä»¥å¸®åŠ©ç”¨æˆ·å±è”½çœŸå®è¡¨ç»“æ„å˜åŒ–å¸¦æ¥çš„å½±å“



##### å­˜å‚¨è¿‡ç¨‹

å­˜å‚¨è¿‡ç¨‹æ˜¯äº‹å…ˆç»è¿‡ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„ä¸€æ®µsqlè¯­å¥çš„é›†åˆï¼Œè°ƒç”¨å­˜å‚¨è¿‡ç¨‹å¯ä»¥ç®€åŒ–åº”ç”¨å¼€å‘äººå‘˜çš„å¾ˆå¤šå·¥ä½œï¼Œå‡å°‘æ•°æ®åœ¨æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“ï¼Œå¯¹äºæé«˜æ•°æ®å¤„ç†çš„æ•ˆç‡æ˜¯æœ‰å¥½å¤„çš„ã€‚

å­˜å‚¨è¿‡ç¨‹æ€æƒ³ä¸Šå¾ˆç®€å•ï¼Œå°±æ˜¯æ•°æ®åº“SQLè¯­è¨€å±‚é¢çš„ä»£ç å°è£…å’Œé‡ç”¨ã€‚

###### ç‰¹ç‚¹

å°è£…ã€å¤ç”¨ï¼Œå¯ä»¥æ¥å—å‚æ•°ï¼Œä¹Ÿå¯ä»¥è¿”å›æ•°æ®ï¼Œå‡å°‘ç½‘ç»œäº¤äº’ï¼Œæ•ˆç‡æå‡

```mysql
-- åˆ›å»ºå­˜å‚¨è¿‡ç¨‹
create procedure  test_procedure()
begin
    select * from table_user;
end;
-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
call test_procedure();
-- æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹
-- æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰çš„å­˜å‚¨è¿‡ç¨‹
select * from information_schema.ROUTINES where ROUTINE_SCHEMA ='redis_lock'
-- æŸ¥çœ‹å•ä¸ªå­˜å‚¨è¿‡ç¨‹çš„sqlä¿¡æ¯
show create procedure  test_procedure;
-- åˆ é™¤å­˜å‚¨è¿‡ç¨‹
drop procedure  if exists  test_procedure1;
```

æ³¨æ„âš ï¸ï¼š

**åœ¨å‘½ä»¤è¡Œä¸­ï¼Œæ‰§è¡Œåˆ›å»ºå­˜å‚¨è¿‡ç¨‹çš„SQLæ—¶ï¼Œéœ€è¦é€šè¿‡å…³é”®å­—delimiteræŒ‡å®šSQLè¯­å¥çš„ç»“æŸç¬¦ã€‚**



###### å˜é‡

**ç³»ç»Ÿå˜é‡**æ˜¯MYSQLæœåŠ¡å™¨æä¾›çš„ï¼Œä¸æ˜¯ç”¨æˆ·å®šä¹‰çš„ï¼Œå±äºæœåŠ¡å™¨å±‚é¢ã€‚åˆ†ä¸º**å…¨å±€å˜é‡**ã€ä¼šè¯å˜é‡ï¼ˆ**SESSION**ï¼‰

```mysql
-- æŸ¥çœ‹ç³»ç»Ÿå˜é‡
-- session çº§åˆ«çš„
show session variables like '%auto%';
-- å…¨å±€çš„
show global variables;
-- å‡†ç¡®æŸ¥çœ‹æŸä¸ªç³»ç»Ÿå˜é‡çš„å€¼
select @@autocommit;
select @@session.autocommit;

-- è®¾ç½®ç³»ç»Ÿå˜é‡
-- session çº§åˆ«
set session autocommit = 0;
-- gloabl çº§åˆ«çš„å˜é‡ åœ¨æœåŠ¡å™¨é‡å¯çš„æ—¶å€™ï¼Œä¼šå¤±æ•ˆ
set global  autocommit  = 1;

```

æ³¨æ„âš ï¸ï¼š

**å¦‚æœæ²¡æœ‰æŒ‡å®šSESSION/GLOBALï¼Œé»˜è®¤æ˜¯SESSIONï¼Œä¼šè¯å˜é‡ã€‚**

**mysqlæœåŠ¡é‡æ–°å¯åŠ¨ä¹‹åï¼Œæ‰€è®¾ç½®çš„å…¨å±€å‚æ•°ä¼šå¤±æ•ˆï¼Œè¦æƒ³ä¸å¤±æ•ˆï¼Œå¯ä»¥åœ¨/etc/my.cnfä¸­é…ç½®ã€‚**



**ç”¨æˆ·è‡ªå®šä¹‰å˜é‡**æ˜¯ç”¨æˆ·æ ¹æ®éœ€è¦è‡ªå·±å®šä¹‰çš„å˜é‡ï¼Œç”¨æˆ·å˜é‡ä¸ç”¨æå‰å£°æ˜ï¼Œåœ¨ç”¨çš„æ—¶å€™ç›´æ¥ç”¨â€œ@å˜é‡åâ€ä½¿ç”¨å°±å¯ä»¥ã€‚å…¶ä½œç”¨åŸŸä¸ºå½“å‰è¿æ¥ã€‚

è¯­æ³•ï¼š

```mysql
-- èµ‹å€¼
set @JackTestVar = 'Jack';
set @JackNameVar := 'Tony';
set @JackCount  :='1000',@JackCount1 = '1111',@JackCount2 :='222';

-- æŠŠæŸä¸ªè¡¨çš„æŸä¸ªå­—æ®µèµ‹å€¼
select COUNT(1) into @JackCount from table_user;
-- ä½¿ç”¨
select @JackNameVar,@JackNameVar,@JackCount,@JackCount1,@JackCount2;


```

æ³¨æ„âš ï¸ï¼š

ç”¨æˆ·å®šä¹‰çš„å˜é‡æ— éœ€å¯¹å…¶è¿›è¡Œå£°æ˜æˆ–åˆå§‹åŒ–ï¼Œåªä¸è¿‡è·å–åˆ°çš„å€¼ä¸ºNULL



**å±€éƒ¨å˜é‡**

å±€éƒ¨å˜é‡æ˜¯æ ¹æ®éœ€è¦å®šä¹‰çš„åœ¨å±€éƒ¨ç”Ÿæ•ˆçš„å˜é‡ï¼Œè®¿é—®ä¹‹å‰ï¼Œéœ€è¦DECLAREå£°æ˜ã€‚å¯ç”¨ä½œå­˜å‚¨è¿‡ç¨‹å†…çš„å±€éƒ¨å˜é‡å’Œè¾“å…¥å‚æ•°ï¼Œå±€éƒ¨å˜é‡çš„èŒƒå›´æ˜¯åœ¨å…¶å†…å£°æ˜çš„BEGINã€‚ã€‚ã€‚ENDå—ã€‚

è¯­æ³•ï¼š

```mysql
create procedure testVar()
begin
-- å£°æ˜å˜é‡ å˜é‡å ç±»å‹ é»˜è®¤å€¼
    DECLARE  userCount  int default 0;
    -- å˜é‡èµ‹å€¼
    select COUNT(1) into  userCount from table_user;
    select userCount;
end;
-- è°ƒç”¨å­˜å‚¨è¿‡
call testVar();
```



###### åŸºæœ¬è¯­æ³•

###### IFè¯­æ³•

```mysql
-- åˆ›å»ºå‰ éœ€è¦å…ˆåˆ é™¤
drop procedure  if exists  testIf;
create procedure  testIf()
begin
    declare score int default 59;
    declare result varchar(100) default null;
    if score >= 90 then
        set result = 'A';
    elseif score < 60 then
        set result = 'C';
    else
        set result = 'B';
    end if;
    select result;
end;
-- è°ƒç”¨å­˜è¿‡
call testif();
```

###### å‚æ•°ç”¨æ³•

![image-20240301210111346](./img/37.png)



```mysql
create procedure p1(in/out/inout å‚æ•°å å‚æ•°ç±»å‹)
begin 
    select * from  table_user;
end;
-- å®é™…ä½¿ç”¨
-- å…ˆåˆ é™¤
drop procedure  if exists p1;
-- åˆ›å»ºå­˜è¿‡ å…¥å‚å’Œå‡ºå‚
create procedure p1(in score int,out result varchar(100))
begin
    if score >= 90 then
        set result = 'A';
    elseif score < 60 then
        set result = 'C';
    else
        set result = 'B';
    end if;
end;
-- è°ƒç”¨å­˜è¿‡ è¾“å…¥å‚æ•° å’Œå‡ºå‚èµ‹å€¼
call p1(90,@result);
-- æŸ¥è¯¢èµ‹å€¼
select @result;
```



###### CASEè¯­æ³•



```mysql

drop procedure if exists p1;
create procedure p1(in score int)
begin
    declare  realResult varchar(111);
    case
        when score = 1000 then set realResult := '1';
        when score = 999 then set realResult := '10';
        else set realResult := '100';
        end case;
    select realResult;
end;
call p1(1);
```





###### WHILEè¯­æ³•

```mysql
-- å…ˆåˆ¤å®šæ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸ºtrue åˆ™æ‰§è¡Œé€»è¾‘ï¼Œå¦åˆ™ï¼Œä¸æ‰§è¡Œé€»è¾‘
WHILE condition DO
	SQL 
END WHILE;	

-- example 
drop procedure if exists p1;
create procedure p1(in score int)
begin
    declare  realResult int default 1;
    while  realResult < 100 do
      set  realResult := realResult+score;
        end while;
    select realResult;
end;
-- è°ƒç”¨
call p1(1000);
```



###### REPEATè¯­æ³•

repeatæ˜¯æœ‰æ¡ä»¶çš„å¾ªç¯æ§åˆ¶è¯­å¥ï¼Œå½“æ»¡è¶³æ¡ä»¶çš„æ—¶å€™é€€å‡ºå¾ªç¯ã€‚å…·ä½“è¯­æ³•ï¼š

```mysql
-- å…ˆæ‰§è¡Œä¸€æ¬¡é€»è¾‘ï¼Œç„¶ååˆ¤å®šé€»è¾‘æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™é€€å‡ºã€‚å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯ã€‚

REPEAT
	SQL
	UNTIL condition
	
END REPEAT;

-- example è®¡ç®—ä»1ç´¯åŠ åˆ°Nçš„å€¼ï¼ŒNä¸ºä¼ å…¥å‚æ•°
drop procedure if exists p1;
create procedure p1(in n int)
begin
    declare result int default 0;
    Repeat
        set result := result + n;
        set n := n - 1;
    until n = 0 end repeat;
    select result;
end;
-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
call p1(10);
```



###### LOOPè¯­æ³•

LOOPå®ç°ç®€å•çš„å¾ªç¯ï¼Œå¦‚æœä¸åœ¨SQLé€»è¾‘ä¸­å¢åŠ é€€å‡ºå¾ªç¯çš„æ¡ä»¶ï¼Œå¯ä»¥ç”¨å…¶æ¥å®ç°ç®€å•çš„æ­»å¾ªç¯ã€‚LOOPå¯ä»¥é…åˆä¸€ä¸‹ä¸¤ä¸ªè¯­å¥ä½¿ç”¨ï¼š

LEAVEï¼šé…åˆå¾ªç¯ä½¿ç”¨

ITEATEï¼šå¿…é¡»ç”¨åœ¨å¾ªç¯ä¸­ï¼Œä½œç”¨æ˜¯è·³è¿‡å½“å‰å¾ªç¯å‰©ä¸‹çš„è¯­å¥ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯

```mysql
[BEGIN_LABLE:] LOOP
	SQL
END LOOP [END_LABLE];	

-- example  è®¡ç®—ä»1ç´¯åŠ åˆ°Nçš„å€¼ï¼ŒNä¸ºä¼ å…¥å‚æ•°
drop procedure if exists p1;
create procedure p1(in n int)
begin
    declare result int default 0;
    -- èµ·ä¸ªå¾ªç¯çš„åå­—
    sum:
    loop
        if n <= 0 then
        -- ç»“æŸå¾ªç¯
            leave sum;
        end if;
        set result := result + n;
        set n := n - 1;
    end loop sum;
    select result;
end;
call p1(10);

-- example è®¡ç®—ä»1ç´¯åŠ åˆ°Nçš„å€¼(åªè¦å¶æ•°)ï¼ŒNä¸ºä¼ å…¥å‚æ•°
drop procedure if exists p1;
create procedure p1(in n int)
begin
    declare result int default 0;
    sum:
    loop
        if n <= 0 then
            leave sum;
        end if;
        -- å–æ¨¡è¿ç®—
        if n % 2 = 1 then
            -- å½“å‰å€¼å‡1 å¦åˆ™æ­»å¾ªç¯
            set n := n - 1;
            iterate sum;
        end if;
        set result := result + n;
        set n := n - 1;
    end loop sum;
    select result;
end;
call p1(10);
```

```mysql
LEAVE LABLE;  -- é€€å‡ºæŒ‡å®šæ ‡è®°çš„å¾ªç¯ä½“
ITRATE LABLE; -- ç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
```



###### æ¸¸æ ‡

æ¸¸æ ‡ï¼ˆCURSORï¼‰æ˜¯ç”¨æ¥å­˜å‚¨æŸ¥è¯¢ç»“æœé›†çš„æ•°æ®ç±»å‹ï¼Œåœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œå’Œå‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨æ¸¸æ ‡å¯¹ç»“æœé›†è¿›è¡Œå¾ªç¯çš„å¤„ç†ã€‚æ¸¸æ ‡çš„ä½¿ç”¨åŒ…æ‹¬æ¸¸æ ‡å¯¹å£°æ˜ã€OPENã€FETCHå’ŒCLOSEï¼Œå…¶è¯­æ³•åˆ†åˆ«å¦‚ä¸‹ï¼š

**å£°æ˜æ¸¸æ ‡**

```mysql
declare cursorName cursor for æŸ¥è¯¢è¯­å¥;
```

**æ‰“å¼€æ¸¸æ ‡**

```mysql
open cursor;
```

**è·å–æ¸¸æ ‡è®°å½•**

```mysql
FETCH æ¸¸æ ‡åç§° into å˜é‡,[å˜é‡];
```

**å…³é—­æ¸¸æ ‡**

```mysql
CLOSE cursorName;
```

Example ä»ä¸€ä¸ªè¡¨æŠ½æ•°æ®åˆ°å¦ä¸€ä¸ªè¡¨

```mysql
drop procedure if exists p1;
create procedure p1(in realAge int)
begin
    declare name1 varchar(100);
    declare age1 int;
    -- å£°æ˜æ¸¸æ ‡
    declare u_cursor cursor for select name,age from table_user where age>realAge;
    -- å£°æ˜æ¡ä»¶å¤„ç†
    declare exit handler for sqlstate '02000' close u_cursor;
    -- åˆ›å»ºè¡¨
    drop table  if exists  new_test_user;
    create table new_test_user(
        id int primary key auto_increment comment 'ä¸»é”®id',
        name varchar(100) comment 'Name',
        age int comment 'age'
    )comment 'æµ‹è¯•æ¸¸æ ‡';
     -- æ‰“å¼€æ¸¸æ ‡
    open u_cursor;
    -- å¾ªç¯æ’å…¥æ•°æ®
    while true do
        -- è·å–æ¸¸æ ‡è®°å½•
        fetch u_cursor into name1,age1;
        -- æ’å…¥æ–°è¡¨
        insert into new_test_user values (null,name1,age1);
        end while;
    -- å…³é—­æ¸¸æ ‡
    close u_cursor;
end;
call p1(1);
select * from new_test_user;
```



###### æ¡ä»¶å¤„ç†ç¨‹åº

æ¡ä»¶å¤„ç†ç¨‹åºï¼ˆ**handler**ï¼‰å¯ä»¥ç”¨æ¥å®šä¹‰åœ¨æµç¨‹æ§åˆ¶ç»“æ„æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æ—¶ç›¸åº”çš„å¤„ç†æ­¥éª¤ã€‚å…·ä½“è¯­æ³•ï¼š

```mysql
DECLARE handler_action. HANDLER FOR condition_value [,condition_value] ... statement;

handler_action
	CONTINUE:ç»§ç»­æ‰§è¡Œå½“å‰ç¨‹åº
	EXIT:ç»ˆæ­¢æ‰§è¡Œå½“å‰ç¨‹åº
condition_value
	SQLSTATE sqlstate_value:çŠ¶æ€ç ï¼Œå¦‚02000
	SQLWARNING: æ‰€æœ‰ä»¥01å¼€å¤´çš„SQLSTATEä»£ç çš„ç®€å†™
	NOT FOUND: æ‰€æœ‰ä»¥02å¼€å¤´çš„SQLSTATEä»£ç çš„ç®€å†™
	SQLEXCEPTION: æ‰€æœ‰æ²¡æœ‰è¢«SQLWARNINGæˆ–NOT FOUNDæ•è·çš„SQLSTATEä»£ç çš„ç®€å†™
```



##### å­˜å‚¨å‡½æ•°

å­˜å‚¨å‡½æ•°æ˜¯æœ‰è¿”å›å€¼çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨å‡½æ•°çš„å‚æ•°åªèƒ½æ˜¯INç±»å‹çš„ã€‚å…·ä½“è¯­æ³•ï¼š

```mysql
CREATE FUNCTION å­˜å‚¨å‡½æ•°åç§°([å‚æ•°åˆ—è¡¨])
RETURNS type [characteristic]
BEGIN
	SQL
	RETURN ...;
END;
characteristicè¯´æ˜:
DETERMINSTIC:ç›¸åŒçš„è¾“å…¥å‚æ•°æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„ç»“æœ
NO SQL:ä¸åŒ…å«SQLè¯­å¥
READS SQL DATA:åŒ…å«è¯»å–æ•°æ®çš„è¯­å¥ï¼Œä½†ä¸åŒ…å«å†™å…¥æ•°æ®çš„è¯­å¥
```



**Example**

ä»1ç´¯åŠ åˆ°N

```mysql
drop function if exists testFun1;
create function testFun1(param int)
    returns int
    deterministic
begin
    declare total int default 0;
    while param > 0
        do
            set total := total + param;
            set param := param - 1;
        end while;
    return total;
end;
-- æŸ¥è¯¢æ•°æ®--è°ƒç”¨functionå‡½æ•°
select testFun1(100);
```



##### è§¦å‘å™¨

è§¦å‘å™¨æ˜¯ä¸è¡¨æœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼ŒæŒ‡åœ¨insert/update/deleteä¹‹å‰æˆ–ä¹‹åï¼Œè§¦å‘å¹¶æ‰§è¡Œè§¦å‘å™¨ä¸­å®šä¹‰çš„sqlè¯­å¥é›†åˆã€‚è§¦å‘å™¨çš„è¿™ç§ç‰¹æ€§å¯ä»¥ååŠ©åº”ç”¨åœ¨æ•°æ®åº“ç«¯ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ï¼Œæ—¥å¿—è®°å½•ï¼Œæ•°æ®æ ¡éªŒç­‰æ“ä½œã€‚

ä½¿ç”¨åˆ«å**OLDå’ŒNEW**æ¥**å¼•ç”¨è§¦å‘å™¨ä¸­**å‘ç”Ÿå˜åŒ–çš„è®°å½•å†…å®¹ï¼Œè¿™ä¸å…¶ä»–çš„æ•°æ®åº“æ˜¯ç›¸ä¼¼çš„ã€‚ç°åœ¨è§¦å‘å™¨è¿˜**åªæ”¯æŒè¡Œçº§è§¦å‘**ï¼Œä¸æ”¯æŒè¯­å¥çº§è§¦å‘ã€‚

![image-20240301210316020](./img/38.png)

###### è¯­æ³•

```mysql
-- åˆ›å»ºè§¦å‘å™¨
create trigger trigger_name
    BEFORE/AFTER insert/update/delete
    on table_user
    -- è¡Œçº§è§¦å‘å™¨
    for each row
begin
    trigger_statement;
end;

-- æŸ¥çœ‹è§¦å‘å™¨
show triggers;
-- åˆ é™¤
drop trigger if exists trigger_name;
```

**Example**

é€šè¿‡è§¦å‘å™¨å‡ºå‘è®°å½•userè¡¨ä¸­çš„æ•°æ®å˜æ›´è®°å½•ï¼ˆuser_logï¼‰ åŒ…å«å¢åŠ ä¿®æ”¹åˆ é™¤ï¼Œéœ€è¦åˆ›å»ºä¸‰ä¸ªè¡¨

```mysql
-- ç”¨æˆ·æ—¥å¿—è¡¨
create table user_log(
    id int(11) primary key auto_increment comment 'primary key id',
    operation varchar(20)  not null  comment 'æ“ä½œè®°å½• insert/delete/update',
    operation_time datetime not null  comment 'operation_time',
    operation_id int(11) not null  comment 'operation_id',
    operation_param varchar(500) comment 'æ“ä½œè®°å½•'
) comment 'æ—¥å¿—è®°å½•è¡¨';

-- æ–°å¢insertè§¦å‘å™¨
drop  trigger if exists user_log_insert;
create trigger user_log_insert
    after insert
    on table_user
    -- è¡Œçº§è§¦å‘å™¨
    for each row
begin
    insert into user_log
    values (null, 'insert', now(), NEW.id,
            concat(',', NEW.id, ',', NEW.age, ',', NEW.name, ',', NEW.status, ',', NEW.gender));
end;
-- å…¶ä»– update/delete æ“ä½œåŒç†
```



### 5ã€é”

##### æ¦‚è¿°

é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€ä¸ªèµ„æºçš„æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—å™¨èµ„æºCPU/RAM/IOçš„ç«äº‰æ„å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚

MYSQLä¸­çš„é”ï¼ŒæŒ‰ç…§é”çš„ç²’åº¦åˆ†ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š

1. å…¨å±€é”ğŸ”’ï¼šé”ä½æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨

2. è¡¨çº§é”ğŸ”’ï¼šæ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨

3. è¡Œçº§é”ğŸ”’ï¼šæ¯æ¬¡æ“ä½œéƒ½é”ä½å¯¹åº”çš„è¡Œæ•°æ®**ï¼ˆå¯¹åº”çš„Rowæ•°æ®çš„indexï¼‰**



##### å…¨å±€é”

å…¨å±€é”å°±æ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹åŠ é”ï¼ŒåŠ é”åæ•´ä¸ªå®ä¾‹å¤„äºåªè¯»çŠ¶æ€ï¼Œåç»­çš„DMLè¯­å¥ï¼ŒDDLè¯­å¥ï¼Œå·²ç»æ›´æ–°æ“ä½œçš„äº‹åŠ¡æäº¤è¯­å¥éƒ½å°†è¢«é˜»å¡ã€‚å…¶å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯åšå…¨åº“çš„é€»è¾‘å¤‡ä»½ï¼Œå¯¹æ‰€æœ‰çš„è¡¨è¿›è¡Œé”å®šï¼Œä»è€Œè·å–ä¸€è‡´æ€§è§†å›¾ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚

**è¯­æ³•**

```mysql
-- å¤‡ä»½æ“ä½œ
-- æ‰“å¼€å…¨å±€é”
flush tables with read lock;
-- å¼€å§‹å¤‡ä»½æ“ä½œ -- åœ¨æœåŠ¡å™¨ä¸­æ“ä½œï¼Œä¸è¦åœ¨mysql consoleä¸­æ“ä½œ
mysqldump -uroot -p1234 test>test.sql
-- è§£é”
unlock tables;
```

###### ç‰¹ç‚¹

æ•°æ®åº“ä¸­åŠ å…¨å±€é”ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„æ“ä½œï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. å¦‚æœåœ¨ä¸»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´éƒ½ä¸èƒ½æ‰§è¡ŒDMLã€DDLè¯­å¥ï¼Œä¸šåŠ¡åŸºæœ¬ä¸Šå°±å¾—åœæ‘†

2. å¦‚æœåœ¨ä»åº“ä¸Šå¤‡ä»½ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æœŸé—´ï¼Œä»è‹¦ä¸èƒ½æ‰§è¡Œä¸»åº“åŒæ­¥è¿‡æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆbinlogï¼‰ï¼Œä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿ

åœ¨InnoDBå¼•æ“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤‡ä»½æ—¶åŠ ä¸Šå‚æ•°**--single-transaction**å‚æ•°æ¥å®Œæˆä¸åŠ é”çš„ä¸€è‡´æ€§æ•°æ®å¤‡ä»½ã€‚

```mysql
mysqldump --single-transaction  -uroot -p1234 test>test.sql
```



##### è¡¨çº§é”

è¡¨çº§é”ï¼Œæ¯æ¬¡æ“ä½œéƒ½é”ä½æ•´å¼ è¡¨ã€‚é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚åº”ç”¨åœ¨MyISAMã€InnoDBã€BDBç­‰å­˜å‚¨å¼•æ“ä¸­ã€‚

å¯¹äºè¡¨çº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š

```
1. è¡¨é”
2. å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDLï¼‰
3. æ„å‘é”
```



###### è¡¨é”

1. **è¡¨å…±äº«è¯»é”ï¼ˆread lockï¼‰---åªèƒ½è¯»ï¼Œä¸èƒ½å†™**

2. **è¡¨è¯»å å†™é”ï¼ˆwrite lockï¼‰---å…¶ä»–çš„ä¸èƒ½è¯»ï¼Œä¸èƒ½å†™**

è¯­æ³•

1. **åŠ é”ï¼šlock tables table_name.... read/write**

2. **é‡Šæ”¾é”ï¼šunlock tables /å®¢æˆ·ç«¯æ–­å¼€è¿æ¥**



###### å…ƒæ•°æ®é”ï¼ˆmeta data lockï¼ŒMDLï¼‰

MDLåŠ é”è¿‡ç¨‹æ˜¯ç³»ç»Ÿè‡ªåŠ¨æ§åˆ¶ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨ï¼Œåœ¨è®¿é—®ä¸€å¼ è¡¨çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ ä¸Šã€‚MDLé”ä¸»è¦ä½œç”¨æ˜¯ç»´æŠ¤è¡¨å…ƒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨è¡¨ä¸Šæœ‰æ´»åŠ¨äº‹åŠ¡çš„æ—¶å€™ï¼Œä¸å¯ä»¥å¯¹å…ƒæ•°æ®è¿›è¡Œå†™å…¥æ“ä½œã€‚**ä¸ºäº†é¿å…DMLå’ŒDDLå†²çªï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚**

åœ¨MYSQL5.5ä¸­å¼•å…¥äº†MDLï¼Œå½“å¯¹ä¸€å¼ è¿›è¡ŒCRUDçš„æ—¶å€™ï¼Œ**åŠ MDLè¯»é”ï¼ˆå…±äº«ï¼‰**ï¼›å½“å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´æ“ä½œçš„æ—¶å€™ï¼Œ**åŠ MDLå†™é”ï¼ˆæ’ä»–ï¼‰**ã€‚

![image-20240301211122728](./img/39.png)

æŸ¥çœ‹å…ƒæ•°æ®é”ï¼š

```mysql
select object_type, object_schema, object_name, column_name, object_instance_begin, lock_type, lock_duration from performance_schema.metadata_locks;
```



###### æ„å‘é”

ä¸ºäº†é¿å…DMLåœ¨æ‰§è¡Œæ—¶ï¼ŒåŠ çš„è¡Œé”ä¸è¡¨é”çš„å†²çªï¼Œåœ¨InnoDBä¸­å¼•å…¥äº†æ„å‘é”ï¼Œä½¿å¾—è¡¨é”ä¸ç”¨æ£€æŸ¥æ¯è¡Œæ•°æ®æ˜¯å¦åŠ é”ï¼Œ**ä½¿ç”¨æ„å‘é”æ¥å‡å°‘è¡¨é”çš„æ£€æŸ¥**ã€‚

**æ„å‘å…±äº«é”ï¼ˆISï¼‰ï¼šä¸è¡¨é”å…±äº«é”ï¼ˆreadï¼‰å…¼å®¹ï¼Œä¸è¡¨é”æ’ä»–é”ï¼ˆwriteï¼‰äº’æ–¥**

**æ„å‘æ’ä»–é”ï¼ˆIXï¼‰ï¼šä¸è¡¨é”å…±äº«é”ï¼ˆreadï¼‰åŠæ’å®ƒé”ï¼ˆwriteï¼‰éƒ½äº’æ–¥ã€‚æ„å‘é”ä¹‹é—´ä¸ä¼šäº’æ–¥**



å¯ä»¥é€šè¿‡ä»¥ä¸‹SQLï¼ŒæŸ¥çœ‹æ„å‘é”åŠè¡Œé”çš„åŠ é”æƒ…å†µï¼š

**æ„å‘å…±äº«é”ï¼ˆISï¼‰æ¼”ç¤ºï¼š**

```mysql
-- console1 åŠ äº‹åŠ¡ï¼Œè¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶ä½¿ç”¨è¡Œé”
begin;
select * from table_user where id= 1 lock in share mode;

-- console2 æŸ¥è¯¢ç›®å‰çš„æ„å‘é”

select OBJECT_NAME,OBJECT_SCHEMA,INDEX_NAME, LOCK_MODE,LOCK_DATA,LOCK_TYPE from performance_schema.data_locks;

-- console2 è¿›è¡Œ å¯¹è¡¨è¿›è¡Œè¯»å†™é”æ“ä½œ
-- è¯»é”æ˜¯å…±äº«çš„
lock tables table_user read ;
unlock tables ;
-- å†™é”æ˜¯äº’æ–¥çš„ï¼Œå·²ç»blockä½äº†
lock tables table_user write ;
unlock tables ;
```



**æ„å‘æ’ä»–é”ï¼ˆIXï¼‰æ¼”ç¤ºï¼š**

```mysql
-- console1 åŠ äº‹åŠ¡ï¼Œè¿›è¡Œæ›´æ–°ï¼Œå¹¶ä½¿ç”¨è¡Œé”
begin;
update table_user set name = 'JackOX' where id= 1;

-- console2 æŸ¥è¯¢ç›®å‰çš„æ„å‘é”
select OBJECT_NAME,OBJECT_SCHEMA,INDEX_NAME, LOCK_MODE,LOCK_DATA,LOCK_TYPE from performance_schema.data_locks;

-- console2 è¿›è¡Œ å¯¹è¡¨è¿›è¡Œè¯»å†™é”æ“ä½œ
-- è¯»é”æ˜¯äº’æ–¥çš„
lock tables table_user read ;
unlock tables ;
-- å†™é”æ˜¯äº’æ–¥çš„ï¼Œå·²ç»blockä½äº†
lock tables table_user write ;
unlock tables ;
```



##### è¡Œçº§é”

> ```
> è¡Œçº§é”ï¼Œæ¯æ¬¡æ“ä½œé”ä½å¯¹åº”çš„è¡Œæ•°æ®ã€‚é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚åº”ç”¨åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ã€‚
> InnoDBçš„æ•°æ®æ˜¯åŸºäºç´¢å¼•ç»„ç»‡çš„ï¼Œ**è¡Œé”æ˜¯é€šè¿‡å¯¹ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„**ï¼Œè€Œä¸æ˜¯å¯¹è®°å½•åŠ çš„é”ã€‚
> å¦‚æœåœ¨updateã€deleteæ“ä½œçš„æ—¶å€™ï¼Œç´¢å¼•å¤±æ•ˆæˆ–è€…æ²¡æœ‰å‘½ä¸­ï¼Œé‚£ä¹ˆå°±ä¼šå‡çº§ä¸ºè¡¨é”ã€‚
> ```

å¯¹äºè¡Œçº§é”ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š

**1ã€è¡Œé”ï¼ˆrecord Lockï¼‰ï¼šé”å®šå•ä¸ªè¡Œè®°å½•çš„é”ï¼Œé˜²æ­¢å…¶ä»–äº‹ç‰©å¯¹æ­¤è¿›è¡Œupdateå’Œdeleteæ“ä½œã€‚åœ¨RCã€RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒã€‚**

![image-20240301211241727](./img/40.png)

**2ã€é—´éš™é”ï¼ˆgap Lockï¼‰ï¼šé”å®šç´¢å¼•è®°å½•é—´éš”(ä¸å«è¯¥è®°å½•)ï¼Œç¡®ä¿ç´¢å¼•è®°å½•é—´éš”ä¸å˜ï¼Œé˜²æ­¢å…¶ä»–äº‹ç‰©åœ¨è¿™ä¸ªé—´éš™è¿›è¡Œinsertï¼Œäº§ç”Ÿå¹»è¯»ã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹éƒ½æ”¯æŒã€‚**

![image-20240301211305587](./img/41.png)

**3ã€ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰ï¼šè¡Œé”å’Œé—´éš™é”ç»„åˆï¼ŒåŒæ—¶é”ä½æ•°æ®ï¼Œå¹¶é”ä½æ•°æ®å‰é¢çš„é—´éš™Gapã€‚åœ¨RRéš”ç¦»çº§åˆ«ä¸‹æ”¯æŒã€‚**

![image-20240301211336427](./img/42.png)





###### è¡Œé”ï¼ˆrecord Lockï¼‰

1ã€å…±äº«é”ï¼ˆSï¼‰ï¼šå…è®¸ä¸€ä¸ªäº‹åŠ¡å»è¯»ä¸€è¡Œï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„æ’ä»–é”ã€‚

2ã€æ’ä»–é”ï¼ˆXï¼‰ï¼šå…è®¸è·å–æ’ä»–é”çš„äº‹åŠ¡æ›´æ–°æ•°æ®ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡è·å¾—ç›¸åŒæ•°æ®é›†çš„å…±äº«é”å’Œæ’ä»–é”ã€‚

![image-20240301211434703](./img/43.png)

![image-20240301211524270](./img/44.png)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨**REPEATABLE READ**äº‹åŠ¡éš”ç¦»çº§åˆ«è¿è¡Œï¼ŒInnoDBä½¿ç”¨next-key é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚

1ã€é’ˆå¯¹å”¯ä¸€ç´¢å¼•è¿›è¡Œæ£€ç´¢æ—¶ï¼Œå¯¹å·²å­˜åœ¨çš„è®°å½•è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå°†è‡ªåŠ¨ä¼˜åŒ–ä¸ºè¡Œé”

2ã€InnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹ç´¢å¼•åŠ çš„ï¼Œä¸é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œé‚£ä¹ˆInnoDBå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œæ­¤æ—¶ **å°±ä¼šå‡çº§ä¸ºè¡¨é”**ã€‚

**å‡çº§ä¸ºè¡¨é”æ¼”ç¤º**

```mysql
-- console 1 nameæ— ç´¢å¼•ï¼Œå¼€å¯äº‹åŠ¡ï¼Œæ›´æ–°age æ ¹æ®nameæ¥æ›´æ–°
begin;
update table_user set  age  =109 where  name = 'JackOX';

-- console 2 å¼€å¯äº‹åŠ¡ï¼Œæ›´æ–°idæ¥æ›´æ–°,ä½†æ˜¯é˜»å¡ä½äº†ï¼Œè¡Œé”å·²ç»å‡çº§ä¸ºè¡¨é”---console1çš„nameæ²¡æœ‰ç´¢å¼•
begin ;
update table_user set  age  =109 where  id  = 1;
```



###### **é—´éš™é”/ä¸´é”®é”**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBåœ¨REPEATABLE READäº‹åŠ¡éš”ç¦»çº§åˆ«è¿è¡Œï¼ŒInnoDBä½¿ç”¨next-keyï¼ˆä¸´ç•Œé”ï¼‰é”è¿›è¡Œæœç´¢å’Œç´¢å¼•æ‰«æï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚

1ã€ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰ï¼Œç»™ä¸å­˜åœ¨çš„è®°å½•åŠ é”æ—¶ï¼Œä¼˜åŒ–ä¸ºé—´éš™é”ã€‚

2ã€ç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼ˆæ™®é€šç´¢å¼•ï¼‰ï¼Œå‘å³éå†æ—¶æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚æ—¶ï¼Œnext-key locké€€åŒ–ä¸ºé—´éš™é”ã€‚

3ã€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰--ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚



**æ³¨æ„âš ï¸ï¼š**

***é—´éš™é”å”¯ä¸€ç›®çš„æ˜¯é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥é—´éš™ã€‚é—´éš™é”å¯ä»¥å…±å­˜ï¼Œä¸€ä¸ªäº‹åŠ¡é‡‡ç”¨çš„é—´éš™é”ä¸ä¼šé˜»æ­¢å¦ä¸€ä¸ªäº‹åŠ¡åœ¨åŒä¸€é—´éš™ä¸Šé‡‡ç”¨é—´éš™é”ã€‚***

**æƒ…å†µ1æ¼”ç¤ºï¼š**

```mysql

-- console 1 ï¼Œå¼€å¯äº‹åŠ¡ï¼Œæ›´æ–°name æ ¹æ®idæ¥æ›´æ–° è¿™ä¸ªidçš„å‰ä¸€ä¸ªidä¸º3 åä¸€ä¸ªidä¸º10--- æ‰€ä»¥æŠŠ10é”ä½äº†
begin;
update table_user set name ='ä¸æ˜¯' where id = 5;

-- console 2 å¼€å¯äº‹åŠ¡ï¼Œåœ¨é—´éš”ä¸­æ–°å¢æ•°æ®,ä½†æ˜¯é˜»å¡ä½äº†
begin ;
INSERT INTO table_user (id, name, age, status, gender, test_lock) VALUES (9, 'JackOX', 109, '1', '1', null);

```

**åªé”ä½é—´éš”ï¼Œä¸é”ä½è‡ªå·±**





**æƒ…å†µ2 æ¼”ç¤ºï¼š**

æ™®é€šç´¢å¼•å¯èƒ½é‡å¤ï¼Œæ‰€ä»¥**å‘å³éå†åˆ°ä¸æ»¡è¶³æŸ¥è¯¢éœ€æ±‚çš„æ—¶å€™ï¼Œä¹Ÿå‘å·¦éå†æŸ¥è¯¢**ã€‚

***ä¸´é”®é”åŒ…å«è‡ªå·±å’Œä¹‹å‰çš„é—´éš™***

 ```mysql
 -- console1  æ ¹æ®ageè¿™ä¸ªæ™®é€šç´¢å¼•æŸ¥è¯¢ï¼Œ
 begin;
 select * from table_user where age ='122' lock in share mode ;
 -- æŸ¥çœ‹é”çš„çŠ¶æ€
 select OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_DATA from performance_schema.data_locks;
 ```

**å‘ç°é”ä½äº† 122 å³è¾¹æœ€åä¸€ä¸ª ä¸»é”®idä¸º9çš„ ageä¸º169çš„è¿™è¡Œæ•°æ®**



 

**æƒ…å†µ3 æ¼”ç¤ºï¼š**

æ™®é€šç´¢å¼•å¯èƒ½é‡å¤

***ä¸´é”®é”åŒ…å«è‡ªå·±å’Œä¹‹å‰çš„é—´éš™***

 ```mysql
-- console1  æŸ¥è¯¢å”¯ä¸€ç´¢å¼•id å¤§äºä¸€ä¸ªèŒƒå›´
begin;
select * from table_user where id>=9 lock in share mode ;
-- æŸ¥çœ‹é”çš„çŠ¶æ€
select OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_DATA from performance_schema.data_locks;
 ```

**é”ä½å³è¾¹çš„ä¸‰ä¸ªå’Œè‡ªå·±ï¼ˆä¸´é”®é”ï¼‰**





### 6ã€InnoDBå¼•æ“ TODO



### 7ã€Mysqlç®¡ç†

##### ç³»ç»Ÿæ•°æ®åº“

MYSQLæ•°æ®åº“å®‰è£…å®Œæˆåï¼Œè‡ªå¸¦äº†å››ä¸ªæ•°æ®åº“ï¼Œå…·ä½“ä½œç”¨å¦‚ä¸‹ï¼š

| æ•°æ®åº“             | å«ä¹‰                                                         |
| ------------------ | ------------------------------------------------------------ |
| mysql              | å­˜å‚¨MYSQLæœåŠ¡å™¨æ­£å¸¸è¿è¡Œæ‰€éœ€è¦çš„å„ç§ä¿¡æ¯ï¼ˆè¯†è¶£ã€ä¸»ä»ã€ç”¨æˆ·ã€æƒé™ç­‰ç­‰ï¼‰ |
| information_schema | æä¾›äº†è®¿é—®æ•°æ®åº“å…ƒæ•°æ®çš„å„ç§è¡¨å’Œè§†å›¾ï¼ŒåŒ…å«æ•°æ®åº“ã€è¡¨ã€å­—æ®µç±»å‹åŠè®¿é—®æƒé™ |
| performance_schema | ä¸ºMYSQLæœåŠ¡å™¨è¿è¡Œæ—¶çŠ¶æ€æä¾›äº†ä¸€ä¸ªåº•å±‚ç›‘æ§åŠŸèƒ½ï¼Œä¸»è¦ç”¨äºæ”¶é›†æ•°æ®åº“æœåŠ¡å™¨æ€§èƒ½å‚æ•° |
| sys                | åŒ…å«äº†ä¸€ç³»åˆ—æ–¹ä¾¿DBAå’Œå¼€å‘äººå‘˜åˆ©ç”¨performance_schemaæ€§èƒ½æ•°æ®åº“è¿›è¡Œæ€§èƒ½è°ƒä¼˜å’Œè¯Šæ–­çš„è§†å›¾ |



##### å¸¸ç”¨å·¥å…·

###### mysql

mysqlçš„å®¢æˆ·ç«¯å·¥å…·å‘½ä»¤

```mysql
è¯­æ³•ï¼š
	mysql [option] [database]
é€‰é¡¹ï¼š
	-u,--user=name          #æŒ‡å®šç”¨æˆ·å
	-p,--password[=name]		#æŒ‡å®šå¯†ç 
	-h,--host=name					#æŒ‡å®šæœåŠ¡å™¨IPæˆ–åŸŸå
	-P,--port=port					#æŒ‡å®šè¿æ¥ç«¯å£
	-e,--execute=name 			#æ‰§è¡ŒSQLè¯­å¥å¹¶é€€å‡º
```

-eé€‰é¡¹å¯ä»¥åœ¨Mysqlå®¢æˆ·ç«¯æ‰§è¡ŒSQLè¯­å¥ï¼Œè€Œä¸ç”¨è¿æ¥åˆ°MYSQLæ•°æ®åº“åœ¨æ‰§è¡Œï¼Œå¯¹äºä¸€äº›æ‰¹å¤„ç†è„šæœ¬ï¼Œè¿™ç§æ–¹å¼å°¤å…¶æ–¹ä¾¿ã€‚

example:

```mysql
mysql -uroot -p123456 db01 -e "select * from user";
```



###### mysqladmin

æ˜¯ä¸€ä¸ªæ‰§è¡Œç®¡ç†æ“ä½œçš„å®¢æˆ·ç«¯ç¨‹åºã€‚å¯ä»¥ç”¨å®ƒæ¥æ£€æŸ¥æœåŠ¡å™¨çš„é…ç½®å’Œå½“å‰çŠ¶æ€ã€åˆ›å»ºå¹¶åˆ é™¤æ•°æ®åº“ç­‰ã€‚

```mysql
mysqladmin --help

mysqladmin -uroot -p12345678 version;
```



###### mysqlbinlog

ç”±äºæœåŠ¡å™¨ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä»¥äºŒè¿›åˆ¶æ ¼å¼ä¿å­˜ï¼Œæ‰€ä»¥å¦‚æœè¦æ£€æŸ¥è¿™äº›æ–‡æœ¬çš„æ–‡æœ¬æ ¼å¼ï¼Œå°±ä¼šä½¿ç”¨åˆ°mysqlbinlogæ—¥å¿—ç®¡ç†å·¥å…·ã€‚

```mysql
è¯­æ³•ï¼š
mysqlbinlog [option] log-files log-files2....
optionï¼š
-d,--database=name													#æŒ‡å®šæ•°æ®åº“åç§°ï¼Œåªåˆ—å‡ºæŒ‡å®šçš„æ•°æ®åº“ç›¸å…³æ“ä½œ		
-o,--offset=#																#å¿½ç•¥åˆ°æ—¥å¿—ä¸­çš„å‰nè¡Œå‘½ä»¤
-r,--result-file=name												#å°†è¾“å‡ºçš„æ–‡æœ¬æ ¼å¼æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶
-s,--short-form															#æ˜¾ç¤ºç®€å•æ ¼å¼ï¼Œçœç•¥åˆ°ä¸€äº›ä¿¡æ¯
--start-datatime=date1 --stop-datetime=date2   #æŒ‡å®šæ—¥æœŸé—´éš”å†…çš„æ‰€æœ‰æ—¥å¿—
--start-position=pos1  --stop-position=pos2			#æŒ‡å®šä½ç½®é—´éš”å†…çš„æ‰€æœ‰æ—¥å¿—
```



###### mysqlshow

mysqlshow å®¢æˆ·ç«¯å¯¹è±¡æŸ¥æ‰¾å·¥å…·ï¼Œç”¨æ¥å¾ˆå¿«æŸ¥æ‰¾å­˜åœ¨å“ªäº›æ•°æ®åº“ã€æ•°æ®åº“ä¸­çš„è¡¨ã€è¡¨ä¸­çš„åˆ—æˆ–è€…ç´¢å¼•ã€‚

```mysql
è¯­æ³•ï¼š
mysqlshow [option] [db_name [table_name [col_name]]]

optionï¼š
	--count æ˜¾ç¤ºæ•°æ®åº“åŠè¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ•°æ®åº“ã€è¡¨å‡å¯ä»¥ä¸æŒ‡å®šï¼‰
	--i     æ˜¾ç¤ºæŒ‡å®šæ•°æ®åº“æ´»ç€æŒ‡å®šè¡¨çš„çŠ¶æ€ä¿¡æ¯

example:
	#æŸ¥è¯¢æ¯ä¸ªæ•°æ®åº“çš„è¡¨çš„æ•°é‡åŠè¡¨ä¸­çš„è®°å½•æ•°é‡
	mysqlshow -uroot -p1234 --count
	
	#æŸ¥è¯¢teståº“ä¸­çš„æ¯ä¸ªè¡¨ä¸­çš„å­—æ®µæ•°åŠè¡Œæ•°
		mysqlshow -uroot -p1234 test --count
	
	#æŸ¥è¯¢teståº“ä¸­bookè¡¨çš„è¯¦ç»†æƒ…å†µ
	mysqlshow -uroot -p1234 test book --count
```



###### mysqldump

mysqldump å®¢æˆ·ç«¯å·¥å…·ç”¨æ¥å¤‡ä»½æ•°æ®åº“æˆ–è€…åœ¨ä¸åŒçš„æ•°æ®åº“ä¹‹é—´è¿›è¡Œæ•°æ®è¿ç§»ã€‚å¤‡ä»½å†…å®¹åŒ…å«åˆ›å»ºè¡¨ã€ä»¥åŠæ’å…¥è¡¨çš„sqlè¯­å¥ã€‚

![image-20240301212046804](./img/45.png)



###### mysqlimport/source

mysqlimportæ˜¯å®¢æˆ·ç«¯æ•°æ®å¯¼å…¥å·¥å…·ï¼Œç”¨æ¥å¯¼å…¥mysqldump åŠ  -T å‚æ•°ååˆ°å¤„çš„æ–‡æœ¬æ–‡ä»¶

```sql
è¯­æ³• :
    mysqlimport [options]  db_name  textfile1  [textfile2...]
ç¤ºä¾‹ :
    mysqlimport -uroot -p2143 test /tmp/city.txt
```



å¦‚æœéœ€è¦å¯¼å…¥sqlæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨mysqlä¸­sourceæŒ‡ä»¤ï¼š

```sql
è¯­æ³• :
    source /root/xxxxx.sql
```



## ä¸‰ã€è¿ç»´ç¯‡ç« 



## MySQLä¸‰å¤§æ—¥å¿—è¯¦è§£

MySQL ä¸­çš„ `binlog`ã€`redo log` å’Œ `undo log`ã€‚

### **Binlog (äºŒè¿›åˆ¶æ—¥å¿—)**

å½“è°ˆåˆ° MySQL ä¸­çš„ **äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰** æ—¶ï¼Œå®ƒæ˜¯æ•°æ®åº“çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºè®°å½•å¯¹æ•°æ®çš„å˜æ›´æ“ä½œã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹ `binlog` çš„ä½œç”¨å’ŒåŸç†ï¼š

#### 1. **ä»€ä¹ˆæ˜¯ Binlogï¼Ÿ**

- `binlog` æ˜¯ MySQL çš„é€»è¾‘æ—¥å¿—ï¼Œç”±æœåŠ¡å™¨å±‚è®°å½•ã€‚
- å®ƒè®°å½•äº†å¯¹æ•°æ®åº“çš„æ‰€æœ‰å˜æ›´æ“ä½œï¼ŒåŒ…æ‹¬æ•°æ®ã€è¡¨ç»“æ„ã€ç´¢å¼•ç­‰çš„ä¿®æ”¹ã€‚
- ä¸»è¦ç”¨äºæ•°æ®å½’æ¡£ã€éªŒè¯ã€æ¢å¤å’Œæ•°æ®åŒæ­¥ï¼ˆä¸»ä»å¤åˆ¶ï¼‰ã€‚

#### 2. **åŠŸèƒ½å’Œç”¨é€”**

- æ•°æ®åŒæ­¥å’Œå¤åˆ¶
  - `binlog` æä¾›äº†å¯é ä¸”é«˜æ•ˆçš„æ•°æ®åŒæ­¥æ–¹å¼ï¼Œç”¨äºåœ¨ MySQL æœåŠ¡å™¨ä¹‹é—´å¤åˆ¶æ•°æ®ã€‚
  - ä¸»ä»å¤åˆ¶ä¸­ï¼Œä¸»æœåŠ¡å™¨å°†å˜æ›´è®°å½•åˆ° `binlog`ï¼Œä»æœåŠ¡å™¨è¯»å–å¹¶åº”ç”¨è¿™äº›å˜æ›´ã€‚
- æ•°æ®æ¢å¤
  - `binlog` åœ¨ç‚¹æ—¶é—´æ¢å¤ï¼ˆpoint-in-time recoveryï¼‰ä¸­èµ·åˆ°å…³é”®ä½œç”¨ã€‚
  - å¦‚æœæ•°æ®åº“å‘ç”Ÿæ•…éšœï¼Œå¯ä»¥ä½¿ç”¨ `binlog` æ¥æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„æ•°æ®çŠ¶æ€ã€‚
- å®¡è®¡å’ŒéªŒè¯
  - `binlog` å¯ç”¨äºå®¡è®¡å’ŒéªŒè¯æ•°æ®åº“æ“ä½œã€‚
  - å¯ä»¥æ£€æŸ¥ç‰¹å®šæ—¶é—´æ®µå†…çš„å˜æ›´ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚

#### 3. **æ ¼å¼å’Œé…ç½®**

- binlogæœ‰ä¸åŒçš„è®°å½•æ ¼å¼ï¼š
  - **åŸºäºè¯­å¥çš„ï¼ˆSTATEMENTï¼‰**ï¼šè®°å½• SQL è¯­å¥ã€‚
  - **åŸºäºè¡Œçš„ï¼ˆROWï¼‰**ï¼šè®°å½•æ¯è¡Œå˜æ›´ã€‚
  - **æ··åˆæ ¼å¼ï¼ˆMIXEDï¼‰**ï¼šç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ã€‚
- é…ç½® binlog
  - é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQL å¯ç”¨äº† `binlog`ã€‚
  - å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚ `my.cnf` æˆ– `my.ini`ï¼‰å¯ç”¨æˆ–ç¦ç”¨ `binlog`ã€‚
  - è®¾ç½® `log-bin=mysql-bin` æ¥å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—ã€‚



### **Redo Log (é‡åšæ—¥å¿—)**

 **é‡åšæ—¥å¿—ï¼ˆredo logï¼‰** ï¼Œå®ƒæ˜¯ InnoDB å­˜å‚¨å¼•æ“çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œç”¨äºå®ç°äº‹åŠ¡çš„ ACID ç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯æŒä¹…æ€§ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹ `redo log` çš„ä½œç”¨å’ŒåŸç†ï¼š

```
åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›ä¿®æ”¹
```

#### 1. **ä»€ä¹ˆæ˜¯ Redo Logï¼Ÿ**

- `redo log` æ˜¯ InnoDB å­˜å‚¨å¼•æ“çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºè®°å½•å¯¹æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹æ“ä½œã€‚
- å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯æ”¯æŒäº‹åŠ¡çš„ ACID ç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯**æŒä¹…æ€§**ã€‚
- `redo log` è®°å½•äº†å·²æäº¤äº‹åŠ¡å¯¹æ•°æ®çš„å˜æ›´ï¼Œä»¥ä¾¿åœ¨å´©æºƒæ¢å¤æ—¶å¯ä»¥é‡åšè¿™äº›å˜æ›´ã€‚

#### 2. **åŠŸèƒ½å’ŒåŸç†**ï¼š

- æŒä¹…æ€§çš„ä¿è¯
  - åœ¨äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œ`redo log` ä¸­çš„æ—¥å¿—è®°å½•ä¼šè¢«å†™å…¥ç£ç›˜ã€‚
  - å³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœï¼ˆå¦‚å®•æœºï¼‰ï¼Œå·²æäº¤çš„æ•°æ®å˜æ›´ä¹Ÿå¯ä»¥ä» `redo log` ä¸­é‡åšï¼Œä»è€Œä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚
  - `redo log` çš„å†™å…¥æ˜¯åŸå­æ€§çš„ï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- å´©æºƒæ¢å¤è¿‡ç¨‹
  - å½“æ•°æ®åº“é‡æ–°å¯åŠ¨æ—¶ï¼ŒInnoDB å¼•æ“ä¼šæ£€æŸ¥ `redo log`ï¼Œå¹¶å°†å…¶ä¸­æœªåˆ·æ–°åˆ°ç£ç›˜çš„æ—¥å¿—è®°å½•åº”ç”¨åˆ°æ•°æ®é¡µä¸Šã€‚
  - è¿™æ ·ï¼Œå³ä½¿åœ¨ç³»ç»Ÿå´©æºƒåï¼Œå·²æäº¤çš„æ•°æ®å˜æ›´ä¹Ÿå¯ä»¥è¢«æ­£ç¡®åœ°æ¢å¤ã€‚
- å¾ªç¯å†™å…¥çš„æ—¥å¿—
  - `redo log` æ˜¯ä¸€ä¸ªå¾ªç¯å†™å…¥çš„æ—¥å¿—ï¼Œæ–°çš„æ—¥å¿—è®°å½•ä¼šä¸æ–­è¦†ç›–æ—§çš„è®°å½•ã€‚
  - è¿™æ ·å¯ä»¥ä¿æŒè¾ƒå°çš„ç£ç›˜ç©ºé—´å ç”¨ã€‚



###  **Undo Log (å›æ»šæ—¥å¿—)**

å½“è°ˆåˆ° MySQL ä¸­çš„ `undo log` æ—¶ï¼Œå®ƒæ˜¯ InnoDB å­˜å‚¨å¼•æ“çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œç”¨äºå®ç°äº‹åŠ¡çš„éš”ç¦»æ€§å’Œå›æ»šåŠŸèƒ½ã€‚

```
è®°å½•äº†æ¯æ¬¡dmlç­‰sqlçš„ç›¸åsqlçš„log æ¯”å¦‚ä¸€ä¸ªinsertè¯­å¥å°±ä¼šå¯¹åº”ä¸€ä¸ªdeleteè¯­å¥ ä¸€ä¸ªupdateæ“ä½œ å°±ä¼šå¢åŠ ä¸€ä¸ªåupdateæ“ä½œçš„log
```

#### 1. **Undo Log æ˜¯ä»€ä¹ˆï¼Ÿ**

- `undo log` æ˜¯ InnoDB å­˜å‚¨å¼•æ“çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºè®°å½•äº‹åŠ¡å¯¹æ•°æ®çš„é€»è¾‘ä¿®æ”¹æ“ä½œã€‚
- å®ƒä¸»è¦ç”¨äºå®ç°äº‹åŠ¡çš„éš”ç¦»æ€§å’Œå›æ»šåŠŸèƒ½ã€‚
- è®°å½•äº†äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹å‰çš„çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨å›æ»šæˆ–æ’¤é”€æ“ä½œæ—¶æ¢å¤æ•°æ®ã€‚

### 2. **åŠŸèƒ½å’ŒåŸç†**ï¼š

- å›æ»šæ“ä½œ
  - å½“äº‹åŠ¡éœ€è¦å›æ»šï¼ˆä¾‹å¦‚ç”±äºé”™è¯¯æˆ–ç”¨æˆ·å–æ¶ˆï¼‰æ—¶ï¼Œ`undo log` ä¸­çš„è®°å½•ä¼šè¢«ç”¨æ¥å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ã€‚
  - é€šè¿‡é€†å‘åº”ç”¨ `undo log`ï¼Œå¯ä»¥æ’¤é”€äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚
- äº‹åŠ¡éš”ç¦»æ€§
  - `undo log` ç”¨äºå®ç°äº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œç¡®ä¿ä¸€ä¸ªäº‹åŠ¡å¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ã€‚
  - åœ¨è¯»å·²æäº¤å’Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œ`undo log` ç”¨äºæä¾›ä¸€è‡´çš„å¿«ç…§è§†å›¾ã€‚
- MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰
  - `undo log` æ˜¯ MVCC çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚
  - æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰è‡ªå·±çš„ `undo log`ï¼Œç”¨äºè·Ÿè¸ªå…¶ä¿®æ”¹çš„æ•°æ®ç‰ˆæœ¬ã€‚
  - è¯»æ“ä½œä¼šæ ¹æ®äº‹åŠ¡çš„å¯åŠ¨æ—¶é—´å’Œ `undo log` ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯æ¥è·å–ä¸€è‡´çš„æ•°æ®è§†å›¾ã€‚

### 3. **ç»“æ„å’Œå­˜å‚¨**ï¼š

- `undo log` å­˜å‚¨åœ¨è¡¨ç©ºé—´ä¸­ï¼Œé€šå¸¸æ˜¯ç³»ç»Ÿè¡¨ç©ºé—´çš„ä¸€ä¸ªç‰¹å®šé¡µã€‚
- æ¯ä¸ªäº‹åŠ¡çš„ `undo log` è®°å½•éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡ ID å’Œè¡Œ IDã€‚
- `undo log` è®°å½•äº†ä¿®æ”¹å‰çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ—§å€¼ã€äº‹åŠ¡ IDã€è¡Œ ID ç­‰ã€‚



### æ—¥å¿—

#### é”™è¯¯æ—¥å¿—

é”™è¯¯æ—¥å¿—æ˜¯MYSQKä¸­æœ€é‡è¦çš„æ—¥å¿—ä¹‹ä¸€ï¼Œå®ƒè®°å½•äº†å½“mysqldå¯åŠ¨å’Œåœæ­¢æ—¶ï¼Œä»¥åŠæœåŠ¡å™¨åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿä»»ä½•ä¸¥é‡é”™è¯¯æ—¶çš„ç›¸å…³ä¿¡æ¯ã€‚å½“æ•°æ®åº“å‡ºç°ä»»ä½•æ•…éšœå¯¼è‡´æ— æ³•æ­£å¸¸ä½¿ç”¨æ—¶ï¼Œå»ºè®®é¦–å…ˆæŸ¥çœ‹æ­¤æ—¥å¿—ã€‚

æ”¹æ—¥å¿—æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œé»˜è®¤å­˜æ”¾ç›®å½•/var/log/ï¼Œé»˜è®¤çš„æ—¥å¿—æ–‡ä»¶åä¸ºmysqld.logã€‚æŸ¥çœ‹æ—¥å¿—ä½ç½®ï¼š

```mysql
show variables  like '%log_error%';
```



#### äºŒè¿›åˆ¶æ—¥å¿—

äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆBINLOGï¼‰è®°å½•äº†æ‰€æœ‰çš„DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰è¯­å¥å’ŒDMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰è¯­å¥ï¼Œä½†ä¸åŒ…å«æ•°æ®æŸ¥è¯¢ï¼ˆSELECTã€SHOWï¼‰è¯­å¥ã€‚

ä½œç”¨ï¼š

* ç¾éš¾æ—¶çš„æ•°æ®æ¢å¤
* MYSQLçš„ä¸»ä»å¤åˆ¶

åœ¨MYSQL8ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤äºŒè¿›åˆ¶æ—¥å¿—æ˜¯å¼€å¯ç€ï¼Œæ¶‰åŠåˆ°çš„å‚æ•°å¦‚ä¸‹ï¼š

```mysql
show variables like '%log_bin%';
```

| log_bin                         | ON                          |
| ------------------------------- | --------------------------- |
| log_bin_basename                | /var/lib/mysql/binlog       |
| log_bin_index                   | /var/lib/mysql/binlog.index |
| log_bin_trust_function_creators | OFF                         |
| log_bin_use_v1_row_events       | OFF                         |
| sql_log_bin                     | ON                          |

![image-20240312115344973](./img/46.png)

**æ—¥å¿—æ ¼å¼**

MYSQLæœåŠ¡å™¨ä¸­æä¾›äº†å¤šç§æ ¼å¼æ¥è®°å½•äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå…·ä½“æ ¼å¼åŠç‰¹ç‚¹å¦‚ä¸‹ï¼š

- **åŸºäºè¯­å¥çš„ï¼ˆSTATEMENTï¼‰**ï¼šè®°å½• SQL è¯­å¥ã€‚
- **åŸºäºè¡Œçš„ï¼ˆROWï¼‰**ï¼šè®°å½•æ¯è¡Œå˜æ›´ã€‚
- **æ··åˆæ ¼å¼ï¼ˆMIXEDï¼‰**ï¼šç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ã€‚

```mysql
show variables like '%binlog_format%';
```

![image-20240312115454208](./img/47.png)

ç”±äºæ—¥å¿—æ˜¯ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨çš„ï¼Œä¸èƒ½ç›´æ¥è¯»å–ï¼Œéœ€è¦é€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—æŸ¥è¯¢å·¥å…·mysqlbinlogæ¥æŸ¥çœ‹ï¼Œå…·ä½“è¯­æ³•ï¼š

- `mysqlbinlog [options] log_file ...`

- `log_file` æ˜¯ä½ è¦æŸ¥çœ‹çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚

- ä¾‹å¦‚ï¼Œè¦æ˜¾ç¤ºåä¸ºbinlog.000003çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„å†…å®¹ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

  ```
  mysqlbinlog binlog.000003
  ```



**åˆ é™¤binlogæ—¥å¿—**

```
åˆ é™¤æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—ï¼š
ä½¿ç”¨ PURGE BINARY LOGS TO 'log_name'; å‘½ä»¤ï¼Œå…¶ä¸­ log_name æ˜¯ä½ è¦ä¿ç•™çš„æœ€æ–°æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚
ä¾‹å¦‚ï¼Œè¦åˆ é™¤æ‰€æœ‰åœ¨ mysql-bin.0003 ä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
PURGE BINARY LOGS TO 'mysql-bin.0003';

åˆ é™¤æŒ‡å®šæ—¥æœŸä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—ï¼š
ä½¿ç”¨ PURGE BINARY LOGS BEFORE 'yyyy-mm-dd hh:mm:ss'; å‘½ä»¤ï¼Œå…¶ä¸­ yyyy-mm-dd hh:mm:ss æ˜¯ä½ è¦ä¿ç•™çš„æœ€æ–°æ—¥æœŸå’Œæ—¶é—´ã€‚
ä¾‹å¦‚ï¼Œè¦åˆ é™¤æ‰€æœ‰åœ¨ 2015 å¹´ 9 æœˆ 15 æ—¥ä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
PURGE BINARY LOGS BEFORE '2015-09-15 10:00:00';

åˆ é™¤æ—©äºæŒ‡å®šå¤©æ•°çš„æ‰€æœ‰æ—¥å¿—ï¼š
ä½¿ç”¨ PURGE BINARY LOGS BEFORE NOW() - INTERVAL n DAY; å‘½ä»¤ï¼Œå…¶ä¸­ n æ˜¯ä½ è¦ä¿ç•™çš„å¤©æ•°ã€‚
ä¾‹å¦‚ï¼Œè¦åˆ é™¤æ‰€æœ‰æ—©äº 7 å¤©çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
PURGE BINARY LOGS BEFORE NOW() - INTERVAL 7 DAY;
```

ä¹Ÿå¯ä»¥åœ¨mysqlçš„é…ç½®æ–‡ä»¶ä¸­é…ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„è¿‡æœŸæ—¶é—´ï¼Œè®¾ç½®äº†ä¹‹åï¼ŒäºŒè¿›åˆ¶æ—¥å¿—è¿‡æœŸä¼šè‡ªåŠ¨åˆ é™¤ã€‚

```mysql
show variables like '%binlog_expire_logs_seconds%';
```



#### æŸ¥è¯¢æ—¥å¿—

æŸ¥è¯¢æ—¥å¿—ä¸­è®°å½•äº†å®¢æˆ·ç«¯çš„æ‰€æœ‰æ“ä½œè¯­å¥ï¼Œè€ŒäºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«æŸ¥è¯¢æ•°æ®çš„sqlè¯­å¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ—¥å¿—æ˜¯æœªå¼€å¯çš„ã€‚å¦‚æœéœ€è¦å¼€å¯æŸ¥è¯¢æ—¥å¿—ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹é…ç½®ï¼š

```mysql
show variables like '%general%';
```

| Variable\_name     | Value                           |
| :----------------- | :------------------------------ |
| general\_log       | OFF                             |
| general\_log\_file | /var/lib/mysql/8a3f29e96d36.log |

æˆ–è€…ä¿®æ”¹MYSQLçš„é…ç½®æ–‡ä»¶/etc/my.cnfæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```cnf
# å°† general_log è®¾ç½®ä¸º 1 è¡¨ç¤ºå¼€å¯ general log åŠŸèƒ½ã€‚
general_log = 1
# è®¾ç½® general_log_file ä¸ºä½ å¸Œæœ›ä¿å­˜æ—¥å¿—çš„æ–‡ä»¶è·¯å¾„ã€‚
general_log_file = /path/to/your/logfile.log
```

æˆ–è€…ç›´æ¥åœ¨terminalæ‰§è¡Œè„šæœ¬

```
SET GLOBAL general_log = 'ON';
```



#### æ…¢æŸ¥è¯¢æ—¥å¿—

æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡å‚æ•°long_query_timeè®¾ç½®å€¼å¹¶ä¸”æ‰«æè®°å½•æ•°å°äºmin_examined_row_limitçš„æ‰€æœ‰çš„SQLè¯­å¥çš„æ—¥å¿—ï¼Œé»˜è®¤æœªå¼€å¯ã€‚long_query_timeé»˜è®¤ä¸º10sï¼Œæœ€å°ä¸º0ï¼Œç²¾åº¦å¯ä»¥åˆ°å¾®å¦™ã€‚

```mysql
#æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log=1
#æ‰§è¡Œæ—¶é—´å‚æ•°
long_query_time=2
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¼šè®°å½•ç®¡ç†è¯­å¥ï¼Œä¹Ÿä¸ä¼šè®°å½•ä¸é€‚ç”¨ç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾çš„æŸ¥è¯¢ã€‚å¯ä»¥ä½¿ç”¨log_slow_admin_statementså’Œæ›´æ”¹æ­¤è¡Œä¸ºlog_query_not_using_indexes,å¦‚ä¸‹æ‰€è¿°ï¼š

```sh
##é€šè¿‡é…ç½®æ–‡ä»¶å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š
##ç¼–è¾‘ MySQL é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ my.cnf æˆ– my.iniï¼‰ã€‚åœ¨ [mysqld] éƒ¨åˆ†æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

# å°† slow_query_log è®¾ç½®ä¸º 1 è¡¨ç¤ºå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ã€‚
slow_query_log = 1
# è®¾ç½® slow_query_log_file ä¸ºä½ å¸Œæœ›ä¿å­˜æ—¥å¿—çš„æ–‡ä»¶è·¯å¾„ã€‚
slow_query_log_file = /path/to/your/logfile.log
```

æˆ–è€…ç›´æ¥åœ¨terminalæ‰§è¡Œè„šæœ¬ï¼š

```sql
SET GLOBAL slow_query_log = 'ON';
```

```mysql
#è®°å½•æ‰§è¡Œè¾ƒæ…¢çš„ç®¡ç†è¯­å¥
log_slow_admin_statements=1
#è®°å½•æ‰§è¡Œè¾ƒæ…¢çš„æœªä½¿ç”¨ç´¢å¼•çš„è¯­å¥
log_query_not_using_indexes=1
```



### ä¸»ä»å¤åˆ¶

#### æ¦‚è¿°

ä¸»ä»å¤åˆ¶æ˜¯æŒ‡å°†ä¸»æ•°æ®åº“çš„DDLå’ŒDMLæ“ä½œé€šè¿‡äºŒè¿›åˆ¶æ—¥å¿—ä¼ è¾“åˆ°ä»åº“æœåŠ¡å™¨ä¸­ï¼Œç„¶ååœ¨ä»åº“ä¸Šå¯¹è¿™äº›æ—¥å¿—é‡æ–°æ‰§è¡Œï¼ˆä¹Ÿå«é‡åšï¼‰ï¼Œä»è€Œä½¿å¾—ä»åº“å’Œä¸»åº“çš„æ•°æ®ä¿æŒåŒæ­¥ã€‚

MYSQLæ”¯æŒä¸€å°ä¸»åº“åŒæ—¶å‘å¤šå°ä»åº“è¿›è¡Œå¤åˆ¶ï¼Œä»åº“åŒæ—¶ä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»åº“ï¼Œå®ç°é“¾çŠ¶å¤åˆ¶ã€‚

**ä¼˜ç‚¹ï¼š**

1. ä¸»åº“å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡æ¢åˆ°ä»åº“æä¾›æœåŠ¡ã€‚
2. å®ç°è¯»å†™åˆ†ç¦»ï¼Œé™ä½ä¸»åº“çš„è®¿é—®å‹åŠ›ã€‚
3. å¯ä»¥åœ¨ä»åº“ä¸­æ‰§è¡Œå¤‡ä»½ï¼Œä»¥é¿å…å¤‡ä»½æœŸé—´å½±å“ä¸»åº“æœåŠ¡ã€‚



#### åŸç†



**åŸç†æ­¥éª¤ï¼š**

1. Masterä¸»åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œä¼šæŠŠæ•°æ®å˜æ›´è®°å½•åœ¨äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶Binlogä¸­ã€‚
2. ä»åº“è¯»å–ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶Binlogï¼Œå†™å…¥åˆ°ä»åº“çš„ä¸­ç»§æ—¥å¿—Relay Logã€‚
3. slaveé‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åæ˜ å®ƒè‡ªå·±çš„æ•°æ®ã€‚



#### æ­å»º

**æœåŠ¡å™¨å‡†å¤‡**



 

##### **ä¸»åº“é…ç½®**

ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/my.cnf

```mysql
#mysqlæœåŠ¡IDï¼Œä¿è¯æ•´ä¸ªé›†ç¾¤ç¯å¢ƒä¸­å”¯ä¸€ï¼Œå–å€¼èŒƒå›´ï¼š1-2^32 -1. é»˜è®¤ä¸º1
server-id = 1
#æ˜¯å¦åªè¯»ï¼Œ1ä»£è¡¨åªè¯»ï¼Œ0ä»£è¡¨è¯»å†™
read-only=0
#å¿½ç•¥çš„æ•°æ®ï¼ŒæŒ‡ä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“
#binlog-ignore-db=mysql
#æŒ‡å®šåŒæ­¥çš„æ•°æ®åº“
#binlog-do-db=db01

```

é‡å¯MYSQLæœåŠ¡å™¨

```mysql
systemctl restart mysqld
```

ç™»é™†mysqlï¼Œåˆ›å»ºè¿œç¨‹è¿æ¥çš„è´¦å·ï¼Œå¹¶æˆäºˆä¸»ä»å¤åˆ¶çš„æƒé™

```mysql
#åˆ›å»ºtestç”¨æˆ·ï¼Œå¹¶è®¾ç½®å¯†ç ï¼Œè¯¥ç”¨æˆ·å¯åœ¨ä»»æ„ä¸»æœºè¿æ¥è¯¥MYSQLæœåŠ¡
CREATE USER 'test'@'%' IDENTIFIED WITH mysql_sql_native_password BY 'Jack@12345678';
# ä¸ºtestç”¨æˆ·åˆ†é…ä¸»ä»å¤åˆ¶æƒé™
GRANT REPLICATION SLAVE ON *.* TO 'test'@'%'
```

é€šè¿‡æŒ‡ä»¤ï¼ŒæŸ¥çœ‹äºŒè¿›åˆ¶æ—¥å¿—åæ ‡

```mysql
show master status;
```

![image-20240312120800054](./img/48.png)

```mysql
#file:ä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹æ¨é€æ—¥å¿—æ–‡ä»¶
#position:ä»å“ªä¸ªä½ç½®å¼€å§‹æ¨é€æ—¥å¿—
#binlog_ignore_db:æŒ‡å®šä¸éœ€è¦åŒæ­¥çš„æ•°æ®åº“
```



##### ä»åº“é…ç½®

ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/my.cnf

```mysql
#mysqlæœåŠ¡IDï¼Œä¿è¯æ•´ä¸ªé›†ç¾¤ç¯å¢ƒä¸­å”¯ä¸€ï¼Œå–å€¼èŒƒå›´ï¼š1-2^32 -1. é»˜è®¤ä¸º1
server-id = 2
#æ˜¯å¦åªè¯»ï¼Œ1ä»£è¡¨åªè¯»ï¼Œ0ä»£è¡¨è¯»å†™
read-only=1

#è¶…çº§ç®¡ç†å‘˜ä¹Ÿæ˜¯åªè¯» ä¸è®¾ç½® å°±ä¼šæœ‰è¯»å†™åŠŸèƒ½
#superâ€”read-only = 1
```

é‡å¯MYSQLæœåŠ¡å™¨

```mysql
systemctl restart mysqld
```

ç™»é™†MYSQL è®¾ç½®ä¸»åº“é…ç½®

8.0.23ä¹‹åçš„ç‰ˆæœ¬

```mysql
CHANGE REPLICATION SOURCE TO SOURCE_HOST='127.0.0.1',SOURCE_USER='test',SOURCE_PASSWORD='Jack@12345678',SOURCE_LOG_FILE='binlog.000029',SOURCE_LOG_POS='156';
```

8.0.23ä¹‹å‰çš„ç‰ˆæœ¬

```mysql
CHANGE MASTER SOURCE TO MASTER_HOST='127.0.0.1',MASTER_USER='test',MASTER_PASSWORD='Jack@12345678',MASTER_LOG_FILE='binlog.000029',MASTER_LOG_POS='156';
```





**å¼€å¯åŒæ­¥æ“ä½œ**

```mysql
# 8.0.22ä¹‹å
start replica;
# 8.0.22ä¹‹å‰
start slave;
```

**æŸ¥çœ‹ä¸»ä»åŒæ­¥çŠ¶æ€**

```mysql
# 8.0.22ä¹‹å
show replica status;
# 8.0.22ä¹‹å‰
show slave status;
```

**ä¸¤ä¸ªå…³é”®å­—æ®µæ˜¯YESåŠè¡¨ç¤ºæˆåŠŸ**



###  

















