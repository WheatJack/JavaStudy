 ![image-20240112211249969](./img/1.png)



# JVMåŸºç¡€ç¯‡

## 1.åˆå§‹JVM

### ä»€ä¹ˆæ˜¯JVM

JVMæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨è®¡ç®—æœºä¸Šçš„ç¨‹åºï¼Œä»–çš„èŒè´£æ˜¯è¿è¡ŒJavaå­—èŠ‚ç æ–‡ä»¶ã€‚

![image-20240113220844018](./img/2.png)



### JVMçš„åŠŸèƒ½

**1ã€è§£é‡Šå’Œè¿è¡Œ**

- å¯¹å­—èŠ‚ç æ–‡ä»¶ä¸­çš„æŒ‡ä»¤ï¼Œå®æ—¶çš„è§£é‡Šç§°æœºå™¨ç ï¼Œè®©è®¡ç®—æœºæ‰§è¡Œ

**2ã€å†…å­˜ç®¡ç†**

- è‡ªåŠ¨ä¸ºå¯¹è±¡ã€æ–¹æ³•ç­‰åˆ†é…å†…å­˜
- è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå›æ”¶ä¸åœ¨ä½¿ç”¨çš„å¯¹è±¡

**3ã€å³æ—¶ç¼–è¯‘**

å¯¹çƒ­ç‚¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œæå‡æ‰§è¡Œæ•ˆç‡



### å³æ—¶ç¼–è¯‘

Javaè¯­è¨€å¦‚æœä¸åšä»»ä½•ä¼˜åŒ–ï¼Œæ€§èƒ½ä¸å¦‚C++ç­‰è¯­è¨€ã€‚

> **å› ä¸ºæ˜¯å®æ—¶è§£é‡Šä¸ºæœºå™¨ç **

![image-20240113221332594](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221332594.png)

è€Œå…¶ä»–çš„C++è¯­è¨€æ˜¯æ‰“åŒ…ç¼–è¯‘ç§°å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæœºå™¨ç ï¼‰

> **ç›´æ¥è¿è¡Œæœºå™¨ç **

![image-20240113221345653](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221345653.png)

**Javaéœ€è¦å®æ—¶è§£é‡Šçš„åŸå› ï¼Ÿ**

> ä¸»è¦æ˜¯é—®äº†è·¨å¹³å°ç‰¹æ€§

![image-20240113221444191](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221444191.png)

![image-20240112212203984](./img/7.png)

JVMæä¾›äº†**å³æ—¶ç¼–è¯‘**ï¼ˆJust-In-Time ç®€ç§°JITï¼‰è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°æ¥è¿‘C++è¯­è¨€çš„è¿è¡Œæ€§èƒ½ï¼Œç”šè‡³åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹å®ç°äº†è¶…è¶Šã€‚



### å¸¸è§çš„JVM

![image-20240112212234283](./img/9.png)



å¸¸è§çš„JVM-HotSpotçš„å‘å±•å†ç¨‹

![image-20240112212829319](./img/10.png)



## 2.å­—èŠ‚ç æ–‡ä»¶è¯¦è§£

### 1.Javaè™šæ‹Ÿæœºçš„ç»„æˆ

ä¸»è¦åŒ…æ‹¬ï¼š

- ç±»åŠ è½½å™¨
- è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆJVMç®¡ç†çš„å†…å­˜ï¼‰
- æ‰§è¡Œå¼•æ“ï¼ˆå³æ—¶ç¼–è¯‘å™¨ã€è§£é‡Šå™¨ã€åƒåœ¾å›æ”¶å™¨ç­‰ï¼‰

![image-20240112213321990](./img/13.png)



### 2.å­—èŠ‚ç æ–‡ä»¶çš„ç»„æˆ

ä¸»è¦åŒ…æ‹¬ï¼š

- åŸºæœ¬ä¿¡æ¯
- å¸¸é‡æ± 
- æ¥å£
- æ–¹æ³•
- å±æ€§

![image-20240112214640168](./img/15.png)

**æŸ¥çœ‹å­—èŠ‚ç å¸¸ç”¨çš„å·¥å…·**

- Javapå‘½ä»¤

- Jclasslibè½¯ä»¶æˆ–è€…æ’ä»¶

  > ![image-20240112215217620](./img/11.png)
  >
  > githubåœ°å€ï¼šhttps://github.com/ingokegel/jclasslib

- Arthus

  > å®˜ç½‘åœ°å€ï¼šhttps://arthas.aliyun.com/doc/





#### 1ï¼‰åŸºæœ¬ä¿¡æ¯

**Magicé­”æ•°**

- æ–‡ä»¶æ˜¯æ— æ³•é€šè¿‡æ–‡ä»¶æ‰©å±•åæ¥ç¡®å®šæ–‡ä»¶ç±»å‹çš„ï¼Œæ–‡ä»¶æ‰©å±•åå¯ä»¥éšæ„ä¿®æ”¹ï¼Œä¸å½±å“æ–‡ä»¶çš„å†…å®¹
- è½¯ä»¶ä½¿ç”¨æ–‡ä»¶çš„å¤´å‡ ä¸ªå­—èŠ‚ï¼ˆæ–‡ä»¶å¤´ï¼‰å»æ£€éªŒæ–‡ä»¶çš„ç±»å‹ï¼Œå¦‚æœè½¯ä»¶ä¸æ”¯æŒè¯¥ç§ç±»å‹å°±ä¼šå‡ºé”™ã€‚
- Javaå­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å¤´ç§°ä¸ºMagicé­”æ•°

![image-20240113223527525](./img/12.png)

å¸¸è§çš„æ–‡ä»¶å¤´

![image-20240113223754367](./img/24.png)



**ä¸»å‰¯ç‰ˆæœ¬å·**

- ä¸»å‰¯ç‰ˆæœ¬å·æŒ‡çš„æ˜¯ç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶çš„JDKç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬å·æ˜¯ç”¨æ¥è¯†åˆ«å¤§ç‰ˆæœ¬å·ï¼ŒJDK1.0-1.1ä½¿ç”¨äº†45.0-45.3ï¼ŒJDK1.2æ˜¯46ä¹‹åæ¯å‡çº§ä¸€ä¸ªå¤§ç‰ˆæœ¬å·å°±åŠ 1ï¼Œå‰¯ç‰ˆæœ¬å·æ˜¯å½“ä¸»ç‰ˆæœ¬å·ç›¸åŒæ—¶ä½œä¸ºåŒºåˆ†ä¸åŒç‰ˆæœ¬çš„æ ‡è¯†ï¼Œä¸€èˆ¬åªéœ€è¦å…³å¿ƒä¸»ç‰ˆæœ¬å·ã€‚
- ç‰ˆæœ¬å·çš„ä½œç”¨ä¸»è¦æ˜¯åˆ¤æ–­å½“å‰å­—èŠ‚ç çš„ç‰ˆæœ¬å’Œè¿è¡Œæ—¶çš„JDKæ˜¯å¦å…¼å®¹

> Tips:
>
> 1.2ä¹‹åå¤§ç‰ˆæœ¬å·è®¡ç®—çš„æ–¹å¼å°±æ˜¯ä¸»ç‰ˆæœ¬å·-44 
>
> ä¾‹å¦‚ï¼šä¸»ç‰ˆæœ¬å·52å°±æ˜¯JDK8



![image-20240113230402739](./img/16.png)

![image-20240112220051858](./img/25.png)

![image-20240113230833483](./img/26.png)

| åç§°               | ä½œç”¨                                                         |
| ------------------ | ------------------------------------------------------------ |
| Magicé­”æ•°          | å›ºå®šä¸º0XCAFEBABE ä¸ä¼šæ”¹å˜                                    |
| ä¸»å‰¯ç‰ˆæœ¬å·         | ç¼–è¯‘å­—èŠ‚ç çš„JDKç‰ˆæœ¬                                          |
| è®¿é—®æ ‡è¯†           | æ ‡è¯†æ˜¯ç±»è¿˜æ˜¯æ¥å£ã€æšä¸¾ã€æ³¨è§£ã€æ¨¡å— æ ‡è¯†publicã€finalã€abstract |
| ç±»ã€çˆ¶ç±»ã€æ¥å£ç´¢å¼• | é€šè¿‡è¿™äº›ç´¢å¼•å¯ä»¥æ‰¾åˆ°ç±»ã€çˆ¶ç±»ã€æ¥å£çš„ä¿¡æ¯                     |



#### 2ï¼‰å¸¸é‡æ± 

å­—èŠ‚ç æ–‡ä»¶ä¸­å¸¸é‡æ± çš„ä½œç”¨ï¼š

- é¿å…ç›¸åŒçš„å†…å®¹é‡å¤å®šä¹‰ã€èŠ‚çœç©ºé—´ã€‚

```
    public static String A = "ä¸­å›½";
    public static String B = "ä¸­å›½";
```

> å…¶ä»–çš„ç›¸åŒçš„å­—æ®µå°±ä¼šå»å¼•ç”¨åˆ° çœŸæ­£çš„stringå­—é¢é‡

![image-20240112222511280](./img/17.png)

> å¦‚æœæ˜¯å¸¸é‡ é‚£ä¹ˆä¼šæŒ‡å‘å¸¸é‡æ± é‡Œé¢çš„index æœ€ç»ˆæ‰¾åˆ°å­—é¢é‡
>
> å¦‚æœæ˜¯æ™®é€šçš„ æ˜¯å­˜åœ¨å¸¸é‡æ± é‡Œé¢ é‚£ä¹ˆä¼šç›´æ¥æ‰¾åˆ°å¯¹åº”çš„å­—é¢é‡å€¼

- å¸¸é‡æ± ä¸­çš„æ•°æ®éƒ½æœ‰ä¸€ä¸ªç¼–å·ï¼Œç¼–å·ä»1å¼€å§‹ã€‚åœ¨å­—æ®µæˆ–è€…å­—èŠ‚ç æŒ‡ä»¤ä¸­é€šè¿‡ç¼–å·å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚

- å­—èŠ‚ç æŒ‡ä»¤ä¸­é€šè¿‡ç¼–å·å¼•ç”¨åˆ°å¸¸é‡æ± çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºç¬¦å·å¼•ç”¨

  > ![image-20240113232200998](./img/18.png)![image-20240113232211200](./img/19.png)





#### 3ï¼‰æ–¹æ³•

- å­—èŠ‚ç ä¸­çš„æ–¹æ³•åŒºåŸŸæ˜¯å­˜æ”¾**å­—èŠ‚ç æŒ‡ä»¤**çš„æ ¸å¿ƒä½ç½®ï¼Œå­—èŠ‚ç æŒ‡ä»¤çš„å†…å®¹æ”¾åœ¨æ–¹æ³•çš„codeå±æ€§ä¸­

  > ![image-20240113232345246](./img/20.png)

![image-20240112225630253](./img/21.png)

![image-20240112225750701](./img/22.png)



**é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤åˆ†æä¸‹é¢ä¸‰ç§â€œåŠ 1â€çš„æ“ä½œæ€§èƒ½çš„é«˜ä½ï¼Ÿ**

> å­—èŠ‚ç è¡Œæ•°è¶Šå°‘ æ•ˆç‡è¶Šé«˜

```java
int i=0,j=0,k=0;
i++;
j=j+1;
k += 1;
```

> iå’Œkä¸€æ ·è¡Œæ•°
>
> jçš„è¡Œæ•°æœ€å¤š



**å­—èŠ‚ç å·¥å…·**

- javap -v

  > javapæ˜¯JDKè‡ªå¸¦çš„åç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å°æŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶çš„å†…å®¹ã€‚é€‚åˆåœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶å†…å®¹
  >
  > ç›´æ¥è¾“å…¥javap æŸ¥çœ‹æ‰€æœ‰å‚æ•°
  >
  > è¾“å…¥javap -v å­—èŠ‚ç æ–‡ä»¶åç§° æŸ¥çœ‹å…·ä½“çš„å­—èŠ‚ç ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯jaråŒ… éœ€è¦ç”¨jar -xvfå‘½ä»¤è§£å‹ï¼‰
  >
  > > linux > ç¬¦å·è¿½åŠ åˆ°æŒ‡å®šçš„ä½ç½®æ–‡ä»¶å†…

- Arthas

  > å®˜ç½‘åœ°å€ï¼šhttps://arthas.aliyun.com/doc/
  >
  > ![image-20240113140957469](./img/23.png)
  >
  > - jadç±»çš„å…¨é™å®šåï¼šåç¼–è¯‘å·²ç»åŠ è½½ç±»çš„æºç 
  >
  > - dumpç±»çš„å…¨é™å®šåï¼šdumpå·²åŠ è½½ç±»çš„å­—èŠ‚ç æ–‡ä»¶åˆ°ç‰¹å®šç›®å½•
  >
  >   > å…¨é™åï¼š**åŒ…ååŠ ç±»å**



### 3.ç±»çš„ç”Ÿå‘½å‘¨æœŸ

åº”ç”¨åœºæ™¯ï¼š

- è¿è¡Œæ—¶å¸¸é‡æ± 
- å¤šæ€çš„åŸç†
- ç±»åŠ è½½å™¨çš„ä½œç”¨
- ç±»çš„åŠ å¯†å’Œè§£å¯†



#### 0ï¼‰ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°

**åˆ†ä¸ºä¸‹é¢äº”ä¸ªé˜¶æ®µï¼š**

- 1-åŠ è½½

- 2-è¿æ¥

  > é‡ç‚¹çŸ¥è¯†ï¼š
  >
  > - æ ¡éªŒ
  > - å‡†å¤‡
  > - è§£æ

- 3-åˆå§‹åŒ–

- 4-ä½¿ç”¨

  > è·ç¦»ï¼šnewä¸€ä¸ªå¯¹è±¡
  >
  > ```
  > Class class = new Class();
  > Class<Class> clazz = Class.class;
  > Class class1 = clazz.newInstance();
  > ```
  >
  > 

- 5-å¸è½½

  > ç±»çš„å¸è½½ä¸»è¦ä½“ç°åœ¨åƒåœ¾å›æ”¶â™»ï¸æœºåˆ¶



#### 1ï¼‰åŠ è½½é˜¶æ®µ

- Loadingé˜¶æ®µç¬¬ä¸€æ­¥æ˜¯**ç±»åŠ è½½å™¨**æ ¹æ®ç±»çš„å…¨é™å®šåé€šè¿‡ä¸åŒçš„æ¸ é“ä»¥äºŒè¿›åˆ¶æµçš„æ–¹å¼è·å–åˆ°å­—èŠ‚ç ä¿¡æ¯ã€‚

  - æœ¬åœ°æ–‡ä»¶- ç£ç›˜ä¸Šçš„å­—èŠ‚ç æ–‡ä»¶
  - åŠ¨æ€ä»£ç†ç”Ÿæˆ-ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆ
  - é€šè¿‡ç½‘ç»œä¼ è¾“çš„ç±»-æ—©æœŸçš„AppletæŠ€æœ¯ä½¿ç”¨

- ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°æ–¹æ³•åŒºä¸­

  > æ–¹æ³•åŒºï¼šè™šæ‹Ÿçš„ç©ºé—´
  >
  > Java8ä»¥åå«å…ƒç©ºé—´

- ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°å†…å­˜çš„æ–¹æ³•åŒºä¸­ã€‚

  > ç”Ÿæˆä¸€ä¸ªInstanceKlasså¯¹è±¡ï¼Œä¿å­˜ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œé‡Œé¢è¿˜åŒ…å«å®ç°ç‰¹å®šåŠŸèƒ½æ¯”å¦‚å¤šæ€çš„ä¿¡æ¯ã€‚
  >
  > ![image-20240114140938691](./img/27.png)

- åŒæ—¶ï¼ŒJavaè™šæ‹Ÿæœºè¿˜åœ¨å †ä¸­ç”Ÿæˆä¸€ä»½ä¸æ–¹æ³•åŒºä¸­æ•°æ®ç±»ä¼¼çš„java.lang.Class å¯¹è±¡

  > ä½œç”¨ï¼šæ˜¯åœ¨Javaä»£ç ä¸­å»è·å–ç±»çš„ä¿¡æ¯ä»¥åŠå­˜å‚¨é™æ€å­—æ®µçš„å­—æ®µï¼ˆJDK8åŠä¹‹åï¼‰
  >
  > ![image-20240114141447375](./img/28.png)
  >
  > ![image-20240113144305816](./img/30.png)
  >
  > ![image-20240113144323237](./img/31.png)

  

  

**ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªåŒºï¼Ÿ**

> å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œ**åªéœ€è¦è®¿é—®å †ä¸­çš„Classå¯¹è±¡**è€Œä¸éœ€è¦è®¿é—®æ–¹æ³•åŒºä¸­æ‰€æœ‰ä¿¡æ¯
>
> **è¿™æ ·è™šæ‹Ÿæœºå°±èƒ½å¾ˆå¥½åœ°æ§åˆ¶å¼€å‘è€…è®¿é—®æ•°æ®çš„èŒƒå›´**
>
> ![image-20240113144512326](./img/32.png)



**æŸ¥çœ‹å†…å­˜ä¸­çš„å¯¹è±¡**

- æ¨èä½¿ç”¨JDKè‡ªå¸¦çš„hsdbå·¥å…·æŸ¥çœ‹Javaè™šæ‹Ÿæœºå†…å­˜ä¿¡æ¯ã€‚å·¥å…·ä½äºJDKå®‰è£…ç›®å½•ä¸‹libæ–‡ä»¶å¤¹ä¸­çš„sa-jdi.jar

- å¯åŠ¨å‘½ä»¤

  > ```shell
  > java -cp sa-jdi.jar sun.jvm.hotspot.HSDB
  > ```
  >
  > ç„¶åä½¿ç”¨å¯¹åº”çš„javaè¿›ç¨‹ç«¯å£å·è¿æ¥
  >
  > <img src="./img/33.png" alt="image-20240113192844569" style="zoom: 50%;" />
  >
  > ![image-20240114150009116](./img/34.png)

  

  **TipsğŸ’¡**

> jps å‘½ä»¤ï¼šæŸ¥çœ‹æ‰€æœ‰çš„javaå¯¹è±¡è¿›ç¨‹
>
> ![image-20240113193437270](./img/51.png)





#### 2ï¼‰è¿æ¥é˜¶æ®µ

è¿æ¥é˜¶æ®µä¸»è¦åŒ…å«***ä¸‰ä¸ªè¿‡ç¨‹***ï¼š

- ***éªŒè¯-éªŒè¯å†…å®¹æ˜¯å¦æ»¡è¶³ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹***

  > Linkingé˜¶æ®µä¸éœ€è¦ç¨‹åºå‘˜å‚ä¸
  >
  > ä¸»è¦éªŒè¯å››éƒ¨åˆ†ï¼š
  >
  > - æ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œæ¯”å¦‚æ–‡ä»¶æ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´ï¼Œä¸»å‰¯ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³å½“å‰Javaè™šæ‹Ÿæœºç‰ˆæœ¬è¦æ±‚
  > - å…ƒä¿¡æ¯éªŒè¯ï¼Œä¾‹å¦‚ç±»å¿…é¡»æœ‰çˆ¶ç±»ï¼ˆsuperä¸èƒ½ä¸ºç©ºï¼‰
  > - éªŒè¯ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰ï¼Œæ¯”å¦‚æ–¹æ³•å†…çš„æŒ‡ä»¤æ‰§è¡Œåˆ°ä¸€åŠå¼ºè¡Œè·³è½¬åˆ°å…¶ä»–æ–¹æ³•ä¸­å»
  > - ç¬¦å·å¼•ç”¨éªŒè¯ï¼Œä¾‹å¦‚æ˜¯å¦è®¿é—®äº†å…¶ä»–ç±»ä¸­privateçš„æ–¹æ³•ç­‰

- ***ç»™é™æ€å˜é‡èµ‹åˆå€¼***

  > åªè¦è®¨è®ºJDK8åŠä»¥åçš„ç‰ˆæœ¬
  >
  > - è™½ç„¶èµ‹å€¼ä¸º1 ä½†æ˜¯åˆå§‹å€¼èµ‹å€¼ä¸º0
  >
  > ![image-20240114150957325](./img/35.png)
  >
  > - **å‡†å¤‡é˜¶æ®µåªä¼šç»™é™æ€å˜é‡èµ‹åˆå§‹å€¼ï¼Œè€Œæ¯ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹éƒ½æœ‰å…¶åˆå§‹å€¼**
  >
  > ![image-20240114151135717](./img/36.png)
  >
  > - **finalä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹çš„é™æ€å˜é‡ï¼Œå‡†å¤‡é˜¶æ®µç›´æ¥ä¼šå°†ä»£ç ä¸­çš„å€¼è¿›è¡Œèµ‹å€¼ã€‚ï¼ˆå› ä¸ºå€¼ä¸èƒ½ä¿®æ”¹ï¼Œå·²ç»ç¡®å®šäº†ï¼‰**
  >
  > ![image-20240114151248373](./img/37.png)

  

- ***å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢æˆæŒ‡å‘å†…å­˜çš„ç›´æ¥å¼•ç”¨***

  > - **ç›´æ¥å¼•ç”¨ä¸åœ¨ä½¿ç”¨ç¼–å·ï¼Œè€Œæ˜¯ä½¿ç”¨å†…å­˜ä¸­åœ°å€è¿›è¡Œè®¿é—®å…·ä½“çš„æ•°æ®**
  >
  > ![image-20240114151357606](./img/38.png)

> ***ç¬¦å·å¼•ç”¨***æ˜¯å­—èŠ‚ç æ–‡ä»¶ä¸­ä½¿ç”¨**ç¼–å·**å»å¸¸é‡æ± ä¸­æ‰¾å¯¹åº”çš„å†…å®¹ï¼Œ***ç›´æ¥å¼•ç”¨***æ˜¯å»æ‰¾å†…å­˜åœ°å€çš„å¼•ç”¨
>
> ![image-20240114152031342](./img/39.png)
>
> ç±»çš„ä¿¡æ¯å·²ç»åŠ è½½åœ¨å†…å­˜ä¸­







#### 3ï¼‰åˆå§‹åŒ–é˜¶æ®µ

- åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œ**é™æ€ä»£ç å—ä¸­çš„ä»£ç **ï¼Œå¹¶**ä¸ºé™æ€å˜é‡èµ‹å€¼**ã€‚æ‰§è¡Œæµç¨‹ä¸ä»£ç æ‰§è¡Œæµç¨‹ä¸€è‡´ã€‚

- åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶ä¸­**cliinit**éƒ¨åˆ†çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚

  > **clinit**æ–¹æ³•ä¸­å’Œjavaæ‰§è¡Œçš„é¡ºåºä¸€è‡´
  >
  > ![image-20240114152342473](./img/40.png)



**ä»¥ä¸‹å‡ ç§æ–¹å¼ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼š**

1. è®¿é—®ä¸€ä¸ªç±»çš„é™æ€å˜é‡æˆ–è€…é™æ€æ–¹æ³•ï¼Œæ³¨æ„å˜é‡æ—¶**finalä¿®é¥°çš„å¹¶ä¸”ç­‰å·å³è¾¹æ—¶å¸¸é‡ä¸ä¼šè§¦å‘åˆå§‹åŒ–**ï¼ˆå·²ç»åœ¨è¿æ¥é˜¶æ®µçš„å‡†å¤‡é˜¶æ®µå·²ç»åˆå§‹åŒ–äº†ï¼‰
2. è°ƒç”¨Class.forName(String className)
3. new ä¸€ä¸ªè¯¥ç±»çš„å¯¹è±¡æ—¶
4. æ‰§è¡ŒMainæ–¹æ³•çš„å½“å‰ç±»

**TipsğŸ’¡**

> VMå‚æ•°ï¼š
>
> ```
> -XX:+TraceClassLoading å‚æ•°å¯ä»¥æ‰“å°å‡ºåŠ è½½å¹¶åˆå§‹åŒ–çš„ç±»
> ```

**æ¡ˆä¾‹ï¼š**

> ![image-20240113195843126](./img/41.png)

> æ‰§è¡Œmainæ–¹æ³•çš„æ—¶å€™ ä¼šå…ˆåˆå§‹åŒ–clinit æ‰§è¡Œå½“å‰mainæ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡é™æ€ä»£ç å—ï¼ˆ**æœ‰ä¸”åªä¼šæ‰§è¡Œä¸€æ¬¡é™æ€ä»£ç å—**ï¼‰æ‰€ä»¥æ‰“å°D ç„¶åæ‰§è¡Œmainæ–¹æ³•è‡ªå·±çš„A 
>
> **ä¸€ä¸ªç±»*åŠ è½½åˆå§‹åŒ–*åªä¼šæ‰§è¡Œä¸€æ¬¡**
>
> ç„¶ånewä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼ˆå¯ä»¥åˆ›å»ºå¤šä¸ªå¯¹è±¡ ä¼šåˆå§‹åŒ–å¤šæ¬¡æ„é€ æ–¹æ³•ï¼‰ **æ‰§è¡Œé¡ºåºï¼šé™æ€ä»£ç å—-> ä»£ç å—-> æ„é€ æ–¹æ³•** ï¼Œå› ä¸ºmainåˆå§‹åŒ–ï¼ˆå·²ç»åŠ è½½äº†æœ¬èº«ï¼‰çš„æ—¶å€™å·²ç»æ‰§è¡Œäº†é™æ€ä»£ç å— ï¼Œç„¶åä¼šå…ˆåˆå§‹åŒ–è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼ˆå¦‚æœæœ‰å±€éƒ¨ä»£ç å— é‚£ä¹ˆinitçš„æ—¶å€™ä¼šæŠŠè¯¥ä»£ç å—æ”¾åˆ°æ„é€ æ–¹æ³•é‡Œé¢ä¸€èµ·æ‰§è¡Œï¼‰ã€‚
>
> ```java
> class Test001{
>     public static void main(String[] args) {
>         System.out.println("A");
>         new Test001();
>         new Test001();
>     }
> 
>     public Test001() {
>         System.out.println("B");
>     }
>     {
>         System.out.println("C");
>     }
>     static {
>         System.out.println("D");
>     }
> }
> ```
>
> **æ‰§è¡Œç»“æœä¸ºï¼šDACBCB**



clinitæŒ‡ä»¤åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¸ä¼šå‡ºç°æŒ‡ä»¤æ“ä½œ

æ¯”å¦‚ï¼šä»¥ä¸‹å‡ ç§æƒ…å†µæ˜¯***ä¸ä¼š**è¿›è¡Œåˆå§‹åŒ–æŒ‡ä»¤æ“ä½œçš„*ã€‚

1. æ— é™æ€ä»£ç å—ä¸”æ— é™æ€å˜é‡èµ‹å€¼è¯­å¥çš„
2. æœ‰é™æ€å˜é‡çš„å£°æ˜ï¼Œä½†æ˜¯æ²¡æœ‰èµ‹å€¼è¯­å¥çš„
3. é™æ€å˜é‡çš„å®šä¹‰ä½¿ç”¨finalå…³é”®å­—çš„ï¼Œè¿™ç±»å˜é‡ä¼šåœ¨ï¼ˆ**è¿æ¥é˜¶æ®µçš„å‡†å¤‡é˜¶æ®µ**ï¼‰ç›´æ¥è¿›è¡Œåˆå§‹åŒ–
4. **ç›´æ¥è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œä¸ä¼šå‡ºå‘å­ç±»çš„åˆå§‹åŒ–**
5. å­ç±»çš„åˆå§‹åŒ–clinitè°ƒç”¨ä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„clinitåˆå§‹åŒ–æ–¹æ³•

**æ¡ˆä¾‹1ï¼š**

> ![image-20240114155119136](./img/42.png)
>
> **ç­”æ¡ˆï¼šå…ˆæ‰§è¡Œçˆ¶ç±» æŠŠå€¼èµ‹å€¼ä¸º1 ç„¶åæ‰§è¡Œå­ç±»ã€‚æŠŠå€¼èµ‹å€¼ä¸º2 ç„¶åæ‰“å°æ•°æ®ä¸º2**

**æ¡ˆä¾‹2:**

> **æ•°ç»„çš„åˆ›å»ºä¸ä¼šå¯¼è‡´æ•°ç»„ä¸­å…ƒç´ çš„ç±»è¿›è¡Œåˆå§‹åŒ–**
>
> ```java
> class Test001 {
>     public static void main(String[] args) {
>         Test002[] test001s = new Test002[10];
>     }
> }
> 
> class Test002 {
>     static {
>         System.out.println("D");
>     }
> }
> ```
>
> **ç­”æ¡ˆï¼šä¸ä¼šæ‰“å°é™æ€ä»£ç å—**

**æ¡ˆä¾‹3:**

> **finalä¿®é¥°çš„å˜é‡å¦‚æœèµ‹å€¼çš„å†…å®¹éœ€è¦æ‰§è¡ŒæŒ‡ä»¤æ‰èƒ½å¾—åˆ°ç»“æœï¼Œä¼šæ‰§è¡Œclinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–**
>
> 
>
> ```java
> class Test001 {
>     public static void main(String[] args) {
>         System.out.println(Test002.a);
>     }
> }
> 
> class Test002 {
>     public static final int a = Integer.valueOf(1);
> 
>     static {
>         System.out.println("é™æ€ä»£ç å—è¿è¡Œ");
>     }
> }
> ```
>
> **ç­”æ¡ˆï¼šæ˜¯1 ç„¶åæ˜¯æ‰“å°æ–‡å­—**



### 4.ç±»åŠ è½½å™¨

ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿ

> ç±»åŠ è½½å™¨ï¼ˆclassLoaderï¼‰æ˜¯Javaè™šæ‹Ÿæœºæä¾›ç»™åº”ç”¨ç¨‹åºåŒºå®ç°è·å–ç±»å’Œæ¥å£å­—èŠ‚ç æ•°æ®çš„æŠ€æœ¯

![image-20240114210334102](./img/43.png)

![image-20240114164002896](./img/44.png)



**ç±»åŠ è½½å™¨çš„åº”ç”¨åœºæ™¯ï¼š**

- ä¼ä¸šçº§åº”ç”¨
  1. SPIæœºåˆ¶
  2. ç±»çš„çƒ­éƒ¨ç½²
  3. Tomcatç±»çš„éš”ç¦»
- å¤§é‡çš„é¢è¯•é¢˜
  1. ä»€ä¹ˆæ˜¯ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶
  2. æ‰“ç ´ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶
  3. è‡ªå®šä¹‰ç±»åŠ è½½å™¨
- è§£å†³çº¿ä¸Šé—®é¢˜
  1. ä½¿ç”¨Arthasä¸åœæœºè§£å†³çº¿ä¸Šæ•…éšœ







#### 1ï¼‰ç±»åŠ è½½å™¨çš„åˆ†ç±»

ç±»åŠ è½½å™¨åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯Javaä»£ç ä¸­å®ç°çš„ï¼Œä¸€ç±»æ˜¯Javaè™šæ‹Ÿæœºåº•å±‚æºç å®ç°çš„

![image-20240114210830514](./img/45.png)

- ç±»åŠ è½½å™¨çš„è®¾è®¡JDK8å’Œ8ä¹‹åçš„ç‰ˆæœ¬å·®åˆ«è¾ƒå¤§ï¼ŒJDK8åŠä¹‹åçš„ç‰ˆæœ¬ä¸­é»˜è®¤çš„ç´¯ç§¯è½½å™¨æœ‰å¦‚ä¸‹å‡ ç§

**è™šæ‹Ÿæœºæ—¶å®ç°çš„ï¼š**

>**Bootstrapï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰**
>
>è™šæ‹Ÿæœºåº•å±‚å®ç°çš„C++ï¼ŒåŠ è½½Javaç±»ä¸­æœ€æ ¸å¿ƒçš„ç±»

**Javaå®ç°çš„ï¼š**

> **Extensionï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰**
>
> å…è®¸æ‰©å±•Javaä¸­æ¯”è¾ƒé€šç”¨çš„ç±»
>
> **Applicationï¼ˆåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼‰**
>
> åŠ è½½åº”ç”¨ä½¿ç”¨çš„ç±»





ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥é€šè¿‡classloaderå‘½ä»¤æŸ¥

> ```shell
> [arthas@60081]$ classloader
> ```
>
> å¯ä»¥çœ‹åˆ°å±‚çº§å…³ç³»ä¸ºæœ€ä¸Šå±‚çš„çˆ¶ç±»ä¸º**BootstrapClassLoader**ï¼Œå…¶æ¬¡**sun.misc.LauncherExtClassLoader**ï¼Œåœ¨å…¶æ¬¡ä¸º**sun.misc.LauncherAppClassLoader**
>
> ![image-20240114215035975](./img/46.png)





##### **Bootstrap ClassLoader**

- Bootstrap ClassLoader æ˜¯ç”±HotSpotè™šæ‹Ÿæœºæä¾›ã€ä½¿ç”¨C++ç¼–å†™çš„ç±»åŠ è½½å™¨

- é»˜è®¤åŠ è½½Javaå®‰è£…ç›®å½•ä¸‹/jre/libä¸‹çš„ç±»æ–‡ä»¶

  > ![image-20240114215637896](./img/47.png)



**å¦‚æœæƒ³ç”¨BootStrap ClassLoader åŠ è½½ç”¨æˆ·è‡ªå·±çš„jaråŒ…ï¼Œæœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- ï¼ˆä¸æ¨èï¼‰æŠŠè‡ªå·±çš„jaråŒ…æ”¾å…¥libç›®å½•ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ–‡ä»¶åä¸åŒ¹é…çš„é—®é¢˜ä¹Ÿä¸ä¼šæ­£å¸¸çš„è¢«åŠ è½½

- **ï¼ˆæ¨èï¼‰**ä½¿ç”¨VMå‚æ•°è¿›è¡Œæ‰©å±•

  > ä½¿ç”¨å‘½ä»¤ï¼š
  >
  > ```
  > -Xbootclasspath/a:jaråŒ…ç›®å½•/jaråŒ…å
  > ```
  >
  > å¯ä»¥è‡ªå·±æ‰‹åŠ¨å†™ä¸€ä¸ªç±» ç„¶åä½¿ç”¨vmå‚æ•°æŠŠè¿™ä¸ªç±»åŠ è½½è¿›å»ï¼Œè¿™ä¸ªç±»å¯ä»¥å†™äº†staticæ–¹æ³• æ‰“å°æ—¥å¿—  ç„¶åè°ƒç”¨çš„è¿™ä¸ª å»æŒ‡å®šå¼•ç”¨è¿™ä¸ªç±» forname ç„¶åçœ‹ç»“æœ ä½†æ˜¯è¿™ä¸ªç±»åŠ è½½å™¨è¿˜æ˜¯null æ˜¯å±äºbootstrapåŠ è½½å™¨



**Javaä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨**

- **Extension ClassLoader**å’Œ**Application ClassLoader**éƒ½æ˜¯JDKä¸­æä¾›çš„ï¼Œä½¿ç”¨Javaç¼–å†™çš„ç±»åŠ è½½å™¨
- å®ƒä»¬çš„æºç éƒ½ä½äºsun.misc,Launcherä¸­ï¼Œæ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ã€‚ç»§æ‰¿è‡ªURLCLlassLoaderã€‚å±€éƒ¨é€šè¿‡ç›®å½•æˆ–è€…æŒ‡å®šjaråŒ…å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

![image-20240114221554145](./img/48.png)





##### Extension ClassLoader

- Extension ClassLoader æ˜¯JDKä¸­æä¾›çš„ã€ä½¿ç”¨Javaç¼–å†™çš„ç±»åŠ è½½å™¨

- é»˜è®¤åŠ è½½Javaå®‰è£…ç›®å½•/jre/lib/extä¸‹çš„ç±»æ–‡ä»¶

  > ![image-20240114221237025](./img/49.png)

**å¦‚æœæƒ³ç”¨Extension ClassLoader åŠ è½½ç”¨æˆ·è‡ªå·±çš„jaråŒ…ï¼Œæœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- ï¼ˆä¸æ¨èï¼‰æŠŠè‡ªå·±çš„jaråŒ…æ”¾å…¥/j re/lib/ext/ç›®å½•ä¸‹ï¼Œå°½é‡ä¸è¦å»æ”¹JDKå®‰è£…ç›®å½•ä¸­çš„å†…å®¹

- **ï¼ˆæ¨èï¼‰**ä½¿ç”¨VMå‚æ•°è¿›è¡Œæ‰©å±•

  > ä½¿ç”¨å‘½ä»¤ï¼š
  >
  > ```
  > -Djava.ext.dirs=jaråŒ…ç›®å½•è¿›è¡Œæ‰©å±•ï¼Œè¿™ç§æ–¹å¼ä¼šè¦†ç›–åŸæ˜¯ç›®å½•ï¼Œæ‰€ä»¥éœ€è¦ç”¨ ; è¿½åŠ åŸå§‹ç›®å½•
  > ```



##### Application ClassLoader

- è‡ªå·±å†™çš„ä»£ç é»˜è®¤å°±æ˜¯Application ClassLoader



**ä½¿ç”¨ArthasæŸ¥çœ‹ç±»åŠ è½½å™¨**

![image-20240114222734187](./img/50.png)



#### 2ï¼‰åŒäº²å§”æ´¾æœºåˆ¶

> ç”±äºJavaè™šæ‹Ÿæœºä¸­æœ‰å¤šä¸ªç±»åŠ è½½å™¨ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒæ˜¯è§£å†³ä¸€ä¸ªç±»åˆ°åº•ç”±è°æ¥åŠ è½½çš„é—®é¢˜

**åŒäº²å§”æ´¾æœºåˆ¶æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ**

1. ä¿è¯ç±»åŠ è½½çš„å®‰å…¨æ€§

   > é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶é¿å…æ¶æ„ä»£ç æ›¿æ¢JDKçš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§

2. é¿å…é‡å¤åŠ è½½

   > å¯ä»¥é¿å…ä¸€ä¸ªç±»è¢«åå¤å¤šæ¬¡åŠ è½½



**ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ**

> å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½ç±»å½“ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼š**è‡ªåº•å‘ä¸ŠæŸ¥æ‰¾**æ˜¯å¦åŠ è½½è¿‡ï¼Œå†**ç”±é¡¶å‘ä¸‹è¿›è¡ŒåŠ è½½**
>
> å‘ä¸‹å§”æ´¾åŠ è½½èµ·åˆ°äº†ä¸€ä¸ªåŠ è½½ä¼˜å…ˆçº§çš„ä½œç”¨
>
> ![image-20240114230839019](./img/52.png)

æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ï¼Œ**Application** çš„çˆ¶ç±»æ˜¯**Extension** ï¼Œ**Extension**çš„parentæ˜¯**Null**

- åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½ä¼šå…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½ç±»è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå°†åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œé€çº§å‘ä¸Š

> ![image-20240114231300679](./img/53.png)

- å¦‚æœæ‰€æœ‰çš„çˆ¶ç±»åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œé‚£ä¹ˆå°±ä¼šç”±æœ€ä¸Šå±‚çš„ç±»åŠ è½½å™¨å¼€å§‹**è‡ªé¡¶å‘ä¸‹**å°è¯•åŠ è½½ç±»ã€‚

> ![image-20240114231505985](./img/54.png)



**é—®é¢˜ï¼š**

1. å¦‚æœä¸€ä¸ªç±»é‡å¤å‡ºç°åœ¨ä¸‰ä¸ªç±»åŠ è½½å™¨çš„åŠ è½½ä½ç½®ï¼Œåº”è¯¥ç”±è°æ¥åŠ è½½ï¼Ÿ

   > åº”è¯¥ç”±Bootstrap ClassLoaderæ¥åŠ è½½ï¼Œè¯¥Loaderä¼˜å…ˆçº§æœ€é«˜

2. Stringç±»èƒ½è¦†ç›–å˜›ï¼Ÿ

   > Stringç±»ä¸èƒ½é‡å†™ï¼Œä¸ä¼šï¼Œä¸”Stringç±»ç”±Bootstrap ClassLoaderæ¥åŠ è½½

3. å¦‚ä½•åœ¨Javaä¸­ä½¿ç”¨ä»£ç çš„æ–¹å¼å»ä¸»åŠ¨åŠ è½½ä¸€ä¸ªç±»ï¼Ÿ

   > - ä½¿ç”¨Class.forNameæ–¹æ³•ï¼Œä½¿ç”¨å½“å‰çš„ç±»çš„ç±»åŠ è½½å™¨å»åŠ è½½æŒ‡å®šçš„ç±»
   >
   >   ```java
   >   
   >           Class<?> aClass = Class.forName("xxxx.xxxx");
   >           aClass.getClassLoader();
   >   ```
   >
   > - è·å–ç±»åŠ è½½å™¨ï¼Œé€šè¿‡ç±»åŠ è½½å™¨çš„loadClass() æŒ‡å®šæŸä¸ªç±»åŠ è½½å™¨åŠ è½½
   >
   >   ```java
   >   ClassLoader classLoader = Test002.class.getClassLoader();
   >   Class<?> aClass1 = classLoader.loadClass("xxxx.xxx");
   >   ```



**æ¯ä¸ªJavaå®ç°çš„ç±»åŠ è½½å™¨ä¸­ä¿å­˜äº†ä¸€ä¸ªæˆå‘˜å˜é‡ parentç±»åŠ è½½å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸Šä¸€çº§åŠ è½½å™¨ï¼Œä¸æ˜¯Javaä¸­ç»§æ‰¿å…³ç³»å’Œå«ä¹‰**

> ![image-20240114232844794](./img/55.png)





- ApplicationåŠ è½½å™¨çš„parentæ˜¯Extension åŠ è½½å™¨ï¼Œè€Œ**ExtensionåŠ è½½çš„parentæ˜¯Null**ï¼Œä½†æ˜¯åœ¨ä»£ç é€»è¾‘ä¸Šï¼ŒExtension ClassLoaderä¾ç„¶ä¼šæŠŠBootstrap ClassLoaderå½“æˆçˆ¶ç±»åŠ è½½å™¨å¤„ç†
- Bootstrap ClassLoaderä½¿ç”¨C++ç¼–å†™ï¼Œæ²¡æœ‰parentåŠ è½½å™¨

![image-20240114233152391](./img/56.png)

ä½¿ç”¨ArthasæŸ¥çœ‹ClassLoaderçš„çˆ¶å­å…³ç³»ï¼š

> ```shell
> classloader -t
> ```
>
> ![image-20240114233340193](./img/57.png)



##### **é¢è¯•é¢˜**

**ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ**

1. å½“ä¸€ä¸ªç±»åŠ è½½å™¨å»åŠ è½½æŸä¸ªç±»çš„æ—¶å€™ï¼Œä¼šè‡ªåº•å‘ä¸ŠæŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸€ç›´åˆ°æœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½ï¼Œå†ç”±é¡¶å‘ä¸‹è¿›è¡ŒåŠ è½½ã€‚
2. åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œæ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆ**ä¸ºNull**ï¼‰ã€‚
3. åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„æœ‰ä¸¤ç‚¹: ç¬¬ä¸€æ˜¯é¿å…æ¶æ„ä»£ç æ›¿æ¢JDKä¸­çš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚ç¬¬äºŒæ˜¯é¿å…ä¸€ä¸ªç±»é‡å¤åœ°è¢«åŠ è½½ã€‚





#### 3ï¼‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶

**æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶æœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- è‡ªå®šä¹‰ç±»åŠ è½½å™¨

  > è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶ä¸”é‡å†™loadclassæ–¹æ³•ï¼Œå°±å¯ä»¥å°†åŒäº²å§”æ´¾æœºåˆ¶çš„ä»£ç å»é™¤Tomcaté€šè¿‡è¿™ç§æ–¹å¼å®ç°åº”ç”¨ä¹‹é—´ç±»éš”ç¦»ï¼Œã€Šé¢è¯•ç¯‡ã€‹ä¸­åˆ†äº«å®ƒçš„åšæ³•

- çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨

  > åˆ©ç”¨ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±»ï¼Œæ¯”å¦‚JDBCå’ŒJNDIç­‰

- Osgiæ¡†æ¶çš„ç±»åŠ è½½å™¨

  > å†å²ä¸Šosgiæ¡†æ¶å®ç°äº†ä¸€å¥—æ–°çš„ç±»åŠ è½½å™¨æœºåˆ¶ï¼Œå…è®¸åŒçº§ä¹‹é—´å§”æ‰˜è¿›è¡Œç±»çš„åŠ è½½



**ä¸ºä»€ä¹ˆæœ‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ**

- ä¸€ä¸ªTomcatç¨‹åºæ˜¯å¯ä»¥è¿è¡Œå¤šä¸ªWebåº”ç”¨çš„ï¼Œå¦‚æœä¸¤ä¸ªåº”ç”¨ä¸­å‡ºç°äº†æƒ³åçš„é™å®šåçš„ç±»ï¼Œæ¯”å¦‚Servetç±»ï¼ŒTomcatè¦ä¿è¯è¿™ä¸¤ä¸ªç±»èƒ½å¤ŸåŠ è½½å¹¶ä¸”å®ƒä»¬åº”è¯¥æ˜¯ä¸åŒçš„ç±»

- å¦‚æœä¸æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå½“åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½Webåº”ç”¨1çš„MyServletä¹‹åï¼ŒWebåº”ç”¨2ä¸­ç›¸åŒé™å®šåçš„MyServletç±»å°±æ— æ³•è¢«åŠ è½½äº†

  > ![image-20240115112852947](./img/58.png)



##### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

- Tomcatä½¿ç”¨äº†è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°åº”ç”¨ä¹‹é—´ç±»çš„éš”ç¦»ã€‚æ¯ä¸€ä¸ªåº”ç”¨ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åŠ è½½å™¨åŠ è½½ç›¸åº”çš„ç±»ã€‚

![image-20240115113239937](./img/59.png)

- å…ˆæ¥åˆ†æClassLoaderçš„åŸç†ï¼ŒClassLoaderä¸­åŒ…å«äº†4ä¸ªæ ¸å¿ƒæ–¹æ³•

  > ```java
  > // ç±»åŠ è½½çš„å…¥å£ï¼Œæä¾›äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚å†…éƒ¨ä¼šè°ƒç”¨findClass é‡è¦
  > public Class<?> loadClass(String name) 
  > // ç”±ç±»åŠ è½½å™¨å­ç±»å®ç°,è·å–äºŒè¿›åˆ¶æ•°æ®è°ƒç”¨defineClass ï¼Œæ¯”å¦‚URLClassLoaderä¼šæ ¹æ®æ–‡ä»¶è·¯å¾„å»è·å–ç±»æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®ã€‚é‡è¦
  > protected Class<?> findClass(String name)
  > // åšä¸€äº›ç±»åçš„æ ¡éªŒï¼Œç„¶åè°ƒç”¨è™šæ‹Ÿæœºåº•å±‚çš„æ–¹æ³•å°†å­—èŠ‚ç ä¿¡æ¯åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­
  > protected final Class<?> defineClass(String name, byte[] b, int off, int len)
  > // æ‰§è¡Œç±»ç”Ÿå‘½å‘¨æœŸä¸­çš„è¿æ¥é˜¶æ®µ
  > protected final void resolveClass(Class<?> c)
  > ```
  >
  > 

- åŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒä»£ç å°±æ˜¯ä½äºloadClassæ–¹æ³•ä¸­

- æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯å°†ä¸‹é¢loadClassæ–¹æ³•çš„ä»£ç é‡å†™

  > ```java
  > synchronized (getClassLoadingLock(name)) {
  >             // First, check if the class has already been loaded é¦–å…ˆæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½
  >             Class<?> c = findLoadedClass(name);
  >             if (c == null) {
  >                 long t0 = System.nanoTime();
  >                 try {
  >                     if (parent != null) {
  >                       // è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å»åŠ è½½
  >                         c = parent.loadClass(name, false);
  >                     } else {
  >                         c = findBootstrapClassOrNull(name);
  >                     }
  >                 } catch (ClassNotFoundException e) {
  >                     // ClassNotFoundException thrown if class not found
  >                     // from the non-null parent class loader
  >                 }
  >               
  >               if (c == null) {
  >                     // If still not found, then invoke findClass in order
  >                     // to find the class. å¦‚æœçˆ¶ç±»åŠ è½½ä¸äº† å°±è‡ªå·±æ¥åŠ è½½
  >                     long t1 = System.nanoTime();
  >                     c = findClass(name);
  > 
  >                     // this is the defining class loader; record the stats
  >                     sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
  >                     sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
  >                     sun.misc.PerfCounter.getFindClasses().increment();
  >                 }
  > ```

è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»ä¸ºä»€ä¹ˆæ˜¯Application ClassLoaderï¼Ÿ

![image-20240115115419865](./img/60.png)

- JDK8ä¸ºä¾‹ï¼ŒClassLoaderç±»ä¸­æä¾›äº†æ„é€ æ–¹æ³•è®¾ç½®parentå†…å®¹ï¼š

  > ![image-20240115115850304](./img/61.png)
  >
  
- è¿™ä¸ªæ„é€ æ–¹æ³•ç”±å¦ä¸€ä¸ªæ„é€ æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­çˆ¶ç±»åŠ è½½å™¨ç”±get SystemClassLoaderæ–¹æ³•è®¾ç½®ã€‚è¯¥æ–¹æ³•è¿”å›çš„æ˜¯Application ClassLoader

> ![image-20240115120137650](./img/62.png)



**ä¸¤ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ç›¸åŒé™å®šçš„ç±»ï¼Œä¸ä¼šå†²çªï¼Ÿï¼Ÿ**

- ä¸ä¼šå†²çªï¼Œåœ¨åŒä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸­ï¼Œåªæœ‰**ç›¸åŒç±»åŠ è½½å™¨+ç›¸åŒçš„ç±»é™å®šå**æ‰ä¼šè¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªç±»

- åœ¨Arthasä¸­ä½¿ç”¨sc -dã€‚classpath å¯ä»¥æŸ¥çœ‹å…·ä½“æƒ…å†µ

  > â€‹	![image-20240115122551265](./img/63.png)

- æ­£ç¡®çš„å»å®ç°ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ–¹å¼æ˜¯é‡å†™**findClass**æ–¹æ³•ï¼Œè¿™æ ·ä¸ä¼šç ´ååŒäº²å§”æ´¾æœºåˆ¶ã€‚

  > ![image-20240115122814322](./img/64.png)



##### çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨

- JDBCä½¿ç”¨äº†DriverManageræ¥ç®¡ç†é¡¹ç›®ä¸­å¼•å…¥çš„ä¸åŒæ•°æ®åº“çš„é©±åŠ¨ï¼Œæ¯”å¦‚mysqlé©±åŠ¨ã€oracleé©±åŠ¨

  > ![image-20240115132802106](./img/65.png)

- DriverManagerä½äºrt.jaråŒ…ä¸­ï¼Œç”±Bootstrap ClassLoaderåŠ è½½çš„

  > ![image-20240115133058064](./img/66.png)

- DriverManagerä½äºrt.jaråŒ…ä¸­ï¼Œç”±**Bootstrap ClassLoader**åŠ è½½ã€‚è€Œç”¨æˆ·jaråŒ…ä¸­çš„é©±åŠ¨éœ€è¦ç”¨**Application ClassLoader**æ¥åŠ è½½ï¼Œè¿™ä¸ªå°±è¿åäº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚

  > ![image-20240115133243345](./img/67.png)



###### **SPIæœºåˆ¶**

- SPIå…¨ç§°ä¸ºï¼ˆService Provider Interfaceï¼‰ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœåŠ¡

- â­ï¸â€¼ï¸SPIçš„**å·¥ä½œåŸç†**ï¼š

  > 1. **é©±åŠ¨jaråŒ…-------åœ¨ClassPathè·¯å¾„ä¸‹çš„META-INFO/servicesæ–‡ä»¶å¤¹ä¸­ï¼Œä»¥æ¥å£çš„å…¨é™åæ¥å‘½åæ–‡ä»¶å¤¹ï¼Œå¯¹åº”çš„æ–‡ä»¶é‡Œé¢å†™è¯¥æ¥å£çš„å®ç°**
  >
  >    ![image-20240115134137351](./img/68.png)
  >
  > 2. **ä½¿ç”¨ServiceLoaderåŠ è½½å®ç°ç±»---- DriverManageråŠ è½½çš„æ˜¯æœ‰ä¸ªé™æ€åˆå§‹åŒ–çš„æ–¹æ³• åŠ è½½é©±åŠ¨**
  >
  >    ![image-20240115134352644](./img/69.png)

- **DriverManagerä½¿ç”¨SPIæœºåˆ¶ï¼Œæœ€ç»ˆåŠ è½½jaråŒ…ä¸­å¯¹åº”çš„é©±åŠ¨ç±»**

  > ![image-20240115135346665](./img/70.png)



**JDBCæ¡ˆä¾‹æ€»ç»“**

- Bootstrap ClassLoader Load DriveManager
- åœ¨åˆå§‹åŒ–DriveManagerçš„æ—¶å€™ï¼Œé€šè¿‡SPIæœºåˆ¶åŠ è½½jaråŒ…ä¸­çš„mysqlé©±åŠ¨
- SPIåˆ©ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThreadContextClassLoaderï¼‰ å»åŠ è½½å¹¶åˆ›å»ºå¯¹è±¡
- è¿™ç§ç”±BootStrap ClassLoaderåŠ è½½çš„ç±»ï¼Œå§”æ´¾Application ClassLoaderå»åŠ è½½ç±»çš„æ–¹å¼ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶

![image-20240115140152864](./img/71.png)

> Java æä¾›äº†å¾ˆå¤šæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºè¿™äº›æ¥å£æä¾›å®ç°ã€‚å¸¸è§çš„ SPI æœ‰ JDBCã€JCEã€JNDIã€JAXP å’Œ JBI ç­‰ã€‚
>
> è¿™äº› SPI çš„æ¥å£ç”± Java æ ¸å¿ƒåº“æ¥æä¾›ï¼Œè€Œè¿™äº› SPI çš„å®ç°ä»£ç åˆ™æ˜¯ä½œä¸º Java åº”ç”¨æ‰€ä¾èµ–çš„ jar åŒ…è¢«åŒ…å«è¿›ç±»è·¯å¾„ï¼ˆCLASSPATHï¼‰é‡Œã€‚SPIæ¥å£ä¸­çš„ä»£ç ç»å¸¸éœ€è¦åŠ è½½å…·ä½“çš„å®ç°ç±»ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒSPIçš„æ¥å£æ˜¯Javaæ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ç”±**å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap Classloader)æ¥åŠ è½½çš„ï¼›SPIçš„å®ç°ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨(System ClassLoader)**æ¥åŠ è½½çš„ã€‚å¼•å¯¼ç±»åŠ è½½å™¨æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºä¾ç…§åŒäº²å§”æ´¾æ¨¡å‹ï¼ŒBootstrapClassloaderæ— æ³•å§”æ´¾AppClassLoaderæ¥åŠ è½½ç±»ã€‚
>
> è€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ç ´åäº†â€œåŒäº²å§”æ´¾æ¨¡å‹â€ï¼Œå¯ä»¥åœ¨æ‰§è¡Œçº¿ç¨‹ä¸­æŠ›å¼ƒåŒäº²å§”æ´¾åŠ è½½é“¾æ¨¡å¼ï¼Œä½¿ç¨‹åºå¯ä»¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ã€‚



**JDBCæ¡ˆä¾‹ä¸­çœŸçš„æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶å—ï¼Ÿï¼Ÿ**

- **æ‰“ç ´äº†**

  > è¿™ç§ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œå§”æ´¾åº”ç”¨ç¨‹åºåŠ è½½å™¨å»åŠ è½½ç±»çš„æ–¹å¼ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶

- **æ²¡æœ‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶**

  > ***JDBCåªæ˜¯åœ¨DriverManageråŠ è½½å®Œä¹‹åï¼Œé€šè¿‡åˆå§‹åŒ–é˜¶æ®µè§¦å‘äº†é©±åŠ¨ç±»çš„åŠ è½½ï¼Œç±»çš„åŠ è½½ä¾ç„¶éµå¾ªåŒäº²å§”æ´¾æœºåˆ¶***



##### Osgiæ¡†æ¶çš„ç±»åŠ è½½å™¨

- å†å²ä¸Šï¼ŒOSGIæ¨¡å—åŒ–æ¡†æ¶ã€‚å®ƒå­˜åœ¨åŒçº§ä¹‹é—´çš„ç±»åŠ è½½å™¨çš„å§”æ‰˜åŠ è½½ã€‚OSGIè¿˜ä½¿ç”¨ç±»åŠ è½½å™¨å®ç°äº†**çƒ­éƒ¨ç½²**çš„åŠŸèƒ½

  > ![image-20240115142121335](./img/72.png)

- çƒ­éƒ¨ç½²æŒ‡çš„æ˜¯åœ¨æœåŠ¡ä¸åœæ­¢çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°æ›´æ–°å­—èŠ‚ç æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚





**ä½¿ç”¨Arthasä¸åœæœºè§£å†³çº¿ä¸Šé—®é¢˜**

> åªé€‚åˆæ”¹æå°‘æ•°ä»£ç ï¼Œå·²ç»ä¸èƒ½åœæœºçš„è¿™ç§æƒ…å†µ

**æ€è·¯:**

- åœ¨å‡ºé—®é¢˜çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²ä¸€ä¸ª arthasï¼Œå¹¶å¯åŠ¨ã€‚
- jad --source-only ç±»å…¨é™å®šå >ç›®å½•/æ–‡ä»¶åjavajad å‘½ä»¤åç¼–è¯‘ï¼Œç„¶åå¯ä»¥ç”¨å…¶å®ƒç¼–è¯‘å™¨ï¼Œæ¯”å¦‚ vim æ¥ä¿®æ”¹æºç 
- mc -c ç±»åŠ è½½å™¨çš„hashcode ç›®å½•/æ–‡ä»¶å.java -d è¾“å‡ºç›®å½•mc å‘½ä»¤ç”¨æ¥ç¼–è¯‘ä¿®æ”¹è¿‡çš„ä»£ç 
- retransform classæ–‡ä»¶æ‰€åœ¨ç›®å½•/xxx.classç”¨ retransform å‘½ä»¤åŠ è½½æ–°çš„å­—èŠ‚ç 

**æ³¨æ„äº‹é¡¹ï¼š**

- ç¨‹åºé‡å¯ä¹‹åï¼Œå­—èŠ‚ç æ–‡ä»¶ä¼šæ¢å¤ï¼Œé™¤éå°†classæ–‡ä»¶æ”¾å…¥jaråŒ…ä¸­è¿›è¡Œæ›´æ–°ã€‚
- ä½¿ç”¨retransformä¸èƒ½æ·»åŠ æ–¹æ³•æˆ–è€…å­—æ®µï¼Œä¹Ÿä¸èƒ½æ›´æ–°æ­£åœ¨æ‰§è¡Œä¸­çš„æ–¹æ³•





#### 4ï¼‰JDK9ä»¥åçš„ç±»åŠ è½½å™¨

- JDK8ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼ŒExtension ClassLoader å’ŒApplication ClassLoaderçš„æºç éƒ½æ˜¯ä½äºrt.jaråŒ…ä¸­çš„sun.misc.Launcher.java

  > ![image-20240115143630152](./img/73.png)

- JDK9å¼•å…¥ç±»moduleæ‰“æ¦‚å¿µï¼Œç±»åŠ è½½å™¨åœ¨è®¾è®¡ä¸Šå‘ç”Ÿäº†è®¸å¤šå˜åŒ–

  > 1. Bootstrap ClassLoaderä½¿ç”¨Javaç¼–å†™ï¼Œä½äºjdk.internnal.loader.ClassLoadersç±»ä¸­
  >
  >    Javaä¸­çš„BootClassLoaderå³æˆBuiltinClassLoaderå®ç°ä»æ¨¡å—ä¸­æ‰¾åˆ°è¦åŠ è½½çš„å­—èŠ‚ç èµ„æºæ–‡ä»¶ã€‚
  >
  >    **Bootstrap ClassLoaderä¾ç„¶æ— æ³•é€šè¿‡javaä»£ç è·å–åˆ°ï¼Œè¿”å›çš„ä»ç„¶æ˜¯nullï¼Œä¸ºäº†ä¿æŒç»Ÿä¸€ã€‚**
  >
  >    ![image-20240115144346647](./img/74.png)
  >
  > 2. Extension ClassLoader è¢«æ›¿æ¢æˆPlatform Class Loader ï¼ŒPlatform ClassLoaderéµå¾ªæ¨¡å—åŒ–çš„æ–¹å¼åŠ è½½å­—èŠ‚ç æ–‡ä»¶ï¼Œæ‰€ä»¥ç»§æ‰¿å…³ç³»ä»URLClassLoaderå˜æˆäº† BuiltinClassLoaderï¼ŒBuiltinClassLoaderå®ç°äº†ä»æ¨¡å—ä¸­åŠ è½½å­—èŠ‚ç æ–‡ä»¶ã€‚**Platform Class Loaderå­˜åœ¨çš„æ›´å¤šçš„æ˜¯ä¸è€ç‰ˆæœ¬çš„è®¾è®¡æ–¹æ¡ˆå…¼å®¹ï¼Œè‡ªèº«æ²¡æœ‰ç‰¹æ®Šçš„é€»è¾‘ã€‚**
  >
  >    ![image-20240115144708005](./img/75.png)

- æœ‰å‡ ç§åŠ è½½å™¨ï¼Ÿ

  > 1. å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader) åŠ è½½æ ¸å¿ƒç±»
  > 2. æ‰©å±•ç±»åŠ è½½å™¨ (Extension ClassLoader) åŠ è½½æ‰©å±•ç±»
  > 3. åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ (Application ClassLoader) åŠ è½½åº”ç”¨classpathä¸­çš„ç±»
  > 4. è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œé‡å†™findClassæ–¹æ³•
  > 5. JDK9åŠä¹‹åæ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader) å˜æˆäº†å¹³å°ç±»åŠ è½½å™¨(Platform ClassLoader)

  > **JDK8** 
  >
  > ![image-20240115144925651](./img/76.png)
  > 

  

---



##  3.JVMçš„å†…å­˜åŒºåŸŸ

> å°±æ˜¯è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆJVMç®¡ç†çš„å†…å­˜ï¼‰
>
> ![image-20240114202018548](./img/77.png)

ä¸»è¦åˆ†ä¸ºå››éƒ¨åˆ†

- ç¨‹åºè®¡æ•°å™¨
- æ ˆ
- å †
- æ–¹æ³•åŒº
- **ç›´æ¥å†…å­˜ï¼ˆä¸å±äºJVMç®¡ç†çš„ï¼‰**



### è¿è¡Œæ—¶æ•°æ®åŒº

- Javaè™šæ‹Ÿæœºåœ¨è¿è¡ŒJavaç¨‹åºè¿‡ç¨‹ä¸­ç®¡ç†çš„å†…å­˜åŒºåŸŸï¼Œç§°ä¹‹ä¸ºè¿è¡Œæ—¶æ•°æ®åŒº
- ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­è§„èŒƒäº†æ¯ä¸€éƒ¨åˆ†çš„ä½œç”¨ã€‚

![image-20240115171340438](./img/78.png)





#### 1ï¼‰ç¨‹åºè®¡æ•°å™¨-Program Counter

- ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Register ï¼‰ä¹Ÿå«PCå¯„å­˜å™¨ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šé€šè¿‡ç¨‹åºè®¡æ•°å™¨**è®°å½•å½“å‰è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€**

  > ![image-20240115172103211](./img/79.png)

  

- åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºè®¡æ•°å™¨**ä¼šè®°å½•ä¸‹ä¸€è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€**ã€‚æ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤ä¹‹åï¼Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“ä¼šæ ¹æ®**ç¨‹åºè®¡æ•°å™¨**æ‰§è¡Œä¸‹ä¸€è¡ŒæŒ‡ä»¤ã€‚

**æ¡ˆä¾‹ï¼š**

![image-20240115172549040](./img/80.png)

![image-20240115172628629](./img/82.png)

> ğŸŒŸğŸŒŸ**ç¨‹åºè®¡æ•°å™¨ä¼šè®°ä½ä¸‹ä¸€è¡Œåç§»é‡çš„å†…å­˜åœ°å€ï¼Œæ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ®åœ°å€æ‰¾åˆ°ä¸‹ä¸€è¡ŒæŒ‡ä»¤ã€‚**

- åœ¨å¤šçº¿ç¨‹æ‰§è¡Œæƒ…å†µä¸‹ï¼ŒJavaè™šæ‹Ÿæœºéœ€è¦é€šè¿‡ç¨‹åºè®¡æ•°å™¨è®°å½•CPU**åˆ‡æ¢å‰è§£é‡Šæ‰§è¡Œåˆ°é‚£ä¸€å¥æŒ‡ä»¤**å¹¶ç»§ç»­è¿è¡Œ

  > å…ˆæ‰§è¡Œçº¿ç¨‹Aï¼Œå¯åŠ¨ä¸€ä¸ªå¤šçº¿ç¨‹æ‰§è¡Œçº¿ç¨‹Bï¼ˆé‚£ä¹ˆAçº¿ç¨‹çš„ç¨‹åºè®¡æ•°å™¨å°±ä¼šè®°å½•å½“å‰Aæ‰€æ‰§è¡Œçš„å†…å­˜åœ°å€æˆ–è€…è¯´åç§»é‡ï¼‰ï¼Œé‚£ä¹ˆå½“Aç­‰å¾…çš„æ—¶å€™ï¼ŒBæ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œå¼€å§‹æ‰§è¡ŒAäº†ï¼Œé‚£ä¹ˆAçº¿ç¨‹å°±ä¼šç§°ç¨‹åºè®¡æ•°å™¨ä¸­æ‰¾åˆ°å†…å­˜åœ°å€ç»§ç»­æ‰§è¡Œã€‚
  >
  > ![image-20240115194819932](./img/81.png)





**é—®é¢˜ï¼š**

ç¨‹åºè®¡æ•°å™¨åœ¨è¿è¡Œä¸­ä¼šå‡ºç°å†…å­˜æº¢å‡ºå—ï¼Ÿ

- å†…å­˜æº¢å‡ºæŒ‡çš„æ˜¯ç¨‹åºåœ¨ä½¿ç”¨æŸä¸€å—å†…å­˜åŒºåŸŸçš„æ—¶ï¼Œå­˜æ”¾çš„æ•°æ®éœ€è¦å ç”¨çš„å†…å­˜å¤§å°è¶…è¿‡äº†è™šæ‹Ÿæœºèƒ½æä¾›çš„å†…å­˜ä¸Šé™
- å› ä¸ºæ¯ä¸ªçº¿ç¨‹åªå­˜å‚¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å†…å­˜åœ°å€ï¼Œ**ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºçš„ã€‚**
- ç¨‹åºå‘˜æ— éœ€å¯¹ç¨‹åºè®¡æ•°å™¨åšä»»ä½•å¤„ç†







#### 2ï¼‰æ ˆ-Stack

Javaè™šæ‹Ÿæœºæ ˆï¼ˆJava Virtual Machine Stackï¼‰é‡‡ç”¨**æ ˆçš„æ•°æ®ç»“æ„æ¥ç®¡ç†è°ƒç”¨ä¸­çš„åŸºæœ¬æ•°æ®**ï¼Œ**å…ˆè¿›åå‡º**ï¼ˆfirst in last outï¼‰ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨ä½¿ç”¨ä¸€ä¸ªæ ˆå¸§æ¥ï¼ˆStack Frameï¼‰æ¥ä¿å­˜ã€‚

![image-20240115204105545](./img/83.png)

**ä½¿ç”¨IDEAæ¥debugçš„æ—¶å€™ï¼Œæ‰“æ–­ç‚¹å¯ä»¥æŸ¥çœ‹å¯¹åº”çš„æ ˆå¸§**

![image-20240115204327960](./img/84.png)

**å½“æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼Œä¹Ÿä¼šä¸€ä¸ªä¸ªé€€å‡ºæ ˆå¸§ã€‚æ—¥å¿—ä¸­ä¼šæ˜¾ç¤ºã€‚**

![image-20240115204546036](./img/85.png)



- **Javaè™šæ‹Ÿæœºæ ˆéšç€çº¿ç¨‹åˆ›å»ºè€Œåˆ›å»ºï¼Œè€Œå›æ”¶åˆ™ä¼šåœ¨çº¿ç¨‹çš„é”€æ¯æ—¶è¿›è¡Œ**ã€‚ç”±äºæ–¹æ³•å¯èƒ½ä¼šåœ¨ä¸åŒçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåŒ…å«ä¸€ä¸ªè‡ªå·±çš„è™šæ‹Ÿæœºæ ˆã€‚

  > ![image-20240115213826204](./img/86.png)



**æ ˆå¸§çš„ç»„æˆ**

- **å±€éƒ¨å˜é‡è¡¨**

  > å±€éƒ¨å˜é‡è¡¨çš„ä½œç”¨æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­**å­˜æ”¾æ‰€æœ‰çš„å±€éƒ¨å˜é‡**

- **æ“ä½œæ•°æ ˆ**

  > æ“ä½œæ•°æ ˆæ—¶æ ˆå¸§ä¸­è™šæ‹Ÿæœºåœ¨æ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ç”¨æ¥**å­˜æ”¾ä¸´æ—¶æ•°æ®**çš„ä¸€å—åŒºåŸŸ

- **å¸§æ•°æ®**

  > å¸§æ•°æ®ä¸»è¦åŒ…å«åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ã€å¼‚å¸¸è¡¨çš„å¼•ç”¨



###### å±€éƒ¨å˜é‡è¡¨

- å±€éƒ¨å˜é‡è¡¨çš„ä½œç”¨æ˜¯åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å­˜æ”¾æ‰€æœ‰çš„å±€éƒ¨å˜é‡ã€‚ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶æ—¶å°±å¯ä»¥ç¡®å®šå±€éƒ¨å˜é‡è¡¨çš„å†…å®¹

  > ```java
  > public static void test() {
  >         int i = 0;
  >         int j = 1;
  >     }
  > ```
  >
  > å­—èŠ‚ç æŒ‡ä»¤ï¼š
  >
  > ```bytecode
  > 0 iconst_0
  > 1 istore_0
  > 2 iconst_1
  > 3 istore_1
  > 4 return
  > ```
  >
  > ![image-20240115215016115](./img/87.png)
  >
  > Strat PC ä»ç¬¬ç¬¬ä¸€è¡Œå¼€å§‹ä¾‹å¦‚ i=0 é‚£ä¹ˆå°±æ˜¯**1 istore_0**

- æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ**æ•°ç»„ä¸­æ¯ä¸€ä¸ªä½ç½®ç§°ä¹‹ä¸ºæ§½ï¼ˆslotï¼‰**ï¼Œ***Long*å’Œ*Double*ç±»å‹å ç”¨ä¸¤ä¸ªæ§½**ï¼Œå…¶ä»–ç±»å‹å ç”¨ä¸€ä¸ªæ§½ã€‚

  > Code:
  >
  > ```java
  >  public static void test() {
  >         int i = 0;
  >         long j = 1;
  >         int k = 2;
  >     }
  > ```
  >
  > ![222](./img/88.png)
  >
  > 

**ä¸ºä»€ä¹ˆä¸èƒ½åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨thisï¼Ÿ**

> ğŸŒŸâ€¼ï¸**å¦‚æœè¯¥æ–¹æ³•æ˜¯staticçš„ï¼Œé‚£ä¹ˆä¸èƒ½åœ¨è¯¥æ–¹æ³•ä¸­ä½¿ç”¨thisï¼Œå› ä¸ºthisä»£è¡¨å®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆstaticéšç€ç±»åŠ è½½è€ŒåŠ è½½ï¼Œå…ˆäºå®ä¾‹ä¹‹å‰å°±åˆ›å»ºäº†ï¼Œä¸å­˜åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨**	



- æ–¹æ³•å‚æ•°ä¹Ÿä¼šä¿å­˜åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå…¶é¡ºåºä¸æ–¹æ³•ä¸­å‚æ•°å®šä¹‰çš„é¡ºåºä¸€è‡´

- å±€éƒ¨å˜é‡è¡¨ä¿å­˜çš„å†…å®¹æœ‰ï¼š**å®ä¾‹æ–¹æ³•çš„thiså¯¹è±¡æ°¸è¿œåœ¨ç¬¬ä¸€ä½**ï¼Œæ–¹æ³•çš„å‚æ•°ï¼Œæ–¹æ³•ä½“ä¸­å£°æ˜çš„å±€éƒ¨å˜é‡ã€‚

  > ![image-20240115221651156](./img/89.png)

- ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œå±€éƒ¨**å˜é‡è¡¨ä¸­çš„æ§½æ˜¯å¯ä»¥å¤ç”¨çš„**ï¼Œä¸€æ—¦æŸä¸ªå±€éƒ¨å˜é‡ä¸å†ç”Ÿæ•ˆï¼Œå½“å‰æ§½å°±å¯ä»¥å†æ¬¡è¢«ä½¿ç”¨

  > ```
  >  0 iconst_0
  >  1 istore_3
  >  2 iconst_1
  >  3 istore 4
  >  5 iconst_1
  >  6 istore_3
  >  7 iconst_0
  >  8 istore_3
  >  9 iconst_1
  > 10 istore 4
  > 12 return
  > ```
  >
  > ![image-20240115222933173](./img/92.png)
  >
  > **å±€éƒ¨å˜é‡è¡¨**
  >
  > | this | k    | m    | ç¬¬ä¸€æ¬¡å­˜aã€ç¬¬äºŒæ¬¡çš„æ—¶å€™å­˜äº†c | ç¬¬ä¸€æ¬¡å­˜b ç¬¬äºŒæ¬¡å­˜äº†i | j    |
  > | ---- | ---- | ---- | ---------------------------- | --------------------- | ---- |
  > | 0    | 1    | 2    | 3                            | 4                     | 5    |



###### **æ“ä½œæ•°æ ˆ**

- æ“ä½œæ•°æ ˆæ˜¯æ ˆå¸§ä¸­è™šæ‹Ÿæœºåœ¨æ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ç”¨æ¥å­˜æ”¾ä¸­é—´æ•°æ®çš„ä¸€å—åŒºåŸŸã€‚ä»–æ˜¯ä¸€ç§æ ˆå¼çš„æ•°æ®ç»“æ„ï¼Œå¦‚æœä¸€æ¡æŒ‡ä»¤å°†ä¸€ä¸ªå€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œåˆ™åé¢çš„æŒ‡ä»¤å¯ä»¥å¼¹å‡ºå¹¶ä½¿ç”¨è¯¥å€¼ã€‚

- åœ¨**ç¼–è¯‘æœŸ**å°±å¯ä»¥ç¡®å®šæ“ä½œæ•°æ ˆçš„æœ€å¤§æ·±åº¦ï¼Œä»è€Œåœ¨æ‰§è¡Œæ—¶æ­£ç¡®çš„åˆ†é…å†…å­˜å¤§å°ã€‚

  > ![image-20240115224125924](./img/90.png)
  >
  > ```
  > 0 iconst_0
  > 1 istore_3
  > 2 iload_3
  > 3 iconst_1
  > 4 iadd
  > 5 istore 4
  > 7 return
  > ```
  >
  > ![image-20240115224442814](./img/91.png)
  >
  > > å…ˆå…¥æ ˆä¸º0 ï¼Œç„¶ååœ¨å…¥æ ˆ1 ç„¶åæ“ä½œæ•°æ ˆç›´æ¥ç›¸åŠ å˜æˆ1ï¼Œç„¶ååœ¨å­˜å‚¨å±€éƒ¨å˜é‡è¡¨ä¸­jä¸º1
  >



###### å¸§æ•°æ®

> åŒ…å«äº†ä¸‰éƒ¨åˆ†ï¼š
>
> 1. åŠ¨æ€é“¾æ¥
> 2. æ–¹æ³•å‡ºå£
> 3. å¼‚å¸¸è¡¨

- **åŠ¨æ€é“¾æ¥**  å½“å‰ç±»çš„å­—èŠ‚ç æŒ‡ä»¤å¼•ç”¨äº†å…¶ä»–ç±»çš„å±æ€§æˆ–è€…æ–¹æ³•æ—¶ï¼Œéœ€è¦å°†ç¬¦å·å¼•ç”¨ï¼ˆç¼–å·ï¼‰è½¬æ¢å¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„å†…å­˜åœ°å€ã€‚**åŠ¨æ€é“¾æ¥å°±ä¿å­˜äº†ç¼–å·åˆ°å¸¸é‡æ± çš„å†…å­˜åœ°å€çš„æ˜ å°„å…³ç³»ã€‚**

  > ![image-20240116111155940](./img/93.png)
  >
  > Aç±»è°ƒç”¨Bç±»çš„æ–¹æ³•
  >
  > ![image-20240116111412111](./img/94.png)

- **æ–¹æ³•å‡ºå£**æŒ‡çš„æ˜¯æ–¹æ³•åœ¨æ­£ç¡®æˆ–è€…å¼‚å¸¸ç»“æŸçš„æ—¶å€™ã€‚å½“å‰æ ˆå¸§ä¼šè¢«å¼¹å‡ºï¼ŒåŒæ—¶ç¨‹åºè®¡æ•°å™¨åº”è¯¥æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æ‰€ä»¥åœ¨å½“å‰æ ˆå¸§ä¸­ï¼Œ**éœ€è¦å­˜å‚¨æ­¤æ–¹æ³•å‡ºå£çš„åœ°å€ã€‚**

  > ![image-20240116111638106](./img/95.png)

- **å¼‚å¸¸è¡¨å­˜**æ”¾çš„æ˜¯**ä»£ç ä¸­å¼‚å¸¸çš„å¤„ç†ä¿¡æ¯**ï¼ŒåŒ…å«äº†tryä»£ç å—å’Œcatchä»£ç å—æ‰§è¡Œåè·³è½¬åˆ°åˆ°å­—èŠ‚ç æŒ‡ä»¤ä½ç½®

  > **Code:**
  >
  > ```java
  >  public void test() {
  >         try {
  >             int i = 0;
  >         } catch (Exception e) {
  >             int j = 1;
  >         } finally {
  >             int i = 2;
  >         }
  >     }
  > ```
  >
  > **å­—èŠ‚ç ï¼š**
  >
  > ```java
  >  0 iconst_0
  >  1 istore_1
  >  2 iconst_2
  >  3 istore_1
  >  4 goto 21 (+17)
  >  7 astore_1
  >  8 iconst_1
  >  9 istore_2
  > 10 iconst_2
  > 11 istore_1
  > 12 goto 21 (+9)
  > 15 astore_3
  > 16 iconst_2
  > 17 istore 4
  > 19 aload_3
  > 20 athrow
  > 21 return
  > ```
  >
  > å¼‚å¸¸çš„æ—¶å€™ï¼Œ **7 astore_1**
  >
  > ![image-20240116112027389](./img/96.png)



###### æ ˆå†…å­˜æº¢å‡º

- Javaè™šæ‹Ÿæœºæ ˆå¦‚æœæ ˆå¸§è¿‡å¤šï¼Œå ç”¨å†…å­˜è¶…è¿‡æ ˆå†…å­˜å¯ä»¥åˆ†é…åˆ°æœ€å¤§å¤§å°å°±ä¼šå‡ºç°å†…å­˜æº¢å‡ºã€‚

- Javaè™šæ‹Ÿæœºæ ˆå†…å­˜æº¢å‡ºæ—¶ä¼šåˆé€‰StackOverFlowErroråˆ°é”™è¯¯

  > **æ¨¡æ‹Ÿæ ˆå†…å­˜æº¢å‡º**
  >
  > ```java
  > public class Demo1 {
  >     private static AtomicInteger atomicInteger = new AtomicInteger();
  >     public static void main(String[] args) {
  >         test();
  >     }
  >     public static void test() {
  >         System.out.println(atomicInteger.incrementAndGet());
  >         test();
  >     }
  > }
  > ```
  >
  > **æº¢å‡ºæŠ¥é”™**
  >
  > ![image-20240116114043441](./img/97.png)

- å¦‚æœæˆ‘ä»¬ä¸æŒ‡å®šè™šæ‹Ÿæœºæ ˆçš„å¤§å°ï¼ŒJVMå°†åˆ›å»ºä¸€ä¸ªå…·æœ‰**é»˜è®¤å¤§å°çš„æ ˆ**ã€‚å¤§å°å–å†³äºæ“ä½œç³»ç»Ÿå’Œè®¡ç®—æœºçš„ä½“ç³»ç»“æ„ã€‚

  > ![image-20240116120758896](./img/98.png)
  >
  > ![image-20240116120808465](./img/99.png)
  >
  
  - ***ä¿®æ”¹Javaè™šæ‹Ÿæœºæ ˆçš„å¤§å°***
  
  > - **è¦ä¿®æ”¹Javaè™šæ‹Ÿæœºæ ˆçš„å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° -Xss**
  > - **è¯­æ³•ï¼š**-Xssæ ˆå¤§å°
  > - å•ä½ï¼šå­—èŠ‚ï¼ˆé»˜è®¤ï¼Œå¿…é¡»æ—¶1024çš„å€æ•°ï¼‰ï¼Œkæˆ–è€…Kï¼ˆKBï¼‰ï¼Œmæˆ–è€…Mï¼ˆMBï¼‰ï¼Œgæˆ–è€…Gï¼ˆGBï¼‰
  >
  > æ¡ˆä¾‹ï¼š
  >
  > ![image-20240116121201155](./img/100.png)
  >
  > ![image-20240116121352005](./img/101.png)

**ğŸŒŸğŸŒŸTipsï¼š**

1. ä¸-Xssç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨-XX:ThreadStackSizeè°ƒæ•´æ ‡å¿—æ¥é…ç½®å †æ ˆå¤§å°ï¼Œæ ¼å¼-XX:ThreadStackSize=1024

2. HotSpot JVMå¯¹æ ˆå¤§å°çš„æœ€å¤§å€¼å’Œæœ€å°å€¼æœ‰è¦æ±‚ï¼š

   > æ¯”å¦‚æµ‹è¯•å¦‚ä¸‹ä¸¤ä¸ªå‚æ•° -Xss1k     -Xss1025mã€‚  Windowsï¼ˆ64ï¼‰ä¸‹çš„JDK8æµ‹è¯•ä¸‹æœ€å°å€¼ä¸º180kï¼Œæœ€å¤§å€¼ä¸º1024m

3. å±€éƒ¨å˜é‡è¿‡å¤šã€æ“ä½œæ•°æ ˆæ·±åº¦è¿‡å¤§ä¹Ÿä¼šå½±å“æ ˆå†…å­˜çš„å¤§å°

   > ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå·¥ä½œä¸­å³ä¾¿ä½¿ç”¨äº†é€’å½’è¿›è¡Œæ“ä½œï¼Œæ ˆçš„æ·±åº¦æœ€å¤šä¹Ÿåªèƒ½åˆ°å‡ ç™¾,ä¸ä¼šå‡ºç°æ ˆçš„æº¢å‡ºã€‚æ‰€ä»¥æ­¤å‚æ•°å¯ä»¥æ‰‹åŠ¨æŒ‡å®šä¸º-Xss256kèŠ‚çœå†…å­˜



###### **æœ¬åœ°æ–¹æ³•æ ˆ**

- Javaè™šæ‹Ÿæœºæ ˆå­˜å‚¨äº†Javaæ–¹æ³•è°ƒç”¨æ—¶çš„æ ˆå¸§ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆå­˜å‚¨çš„æ˜¯**nativeæœ¬åœ°æ–¹æ³•çš„æ ˆå¸§ã€‚**

- åœ¨Hotspotè™šæ‹Ÿæœºä¸­ï¼Œ**Javaè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆå®ç°ä½¿ç”¨äº†åŒä¸€ä¸ªæ ˆç©ºé—´ã€‚**æœ¬åœ°æ–¹æ³•æ ˆä¼šåœ¨æ ˆå†…å­˜ä¸Šç”Ÿæˆä¸€ä¸ªæ ˆå¸§ï¼Œä¸´æ—¶ä¿å­˜æ–¹æ³•çš„å‚æ•° åŒæ—¶æ–¹ä¾¿å‡ºç°å¼‚å¸¸æ—¶ä¹ŸæŠŠæœ¬åœ°æ–¹æ³•çš„æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚

  > ![image-20240116132525420](./img/102.png)





#### 3ï¼‰å †-Heap

- ä¸€èˆ¬Javaç¨‹åºä¸­å †å†…å­˜æ˜¯ç©ºé—´æœ€å¤§çš„ä¸€å—å†…å­˜åŒºåŸŸã€‚**åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡éƒ½å­˜äºå †ä¸Šã€‚****æ˜¯çº¿ç¨‹å…±äº«çš„ã€‚**

- æ ˆä¸Šçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå¯ä»¥å­˜æ”¾å †ä¸Šå¯¹è±¡çš„å¼•ç”¨ã€‚é™æ€å˜é‡ä¹Ÿå¯ä»¥å­˜æ”¾å †å¯¹è±¡çš„å¼•ç”¨ï¼Œé€šè¿‡é™æ€å˜é‡å°±å¯ä»¥å®ç°å¯¹è±¡åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚

  > ![image-20240116224330000](./img/103.png)



##### **æ¨¡æ‹ŸHeap å†…å­˜æº¢å‡º**

> å½“heapå†…å­˜è¾¾åˆ°ä¸Šé™çš„æ—¶å€™ï¼Œå°±ä¼š**OutOfMemoryError**
>
> ![image-20240116224756337](./img/104.png)

- Heap Spaceæœ‰ä¸ªä¸‰ä¸ªéœ€è¦å…³æ³¨çš„å€¼ï¼Œ**usedã€totalã€max**

  > **used**æŒ‡çš„æ˜¯å½“å‰å·²ä½¿ç”¨çš„å †å†…å­˜ï¼Œ**total**æ˜¯Javaè™šæ‹Ÿæœºå·²ç»åˆ†é…çš„å¯ç”¨å †å†…å­˜ï¼Œ**max**æ˜¯Javaè™šæ‹Ÿæœºå¯ä»¥åˆ†é…çš„æœ€å¤§å†…å­˜ã€‚
  >
  > ![image-20240116225034573](./img/105.png)

- éšç€å †ä¸­å¯¹è±¡å¢å¤šï¼Œå½“totalå¯ä»¥ä½¿ç”¨çš„å†…å­˜å³å°†ä¸è¶³æ—¶ï¼Œjavaè™šæ‹Ÿæœºä¼šç»§ç»­åˆ†é…å†…å­˜ç©ºé—´ç»™å †ã€‚

  > ![image-20240116225207282](./img/106.png)

- å¦‚æœheapå‘¢å­˜ä¸è¶³ï¼ŒJavaè™šæ‹Ÿæœºå°±ä¼šä¸æ–­çš„åˆ†é…å†…å­˜ï¼Œtotalå€¼ä¼šå˜å¤§ã€‚totalæœ€å¤šåªèƒ½ä¸maxç›¸ç­‰ã€‚

  > ![image-20240116225318963](./img/107.png)

**Arthasè§‚å¯Ÿå†…å­˜å˜åŒ–**

> dashboard -i 2000
>
> å‘ç°usageé€æ¸å¢åŠ  ç›´è‡³å´©æºƒ
>
> ![image-20240116231500344](./img/108.png)

**é—®é¢˜ï¼š**

æ˜¯ä¸æ˜¯å½“used=max=totalçš„æ—¶å€™ï¼Œå †å†…å­˜å°±æº¢å‡ºï¼Ÿ

> ä¸æ˜¯ï¼Œå †å†…å­˜æº¢å‡ºçš„åˆ¤æ–­æ¡ä»¶æ¯”è¾ƒå¤æ‚

- Heapè®¾ç½®å¤§å°

  > è¦ä¿®æ”¹heapçš„å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° **-Xmxï¼ˆmaxæœ€å¤§å€¼ï¼‰å’Œ-Xmsï¼ˆåˆå§‹çš„totalï¼‰**
  >
  > - å•ä½ï¼šå­—èŠ‚ï¼ˆé»˜è®¤ï¼Œå¿…é¡»æ—¶1024çš„å€æ•°ï¼‰ï¼Œkæˆ–è€…Kï¼ˆKBï¼‰ï¼Œmæˆ–è€…Mï¼ˆMBï¼‰ï¼Œgæˆ–è€…Gï¼ˆGBï¼‰
  > - é™åˆ¶Xmxå¿…é¡»å¤§äº 2MBï¼ŒXmså¿…é¡»å¤§äº1MB
  >
  > 
  >
  > JVMå‚æ•°ï¼š
  >
  > ![image-20240116233023924](./img/109.png)
  >
  > Arthasçš„dashboardï¼š
  >
  > ![image-20240116232932649](./img/110.png)

  

  **é—®é¢˜ï¼Ÿ**

  ä¸ºä»€ä¹ˆarthasä¸­æ˜¾ç¤ºçš„heapå †å¤§å°ä¸è®¾ç½®çš„å€¼ä¸ä¸€æ ·å‘¢?

  > arthasä¸­çš„heapå †å†…å­˜ä½¿ç”¨äº†JMXæŠ€æœ¯ä¸­å†…å­˜è·å–æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸åƒåœ¾å›æ”¶å™¨æœ‰å…³ï¼Œè®¡ç®—çš„æ˜¯å¯ä»¥åˆ†é…å¯¹è±¡çš„å†…å­˜ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå†…å­˜ã€‚

- JavaæœåŠ¡ç«¯ç¨‹åºå¼€å‘æ—¶ï¼Œ**å»ºè®®å°†-Xmxå’Œ-Xmsè®¾ç½®ä¸ºç›¸åŒçš„å€¼**ï¼Œè¿™æ ·åœ¨ç¨‹åºå¯åŠ¨ä¹‹åå¯ä½¿ç”¨çš„æ€»å†…å­˜å°±æ˜¯æœ€å¤§å†…å­˜ï¼Œè€Œæ— éœ€å‘javaè™šæ‹Ÿæœºå†æ¬¡ç”³è¯·ï¼Œå‡å°‘äº†ç”³è¯·å¹¶åˆ†é…å†…å­˜æ—¶é—´ä¸Šçš„å¼€é”€ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šå‡ºç°å†…å­˜è¿‡å‰©ä¹‹åå †æ”¶ç¼©çš„æƒ…å†µã€‚

  > ![image-20240116233233354](./img/111.png)



#### 4ï¼‰æ–¹æ³•åŒº-Method Area

æ–¹æ³•åŒºæ˜¯å­˜æ”¾**åŸºç¡€ä¿¡æ¯çš„ä½ç½®ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„**ï¼Œä¸»è¦åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼š

- **ç±»çš„å…ƒä¿¡æ¯**--ä¿å­˜äº†æ‰€æœ‰ç±»çš„åŸºæœ¬ä¿¡æ¯
- **è¿è¡Œæ—¶å¸¸é‡æ± **--ä¿å­˜äº†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å¸¸é‡æ± å†…å®¹
- **å­—ç¬¦ä¸²å¸¸é‡æ± **--ä¿å­˜äº†å­—ç¬¦ä¸²å¸¸é‡æ± 



###### ç±»çš„å…ƒä¿¡æ¯

- æ–¹æ³•åŒºæ˜¯ç”¨æ¥å­˜å‚¨**æ¯ä¸ªç±»çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå…ƒä¿¡æ¯ï¼‰**ï¼Œä¸€èˆ¬ç§°ä¹‹ä¸ºInstanceKlasså¯¹è±¡ã€‚åœ¨ç±»çš„**åŠ è½½é˜¶æ®µ**å®Œæˆã€‚

  > ![image-20240117103656855](./img/112.png)



###### è¿è¡Œæ—¶å¸¸é‡æ± 

- æ–¹æ³•åŒºé™¤äº†å­˜å‚¨ç±»çš„å…ƒä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜å­˜æ”¾äº†è¿è¡Œæ—¶å¸¸é‡æ± ã€‚**å¸¸é‡æ± ä¸­å­˜æ”¾çš„æ˜¯å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± å†…å®¹ã€‚**

- å­—èŠ‚ç æ–‡ä»¶ä¸­é€šè¿‡ç¼–å·æŸ¥è¡¨çš„æ–¹æ³•æ‰¾åˆ°å¸¸é‡ï¼Œè¿™ç§å¸¸é‡æ± ç§°ä¸º**é™æ€å¸¸é‡æ± **ã€‚å½“é‡æ± åŠ è½½å†…å­˜ä¸­ä¹‹åï¼Œå¯ä»¥é€šè¿‡å†…å­˜åœ°å€å¿«é€Ÿçš„å®šä½åˆ°å¸¸é‡æ± ä¸­çš„å†…å®¹ï¼Œè¿™ç§å¸¸é‡æ± ç§°ä¸º**è¿è¡Œæ—¶å¸¸é‡æ± **ã€‚

  > ![image-20240117104014538](./img/113.png)

- æ–¹æ³•åŒºæ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­è®¾è®¡çš„è™šæ‹Ÿæ¦‚å¿µï¼Œæ¯æ¬¾Javaè™šæ‹Ÿæœºåœ¨å®ç°ä¸Šéƒ½å„ä¸ç›¸åŒã€‚Hotspotè®¾è®¡å¦‚ä¸‹ï¼š

  - JDK7ä¹‹å‰çš„ç‰ˆæœ¬å°†æ–¹æ³•åŒºå­˜æ”¾åœ¨å †åŒºåŸŸä¸­çš„æ°¸ä¹…ä»£ç©ºé—´ï¼Œå †å †å¤§å°ç”±è™šæ‹Ÿæœºå‚æ•°æ¥æ§åˆ¶ã€‚
  - JDK8ä¹‹åçš„ç‰ˆæœ¬å°†æ–¹æ³•åŒºå­˜æ”¾åœ¨**å…ƒç©ºé—´**ä¸­ï¼Œå…ƒç©ºé—´ä½äºæ“ä½œç³»ç»Ÿç»´æŠ¤çš„ç›´æ¥å†…å­˜ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹åªè¦ä¸è¶…è¶Šæ“ä½œç³»ç»Ÿæ‰¿å—çš„ä¸Šé™ï¼Œå¯ä»¥ä¸€ç›´åˆ†é…ã€‚

  ![image-20240117104701920](./img/114.png)



**arthasæŸ¥çœ‹æ–¹æ³•åŒºå†…å­˜**

> JDK7:
>
> ![image-20240117105142641](./img/115.png)
>
> JDK8:
>
> ![image-20240117105306740](./img/116.png)



**éªŒè¯æ–¹æ³•åŒºæº¢å‡º**

é€šè¿‡ByteBuddyæ¡†æ¶ï¼ŒåŠ¨æ€ç”Ÿæˆå­—èŠ‚ç æ•°æ®ï¼ŒåŠ è½½åˆ°å†…å­˜ä¸­ã€‚é€šè¿‡æ­»å¾ªç¯ä¸åœåœ°åŠ è½½åˆ°æ–¹æ³•åŒºï¼Œè§‚å¯Ÿæ–¹æ³•åŒºæ˜¯å¦ä¼šå‡ºç°å†…å­˜æº¢å‡ºçš„æƒ…å†µã€‚åˆ†åˆ«åœ¨JDK7å’ŒJDK8ä¸Šè¿è¡Œä¸Šè¿°ä»£ç ã€‚

> ```xml
>  <dependency>
>             <groupId>net.bytebuddy</groupId>
>             <artifactId>byte-buddy</artifactId>
>         </dependency>
> ```
>
> Code:
>
> ```java
> public static void main(String[] args) throws IOException {
>         System.in.read();
>         Demo1 demo1 = new Demo1();
>         int count = 0;
>         while (true) {
>             String name = "Clas" + count;
>             ClassWriter classWriter = new ClassWriter(0);
>             classWriter.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, name, null, "java/lang/Object", null);
>             byte[] byteArray = classWriter.toByteArray();
>             demo1.defineClass(name, byteArray, 0, byteArray.length);
>             System.out.println(++count);
>         }
>     }
> ```
>
> å®éªŒå‘ç°ï¼ŒJDK7ä¸Šè¿è¡Œå¤§æ¦‚åå‡ ä¸‡æ¬¡ï¼Œå°±å‡ºç°äº†é”™è¯¯ã€‚åœ¨JDK8ä¸Šè¿è¡Œç™¾ä¸‡æ¬¡ï¼Œç¨‹åºéƒ½æ²¡æœ‰å‡ºç°ä»»ä½•é”™è¯¯ï¼Œä½†æ˜¯å†…å­˜ä¼šç›´çº¿å‡é«˜ã€‚è¿™è¯´æ˜JDK7å’ŒJDK8åœ¨æ–¹æ³•åŒºçš„å­˜æ”¾ä¸Šï¼Œé‡‡ç”¨äº†ä¸åŒçš„è®¾è®¡ã€‚
>
> - JDK7å°†æ–¹æ³•åŒºå­˜æ”¾åœ¨å †åŒºåŸŸä¸­çš„æ°¸ä¹…ä»£ç©ºé—´ï¼Œå †çš„å¤§å°ç”±è™šæ‹Ÿæœºå‚æ•°-XX:MaxPermsize=å€¼æ¥æ§åˆ¶
>
> - **JDK8å°†æ–¹æ³•åŒºå­˜æ”¾åœ¨å…ƒç©ºé—´ä¸­**ï¼Œå…ƒç©ºé—´ä½äºæ“ä½œç³»ç»Ÿç»´æŠ¤çš„ç›´æ¥å†…å­˜ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹åªè¦ä¸è¶…è¿‡æ“ä½œç³»ç»Ÿæ‰¿å—çš„ä¸Šé™ï¼Œå¯ä»¥ä¸€ç›´åˆ†é…ã€‚å¯ä»¥ä½¿ç”¨**-XX:MaxMetaspacesize=**å€¼å°†å…ƒç©ºé—´æœ€å¤§å¤§å°è¿›è¡Œé™åˆ¶
>
>   >è®¾ç½®æ–¹æ³•åŒºå†…å­˜å¤§å°
>   >
>   >![image-20240117110509835](./img/117.png)
>   >
>   >![image-20240117110550581](./img/118.png)



###### å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰

- æ–¹æ³•åŒºä¸­é™¤äº†ç±»çš„å…ƒä¿¡æ¯ã€è¿è¡Œæ—¶å¸¸é‡æ± ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€å—åŒºåŸŸå«**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆStringTableï¼‰**

- å­—ç¬¦ä¸²å¸¸é‡æ± å­˜å‚¨åœ¨ä»£ç ä¸­å®šä¹‰çš„**å¸¸é‡å­—ç¬¦ä¸²å†…å®¹**ã€‚æ¯”å¦‚â€œ123â€è¿™ä¸ª123å°±ä¼šè¢«æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚

  > ```java
  > public static void main(String[] args) {
  >     // heapå†…å­˜ä¸­
  >     String string = new String("123");
  >     // å­—ç¬¦ä¸²å¸¸é‡æ± 
  >     String string1 ="123";
  >     // false
  >     System.out.println(string1==string);
  >     // true æ¯”è¾ƒçš„æ˜¯å€¼
  >     System.out.println(string1.equals(string));
  > }
  > ```
  >
  > 

**é—®é¢˜ï¼š**

**å­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ**

> æ—©æœŸè®¾è®¡æ—¶ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ—¶å±äºè¿è¡Œæ—¶å¸¸é‡æ± æ± çš„ä¸€éƒ¨åˆ†ï¼Œä»–ä»¬å­˜å‚¨çš„ä½ç½®ä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚åç»­åšå‡ºäº†è°ƒæ•´ï¼Œå°†å­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± åšäº†æ‹†åˆ†ã€‚
>
> ![image-20240117115219941](./img/119.png)



**é¢è¯•é¢˜ï¼š**

**æ¡ˆä¾‹1 ï¼š**

> Codeï¼š
>
> ```java
> public static void main(String[] args) {
>         // å­—ç¬¦ä¸²å¸¸é‡æ± 
>         String string1 = "123";
>         String string2 = "456";
>         String string3 = "123456";
>         String string4 = string1 + string2;
>         // false
>         System.out.println(string1 == string4);
>         // true æ¯”è¾ƒçš„æ˜¯å€¼
>         System.out.println(string3.equals(string4));
>     }
> ```
>
> å¯¹åº”çš„å­—èŠ‚ç ï¼š
>
> > ä»å­—èŠ‚ç å†…å®¹ï¼ˆ **9 new #5 <java/lang/StringBuilder>**ï¼‰å¯ä»¥çœ‹åˆ° å­—ç¬¦ä¸²ç›¸åŠ ï¼Œ**åº•å±‚æ˜¯newäº†ä¸€ä¸ªStringBuilderï¼Œç„¶åè°ƒç”¨äº†appendæ–¹æ³•çš„**
> >
> > æ‰€ä»¥ç›¸åŠ çš„å­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªnewå‡ºæ¥çš„å¯¹è±¡å­˜åœ¨**Heapå†…å­˜**ä¸­çš„
> >
> > è€ŒString string3 = "123456";æ˜¯å­˜æ”¾åœ¨**æ–¹æ³•åŒºçš„å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­**çš„ã€‚
>
> ```
>  0 ldc #2 <123>
>  2 astore_1
>  3 ldc #3 <456>
>  5 astore_2
>  6 ldc #4 <123456>
>  8 astore_3
>  9 new #5 <java/lang/StringBuilder>
> 12 dup
> 13 invokespecial #6 <java/lang/StringBuilder.<init> : ()V>
> 16 aload_1
> 17 invokevirtual #7 <java/lang/StringBuilder.append : (Ljava/lang/String;)Ljava/lang/StringBuilder;>
> 20 aload_2
> ```

**æ¡ˆä¾‹2ï¼š**

> é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤åˆ†æå¦‚ä¸‹ä»£ç çš„è¿è¡Œç»“æœï¼š
>
> ```java
>  public static void main(String[] args) {
>         // å­—ç¬¦ä¸²å¸¸é‡æ± 
>         String string3 = "123456";
>         String string4 = "123" + "456";
>         // true å¸¸é‡ï¼Œåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ç›´æ¥è¿æ¥
>         System.out.println(string3 == string4);
>     }
> ```
>
> å­—èŠ‚ç ï¼š
>
> ```
>  0 ldc #2 <123456>
>  2 astore_1
>  3 ldc #2 <123456>
>  5 astore_2
>  6 getstatic #3 <java/lang/System.out : Ljava/io/PrintStream;>
>  9 aload_1
> 10 aload_2
> 11 if_acmpne 18 (+7)
> 14 iconst_1
> 15 goto 19 (+4)
> 18 iconst_0
> 19 invokevirtual #4 <java/io/PrintStream.println : (Z)V>
> 22 return
> ```
>
> **éƒ½æ˜¯å­˜åœ¨Method Areaä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚**



###### **Internå­¦ä¹ **

- **String.intern()æ–¹æ³•æ˜¯å¯ä»¥æ‰‹åŠ¨å°†å­—ç¬¦ä¸²æ”¾åˆ°å¸¸é‡æ± ä¸­**

  > JDK7ä»¥å
  >
  > ```java
  >   public static void main(String[] args) {
  >         String s1 = new StringBuilder().append("think").append("123").toString();
  >         // ä¼šæŠŠå¯¹è±¡çš„å¼•ç”¨æ”¾åˆ°å¸¸é‡æ± é‡Œé¢
  >         System.out.println(s1.intern() == s1);
  >         // å†…å­˜ä¸­æœ‰è¿™ä¸ªå…³é”®å­—æ˜¯Java
  >         String s2 = new StringBuilder().append("ja").append("va").toString();
  >         System.out.println(s2.intern() == s2);
  >     }
  > ```
  >
  > JDK6çš„ç»“æœæ˜¯falseã€falseï¼ŒJDK8ä¸­æ˜¯trueã€falseï¼ˆå†…å­˜ä¸­æœ‰è¿™ä¸ªå…³é”®å­—æ˜¯Javaå¯¼è‡´ä¸ç›¸ç­‰ï¼‰
  >
  > > JDK7åŠä¹‹åçš„ç‰ˆæœ¬å‡ºç”±äºå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å †ä¸Šï¼Œæ‰€ä»¥**intern() **æ–¹æ³•ä¼šæŠŠç¬¬ä¸€æ¬¡é‡åˆ°çš„å­—ç¬¦ä¸²çš„å¼•ç”¨æ”¾åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
  > >
  > > **7ä»¥åçš„ç‰ˆæœ¬ internæ–¹æ³•ä¿å­˜çš„æ˜¯å¯¹è±¡çš„å¼•ç”¨**
  > >
  > > ![image-20240117140929063](./img/126.png)

é—®é¢˜

é™æ€å˜é‡å­˜åœ¨å“ªé‡Œï¼Ÿ

- JDK6åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œé™æ€å˜é‡æ—¶å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­ï¼Œä¹Ÿå°±æ˜¯æ°¸ä¹…ä»£

  > ![image-20240117141748558](./img/125.png)

- JDK7åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œé™æ€å˜é‡æ—¶å­˜æ”¾Heapä¸­çš„Classå¯¹è±¡ä¸­ï¼Œè„±ç¦»äº†æ°¸ä¹…ä»£ã€‚

  > ![image-20240117141853600](./img/120.png)



#### 5ï¼‰ç›´æ¥å†…å­˜ï¼ˆä¸å±äºJVMï¼‰

- ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸å†ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å­˜åœ¨ï¼Œæ‰€ä»¥å¹¶ä¸å±äºJavaè¿è¡Œæ—¶çš„å†…å­˜åŒºåŸŸã€‚åœ¨JDK1.4ä¸­å¼•å…¥äº†NIOæœºåˆ¶ï¼Œä½¿ç”¨äº†ç›´æ¥å†…å­˜ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

  1. Javaå †ä¸­çš„å¯¹è±¡å¦‚æœä¸å†ä½¿ç”¨è¦å›æ”¶ï¼Œå›æ”¶æ—¶ä¼šå½±å“å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨ã€‚
  2. IOæ“ä½œæ¯”å¦‚è¯»æ–‡ä»¶ï¼Œéœ€è¦å…ˆæŠŠæ–‡ä»¶è¯»å…¥ç›´æ¥å†…å­˜ï¼ˆç¼“å†²åŒºBufferï¼‰å†æŠŠæ•°æ®èµ‹å€¼åˆ°Javaå †ä¸­ã€‚ç°åœ¨ç›´æ¥æ”¾å…¥ç›´æ¥å†…å­˜å³å¯ï¼ŒåŒæ—¶Javaå †ä¸Šç»´æŠ¤ç›´æ¥å†…å­˜çš„å¼•ç”¨ï¼Œå‡å°‘äº†æ•°æ®èµ‹å€¼çš„å¼€é”€ã€‚å†™æ–‡ä»¶ä¹Ÿæ˜¯ç±»ä¼¼çš„æ€è·¯ã€‚

  ![image-20240117143809403](./img/121.png)

ä½¿ç”¨ç›´æ¥å†…å­˜ï¼š

> ```java
>   int size = 1024 * 1024 * 9;
>         ByteBuffer bufferAllocator = ByteBuffer.allocateDirect(size);
> ```
>
> ![image-20240117144109703](./img/122.png)

è°ƒæ•´ç›´æ¥å†…å­˜ï¼š

- å¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒæ•´ç›´æ¥å†…å­˜çš„å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨-XX:MaxDirectMemorySize= å¤§å°å•ä½kæˆ–Kè¡¨ç¤ºå¹²å­—èŠ‚ï¼Œmæˆ–Mè¡¨ç¤ºå…†å­—èŠ‚ï¼Œgæˆ–Gè¡¨ç¤ºå¹²å…†å­—èŠ‚ã€‚é»˜è®¤ä¸è®¾ç½®è¯¥å‚æ•°æƒ…å†µä¸‹ï¼ŒJVM è‡ªåŠ¨é€‰æ‹©æœ€åˆ†é…çš„å¤§å°ã€‚





#### **6ï¼‰é¢è¯•é¢˜ æ€»ç»“**

- Javaçš„å†…å­˜åˆ†æˆå‡ éƒ¨åˆ†ï¼Ÿå“ªäº›éƒ¨åˆ†ä¼šå†…å­˜æº¢å‡ºï¼Ÿè¯¦ç»†ä»‹ç»ä¸€ä¸‹å§

  > **ç¨‹åºè®¡æ•°å™¨**ï¼Œå†…å­˜ä¸ä¼šæº¢å‡ºï¼Œä¿å­˜ç¨‹åºè¿è¡Œä¸‹ä¸€æ­¥æ‰€éœ€æŒ‡ä»¤**----çº¿ç¨‹ç‹¬æœ‰**
  >
  > **æ ˆStack**ï¼Œå†…å­˜ä¼šæº¢å‡º ä¿å­˜ä¸€äº›æ ˆå¸§æ•°æ®ï¼Œå±€éƒ¨å˜é‡è¡¨**----çº¿ç¨‹ç‹¬æœ‰**
  >
  > **æœ¬åœ°æ–¹æ³•æ ˆ**ï¼Œnativeæ ˆ**----çº¿ç¨‹ç‹¬æœ‰**
  >
  > **å †Heap**ï¼Œä¼šå†…å­˜æº¢å‡ºï¼Œåˆ›å»ºçš„å¯¹è±¡ä¿¡æ¯éƒ½ä¿å­˜åœ¨å †å°çº¢**----çº¿ç¨‹å…±äº«**
  >
  > **æ–¹æ³•åŒº Method Area**ï¼Œå†…å­˜ä¼šæº¢å‡ºï¼Œæœ‰å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç±»çš„å…ƒä¿¡æ¯ï¼Œè¿è¡Œå¸¸é‡æ± **----çº¿ç¨‹å…±äº«**
  >
  > ![image-20240117145049704](./img/123.png)

- JDK7å’ŒJDK8åœ¨å†…å­˜ç»“æ„ä¸Šçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ


> **JDK8æ˜¯æ–¹æ³•åŒºå’Œå †ï¼ŒJDK7æ˜¯å †åŒ…å«äº†æ–¹æ³•åŒºï¼ˆæ°¸ä¹…ä»£ï¼‰å’Œå­—ç¬¦ä¸²å¸¸é‡æ± **
>
> ![image-20240117145140369](./img/124.png)



---





## 4.JVMçš„åƒåœ¾å›æ”¶

- Javaä¸­ä¸ºäº†ç®€åŒ–å¯¹è±¡çš„é‡Šæ”¾ï¼Œå¼•å…¥äº†è‡ªåŠ¨çš„åƒåœ¾å›æ”¶ (Garbage Collectionç®€ç§°GC) æœºåˆ¶ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨æ¥å¯¹ä¸å†ä½¿ç”¨çš„å¯¹è±¡å®Œæˆè‡ªåŠ¨çš„å›æ”¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¸»è¦è´Ÿè´£å¯¹å †ä¸Šçš„å†…å­˜è¿›è¡Œå›æ”¶ã€‚å…¶ä»–å¾ˆå¤šç°ä»£è¯­è¨€æ¯”å¦‚C#ã€Pythonã€Goéƒ½æ‹¥æœ‰è‡ªå·±çš„åƒåœ¾å›æ”¶å™¨

  > ![image-20240119115229380](./img/127.png)
  >
  > 

åº”ç”¨åœºæ™¯ï¼š

- è§£å†³ç³»ç»Ÿåƒµæ­»çš„é—®é¢˜

  > å¤§å‚çš„ç³»ç»Ÿå‡ºç°çš„è®¸å¤šç³»ç»Ÿåƒµæ­»é—®é¢˜éƒ½ä¸é¢‘ç¹çš„åƒåœ¾å›æ”¶æœ‰å…³

- æ€§èƒ½ä¼˜åŒ–

  > å¯¹åƒåœ¾å›æ”¶å™¨è¿›è¡Œåˆç†çš„è®¾ç½®å¯ä»¥æœ‰æ•ˆåœ°æå‡ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½

- é«˜é¢‘é¢è¯•é¢˜

> - å¸¸è§çš„åƒåœ¾å›æ”¶å™¨
> - å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•
> - å››ç§å¼•ç”¨
> - é¡¹ç›®ä¸­ç”¨äº†å“ªä¸€ç§åƒåœ¾å›æ”¶å™¨



### æ–¹æ³•åŒºçš„å›æ”¶

- æ–¹æ³•åŒºä¸­èƒ½å›æ”¶çš„å†…å®¹ä¸»è¦å°±æ˜¯ä¸å†ä½¿ç”¨çš„ç±»ã€‚

åˆ¤å®šä¸€ä¸ªç±»å¯ä»¥è¢«å¸è½½ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š

1. **æ­¤ç±»æ‰€æœ‰å®ä¾‹å¯¹è±¡éƒ½å·²ç»è¢«å›æ”¶ï¼Œåœ¨å †ä¸­ä¸å­˜åœ¨ä»»ä½•è¯¥ç±»çš„å®ä¾‹å¯¹è±¡ä»¥åŠå­ç±»å¯¹è±¡ã€‚**

   > ```java
   > Class<?> aClass = classLoader.loadClass("xxxxxxx.xxxx");
   >         Object o = aClass.newInstance();
   >         o=null;
   > ```

2. **åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶**

   > ```java
   > ClassLoader classLoader = XXXX.class.getClassLoader();
   >         classLoader=null;
   > ```

3. **è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ã€‚**

   > ```java
   > 
   >         Class<?> aClass = classLoader.loadClass("xxxxxxx.xxxx");
   >         aClass =null;
   > ```

- æ–¹æ³•åŒºçš„å†…å­˜å¯ä»¥æ‰‹åŠ¨è§¦å‘å›æ”¶

  > - å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼Œå¯ä»¥è°ƒç”¨System.gc()æ–¹æ³•
  > - è¯­æ³•: System.gc()
  > - æ³¨æ„äº‹é¡¹:
  >   è°ƒç”¨System,gc()æ–¹æ³•å¹¶ä¸ä¸€å®šä¼šç«‹å³å›æ”¶åƒåœ¾ï¼Œä»…ä»…æ˜¯å‘Javaè™šæ‹Ÿæœºå‘é€ä¸€ä¸ªåƒåœ¾å›æ”¶çš„è¯·æ±‚ï¼Œå…·ä½“æ˜¯å¦éœ€è¦æ‰§è¡Œåƒåœ¾å›æ”¶Javaè™šæ‹Ÿæœºä¼šè‡ªè¡Œåˆ¤æ–­ã€‚

TipsğŸŒŸğŸŒŸï¼š

> å¼€å‘ä¸­æ­¤ç±»åœºæ™¯ä¸€èˆ¬å¾ˆå°‘å‡ºç°ï¼Œä¸»è¦åœ¨å¦‚ OSGiã€JSP çš„çƒ­éƒ¨ç½²ç­‰åº”ç”¨åœºæ™¯ä¸­æ¯ä¸ªjspæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ç±»åŠ è½½å™¨ï¼Œå½“ä¸€ä¸ªjspæ–‡ä»¶ä¿®æ”¹äº†ï¼Œå°±ç›´æ¥å¸è½½è¿™ä¸ªjspç±»åŠ è½½å™¨ã€‚é‡æ–°åˆ›å»ºç±»åŠ è½½å™¨ï¼Œé‡æ–°åŠ è½½jspæ–‡ä»¶





### å †å›æ”¶

- å¦‚ä½•åˆ¤æ–­Heapä¸Šçš„å¯¹è±¡å¯ä»¥å›æ”¶ï¼Ÿ

  > Javaä¸­çš„å¯¹è±¡æ˜¯å¦èƒ½è¢«å›æ”¶ï¼Œæ˜¯æ ¹æ®å¯¹è±¡æ˜¯å¦è¢«å¼•ç”¨æ¥å†³å®šçš„ã€‚å¦‚æœå¯¹è±¡è¢«å¼•ç”¨æ¥ï¼Œè¯´æ˜è¯¥å¯¹è±¡è¿˜åœ¨ä½¿ç”¨ï¼Œä¸å…è®¸è¢«å›æ”¶ã€‚
  >
  > ![image-20240119150043711](./img/128.png)
  >
  > å¦‚æœåœ¨mainæ–¹æ³•ä¸­æœ€åæ‰§è¡Œa1=nullï¼Œb1=nullï¼Œæ˜¯å¦èƒ½å›æ”¶Aå’ŒBå¯¹è±¡å‘¢ï¼Ÿ
  >
  > å¯ä»¥å›æ”¶ï¼Œæ–¹æ³•ä¸­å·²ç»æ²¡æœ‰åŠæ³•ä½¿ç”¨å¼•ç”¨åŒºè®¿é—®Aå’ŒBå¯¹è±¡æ¥ã€‚



#### å¼•ç”¨è®¡æ•°å™¨æ³•å’Œå¯è¾¾æ€§åˆ†ææ³•

##### **å¼•ç”¨è®¡æ•°å™¨æ³•**

**å¼•ç”¨è®¡æ•°æ³•**ä¼šä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“å¯¹è±¡è¢«å¼•ç”¨æ—¶åŠ 1ï¼Œå–æ¶ˆå¼•ç”¨æ—¶å‡1ã€‚

![image-20240119151425522](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240119151425522.png)

**å¼•ç”¨è®¡æ•°å™¨æ³•çš„ç¼ºç‚¹-å¾ªç¯å¼•ç”¨**

å¼•ç”¨è®¡æ•°å™¨æ³•çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼ŒC++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆå°±é‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•ï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨ç¼ºç‚¹ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š

1. æ¯æ¬¡å¼•ç”¨å’Œå–æ¶ˆå¼•ç”¨éƒ½éœ€è¦ç»´æŠ¤è®¡æ•°å™¨ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½ä¼šæœ‰ä¸€å®šçš„å½±å“
2. å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œæ‰€è°“å¾ªç¯å¾ªå¼•ç”¨å°±æ˜¯å½“Aå¼•ç”¨Bï¼ŒBåŒæ—¶å¼•ç”¨Aæ—¶ä¼šå‡ºç°å¯¹è±¡æ— æ³•å›æ”¶çš„é—®é¢˜ã€‚

![image-20240119151920800](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240119151920800.png)

æŸ¥çœ‹åƒåœ¾å›æ”¶æ—¥å¿—

- å¯ä»¥ä½¿ç”¨verbose:gcå‚æ•°
- è¯­æ³•ï¼š-verbose:gc

![image-20240119165601130](./img/129.png)



##### å¯è¾¾æ€§åˆ†æç®—æ³•

Javaä½¿ç”¨çš„æ˜¯**å¯è¾¾æ€§åˆ†æç®—æ³•**æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶ã€‚å¯è¾¾æ€§åˆ†æå°†å¯¹è±¡åˆ†ä¸ºä¸¤ç±»: **åƒåœ¾å›æ”¶çš„æ ¹å¯¹è±¡(GCRoot)**å’Œ**æ™®é€šå¯¹è±¡**ï¼Œå¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´å­˜åœ¨å¼•ç”¨å…³ç³»

ä¸‹å›¾Aåˆ°Bå†åˆ°Cå’ŒDï¼Œå½¢æˆäº†ä¸€ä¸ªå¼•ç”¨é“¾ï¼Œå¯è¾¾æ€§åˆ†æç®—æ³•æŒ‡çš„æ˜¯å¦‚æœä»æŸä¸ªåˆ°æŸä¸ªGC Rootå¯¹è±¡æ˜¯å¯è¾¾çš„ï¼Œå¯¹è±¡å°±ä¸å¯è¢«å›æ”¶ã€‚

![image-20240119165903443](./img/130.png)

**å“ªäº›å¯¹è±¡è¢«ç§°ä¹‹ä¸ºGC Rootå¯¹è±¡å‘¢ï¼Ÿ**

- çº¿ç¨‹Threadå¯¹è±¡

- ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„java.lang.Classå¯¹è±¡

  > ![image-20240119170507556](./img/133.png)

- ç›‘è§†å™¨å¯¹è±¡ï¼Œç”¨æ¥ä¿å­˜åŒæ­¥é”synchronizedå…³é”®å­—æŒæœ‰çš„å¯¹è±¡

  > **thiså½“å‰å¯¹è±¡**
  >
  > ![image-20240119170217400](./img/131.png)

- æœ¬åœ°æ–¹æ³•è°ƒç”¨æ—¶ä½¿ç”¨çš„å…¨å±€å¯¹è±¡



> ![image-20240119170315846](./img/132.png)
>
> å¦‚æœæŠŠa1å’Œb1éƒ½è®¾ç½®ä¸ºnullï¼Œé‚£ä¹ˆè¿™äº›éƒ½ä¼šè¢«å›æ”¶â™»ï¸



**æŸ¥çœ‹GC Root**

é€šè¿‡arthaså’Œeclipse Memory Analyzer (MAT) å·¥å…·å¯ä»¥æŸ¥çœ‹GC Rootï¼ŒMATå…·æ˜¯eclipseæ¨å‡ºçš„Javaå †å†…å­˜æ£€æµ‹å·¥å…·ã€‚å…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹:

1. **ä½¿ç”¨arthasçš„heapdumpå‘½ä»¤å°†å †å†…å­˜å¿«ç…§ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ä¸­**

   > ![image-20240119173235485](./img/134.png)

2. **ä½¿ç”¨MATå·¥å…·æ‰“å¼€å †å†…å­˜å¿«ç…§æ–‡ä»¶ã€‚**

   > ![image-20240119173627808](./img/135.png)
   >
   > ![image-20240119173751222](./img/136.png)

3. **é€‰æ‹©GC RootsåŠŸèƒ½æŸ¥çœ‹æ‰€æœ‰çš„GC Root**

   > ![image-20240119173832544](./img/137.png)
   >
   > ![image-20240119174644893](./img/138.png)



#### äº”ç§å¯¹è±¡å¼•ç”¨

å¯è¾¾æ€§ç®—æ³•ä¸­æè¿°çš„å¯¹è±¡å¼•ç”¨ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å¼ºå¼•ç”¨ï¼Œå³æ˜¯GCRootå¯¹è±¡å¯¹æ™®é€šå¯¹è±¡æœ‰å¼•ç”¨å…³ç³»ï¼Œåªè¦è¿™å±‚å…³ç³»å­˜åœ¨ï¼Œæ™®é€šå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ã€‚

##### å¼ºå¼•ç”¨

> å¯è¾¾æ€§ç®—æ³•ä¸­æè¿°çš„å¯¹è±¡å¼•ç”¨ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å¼ºå¼•ç”¨



##### è½¯å¼•ç”¨

>  è½¯å¼•ç”¨ç›¸å¯¹äºå¼ºå¼•ç”¨æ˜¯ä¸€ç§æ¯”è¾ƒå¼±çš„å¼•ç”¨å…³ç³»ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡åªæœ‰è½¯å¼•ç”¨å…³è”åˆ°å®ƒï¼Œ**å½“ç¨‹åºå†…å­˜ä¸è¶³æ—¶ï¼Œå°±ä¼šå°†è½¯å¼•ç”¨ä¸­çš„æ•°æ®è¿›è¡Œå›æ”¶ã€‚**
>
> åœ¨JDK1.2ç‰ˆä¹‹åæä¾›äº†SoftReferenceç±»æ¥å®ç°è½¯å¼•ç”¨ï¼Œè½¯å¼•ç”¨å¸¸ç”¨äºç¼“å­˜ä¸­ã€‚
>
> ![image-20240120145103562](./img/140.png)

è½¯å¼•ç”¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. å°†å¯¹è±¡ä½¿ç”¨è½¯å¼•ç”¨åŒ…è£…èµ·æ¥ï¼Œ**new SoftReference<å¯¹è±¡ç±»å‹>(å¯¹è±¡);**

   > ```java
   > byte[] byteArray = new byte[1024 * 1024 * 100];
   > SoftReference<byte[]> softReference = new SoftReference<>(byteArray);
   > ```

2. å†…å­˜ä¸è¶³æ—¶ï¼Œè™šæ‹Ÿæœºå°è¯•è¿›è¡Œåƒåœ¾å›æ”¶ã€‚

3. å¦‚æœåƒåœ¾å›æ”¶ä»ä¸èƒ½è§£å†³å†…å­˜ä¸è¶³çš„é—®é¢˜ï¼Œå›æ”¶è½¯å¼•ç”¨ä¸­çš„å¯¹è±¡

4. å¦‚æœä¾ç„¶å†…å­˜ä¸è¶³ï¼ŒæŠ›å‡ºOutOfMemoryå¼‚å¸¸ã€‚

   > **è®¾ç½®å †æœ€å¤§å†…å­˜ä¸º-Xms400m**

   > ```java
   > public static void main(String[] args) throws IOException {
   >         byte[] byteArray = new byte[1024 * 1024 * 100];
   >         SoftReference<byte[]> softReference = new SoftReference<>(byteArray);
   >         byteArray = null;
   >         // è¾“å‡ºä¸€ä¸ªå¯¹è±¡
   >         System.out.println(softReference.get());
   >         System.in.read();
   >         byte[] bytes1 = new byte[1024 * 1024 * 200];
   >         SoftReference<byte[]> softReference1 = new SoftReference<byte[]>(bytes1);
   >         // è¾“å‡ºnull
   >         System.out.println(softReference.get());
   >     }
   > ```

> æ‰§è¡Œç»“æœï¼š
>
> ![image-20240120152606910](./img/141.png)

è½¯å¼•ç”¨ä¸­çš„å¯¹è±¡å¦‚æœåœ¨å†…å­˜ä¸è¶³æ—¶å›æ”¶ï¼Œ**SoftReferenceå¯¹è±¡æœ¬èº«ä¹Ÿéœ€è¦è¢«å›æ”¶**ã€‚å¦‚ä½•çŸ¥é“å“ªäº›SoftReferenceå¯¹è±¡éœ€è¦å›æ”¶å‘¢?

**SoftReference**æä¾›äº†ä¸€å¥—é˜Ÿåˆ—æœºåˆ¶ï¼š

1. è½¯å¼•ç”¨åˆ›å»ºæ—¶ï¼Œé€šè¿‡æ„é€ å™¨ä¼ å…¥å¼•ç”¨é˜Ÿåˆ—

2. åœ¨è½¯å¼•ç”¨ä¸­åŒ…å«çš„å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œè¯¥è½¯å¼•ç”¨å¯¹è±¡ä¼šè¢«æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­

   > ![image-20240120153156957](./img/142.png)

3. é€šè¿‡ä»£ç ä¾¿åˆ©å¼•ç”¨é˜Ÿåˆ—ï¼Œå°†SoftReferenceçš„å¼ºå¼•ç”¨åˆ é™¤

   > **è®¾ç½®å †å†…å­˜ä¸º200m æœ€å¤§èƒ½å­˜æ”¾ä¸€ä¸ª100mçš„byteæ•°ç»„**

   > ```java
   > public static void main(String[] args) throws IOException {
   >     ReferenceQueue<byte[]> referenceQueue = new ReferenceQueue<>();
   >     ArrayList<SoftReference<byte[]>> softReferences = new ArrayList<>();
   >     for (int i = 0; i < 10; i++) {
   >         byte[] byteArray = new byte[1024 * 1024 * 100];
   >         SoftReference<byte[]> softReference = new SoftReference<>(byteArray, referenceQueue);
   >         softReferences.add(softReference);
   >     }
   >     System.in.read();
   >     int count = 0;
   >     while (referenceQueue.poll() != null) {
   >         count++;
   >     }
   >     System.out.println(count);
   > }
   > ```

> æœ€ç»ˆæ‰“å°çš„ç»“æœä¸º9ï¼Œæ¯ä¸€æ¬¡é‡Šæ”¾è½¯å¼•ç”¨å†…å­˜ï¼Œç„¶ååœ¨é‡æ–°æ–°å¢ä¸€ä¸ªè¿›å»ï¼Œå¾ªç¯åæ¬¡ï¼Œé‚£ä¹ˆæœ€ç»ˆç©ºçš„è½¯åº”ç”¨å¯¹è±¡ä¸º9ä¸ªï¼Œå…¶ä¸­ä¸€ä¸ªè¿˜æ²¡é‡Šæ”¾å†…å­˜ï¼Œè½¯å¼•ç”¨å¯¹è±¡è¿˜æ˜¯å¼ºå¼•ç”¨ã€‚

è½¯åº”ç”¨ä¹Ÿå¯ä»¥ä½¿ç”¨ç»§æ‰¿è‡ªSoftReferenceç±»çš„æ–¹å¼æ¥å®ç°ï¼ŒStudentRefç±»å°±æ˜¯ä¸€ä¸ªè½¯å¼•ç”¨ã€‚é€šè¿‡æ„é€ å™¨ä¼ å…¥è½¯å¼•ç”¨åŒ…å«çš„å¯¹è±¡ï¼Œå·²ç»å¼•ç”¨é˜Ÿåˆ—ã€‚

> ```java
> class StringRef extends SoftReference<String>{
> 
>     public StringRef(String referent) {
>         super(referent);
>     }
>     public StringRef(String referent, ReferenceQueue<? super String> q) {
>         super(referent, q);
>     }
> }
> ```



![image-20240119212936727](./img/143.png)

 



##### å¼±å¼•ç”¨

> å¼±å¼•ç”¨çš„æ•´ä½“æœºåˆ¶å’Œè½¯å¼•ç”¨åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºå¼±å¼•ç”¨åŒ…å«çš„å¯¹è±¡åœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œä¸**ç®¡å†…å­˜å¤Ÿä¸å¤Ÿéƒ½ä¼šç›´æ¥è¢«å›æ”¶ã€‚**
>
> åœ¨JDK 1.2ç‰ˆä¹‹åæä¾›äº†WeakReferenceç±»æ¥å®ç°å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨ä¸»è¦åœ¨ThreadLocalä¸­ä½¿ç”¨ã€‚
>
> å¼±å¼•ç”¨å¯¹è±¡æœ¬èº«ä¹Ÿå¯ä»¥ä½¿ç”¨å¼•ç”¨é˜Ÿåˆ—è¿›è¡Œå›æ”¶
>
> ![image-20240120155733983](./img/144.png)

> è®¾ç½®å †æœ€å¤§å†…å­˜ä¸º200m
>
> ```java
> public static void main(String[] args) throws IOException {
>         byte[] byteArray = new byte[1024 * 1024 * 100];
>         WeakReference<byte[]> reference = new WeakReference<>(byteArray);
>         byteArray = null;
>         System.out.println(reference.get());
>         System.gc();
>         System.out.println(reference.get());
>     }
> ```



##### è™šå¼•ç”¨

åœ¨å¸¸è§„å¼€å‘ä¸­æ˜¯ä¸ä¼šä½¿ç”¨çš„

> **è™šå¼•ç”¨**ä¹Ÿå«**å¹½çµå¼•ç”¨/å¹»å½±å¼•ç”¨**ï¼Œ**ä¸èƒ½é€šè¿‡è™šå¼•ç”¨å¯¹è±¡è·å–åˆ°åŒ…å«çš„å¯¹è±¡**ã€‚**è™šå¼•ç”¨å”¯ä¸€çš„ç”¨é€”æ˜¯å½“å¯¹è±¡è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶æ—¶å¯ä»¥æ¥æ”¶åˆ°å¯¹åº”çš„é€šçŸ¥**ã€‚Javaä¸­ä½¿ç”¨**PhantomReference**å®ç°äº†è™šå¼•ç”¨ï¼Œç›´æ¥å†…å­˜ä¸­ä¸ºäº†åŠæ—¶çŸ¥é“ç›´æ¥å†…å­˜å¯¹è±¡ä¸å†ä½¿ç”¨ï¼Œä»è€Œå›æ”¶å†…å­˜ï¼Œä½¿ç”¨äº†è™šå¼•ç”¨æ¥å®ç°ã€‚



##### ç»ˆç»“å™¨å¼•ç”¨

åœ¨å¸¸è§„å¼€å‘ä¸­æ˜¯ä¸ä¼šä½¿ç”¨çš„

> ç»ˆç»“å™¨å¼•ç”¨æŒ‡çš„æ˜¯åœ¨å¯¹è±¡éœ€è¦è¢«å›æ”¶æ—¶ï¼Œ**å¯¹è±¡å°†ä¼šè¢«æ”¾ç½®åœ¨Finalizerç±»ä¸­çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œå¹¶åœ¨ç¨åç”±ä¸€æ¡ç”±FinalizerThreadçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è·å–å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œå¯¹è±¡çš„finalizeæ–¹æ³•**ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥åœ¨finalizeæ–¹æ³•ä¸­å†å°†è‡ªèº«å¯¹è±¡ä½¿ç”¨å¼ºå¼•ç”¨å…³è”ä¸Šï¼Œä½†æ˜¯ä¸å»ºè®®è¿™æ ·åšï¼Œå¦‚æœè€—æ—¶è¿‡é•¿ä¼šå½±å“å…¶ä»–å¯¹è±¡çš„å›æ”¶ã€‚
>
> ![image-20240120160411737](./img/145.png)

---





#### åƒåœ¾å›æ”¶ç®—æ³•

- Javaæ˜¯å¦‚ä½•å®ç°åƒåœ¾å›æ”¶çš„å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œåƒåœ¾å›æ”¶è¦åšçš„æœ‰ä¸¤ä»¶äº‹æƒ…ï¼š
  1. æ‰¾åˆ°å†…å­˜ä¸­å­˜æ´»çš„å¯¹è±¡
  2. é‡Šæ”¾ä¸å†å­˜æ´»å¯¹è±¡çš„å†…å­˜ï¼Œä½¿å¾—ç¨‹åºèƒ½å†æ¬¡åˆ©ç”¨è¿™éƒ¨åˆ†ç©ºé—´



##### å†å²å’Œåˆ†ç±»

- 1960å¹´John McCarthyå‘å¸ƒäº†ç¬¬ä¸€ä¸ªGCç®—æ³•: **æ ‡è®°-æ¸…é™¤ç®—æ³•**

- 1963å¹´Marvin L.Minsky å‘å¸ƒäº†**å¤åˆ¶ç®—æ³•**ã€‚

  > æœ¬è´¨ä¸Šåç»­æ‰€æœ‰çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œéƒ½æ˜¯åœ¨ä¸Šè¿°ä¸¤ç§ç®—æ³•çš„åŸºç¡€ä¸Šä¼˜åŒ–è€Œæ¥ã€‚
  >
  > ![image-20240120161012027](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240120161012027.png)



##### åƒåœ¾å›æ”¶ç®—æ³•çš„è¯„ä»·æ ‡å‡†

> Javaåƒåœ¾å›æ”¶è¿‡ç¨‹ä¼šé€šè¿‡å•ç‹¬çš„GCçº¿ç¨‹æ¥å®Œæˆï¼Œä½†æ˜¯ä¸ç®¡ä½¿ç”¨å“ªä¸€ç§GCç®—æ³•ï¼Œéƒ½ä¼šæœ‰éƒ¨åˆ†é˜¶æ®µéœ€è¦åœæ­¢æ‰€æœ‰çš„ç”¨æˆ·çº¿ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¹‹ä¸º**Stop The World**ç®€ç§°**STW**ï¼Œå¦‚æœSTWæ—¶é—´è¿‡é•¿åˆ™ä¼šå½±å“ç”¨æˆ·çš„ä½¿ç”¨ã€‚
>
> ![image-20240120161301749](./img/146.png)

åˆ¤æ–­GCç®—æ³•æ˜¯å¦ä¼˜ç§€ï¼Œå¯ä»¥ä»ä¸‰ä¸ªæ–¹é¢æ¥è€ƒè™‘ï¼š

- **ååé‡TPS**

  > ååé‡æŒ‡çš„æ˜¯ CPU ç”¨äºæ‰§è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´ä¸ CPU æ€»æ‰§è¡Œæ—¶é—´çš„æ¯”å€¼ï¼Œå³**ååé‡ = æ‰§è¡Œç”¨æˆ·ä»£ç æ—¶é—´(æ‰§è¡Œç”¨æˆ·ä»£ç æ—¶é—´ + GCæ—¶é—´)**ã€‚ååé‡æ•°å€¼è¶Šé«˜ï¼Œåƒåœ¾å›æ”¶çš„æ•ˆç‡å°±è¶Šé«˜ã€‚
  >
  > æ¯”å¦‚: è™šæ‹Ÿæœºæ€»å…±è¿è¡Œäº† 100 åˆ†é’Ÿï¼Œå…¶ä¸­GCèŠ±æ‰ 1 åˆ†é’Ÿï¼Œé‚£ä¹ˆååé‡å°±æ˜¯ 99%

- **æœ€å¤§æš‚åœæ—¶é—´**

  > æœ€å¤§æš‚åœæ—¶é—´æŒ‡çš„æ˜¯æ‰€æœ‰åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„STWæ—¶é—´æœ€å¤§å€¼ã€‚æ¯”å¦‚å¦‚ä¸‹çš„å›¾ä¸­ï¼Œé»„è‰²éƒ¨åˆ†çš„STWå°±æ˜¯æœ€å¤§æš‚åœæ—¶é—´ï¼Œæ˜¾è€Œæ˜“è§ä¸Šé¢çš„å›¾æ¯”ä¸‹é¢çš„å›¾æ‹¥æœ‰æ›´å°‘çš„æœ€å¤§æš‚åœæ—¶é—´ã€‚æœ€å¤§æš‚åœæ—¶é—´è¶ŠçŸ­ï¼Œç”¨æˆ·ä½¿ç”¨ç³»ç»Ÿæ—¶å—åˆ°çš„å½±å“å°±è¶ŠçŸ­ã€‚
  >
  > ![image-20240120162000469](./img/147.png)

- **å †ä½¿ç”¨æ•ˆç‡**

  > ä¸åŒåƒåœ¾å›æ”¶ç®—æ³•ï¼Œå¯¹å †å†…å­˜çš„ä½¿ç”¨æ–¹å¼æ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå¯ä»¥ä½¿ç”¨å®Œæ•´çš„å †å†…å­˜ã€‚è€Œå¤åˆ¶ç®—æ³•ä¼šå°†å †å†…å­˜ä¸€åˆ†ä¸ºäºŒï¼Œæ¯æ¬¡åªèƒ½ä½¿ç”¨ä¸€åŠå†…å­˜ã€‚ä»å †ä½¿ç”¨æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®°æ¸…é™¤ç®—æ³•è¦ä¼˜äºå¤åˆ¶ç®—æ³•.
  >
  > ![image-20240120162103273](./img/148.png)

**æ€»ç»“ï¼š**

> ä¸Šè¿°ä¸‰ç§è¯„ä»·æ ‡å‡†:å †ä½¿ç”¨æ•ˆç‡ã€ååé‡ï¼Œä»¥åŠæœ€å¤§æš‚åœæ—¶é—´ä¸å¯å…¼å¾—èˆ¬æ¥è¯´ï¼Œå †å†…å­˜è¶Šå¤§ï¼Œæœ€å¤§æš‚åœæ—¶é—´å°±è¶Šé•¿ã€‚æƒ³è¦å‡å°‘æœ€å¤§æš‚åœæ—¶é—´ï¼Œå°±ä¼šé™ä½ååé‡.
>
> **ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œé€‚ç”¨äºä¸åŒçš„åœºæ™¯**





##### æ ‡è®°æ¸…é™¤ç®—æ³•

æ ‡è®°æ¸…é™¤ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. æ ‡è®°é˜¶æ®µï¼Œå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚Javaä¸­ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä»GC Rootå¼€å§‹é€šè¿‡å¼•ç”¨é“¾éå†å‡ºæ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚
2. æ¸…é™¤é˜¶æ®µï¼Œä»å†…å­˜ä¸­åˆ é™¤æ²¡æœ‰è¢«æ ‡è®°ä¹Ÿå°±æ˜¯éå­˜æ´»å¯¹è±¡ã€‚

**ä¼˜ç‚¹ï¼š**

> å®ç°ç®€å•ï¼Œåªéœ€è¦åœ¨ç¬¬ä¸€é˜¶æ®µç»™æ¯ä¸ªå¯¹è±¡ç»´æŠ¤æ ‡å¿—ä½ï¼Œç¬¬äºŒé˜¶æ®µåˆ é™¤å¯¹è±¡å³å¯.

**ç¼ºç‚¹ï¼š**

> 1. **ç¢ç‰‡åŒ–é—®é¢˜**
>
>    > ç”±äº**å†…å­˜æ˜¯è¿ç»­çš„**ï¼Œæ‰€ä»¥åœ¨å¯¹è±¡è¢«åˆ é™¤ä¹‹åï¼Œå†…å­˜ä¸­ä¼šå‡ºç°å¾ˆå¤šç»†å°çš„å¯ç”¨å†…å­˜å•å…ƒã€‚å¦‚æœæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸ªæ¯”è¾ƒå¤§çš„ç©ºé—´ï¼Œå¾ˆæœ‰å¯èƒ½è¿™äº›å†…å­˜å•å…ƒçš„å¤§å°è¿‡å°æ— æ³•è¿›è¡Œåˆ†é…
>    >
>    > ![image-20240120163146951](./img/150.png)
>    >
>    > ![image-20240120163159483](./img/149.png)
>
> 2. åˆ†é…é€Ÿåº¦æ…¢ã€‚
>
>    > ç”±äºå†…å­˜ç¢ç‰‡çš„å­˜åœ¨ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ª**ç©ºé—²é“¾è¡¨**ï¼Œ**ææœ‰å¯èƒ½å‘ç”Ÿæ¯æ¬¡éœ€è¦éå†åˆ°é“¾è¡¨çš„æœ€åæ‰èƒ½è·å¾—åˆé€‚çš„å†…å­˜ç©ºé—´**ã€‚
>    >
>    > ![image-20240120163322369](./img/151.png)



##### å¤åˆ¶ç®—æ³•

æ ¸å¿ƒæ€æƒ³ä¸ºï¼š

1. å‡†å¤‡ä¸¤å—ç©ºé—´Fromç©ºé—´å’ŒToç©ºé—´ï¼Œæ¯æ¬¡åœ¨åˆ†é…å¯¹è±¡é˜¶æ®µï¼Œåªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€å—ç©ºé—´ï¼ˆFromç©ºé—´ï¼‰ã€‚
2. åœ¨åƒåœ¾å›æ”¶GCé˜¶æ®µï¼Œå°†Fromä¸­å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Toç©ºé—´ã€‚
3. å°†ä¸¤å—ç©ºé—´çš„Fromå’ŒToåå­—äº’æ¢ã€‚

**å®Œæ•´çš„å¤åˆ¶ç®—æ³•çš„ä¾‹å­ï¼š**

1. å°†å †å†…å­˜åˆ†å‰²æˆä¸¤å—**Fromç©ºé—´ã€Toç©ºé—´**ï¼Œå¯¹è±¡åˆ†é…é˜¶æ®µï¼Œåˆ›å»ºå¯¹è±¡ã€‚

2. GCé˜¶æ®µå¼€å§‹ï¼Œ**å°†GC Rootæ¬è¿åˆ°Toç©ºé—´**

3. å°†**GC Rootå…³è”çš„å¯¹è±¡ï¼Œæ¬è¿åˆ°Toç©ºé—´**

4. **æ¸…ç†Fromç©ºé—´**ï¼Œå¹¶æŠŠåç§°äº’æ¢

   > ![image-20240120163745591](./img/152.png)

**ä¼˜ç‚¹ï¼š**

> 1. **ååé‡é«˜**
>
>    > å¤åˆ¶ç®—æ³•åªéœ€è¦éå†ä¸€æ¬¡å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Toç©ºé—´å³å¯ï¼Œæ¯”æ ‡è®°-æ•´ç†ç®—æ³•å°‘äº†ä¸€æ¬¡éå†çš„è¿‡ç¨‹ï¼Œå› è€Œæ€§èƒ½è¾ƒå¥½ï¼Œ**ä½†æ˜¯ä¸å¦‚æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå› ä¸ºæ ‡è®°æ¸…é™¤ç®—æ³•ä¸éœ€è¦è¿›è¡Œå¯¹è±¡çš„ç§»åŠ¨**
>
> 2. **ä¸ä¼šå‘ç”Ÿç¢ç‰‡åŒ–**
>
>    > å¤åˆ¶ç®—æ³•åœ¨å¤åˆ¶ä¹‹åå°±ä¼šå°†å¯¹è±¡æŒ‰é¡ºåºæ”¾å…¥Toç©ºé—´ä¸­ï¼Œæ‰€ä»¥å¯¹è±¡ä»¥å¤–çš„åŒºåŸŸéƒ½æ˜¯å¯ç”¨ç©ºé—´ï¼Œä¸å­˜åœ¨ç¢ç‰‡åŒ–å†…å­˜ç©ºé—´ã€‚

**ç¼ºç‚¹ï¼š**

> **å†…å­˜ä½¿ç”¨æ•ˆç‡ä½**
>
> > æ¯æ¬¡åªèƒ½è®©ä¸€åŠçš„å†…å­˜ç©ºé—´æ¥ä¸ºåˆ›å»ºå¯¹è±¡ä½¿ç”¨



##### æ ‡è®°æ•´ç†ï¼ˆå‹ç¼©ï¼‰ç®—æ³•

> æ ‡è®°æ•´ç†ç®—æ³•ä¹Ÿå«æ ‡è®°å‹ç¼©ç®—æ³•ï¼Œ**æ˜¯å¯¹æ ‡è®°æ¸…ç†ç®—æ³•ä¸­å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡é—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ**

æ ¸å¿ƒæ€æƒ³åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. æ ‡è®°é˜¶æ®µï¼Œå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚Javaä¸­ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä»GC Rootå¼€å§‹é€šè¿‡å¼•ç”¨é“¾éå†å‡ºæ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚

2. æ•´ç†é˜¶æ®µï¼Œ**å°†å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°å †çš„ä¸€ç«¯**ã€‚æ¸…ç†æ‰å­˜æ´»å¯¹è±¡çš„å†…å­˜ç©ºé—´ã€‚

   > ![image-20240120164243224](./img/153.png)
   >
   > **é‚£ä¹ˆå°±ä¼šå¤šå‡ºæ¥ä¸€å—å®Œæ•´çš„å†…å­˜åŒºåŸŸ--çº¢è‰²éƒ¨åˆ†**
   >
   > ![image-20240119225913079](./img/154.png)



**ä¼˜ç‚¹ï¼š**

> 1. **å†…å­˜ä½¿ç”¨æ•ˆç‡é«˜**
>
>    > æ•´ä¸ªå †å†…å­˜éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä¸ä¼šåƒå¤åˆ¶ç®—æ³•åªèƒ½ä½¿ç”¨åŠä¸ªå †å†…å­˜
>
> 2. **ä¸ä¼šå‘ç”Ÿç¢ç‰‡åŒ–**
>
>    > åœ¨æ•´ç†é˜¶æ®µå¯ä»¥å°†å¯¹è±¡å¾€å†…å­˜çš„ä¸€ä¾§è¿›è¡Œç§»åŠ¨ï¼Œ**å‰©ä¸‹çš„ç©ºé—´éƒ½æ˜¯å¯ä»¥åˆ†é…å¯¹è±¡çš„æœ‰æ•ˆç©ºé—´**

ç¼ºç‚¹ï¼š

> **æ•´ç†é˜¶æ®µçš„æ•ˆç‡ä¸é«˜**
>
> > æ•´ç†ç®—æ³•æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚***Lisp2æ•´ç†ç®—æ³•éœ€è¦å¯¹æ•´ä¸ªå †ä¸­çš„å¯¹è±¡æœç´¢3æ¬¡ï¼Œæ•´ä½“æ€§èƒ½ä¸ä½³ã€‚***å¯ä»¥é€šè¿‡Two-Fingerã€è¡¨æ ¼ç®—æ³•ã€ImmixGcç­‰é«˜æ•ˆçš„æ•´ç†ç®—æ³•ä¼˜åŒ–æ­¤é˜¶æ®µçš„æ€§èƒ½
>
> 



##### åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•

> ç°ä»£ä¼˜ç§€çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œä¼šå°†ä¸Šè¿°æè¿°çš„åƒåœ¾å›æ”¶ç®—æ³•ç»„åˆè¿›è¡Œä½¿ç”¨ï¼Œå…¶ä¸­åº”ç”¨æœ€å¹¿çš„å°±æ˜¯åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•ï¼ˆGeneration GCï¼‰ã€‚

åˆ†ä»£åƒåœ¾å›æ”¶ç®—æ³•å°†æ•´ä¸ªå†…å­˜åŒºåŸŸåˆ’åˆ†ä¸º**å¹´è½»ä»£**å’Œ**è€å¹´ä»£**ï¼š

![image-20240120164845048](./img/155.png)



**ä½¿ç”¨ArthasæŸ¥çœ‹åˆ†ä»£ä¹‹åçš„å†…å­˜æƒ…å†µ**

- åœ¨JDK8ä¸­ï¼Œæ·»åŠ **-xx:+UseSerialGC**å‚æ•°ä½¿ç”¨åˆ†ä»£å›æ”¶çš„åƒåœ¾å›æ”¶å™¨ï¼Œè¿è¡Œç¨‹åº

- ä½¿ç”¨memoryå‘½ä»¤æŸ¥çœ‹å†…å­˜æƒ…å†µ

  > ![image-20240120165148349](./img/156.png)

**è°ƒæ•´å†…å­˜åŒºåŸŸçš„å¤§å°**

æ ¹æ®ä»¥ä¸‹è™šæ‹Ÿæœºå‚æ•°ï¼Œè°ƒæ•´å †çš„å¤§å°å¹¶è§‚å¯Ÿç»“æœã€‚æ³¨æ„åŠ ä¸Š**-XX:UseSerialGCï¼ˆä¸²è¡Œåƒåœ¾å›æ”¶å™¨ï¼‰**

|                 å‚æ•°å                  |                           å‚æ•°å«ä¹‰                           |                             ç¤ºä¾‹                             |
| :-------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|                  -Xms                   |       è®¾ç½®å †çš„æœ€å°å’Œåˆå§‹å¤§å°ï¼Œå¿…é¡»æ˜¯1024å€æ•°ä¸”å¤§äº1MB        | æ¯”å¦‚åˆå§‹å¤§å°6MBçš„å†™æ³•Xms6291456<br/>Xms6144k<br/>-Xms6m<br/> |
|                  -Xmx                   |        è®¾ç½®æœ€å¤§å †çš„å¤§å°ï¼Œå¿…é¡»æ˜¯1024å€æ•°ä¸”å¤§äº2MB<br/>        | æ¯”å¦‚æœ€å¤§å †80 MBçš„å†™æ³•:<br/>-Xmx83886080<br/>-Xmx81920k<br/>-Xmx80m<br/> |
|                  -Xmn                   |                      æ–°ç”Ÿä»£çš„å¤§å°<br/>                       | æ–°ç”Ÿä»£256 MBçš„å†™æ³•:-Xmn256m<br/>Xmn262144k<br/>-Xmn268435456<br/> |
|         -XX:SurvivorRatio<br/>          | ä¼Šç”¸å›­åŒºå’Œå¹¸å­˜åŒºçš„æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º8<br/>æ–°ç”Ÿä»£1gå†…å­˜ï¼Œä¼Šç”¸å›­åŒº800MB,S0å’ŒS1å„100MB<br/> |        æ¯”ä¾‹è°ƒæ•´ä¸º4çš„å†™æ³•:<br/>XX:SurvivorRatio=4<br/>        |
| -XX:+PrintGcDetails<br/>verbose:gc<br/> |                       æ‰“å°GCæ—¥å¿—<br/>                        |                              æ—                               |

> è§‚å¯ŸGCå˜åŒ–
>
> ```java
>  // --XX:+PrintGcDetails  -Xmx60m -Xms60M -XX:+UseSerialGC -XX:SurvivorRatio=3 -Xmn20M
>     public static void main(String[] args) throws IOException {
>         ArrayList<Object> objects = new ArrayList<>();
>         int count = 0;
>         while (true) {
>             System.in.read();
>             byte[] byteArray = new byte[1024 * 1024 * 10];
>             System.out.println(count);
>             objects.add(byteArray);
>             count++;
>         }
>     }
> 
> ```
>
> ```
> Heap
>  def new generation   total 16384K, used 11364K [0x00000007bc400000, 0x00000007bd800000, 0x00000007bd800000)
>   eden space 12288K,  92% used [0x00000007bc400000, 0x00000007bcf19108, 0x00000007bd000000)
>   from space 4096K,   0% used [0x00000007bd000000, 0x00000007bd000000, 0x00000007bd400000)
>   to   space 4096K,   0% used [0x00000007bd400000, 0x00000007bd400000, 0x00000007bd800000)
>  tenured generation   total 40960K, used 30720K [0x00000007bd800000, 0x00000007c0000000, 0x00000007c0000000)
>    the space 40960K,  75% used [0x00000007bd800000, 0x00000007bf600030, 0x00000007bf600200, 0x00000007c0000000)
>  Metaspace       used 3291K, capacity 4496K, committed 4864K, reserved 1056768K
>   class space    used 362K, capacity 388K, committed 512K, reserved 1048576K
> ```
>
> 

**åˆ†ä»£GCæµç¨‹**

- åˆ†ä»£å›æ”¶ç®—æ³•å›æ”¶æ—¶ï¼Œåˆ›å»ºå‡ºæ¥çš„å¯¹è±¡é¦–å…ˆä¼šè¢«æ”¾å…¥Edenä¼Šç”¸å›­åŒºã€‚

> ![image-20240120174126414](./img/157.png)

- éšç€å¯¹è±¡åœ¨EdenåŒºè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœEdenåŒºæ»¡äº†ï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡å·²ç»æ— æ³•æ”¾å…¥ï¼Œå°±ä¼šè§¦å‘å¹´è½»ä»£çš„GCï¼Œç§°ä¹‹ä¸ºMinor GCæˆ–è€…YoungGCã€‚Minor GCä¼šæŠŠéœ€è¦edenä¸­å’ŒFroméœ€è¦å›æ”¶çš„å¯¹è±¡å›æ”¶ï¼Œ**æŠŠæ²¡æœ‰å›æ”¶çš„å¯¹è±¡æ”¾å…¥ToåŒº**

> ![image-20240120174353932](./img/158.png)

- æ¥ä¸‹æ¥ S0åŒºä¼šå˜æˆToåŒºï¼ŒS1å˜æˆFromåŒºã€‚å½“edenåŒºæ»¡æ˜¯å†å¾€é‡Œæ”¾å…¥å¯¹è±¡ï¼Œä¾ç„¶ä¼šå‘ç”ŸMinor GCã€‚

![image-20240120174644172](./img/159.png)

- æ­¤æ—¶ä¼šå›æ”¶edenåŒºå’ŒS1ï¼ˆfromï¼‰ä¸­çš„å¯¹è±¡ï¼Œå¹¶æŠŠedenå’ŒfromåŒºä¸­å‰©ä½™çš„å¯¹è±¡æ”¾å…¥S0.

- æ³¨æ„ï¼šæ¯æ¬¡MinorGCåéƒ½ä¼šä¸ºå¯¹è±¡å¯„äº†ä»–çš„å¹´é¾„ï¼Œåˆå§‹å€¼ä¸º0ï¼Œæ¯æ¬¡GCå®ŒåŠ 1.

- å¦‚æœMinorGCåå¯¹è±¡çš„å¹´é¾„è¾¾åˆ°é˜€å€¼ï¼ˆæœ€å¤§15ï¼Œé»˜è®¤å€¼å’Œåƒåœ¾å›æ”¶å™¨æœ‰å…³ï¼Œæœ‰æ—¶å€™å½“youngåŒºæ»¡äº†ä¹‹åï¼Œä¸æ»¡15æ¬¡ä¹Ÿä¼šæ”¾å…¥OldåŒºï¼‰ï¼Œå¯¹è±¡å°±ä¼šè¢«æ™‹å‡è‡³è€å¹´ä»£ã€‚

> ![image-20240120175015382](./img/160.png)

- å½“è€å¹´ä»£ä¸­ç©ºé—´ä¸è¶³ï¼Œæ— æ³•æ”¾å…¥æ–°çš„å¯¹è±¡æ—¶ï¼Œå…ˆå°è¯•minor gcå¦‚æœè¿˜æ˜¯ä¸è¶³ï¼Œå°±ä¼šè§¦å‘Full GCï¼ŒFull GCä¼šå¯¹æ•´ä¸ªå †è¿›è¡Œåƒåœ¾å›æ”¶

> ![image-20240120175049694](./img/161.png)
>
> ![image-20240120175116465](./img/162.png)



**ä¸‹å›¾ä¸ºä»€ä¹ˆä¼šå‡ºç°OutOf Memoryï¼Ÿ**

![image-20240120175203293](./img/163.png)

> Full GCåã€‚æ— æ³•å›æ”¶è€å¹´ä»£**99.93%**ï¼Œé‚£ä¹ˆç»§ç»­å¾€Old åŒºæ”¾æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å¼‚å¸¸ã€‚





#### åƒåœ¾å›æ”¶å™¨

**ä¸ºä»€ä¹ˆGCç®—æ³•è¦æŠŠHeapåˆ†æˆå¹´è½»ä»£å’Œè€å¹´ä»£ï¼Ÿ**

> - ç³»ç»Ÿä¸­çš„å¤§éƒ¨åˆ†å¯¹è±¡ï¼Œéƒ½æ˜¯åˆ›å»ºå‡ºæ¥ä¹‹åå¾ˆå¿«å°±ä¸å†ä½¿ç”¨å¯ä»¥è¢«å›æ”¶ï¼Œå¦‚æœæŸ¥è¯¢æŸæŸæ•°æ®ï¼Œæ•°æ®è¿”å›ä¹‹åå°±å¯ä»¥é‡Šæ”¾äº†ã€‚
> - è€å¹´ä»£ä¸­ä¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œæ¯”å¦‚Springçš„å¤§éƒ¨åˆ†Beanå¯¹è±¡ï¼Œåœ¨ç¨‹åºå¯åŠ¨ä¹‹åå°±ä¸ä¼šè¢«å›æ”¶äº†ã€‚
> - åœ¨è™šæ‹Ÿæœºçš„é»˜è®¤è®¾ç½®ä¸­ï¼Œæ–°ç”Ÿä»£çš„å¤§å°è¦è¿œå°äºè€å¹´ä»£çš„å¤§å°ã€‚
>
> 1. å¯ä»¥é€šè¿‡è°ƒæ•´YoungåŒºåŸŸå’ŒOldåŒºçš„æ¯”ä¾‹æ¥é€‚ç”¨ä¸åŒç±»å‹çš„åº”ç”¨ç¨‹åºï¼Œæé«˜å†…å­˜çš„åˆ©ç”¨æ•ˆç‡å’Œæ€§èƒ½
> 2. YoungåŒºå’ŒOldåŒºä½¿ç”¨ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚YoungåŒºä¸€èˆ¬ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£å¯ä»¥é€‰æ‹©-æ ‡è®°å’Œæ¸…é™¤-æ•´ç†ç®—æ³•ï¼Œç”±ç¨‹åºå‘˜æ¥é€‰æ‹©çš„çµæ´»åº¦è¾ƒé«˜
> 3. åˆ†ä»£çš„è®¾è®¡ä¸­å…è®¸åªå›æ”¶YoungåŒºï¼ˆMinor GCï¼‰ï¼Œå¦‚æœèƒ½æ»¡è¶³å¯¹è±¡åˆ†é…çš„è¦æ±‚å°±ä¸éœ€è¦å¯¹æ•´ä¸ªå †è¿›è¡Œå›æ”¶ï¼ˆFull GCï¼‰ï¼ŒSTWå ç”¨çš„æ—¶é—´å°±ä¼šå‡å°‘ã€‚
>
> ![image-20240122125911330](./img/164.png)



---



##### åƒåœ¾å›æ”¶å™¨çš„ç»„åˆ

åƒåœ¾å›æ”¶å™¨æ˜¯åƒåœ¾å›æ”¶ç®—æ³•çš„å…·ä½“å®ç°ã€‚

ç”±äºåƒåœ¾å›æ”¶å™¨åˆ†ä¸ºYoungåŒºå’ŒOldåŒºï¼Œå‡ºäº†G1ä¹‹å¤–å…¶ä»–åƒåœ¾å›æ”¶å™¨å¿…é¡»æˆå¯¹ç»„åˆè¿›è¡Œä½¿ç”¨ã€‚

å…·ä½“çš„å…³ç³»å›¾ï¼š

> åªæ¨èä½¿ç”¨å®çº¿è¿æ¥çš„
>
> ![image-20240122130537756](./img/165.png)



###### å¹´è½»ä»£-Serialåƒåœ¾å›æ”¶å™¨

>  Serialæ˜¯ä¸€ç§**å•çº¿ç¨‹ä¸²è¡Œ**çš„åƒåœ¾å›æ”¶å™¨
>
> ![image-20240122130923169](./img/166.png)
>
> å›æ”¶å¹´ä»£ï¼šå¹´è½»ä»£
>
> å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•
>
> ä¼˜ç‚¹ï¼šå•CPUå¤„ç†å™¨ä¸‹ååé‡éå¸¸å‡ºè‰²
>
> ç¼ºç‚¹ï¼šå¤šCPUä¸‹ååé‡ä¸å¦‚å…¶ä»–åƒåœ¾å›æ”¶å™¨ï¼ŒHeapå¦‚æœåå¤§ï¼Œä¼šè®©ç”¨æˆ·çº¿ç¨‹å¤„äºé•¿æ—¶é—´çš„ç­‰å¾…
>
> ä½¿ç”¨åœºæ™¯ï¼šJavaç¼–å†™çš„å®¢æˆ·ç«¯ç¨‹åºæˆ–è€…ç¡¬ä»¶é…ç½®æœ‰é™çš„åœºæ™¯



###### è€å¹´ä»£-SerialOldåƒåœ¾å›æ”¶å™¨

> SerialOldæ˜¯Serialåƒåœ¾å›æ”¶å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œé‡‡ç”¨**å•çº¿ç¨‹ä¸²è¡Œå›æ”¶**ï¼Œ**-XX:+UseSerialGC æ–°ç”Ÿä»£ã€è€å¹´ä»£éƒ½é€‚ç”¨ä¸²è¡Œå›æ”¶å™¨**
>
> ![image-20240122131605767](./img/167.png)
>
> å›æ”¶å¹´ä»£ï¼šè€å¹´ä»£
>
> å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•
>
> ä¼˜ç‚¹ï¼šå•CPUå¤„ç†å™¨ä¸‹ååé‡éå¸¸å‡ºè‰²
>
> ç¼ºç‚¹ï¼šå¤šCPUä¸‹ååé‡ä¸å¦‚å…¶ä»–åƒåœ¾å›æ”¶å™¨ï¼ŒHeapå¦‚æœåå¤§ï¼Œä¼šè®©ç”¨æˆ·çº¿ç¨‹å¤„äºé•¿æ—¶é—´çš„ç­‰å¾…
>
> ä½¿ç”¨åœºæ™¯ï¼šä¸Serialåƒåœ¾å›æ”¶å™¨æ­é…ä½¿ç”¨ï¼Œæˆ–è€…åœ¨CMSç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨







###### å¹´è½»ä»£-ParNewåƒåœ¾å›æ”¶å™¨

>**ParNewåƒåœ¾å›æ”¶å™¨æœ¬è´¨ä¸Šæ˜¯å¯¹Serialåœ¨å¤šCPUä¸‹çš„ä¼˜åŒ–ï¼Œä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶**
>
>**-XX:+UseParNewGC YoungåŒºä½¿ç”¨ParNewå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨SerialOldå›æ”¶å™¨**
>
>![image-20240122132019645](./img/168.png)
>
>å›æ”¶å¹´ä»£ï¼šå¹´è½»ä»£
>
>å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•
>
>ä¼˜ç‚¹ï¼šå¤šCPUå¤„ç†å™¨ä¸‹åœé¡¿æ—¶é—´è¾ƒçŸ­
>
>ç¼ºç‚¹ï¼šååé‡å’Œåœé¡¿æ—¶é—´ä¸å¦‚G1ï¼Œæ‰€ä»¥åœ¨JDK9ä¹‹åä¸å»ºè®®ä½¿ç”¨
>
>ä½¿ç”¨åœºæ™¯ï¼šJDK8åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œä¸CMSè€å¹´ä»£åƒåœ¾å›æ”¶å™¨æ­é…ä½¿ç”¨



###### è€å¹´ä»£-CMS(Concurrent Mark Sweep)åƒåœ¾å›æ”¶å™¨

> CMSåƒåœ¾å›æ”¶å™¨å…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„**æš‚åœæ—¶é—´**ï¼Œå…è®¸ç”¨æˆ·çº¿ç¨‹å’Œåƒåœ¾å›æ”¶çº¿ç¨‹åœ¨æŸäº›æ­¥éª¤ä¸­åŒæ—¶æ‰§è¡Œï¼Œå‡å°‘äº†ç”¨æˆ·çº¿ç¨‹çš„ç­‰å¾…æ—¶é—´
>
> ![image-20240122132321936](./img/169.png)
>
> å‚æ•°ï¼šXX:+UseConcMarkSweepGC
>
> å›æ”¶å¹´ä»£ï¼šå¹´è½»ä»£
>
> å›æ”¶ç®—æ³•ï¼šæ ‡è®°æ¸…é™¤ç®—æ³•
>
> ä¼˜ç‚¹ï¼šç³»ç»Ÿç”±äºåƒåœ¾å›æ”¶å‡ºç°çš„åœé¡¿æ—¶é—´è¾ƒçŸ­ï¼Œç”¨æˆ·ä½“éªŒå¥½
>
> ç¼ºç‚¹ï¼š1. å†…å­˜ç¢ç‰‡é—®é¢˜ 2. é€€åŒ–é—®é¢˜ 3. æµ®åŠ¨åƒåœ¾é—®é¢˜
>
> ä½¿ç”¨åœºæ™¯ï¼šå¤§å‹çš„äº’è”ç½‘ç³»ç»Ÿä¸­è¯·æ±‚æ•°æ®é‡å¤§ï¼Œé¢‘ç‡é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚è®¢å•æ¥å£ã€å•†å“æ¥å£ç­‰
>
> **ğŸŒŸCMSæ‰§è¡Œæ­¥éª¤ï¼š**
>
> 1. åˆå§‹æ ‡è®°ï¼Œç”¨æçŸ­çš„æ—¶é—´æ ‡è®°å¤„GC Rootsèƒ½ç›´æ¥å…³è”çš„å¯¹è±¡ã€‚
> 2. å¹¶å‘æ ‡è®°ï¼Œæ ‡è®°æ‰€æœ‰çš„å¯¹è±¡ï¼Œç”¨æˆ·çº¿ç¨‹ä¸éœ€è¦æš‚åœ
> 3. é‡æ–°æ ‡è®°ï¼Œç”±äºå¹¶å‘æ ‡è®°é˜¶æ®µæœ‰äº›å¯¹è±¡ä¼šå‘ç”Ÿäº†å˜åŒ–ï¼Œå­˜åœ¨é”™æ ‡ã€æ¼æ ‡ç­‰æƒ…å†µï¼Œéœ€è¦é‡æ–°æ ‡è®°ã€‚
> 4. å¹¶å‘æ¸…ç†ï¼Œæ¸…ç†æ­»äº¡çš„å¯¹è±¡ï¼Œç”¨æˆ·çº¿ç¨‹ä¸éœ€è¦æš‚åœã€‚
>
> ![image-20240122133103265](./img/170.png)
>
> ç¼ºç‚¹ï¼š
>
> 1. CMSä½¿ç”¨äº†æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶ç»“æŸä¹‹åä¼šå‡ºç°å¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼ŒCMSä¼šåœ¨Full GCæ—¶è¿›è¡Œç¢ç‰‡çš„æ•´ç†ã€‚è¿™æ ·ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹æš‚åœï¼Œå¯ä»¥ä½¿ç”¨-XX:CMSFullGCsBeforeCompaction=N å‚æ•°ï¼ˆé»˜è®¤0ï¼‰ è°ƒæ•´Næ¬¡Full ä¹‹åå†æ•´ç†ã€‚
>
> 2. æ— æ³•å¤„ç†åœ¨å¹¶å‘æ¸…ç†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„â€œæµ®åŠ¨åƒåœ¾â€ï¼Œä¸èƒ½åšåˆ°å®Œå…¨çš„åƒåœ¾å›æ”¶ã€‚
>
> 3. å¦‚æœè€å¹´ä»£å†…å­˜ä¸è¶³æ— æ³•åˆ†é…å¯¹è±¡ï¼ŒCMSå°±ä¼šé€€åŒ–æˆSerial Oldå•çº¿ç¨‹å›æ”¶è€å¹´ä»£ã€‚
>
>    ![image-20240122133925447](./img/171.png)



###### å¹´è½»ä»£- Parallel Scavengeåƒåœ¾å›æ”¶å™¨

> Parallel Scavenge æ˜¯JDK8é»˜è®¤çš„å¹´è½»ä»£åƒåœ¾å›æ”¶å™¨ï¼Œ**å¤šçº¿ç¨‹å¹¶è¡Œå›æ”¶ï¼Œå…³æ³¨çš„æ˜¯ç³»ç»Ÿçš„ååé‡**ã€‚å…·å¤‡**è‡ªåŠ¨è°ƒæ•´å †å†…å­˜å¤§å°çš„**ç‰¹ç‚¹ã€‚
>
> ![image-20240124160255636](./img/172.png)
>
> 
>
> å›æ”¶å¹´ä»£ï¼šå¹´è½»ä»£
>
> å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•
>
> ä¼˜ç‚¹ï¼šååé‡é«˜ï¼Œè€Œä¸”å¯ä»¥æ‰‹åŠ¨å¯æ§ã€‚ä¸ºäº†æé«˜ååé‡ï¼Œè™šæ‹Ÿæœºä¼šåŠ¨æ€è°ƒæ•´å †çš„å‚æ•°
>
> ç¼ºç‚¹ï¼šä¸èƒ½ä¿è¯å•æ¬¡çš„åœé¡¿æ—¶é—´
>
> ä½¿ç”¨åœºæ™¯ï¼šåå°ä»»åŠ¡ï¼Œä¸éœ€è¦ä¸ç”¨æˆ·äº¤äº’ï¼Œå¹¶ä¸”å®¹æ˜“äº§ç”Ÿå¤§é‡çš„å¯¹è±¡ï¼Œæ¯”å¦‚å¤§æ•°æ®çš„å¤„ç†ã€å¤§æ–‡ä»¶å¯¼å‡ºã€‚



###### è€å¹´ä»£- Parallel Oldåƒåœ¾å›æ”¶å™¨

> Parallel Oldæ˜¯ä¸ºParallel Scavengeæ”¶é›†å™¨è®¾è®¡çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹å¹¶å‘æ”¶é›†ã€‚
>
> ![image-20240124160656710](./img/173.png)
>
> å‚æ•°ï¼šXX:+UseConcMarkSweepGC
>
> å›æ”¶å¹´ä»£ï¼šè€å¹´ä»£
>
> å›æ”¶ç®—æ³•ï¼šæ ‡è®°-æ•´ç†ç®—æ³•
>
> ä¼˜ç‚¹ï¼šå¹¶å‘æ”¶é›†ï¼Œåœ¨å¤šæ ¸CPUä¸‹æ•ˆç‡è¾ƒé«˜
>
> ç¼ºç‚¹ï¼šæš‚åœæ—¶é—´ä¼šæ¯”è¾ƒé•¿
>
> ä½¿ç”¨åœºæ™¯ï¼šä¸Parallel Scavenge é…å¥—ä½¿ç”¨

Parallel Scavengeåƒåœ¾å›æ”¶å™¨

> å…è®¸æ‰‹åŠ¨è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´å’Œååé‡ã€‚
>
> Oracleå®˜æ–¹å»ºè®®åœ¨ä½¿ç”¨è¿™ä¸ªç»„åˆæ—¶ï¼Œ**ä¸è¦è®¾ç½®å †å†…å­˜çš„æœ€å¤§å€¼**ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šæ ¹æ®æœ€å¤§æš‚åœæ—¶é—´å’Œååé‡è‡ªåŠ¨è°ƒæ•´å†…å­˜å¤§å°
>
> **æœ€å¤§æš‚åœæ—¶é—´ï¼š`-XX:MaxGCPauseMillis` è®¾ç½®æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶çš„æœ€å¤§åœé¡¿æ¯«ç§’æ•°**
>
> **ååé‡ï¼š-XX:GCTimeRatio=n è®¾ç½®ååé‡ä¸ºnï¼ˆç”¨æˆ·æ‰§è¡Œæ—¶é—´=n/n+1ï¼‰**
>
> **è‡ªåŠ¨è°ƒæ•´å†…å­˜å¤§å°ï¼š`-XX:+UseAdaptiveSizePolicy` è®¾ç½®å¯ä»¥è®©åƒåœ¾å›æ”¶å™¨æ ¹æ®ååé‡å’Œæœ€å¤§åœé¡¿çš„æ¯«ç§’æ•°è‡ªåŠ¨è°ƒæ•´å†…å­˜å¤§å°**



##### G1åƒåœ¾å›æ”¶å™¨

JDK9ä¹‹åé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨æ—¶G1 ï¼ˆGarbage Firstï¼‰åƒåœ¾å›æ”¶å™¨ã€‚

Parallel Scavenge å…³æ³¨ååé‡ï¼Œå…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´ï¼Œä½†æ˜¯ä¼šå‡å°‘å¹´è½»ä»£å¯ç”¨ç©ºé—´çš„å¤§å°ã€‚

CMSå…³æ³¨æš‚åœæ—¶é—´ï¼Œä½†æ˜¯ååé‡æ–¹é¢ä¼šä¸‹é™ã€‚

è€ŒG1è®¾è®¡ç›®æ ‡å°±æ˜¯å°†ä¸Šè¿°ä¸¤ç§åƒåœ¾å›æ”¶å™¨çš„ä¼˜ç‚¹èåˆï¼š

1. æ”¯æŒå·¨å¤§çš„Heapå›æ”¶ï¼Œå¹¶æœ‰è¾ƒé«˜çš„ååé‡ã€‚
2. æ”¯æŒå¤šCPUå¹¶è¡Œåƒåœ¾å›æ”¶
3. å…è®¸ç”¨æˆ·è®¾ç½®æœ€å¤§æš‚åœæ—¶é—´

**ğŸŒŸJDK9ä¹‹åå¼ºçƒˆå»ºè®®ä½¿ç”¨G1åƒåœ¾å›æ”¶å™¨**



###### G1-å†…å­˜ç»“æ„

G1çš„æ•´ä¸ªå †ä¼šè¢«åˆ’åˆ†æˆå¤šä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼Œç§°ä¹‹ä¸ºåŒº**Region**ï¼ŒåŒºåŸŸä¸è¦æ±‚æ˜¯è¿ç»­çš„ã€‚åˆ†ä¸º**Eden**ã€**Survivor**ã€**OldåŒº**ã€‚Regionçš„å¤§å°é€šè¿‡å †ç©ºé—´å¤§å°/2048è®¡ç®—å¾—åˆ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°**-XX:G1HeapRegionSize=32m**æŒ‡å®š(å…¶ä¸­32mæŒ‡å®šregionå¤§å°ä¸º32M)ï¼Œ**Region sizeå¿…é¡»æ˜¯2çš„æŒ‡æ•°å¹•ï¼Œå–å€¼èŒƒå›´ä»1Måˆ°32Mã€‚**

<img src="./img/174.png" alt="image-20240124215912333" style="zoom:50%;" />

G1åƒåœ¾å›æ”¶æ–¹å¼ï¼š

- **å¹´è½»ä»£å›æ”¶ï¼ˆYoung GCï¼‰**
- **æ··åˆå›æ”¶ï¼ˆMixed GCï¼‰**



###### G1-å¹´è½»ä»£å›æ”¶

- å¹´è½»ä»£å›æ”¶ï¼ˆYoung GCï¼‰ï¼Œå›æ”¶EdenåŒºå’ŒSurvivoråŒºä¸­ä¸ç”¨çš„å¯¹è±¡ã€‚ä¼šå¯¼è‡´STWï¼ŒG1ä¸­å¯ä»¥é€šè¿‡å‚æ•°-XX:MaxGCPauseMillis=nï¼ˆé»˜è®¤ä¸º200ï¼‰è®¾ç½®æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶çš„æœ€å¤§æš‚åœæ—¶é—´æ¯«ç§’æ•°ï¼ŒG1åƒåœ¾å›æ”¶å™¨ä¼šå°½å¯èƒ½åœ°ä¿è¯æš‚åœæ—¶é—´ã€‚

- **æ‰§è¡Œæµç¨‹ï¼š**

  > 1. æ–°åˆ›å»ºçš„å¯¹è±¡ä¼šå­˜æ”¾åœ¨EdenåŒºã€‚å½“G1åˆ¤æ–­å¹´è½»ä»£åŒºä¸è¶³ï¼ˆMaxé»˜è®¤ä¸º60%ï¼‰ï¼Œæ— æ³•åˆ†é…å¯¹è±¡æ—¶éœ€è¦å›æ”¶æ—¶ä¼šæ‰§è¡ŒYoung GC
  > 2. æ ‡è®°å‡ºEdenå’ŒSurvivoråŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡
  > 3. æ ¹æ®é…ç½®çš„æœ€å¤§æš‚åœæ—¶é—´**é€‰æ‹©æŸäº›åŒºåŸŸå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„SurvivoråŒºä¸­ï¼ˆå¹´é¾„+1ï¼‰**ï¼Œæ¸…ç©ºè¿™äº›åŒºåŸŸã€‚
  >
  > <img src="./img/175.png" alt="image-20240124220616969" style="zoom: 25%;" /><img src="./img/176.png" alt="image-20240124220641313" style="zoom: 25%;" />

> G1åœ¨è¿›è¡ŒYoung GCåˆ°è¿‡ç¨‹ä¸­ä¼šå»è®°å½•æ¯æ¬¡åƒåœ¾å›æ”¶æ—¶æ¯ä¸ªEdenåŒºå’ŒSurvivoråŒºçš„å¹³å‡è€—æ—¶ï¼Œä»¥ä½œä¸ºä¸‹æ¬¡å›æ”¶æ—¶çš„å‚è€ƒä¾æ®ã€‚è¿™æ ·å°±å¯ä»¥æ ¹æ®é…ç½®çš„æœ€å¤§æš‚åœæ—¶é—´è®¡ç®—å‡ºæœ¬æ¬¡å›æ”¶æ—¶æœ€å¤šèƒ½å›æ”¶å¤šå°‘ä¸ªRegionåŒºåŸŸäº†ã€‚
>
> æ¯”å¦‚ï¼š-XX:MaxGCPauseMillis=nï¼ˆé»˜è®¤200ï¼‰ æ¯ä¸ªRegionå›æ”¶è€—æ—¶40msï¼Œé‚£ä¹ˆæ¯æ¬¡å›æ”¶æœ€å¤šåªèƒ½å›æ”¶4ä¸ªRegionã€‚
>
> <img src="./img/177.png" alt="image-20240124221610205" style="zoom:50%;" />
>
> 4. åç»­Young GCæ—¶ä¸ä¹‹å‰ç›¸åŒï¼Œåªä¸è¿‡SurvivoråŒºä¸­å­˜æ´»å¯¹è±¡ä¼šè¢«æ¬è¿åˆ°å¦ä¸€ä¸ªSurvivoråŒºã€‚
>
> <img src="./img/178.png" alt="image-20240124221734240" style="zoom: 33%;" />
>
> 5. å½“æŸä¸ªå­˜æ´»å¯¹è±¡çš„å¹´é¾„åˆ°è¾¾é˜€å€¼ï¼ˆé»˜è®¤15ï¼‰ï¼Œå°†è¢«æ”¾å…¥è€å¹´ä»£ã€‚
>
>    <img src="./img/179.png" alt="image-20240124221921234" style="zoom:33%;" />
>
> 6. éƒ¨åˆ†å¯¹è±¡å¦‚æœå¤§å°è¶…è¿‡Regionçš„ä¸€åŠï¼Œä¼šç›´æ¥æ”¾å…¥è€å¹´ä»£ï¼Œè¿™ç±»è€å¹´ä»£è¢«ç§°ä¸º**HumongousåŒº**ã€‚æ¯”å¦‚å †å†…å­˜æ—¶4Gï¼Œæ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡1Må°±ä¼šè¢«æ”¾å…¥HumongousåŒºï¼Œå¦‚æœå¯¹è±¡è¿‡å¤§ä¼šæ¨ªè·¨å¤šä¸ªRegionã€‚
>
>    <img src="./img/180.png" alt="image-20240124222224073" style="zoom:33%;" />



###### G1-æ··åˆå›æ”¶

> 7. å¤šæ¬¡åƒåœ¾å›æ”¶ä¹‹åï¼Œä¼šå‡ºç°å¾ˆå¤šOldè€å¹´ä»£åŒºï¼Œæ­¤æ—¶æ€»Heapå ç”¨ç‡è¾¾åˆ°é˜€å€¼æ—¶ï¼ˆ-XX:InitiatingHeap OccupancyPercent é»˜è®¤45%ï¼‰ä¼šè§¦å‘æ··åˆå›æ”¶MixedGCã€‚å›æ”¶æ‰€æœ‰å¹´è½»ä»£å’Œéƒ¨åˆ†è€å¹´ä»£çš„å¯¹è±¡ä»¥åŠå¤§å¯¹è±¡åŒºã€‚é‡‡ç”¨å¤åˆ¶ç®—æ³•æ¥å®Œæˆã€‚
>
>    <img src="./img/182.png" alt="image-20240124222700950" style="zoom:33%;" />

- **æ··åˆå›æ”¶åˆ†ä¸ºï¼šåˆå§‹æ ‡è®°ï¼ˆinitial markï¼‰ã€å¹¶å‘æ ‡è®°ï¼ˆconcurrent markï¼‰ã€æœ€ç»ˆæ ‡è®°ï¼ˆremarkæˆ–è€…Finalize Markingï¼‰ã€å¹¶å‘æ¸…ç†ï¼ˆcleanupï¼‰**

- G1å¯¹è€å¹´ä»£çš„æ¸…ç†ä¼šé€‰æ‹©å­˜æ´»åº¦æœ€ä½çš„åŒºåŸŸæ¥è¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å›æ”¶æ•ˆç‡æœ€é«˜ï¼Œè¿™ä¹Ÿæ˜¯G1ï¼ˆGarbage Firstï¼‰åç§°çš„ç”±æ¥

  > ![image-20240124222948542](./img/181.png)
  >
  > ![image-20240124223035049](./img/183.png)

- æœ€åæ¸…ç†é˜¶æ®µä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡

  > ![image-20240124223302635](./img/184.png)



###### G1-Full GC

æ³¨æ„ï¼šå¦‚æœæ¸…ç†è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºRegionå­˜æ”¾è½¬ç§»çš„å¯¹è±¡ï¼Œä¼šå‡ºç°Full GCã€‚å•çº¿ç¨‹æ‰§è¡Œæ ‡è®°-æ•´ç†ç®—æ³•ï¼Œæ­¤æ—¶ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹çš„æš‚åœã€‚æ‰€ä»¥å°½é‡ä¿è¯åº”ç”¨çš„Heapæœ‰ä¸€å®šå¤šä½™çš„ç©ºé—´ã€‚

> <img src="./img/185.png" alt="image-20240124223629239" style="zoom:50%;" />
>
> **å‚æ•°1: -XX:+UseG1GC æ‰“å¼€G1çš„å¼€å…³ï¼ŒJDK9ä¹‹åé»˜è®¤ä¸éœ€è¦æ‰“å¼€**
>
> **å‚æ•°2: -XX:MaxGCPauseMillis=æ¯«ç§’å€¼æœ€å¤§æš‚åœçš„æ—¶é—´**
>
> <img src="./img/186.png" alt="image-20240124223747007" style="zoom:50%;" />
>
> å›æ”¶å¹´ä»£ï¼šå¹´è½»ä»£+è€å¹´ä»£
>
> å›æ”¶ç®—æ³•ï¼šå¤åˆ¶ç®—æ³•
>
> **ä¼˜ç‚¹ï¼šå¯¹æ¯”è¾ƒå¤§çš„Heap å¦‚è¶…è¿‡6Gå¤§Heapå›æ”¶æ—¶ï¼Œå»¶è¿Ÿå¯æ§ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¹¶å‘æ ‡è®°çš„SATBç®—æ³•æ•ˆç‡é«˜**
>
> **ç¼ºç‚¹ï¼šJDK8ä¹‹å‰è¿˜ä¸å¤Ÿæˆç†Ÿ**
>
> ä½¿ç”¨åœºæ™¯ï¼šJDK8æœ€æ–°ç‰ˆæœ¬ï¼ŒJDK9ä¹‹åå»ºè®®é»˜è®¤ä½¿ç”¨

ğŸŒŸTipsï¼š

> åƒåœ¾å›æ”¶å™¨çš„ç»„åˆå…³ç³»è™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯é’ˆå¯¹å‡ ä¸ªç‰¹å®šçš„ç‰ˆæœ¬ï¼Œæ¯”è¾ƒå¥½çš„ç»„åˆé€‰æ‹©å¦‚ä¸‹:
> **JDK8åŠä¹‹å‰ï¼š**
> **ParNew + CMS (å…³æ³¨æš‚åœæ—¶é—´) ã€Parallel Scavenge + Parallel Old (å…³æ³¨ååé‡)ã€ G1 (DK8ä¹‹å‰ä¸å»ºè®®ï¼Œè¾ƒå¤§å †å¹¶ä¸”å…³æ³¨æš‚åœæ—¶é—´)**
> **JDK9ä¹‹å:**
> **G1 (é»˜è®¤)**
>
> ä»JDK9ä¹‹åï¼Œç”±äºG1æ—¥è¶‹æˆç†Ÿï¼ŒJDKé»˜è®¤çš„åƒåœ¾å›æ”¶å™¨å·²ç»ä¿®æ”¹ä¸ºG1ï¼Œæ‰€ä»¥å¼ºçƒˆå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½¿ç”¨G1ã€‚
> G1çš„å®ç°åŸç†å°†åœ¨ã€ŠåŸç†ç¯‡ã€‹ä¸­ä»‹ç»ï¼Œæ›´å¤šå‰æ²¿æŠ€æœ¯ZGCã€GraalVMå°†åœ¨ã€Šé«˜çº§ç¯‡ã€‹ä¸­ä»‹ç»



1ã€Javaä¸­æœ‰å“ªå‡ å—å†…å­˜éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶?
2ã€æœ‰å“ªå‡ ç§å¸¸è§çš„å¼•ç”¨ç±»å‹?
3ã€æœ‰å“ªå‡ ç§å¸¸è§çš„åƒåœ¾å›æ”¶ç®—æ³•?
4ã€å¸¸è§çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›?
