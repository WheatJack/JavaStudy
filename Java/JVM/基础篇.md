 ![image-20240112211249969](./img/1.png)



# 1ã€åŸºç¡€ç¯‡

## åˆå§‹JVM

### ä»€ä¹ˆæ˜¯JVM

JVMæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨è®¡ç®—æœºä¸Šçš„ç¨‹åºï¼Œä»–çš„èŒè´£æ˜¯è¿è¡ŒJavaå­—èŠ‚ç æ–‡ä»¶ã€‚

![image-20240113220844018](./img/2.png)



### JVMçš„åŠŸèƒ½

**1ã€è§£é‡Šå’Œè¿è¡Œ**

- å¯¹å­—èŠ‚ç æ–‡ä»¶ä¸­çš„æŒ‡ä»¤ï¼Œå®æ—¶çš„è§£é‡Šç§°æœºå™¨ç ï¼Œè®©è®¡ç®—æœºæ‰§è¡Œ

**2ã€å†…å­˜ç®¡ç†**

- è‡ªåŠ¨ä¸ºå¯¹è±¡ã€æ–¹æ³•ç­‰åˆ†é…å†…å­˜
- è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå›æ”¶ä¸åœ¨ä½¿ç”¨çš„å¯¹è±¡

**3ã€å³æ—¶ç¼–è¯‘**

å¯¹çƒ­ç‚¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œæå‡æ‰§è¡Œæ•ˆç‡



### å³æ—¶ç¼–è¯‘

Javaè¯­è¨€å¦‚æœä¸åšä»»ä½•ä¼˜åŒ–ï¼Œæ€§èƒ½ä¸å¦‚C++ç­‰è¯­è¨€ã€‚

> **å› ä¸ºæ˜¯å®æ—¶è§£é‡Šä¸ºæœºå™¨ç **

![image-20240113221332594](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221332594.png)

è€Œå…¶ä»–çš„C++è¯­è¨€æ˜¯æ‰“åŒ…ç¼–è¯‘ç§°å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæœºå™¨ç ï¼‰

> **ç›´æ¥è¿è¡Œæœºå™¨ç **

![image-20240113221345653](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221345653.png)

**Javaéœ€è¦å®æ—¶è§£é‡Šçš„åŸå› ï¼Ÿ**

> ä¸»è¦æ˜¯é—®äº†è·¨å¹³å°ç‰¹æ€§

![image-20240113221444191](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240113221444191.png)

![image-20240112212203984](./img/7.png)

JVMæä¾›äº†**å³æ—¶ç¼–è¯‘**ï¼ˆJust-In-Time ç®€ç§°JITï¼‰è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°æ¥è¿‘C++è¯­è¨€çš„è¿è¡Œæ€§èƒ½ï¼Œç”šè‡³åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹å®ç°äº†è¶…è¶Šã€‚



### å¸¸è§çš„JVM

![image-20240112212234283](./img/9.png)



å¸¸è§çš„JVM-HotSpotçš„å‘å±•å†ç¨‹

![image-20240112212829319](./img/10.png)



## å­—èŠ‚ç æ–‡ä»¶è¯¦è§£

### 1.Javaè™šæ‹Ÿæœºçš„ç»„æˆ

ä¸»è¦åŒ…æ‹¬ï¼š

- ç±»åŠ è½½å™¨
- è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆJVMç®¡ç†çš„å†…å­˜ï¼‰
- æ‰§è¡Œå¼•æ“ï¼ˆå³æ—¶ç¼–è¯‘å™¨ã€è§£é‡Šå™¨ã€åƒåœ¾å›æ”¶å™¨ç­‰ï¼‰

![image-20240112213321990](./img/13.png)



### 2.å­—èŠ‚ç æ–‡ä»¶çš„ç»„æˆ

ä¸»è¦åŒ…æ‹¬ï¼š

- åŸºæœ¬ä¿¡æ¯
- å¸¸é‡æ± 
- æ¥å£
- æ–¹æ³•
- å±æ€§

![image-20240112214640168](./img/15.png)

**æŸ¥çœ‹å­—èŠ‚ç å¸¸ç”¨çš„å·¥å…·**

- Javapå‘½ä»¤

- Jclasslibè½¯ä»¶æˆ–è€…æ’ä»¶

  > ![image-20240112215217620](./img/11.png)
  >
  > githubåœ°å€ï¼šhttps://github.com/ingokegel/jclasslib

- Arthus

  > å®˜ç½‘åœ°å€ï¼šhttps://arthas.aliyun.com/doc/





#### 1ï¼‰åŸºæœ¬ä¿¡æ¯

**Magicé­”æ•°**

- æ–‡ä»¶æ˜¯æ— æ³•é€šè¿‡æ–‡ä»¶æ‰©å±•åæ¥ç¡®å®šæ–‡ä»¶ç±»å‹çš„ï¼Œæ–‡ä»¶æ‰©å±•åå¯ä»¥éšæ„ä¿®æ”¹ï¼Œä¸å½±å“æ–‡ä»¶çš„å†…å®¹
- è½¯ä»¶ä½¿ç”¨æ–‡ä»¶çš„å¤´å‡ ä¸ªå­—èŠ‚ï¼ˆæ–‡ä»¶å¤´ï¼‰å»æ£€éªŒæ–‡ä»¶çš„ç±»å‹ï¼Œå¦‚æœè½¯ä»¶ä¸æ”¯æŒè¯¥ç§ç±»å‹å°±ä¼šå‡ºé”™ã€‚
- Javaå­—èŠ‚ç æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å¤´ç§°ä¸ºMagicé­”æ•°

![image-20240113223527525](./img/12.png)

å¸¸è§çš„æ–‡ä»¶å¤´

![image-20240113223754367](./img/24.png)



**ä¸»å‰¯ç‰ˆæœ¬å·**

- ä¸»å‰¯ç‰ˆæœ¬å·æŒ‡çš„æ˜¯ç¼–è¯‘å­—èŠ‚ç æ–‡ä»¶çš„JDKç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬å·æ˜¯ç”¨æ¥è¯†åˆ«å¤§ç‰ˆæœ¬å·ï¼ŒJDK1.0-1.1ä½¿ç”¨äº†45.0-45.3ï¼ŒJDK1.2æ˜¯46ä¹‹åæ¯å‡çº§ä¸€ä¸ªå¤§ç‰ˆæœ¬å·å°±åŠ 1ï¼Œå‰¯ç‰ˆæœ¬å·æ˜¯å½“ä¸»ç‰ˆæœ¬å·ç›¸åŒæ—¶ä½œä¸ºåŒºåˆ†ä¸åŒç‰ˆæœ¬çš„æ ‡è¯†ï¼Œä¸€èˆ¬åªéœ€è¦å…³å¿ƒä¸»ç‰ˆæœ¬å·ã€‚
- ç‰ˆæœ¬å·çš„ä½œç”¨ä¸»è¦æ˜¯åˆ¤æ–­å½“å‰å­—èŠ‚ç çš„ç‰ˆæœ¬å’Œè¿è¡Œæ—¶çš„JDKæ˜¯å¦å…¼å®¹

> Tips:
>
> 1.2ä¹‹åå¤§ç‰ˆæœ¬å·è®¡ç®—çš„æ–¹å¼å°±æ˜¯ä¸»ç‰ˆæœ¬å·-44 
>
> ä¾‹å¦‚ï¼šä¸»ç‰ˆæœ¬å·52å°±æ˜¯JDK8



![image-20240113230402739](./img/16.png)

![image-20240112220051858](./img/25.png)

![image-20240113230833483](./img/26.png)

| åç§°               | ä½œç”¨                                                         |
| ------------------ | ------------------------------------------------------------ |
| Magicé­”æ•°          | å›ºå®šä¸º0XCAFEBABE ä¸ä¼šæ”¹å˜                                    |
| ä¸»å‰¯ç‰ˆæœ¬å·         | ç¼–è¯‘å­—èŠ‚ç çš„JDKç‰ˆæœ¬                                          |
| è®¿é—®æ ‡è¯†           | æ ‡è¯†æ˜¯ç±»è¿˜æ˜¯æ¥å£ã€æšä¸¾ã€æ³¨è§£ã€æ¨¡å— æ ‡è¯†publicã€finalã€abstract |
| ç±»ã€çˆ¶ç±»ã€æ¥å£ç´¢å¼• | é€šè¿‡è¿™äº›ç´¢å¼•å¯ä»¥æ‰¾åˆ°ç±»ã€çˆ¶ç±»ã€æ¥å£çš„ä¿¡æ¯                     |



#### 2ï¼‰å¸¸é‡æ± 

å­—èŠ‚ç æ–‡ä»¶ä¸­å¸¸é‡æ± çš„ä½œç”¨ï¼š

- é¿å…ç›¸åŒçš„å†…å®¹é‡å¤å®šä¹‰ã€èŠ‚çœç©ºé—´ã€‚

```
    public static String A = "ä¸­å›½";
    public static String B = "ä¸­å›½";
```

> å…¶ä»–çš„ç›¸åŒçš„å­—æ®µå°±ä¼šå»å¼•ç”¨åˆ° çœŸæ­£çš„stringå­—é¢é‡

![image-20240112222511280](./img/17.png)

> å¦‚æœæ˜¯å¸¸é‡ é‚£ä¹ˆä¼šæŒ‡å‘å¸¸é‡æ± é‡Œé¢çš„index æœ€ç»ˆæ‰¾åˆ°å­—é¢é‡
>
> å¦‚æœæ˜¯æ™®é€šçš„ æ˜¯å­˜åœ¨å¸¸é‡æ± é‡Œé¢ é‚£ä¹ˆä¼šç›´æ¥æ‰¾åˆ°å¯¹åº”çš„å­—é¢é‡å€¼

- å¸¸é‡æ± ä¸­çš„æ•°æ®éƒ½æœ‰ä¸€ä¸ªç¼–å·ï¼Œç¼–å·ä»1å¼€å§‹ã€‚åœ¨å­—æ®µæˆ–è€…å­—èŠ‚ç æŒ‡ä»¤ä¸­é€šè¿‡ç¼–å·å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°å¯¹åº”çš„æ•°æ®ã€‚

- å­—èŠ‚ç æŒ‡ä»¤ä¸­é€šè¿‡ç¼–å·å¼•ç”¨åˆ°å¸¸é‡æ± çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºç¬¦å·å¼•ç”¨

  > ![image-20240113232200998](./img/18.png)![image-20240113232211200](./img/19.png)





#### 3ï¼‰æ–¹æ³•

- å­—èŠ‚ç ä¸­çš„æ–¹æ³•åŒºåŸŸæ˜¯å­˜æ”¾**å­—èŠ‚ç æŒ‡ä»¤**çš„æ ¸å¿ƒä½ç½®ï¼Œå­—èŠ‚ç æŒ‡ä»¤çš„å†…å®¹æ”¾åœ¨æ–¹æ³•çš„codeå±æ€§ä¸­

  > ![image-20240113232345246](./img/20.png)

![image-20240112225630253](./img/21.png)

![image-20240112225750701](./img/22.png)



**é€šè¿‡å­—èŠ‚ç æŒ‡ä»¤åˆ†æä¸‹é¢ä¸‰ç§â€œåŠ 1â€çš„æ“ä½œæ€§èƒ½çš„é«˜ä½ï¼Ÿ**

> å­—èŠ‚ç è¡Œæ•°è¶Šå°‘ æ•ˆç‡è¶Šé«˜

```java
int i=0,j=0,k=0;
i++;
j=j+1;
k += 1;
```

> iå’Œkä¸€æ ·è¡Œæ•°
>
> jçš„è¡Œæ•°æœ€å¤š



**å­—èŠ‚ç å·¥å…·**

- javap -v

  > javapæ˜¯JDKè‡ªå¸¦çš„åç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å°æŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶çš„å†…å®¹ã€‚é€‚åˆåœ¨æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹å­—èŠ‚ç æ–‡ä»¶å†…å®¹
  >
  > ç›´æ¥è¾“å…¥javap æŸ¥çœ‹æ‰€æœ‰å‚æ•°
  >
  > è¾“å…¥javap -v å­—èŠ‚ç æ–‡ä»¶åç§° æŸ¥çœ‹å…·ä½“çš„å­—èŠ‚ç ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯jaråŒ… éœ€è¦ç”¨jar -xvfå‘½ä»¤è§£å‹ï¼‰
  >
  > > linux > ç¬¦å·è¿½åŠ åˆ°æŒ‡å®šçš„ä½ç½®æ–‡ä»¶å†…

- Arthas

  > å®˜ç½‘åœ°å€ï¼šhttps://arthas.aliyun.com/doc/
  >
  > ![image-20240113140957469](./img/23.png)
  >
  > - jadç±»çš„å…¨é™å®šåï¼šåç¼–è¯‘å·²ç»åŠ è½½ç±»çš„æºç 
  >
  > - dumpç±»çš„å…¨é™å®šåï¼šdumpå·²åŠ è½½ç±»çš„å­—èŠ‚ç æ–‡ä»¶åˆ°ç‰¹å®šç›®å½•
  >
  >   > å…¨é™åï¼š**åŒ…ååŠ ç±»å**



### 3.ç±»çš„ç”Ÿå‘½å‘¨æœŸ

åº”ç”¨åœºæ™¯ï¼š

- è¿è¡Œæ—¶å¸¸é‡æ± 
- å¤šæ€çš„åŸç†
- ç±»åŠ è½½å™¨çš„ä½œç”¨
- ç±»çš„åŠ å¯†å’Œè§£å¯†



#### 0ï¼‰ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°

**åˆ†ä¸ºä¸‹é¢äº”ä¸ªé˜¶æ®µï¼š**

- 1-åŠ è½½

- 2-è¿æ¥

  > é‡ç‚¹çŸ¥è¯†ï¼š
  >
  > - æ ¡éªŒ
  > - å‡†å¤‡
  > - è§£æ

- 3-åˆå§‹åŒ–

- 4-ä½¿ç”¨

  > è·ç¦»ï¼šnewä¸€ä¸ªå¯¹è±¡
  >
  > ```
  > Class class = new Class();
  > Class<Class> clazz = Class.class;
  > Class class1 = clazz.newInstance();
  > ```
  >
  > 

- 5-å¸è½½

  > ç±»çš„å¸è½½ä¸»è¦ä½“ç°åœ¨åƒåœ¾å›æ”¶â™»ï¸æœºåˆ¶



#### 1ï¼‰åŠ è½½é˜¶æ®µ

- Loadingé˜¶æ®µç¬¬ä¸€æ­¥æ˜¯**ç±»åŠ è½½å™¨**æ ¹æ®ç±»çš„å…¨é™å®šåé€šè¿‡ä¸åŒçš„æ¸ é“ä»¥äºŒè¿›åˆ¶æµçš„æ–¹å¼è·å–åˆ°å­—èŠ‚ç ä¿¡æ¯ã€‚

  - æœ¬åœ°æ–‡ä»¶- ç£ç›˜ä¸Šçš„å­—èŠ‚ç æ–‡ä»¶
  - åŠ¨æ€ä»£ç†ç”Ÿæˆ-ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆ
  - é€šè¿‡ç½‘ç»œä¼ è¾“çš„ç±»-æ—©æœŸçš„AppletæŠ€æœ¯ä½¿ç”¨

- ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°æ–¹æ³•åŒºä¸­

  > æ–¹æ³•åŒºï¼šè™šæ‹Ÿçš„ç©ºé—´
  >
  > Java8ä»¥åå«å…ƒç©ºé—´

- ç±»åŠ è½½å™¨åœ¨åŠ è½½å®Œç±»ä¹‹åï¼ŒJavaè™šæ‹Ÿæœºä¼šå°†å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ä¿å­˜åˆ°å†…å­˜çš„æ–¹æ³•åŒºä¸­ã€‚

  > ç”Ÿæˆä¸€ä¸ªInstanceKlasså¯¹è±¡ï¼Œä¿å­˜ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œé‡Œé¢è¿˜åŒ…å«å®ç°ç‰¹å®šåŠŸèƒ½æ¯”å¦‚å¤šæ€çš„ä¿¡æ¯ã€‚
  >
  > ![image-20240114140938691](./img/27.png)

- åŒæ—¶ï¼ŒJavaè™šæ‹Ÿæœºè¿˜åœ¨å †ä¸­ç”Ÿæˆä¸€ä»½ä¸æ–¹æ³•åŒºä¸­æ•°æ®ç±»ä¼¼çš„java.lang.Class å¯¹è±¡

  > ä½œç”¨ï¼šæ˜¯åœ¨Javaä»£ç ä¸­å»è·å–ç±»çš„ä¿¡æ¯ä»¥åŠå­˜å‚¨é™æ€å­—æ®µçš„å­—æ®µï¼ˆJDK8åŠä¹‹åï¼‰
  >
  > ![image-20240114141447375](./img/28.png)
  >
  > ![image-20240113144305816](./img/30.png)
  >
  > ![image-20240113144323237](./img/31.png)

  

  

**ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªåŒºï¼Ÿ**

> å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œ**åªéœ€è¦è®¿é—®å †ä¸­çš„Classå¯¹è±¡**è€Œä¸éœ€è¦è®¿é—®æ–¹æ³•åŒºä¸­æ‰€æœ‰ä¿¡æ¯
>
> **è¿™æ ·è™šæ‹Ÿæœºå°±èƒ½å¾ˆå¥½åœ°æ§åˆ¶å¼€å‘è€…è®¿é—®æ•°æ®çš„èŒƒå›´**
>
> ![image-20240113144512326](./img/32.png)



**æŸ¥çœ‹å†…å­˜ä¸­çš„å¯¹è±¡**

- æ¨èä½¿ç”¨JDKè‡ªå¸¦çš„hsdbå·¥å…·æŸ¥çœ‹Javaè™šæ‹Ÿæœºå†…å­˜ä¿¡æ¯ã€‚å·¥å…·ä½äºJDKå®‰è£…ç›®å½•ä¸‹libæ–‡ä»¶å¤¹ä¸­çš„sa-jdi.jar

- å¯åŠ¨å‘½ä»¤

  > ```shell
  > java -cp sa-jdi.jar sun.jvm.hotspot.HSDB
  > ```
  >
  > ç„¶åä½¿ç”¨å¯¹åº”çš„javaè¿›ç¨‹ç«¯å£å·è¿æ¥
  >
  > <img src="./img/33.png" alt="image-20240113192844569" style="zoom: 50%;" />
  >
  > ![image-20240114150009116](./img/34.png)

  

  **TipsğŸ’¡**

> jps å‘½ä»¤ï¼šæŸ¥çœ‹æ‰€æœ‰çš„javaå¯¹è±¡è¿›ç¨‹
>
> ![image-20240113193437270](./img/51.png)





#### 2ï¼‰è¿æ¥é˜¶æ®µ

è¿æ¥é˜¶æ®µä¸»è¦åŒ…å«***ä¸‰ä¸ªè¿‡ç¨‹***ï¼š

- ***éªŒè¯-éªŒè¯å†…å®¹æ˜¯å¦æ»¡è¶³ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹***

  > Linkingé˜¶æ®µä¸éœ€è¦ç¨‹åºå‘˜å‚ä¸
  >
  > ä¸»è¦éªŒè¯å››éƒ¨åˆ†ï¼š
  >
  > - æ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œæ¯”å¦‚æ–‡ä»¶æ˜¯å¦ä»¥0xCAFEBABEå¼€å¤´ï¼Œä¸»å‰¯ç‰ˆæœ¬å·æ˜¯å¦æ»¡è¶³å½“å‰Javaè™šæ‹Ÿæœºç‰ˆæœ¬è¦æ±‚
  > - å…ƒä¿¡æ¯éªŒè¯ï¼Œä¾‹å¦‚ç±»å¿…é¡»æœ‰çˆ¶ç±»ï¼ˆsuperä¸èƒ½ä¸ºç©ºï¼‰
  > - éªŒè¯ç¨‹åºæ‰§è¡ŒæŒ‡ä»¤çš„è¯­ä¹‰ï¼Œæ¯”å¦‚æ–¹æ³•å†…çš„æŒ‡ä»¤æ‰§è¡Œåˆ°ä¸€åŠå¼ºè¡Œè·³è½¬åˆ°å…¶ä»–æ–¹æ³•ä¸­å»
  > - ç¬¦å·å¼•ç”¨éªŒè¯ï¼Œä¾‹å¦‚æ˜¯å¦è®¿é—®äº†å…¶ä»–ç±»ä¸­privateçš„æ–¹æ³•ç­‰

- ***ç»™é™æ€å˜é‡èµ‹åˆå€¼***

  > åªè¦è®¨è®ºJDK8åŠä»¥åçš„ç‰ˆæœ¬
  >
  > - è™½ç„¶èµ‹å€¼ä¸º1 ä½†æ˜¯åˆå§‹å€¼èµ‹å€¼ä¸º0
  >
  > ![image-20240114150957325](./img/35.png)
  >
  > - **å‡†å¤‡é˜¶æ®µåªä¼šç»™é™æ€å˜é‡èµ‹åˆå§‹å€¼ï¼Œè€Œæ¯ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹éƒ½æœ‰å…¶åˆå§‹å€¼**
  >
  > ![image-20240114151135717](./img/36.png)
  >
  > - **finalä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹çš„é™æ€å˜é‡ï¼Œå‡†å¤‡é˜¶æ®µç›´æ¥ä¼šå°†ä»£ç ä¸­çš„å€¼è¿›è¡Œèµ‹å€¼ã€‚ï¼ˆå› ä¸ºå€¼ä¸èƒ½ä¿®æ”¹ï¼Œå·²ç»ç¡®å®šäº†ï¼‰**
  >
  > ![image-20240114151248373](./img/37.png)

  

- ***å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢æˆæŒ‡å‘å†…å­˜çš„ç›´æ¥å¼•ç”¨***

  > - **ç›´æ¥å¼•ç”¨ä¸åœ¨ä½¿ç”¨ç¼–å·ï¼Œè€Œæ˜¯ä½¿ç”¨å†…å­˜ä¸­åœ°å€è¿›è¡Œè®¿é—®å…·ä½“çš„æ•°æ®**
  >
  > ![image-20240114151357606](./img/38.png)

> ***ç¬¦å·å¼•ç”¨***æ˜¯å­—èŠ‚ç æ–‡ä»¶ä¸­ä½¿ç”¨**ç¼–å·**å»å¸¸é‡æ± ä¸­æ‰¾å¯¹åº”çš„å†…å®¹ï¼Œ***ç›´æ¥å¼•ç”¨***æ˜¯å»æ‰¾å†…å­˜åœ°å€çš„å¼•ç”¨
>
> ![image-20240114152031342](./img/39.png)
>
> ç±»çš„ä¿¡æ¯å·²ç»åŠ è½½åœ¨å†…å­˜ä¸­







#### 3ï¼‰åˆå§‹åŒ–é˜¶æ®µ

- åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œ**é™æ€ä»£ç å—ä¸­çš„ä»£ç **ï¼Œå¹¶**ä¸ºé™æ€å˜é‡èµ‹å€¼**ã€‚æ‰§è¡Œæµç¨‹ä¸ä»£ç æ‰§è¡Œæµç¨‹ä¸€è‡´ã€‚

- åˆå§‹åŒ–é˜¶æ®µä¼šæ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶ä¸­**cliinit**éƒ¨åˆ†çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚

  > **clinit**æ–¹æ³•ä¸­å’Œjavaæ‰§è¡Œçš„é¡ºåºä¸€è‡´
  >
  > ![image-20240114152342473](./img/40.png)



**ä»¥ä¸‹å‡ ç§æ–¹å¼ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼š**

1. è®¿é—®ä¸€ä¸ªç±»çš„é™æ€å˜é‡æˆ–è€…é™æ€æ–¹æ³•ï¼Œæ³¨æ„å˜é‡æ—¶**finalä¿®é¥°çš„å¹¶ä¸”ç­‰å·å³è¾¹æ—¶å¸¸é‡ä¸ä¼šè§¦å‘åˆå§‹åŒ–**ï¼ˆå·²ç»åœ¨è¿æ¥é˜¶æ®µçš„å‡†å¤‡é˜¶æ®µå·²ç»åˆå§‹åŒ–äº†ï¼‰
2. è°ƒç”¨Class.forName(String className)
3. new ä¸€ä¸ªè¯¥ç±»çš„å¯¹è±¡æ—¶
4. æ‰§è¡ŒMainæ–¹æ³•çš„å½“å‰ç±»

**TipsğŸ’¡**

> VMå‚æ•°ï¼š
>
> ```
> -XX:+TraceClassLoading å‚æ•°å¯ä»¥æ‰“å°å‡ºåŠ è½½å¹¶åˆå§‹åŒ–çš„ç±»
> ```

**æ¡ˆä¾‹ï¼š**

> ![image-20240113195843126](./img/41.png)

> æ‰§è¡Œmainæ–¹æ³•çš„æ—¶å€™ ä¼šå…ˆåˆå§‹åŒ–clinit æ‰§è¡Œå½“å‰mainæ–¹æ³•æ‰€åœ¨çš„å¯¹è±¡é™æ€ä»£ç å—ï¼ˆ**æœ‰ä¸”åªä¼šæ‰§è¡Œä¸€æ¬¡é™æ€ä»£ç å—**ï¼‰æ‰€ä»¥æ‰“å°D ç„¶åæ‰§è¡Œmainæ–¹æ³•è‡ªå·±çš„A 
>
> **ä¸€ä¸ªç±»*åŠ è½½åˆå§‹åŒ–*åªä¼šæ‰§è¡Œä¸€æ¬¡**
>
> ç„¶ånewä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼ˆå¯ä»¥åˆ›å»ºå¤šä¸ªå¯¹è±¡ ä¼šåˆå§‹åŒ–å¤šæ¬¡æ„é€ æ–¹æ³•ï¼‰ **æ‰§è¡Œé¡ºåºï¼šé™æ€ä»£ç å—-> ä»£ç å—-> æ„é€ æ–¹æ³•** ï¼Œå› ä¸ºmainåˆå§‹åŒ–ï¼ˆå·²ç»åŠ è½½äº†æœ¬èº«ï¼‰çš„æ—¶å€™å·²ç»æ‰§è¡Œäº†é™æ€ä»£ç å— ï¼Œç„¶åä¼šå…ˆåˆå§‹åŒ–è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼ˆå¦‚æœæœ‰å±€éƒ¨ä»£ç å— é‚£ä¹ˆinitçš„æ—¶å€™ä¼šæŠŠè¯¥ä»£ç å—æ”¾åˆ°æ„é€ æ–¹æ³•é‡Œé¢ä¸€èµ·æ‰§è¡Œï¼‰ã€‚
>
> ```java
> class Test001{
>     public static void main(String[] args) {
>         System.out.println("A");
>         new Test001();
>         new Test001();
>     }
> 
>     public Test001() {
>         System.out.println("B");
>     }
>     {
>         System.out.println("C");
>     }
>     static {
>         System.out.println("D");
>     }
> }
> ```
>
> **æ‰§è¡Œç»“æœä¸ºï¼šDACBCB**



clinitæŒ‡ä»¤åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¸ä¼šå‡ºç°æŒ‡ä»¤æ“ä½œ

æ¯”å¦‚ï¼šä»¥ä¸‹å‡ ç§æƒ…å†µæ˜¯***ä¸ä¼š**è¿›è¡Œåˆå§‹åŒ–æŒ‡ä»¤æ“ä½œçš„*ã€‚

1. æ— é™æ€ä»£ç å—ä¸”æ— é™æ€å˜é‡èµ‹å€¼è¯­å¥çš„
2. æœ‰é™æ€å˜é‡çš„å£°æ˜ï¼Œä½†æ˜¯æ²¡æœ‰èµ‹å€¼è¯­å¥çš„
3. é™æ€å˜é‡çš„å®šä¹‰ä½¿ç”¨finalå…³é”®å­—çš„ï¼Œè¿™ç±»å˜é‡ä¼šåœ¨ï¼ˆ**è¿æ¥é˜¶æ®µçš„å‡†å¤‡é˜¶æ®µ**ï¼‰ç›´æ¥è¿›è¡Œåˆå§‹åŒ–
4. **ç›´æ¥è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œä¸ä¼šå‡ºå‘å­ç±»çš„åˆå§‹åŒ–**
5. å­ç±»çš„åˆå§‹åŒ–clinitè°ƒç”¨ä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„clinitåˆå§‹åŒ–æ–¹æ³•

**æ¡ˆä¾‹1ï¼š**

> ![image-20240114155119136](./img/42.png)
>
> **ç­”æ¡ˆï¼šå…ˆæ‰§è¡Œçˆ¶ç±» æŠŠå€¼èµ‹å€¼ä¸º1 ç„¶åæ‰§è¡Œå­ç±»ã€‚æŠŠå€¼èµ‹å€¼ä¸º2 ç„¶åæ‰“å°æ•°æ®ä¸º2**

**æ¡ˆä¾‹2:**

> **æ•°ç»„çš„åˆ›å»ºä¸ä¼šå¯¼è‡´æ•°ç»„ä¸­å…ƒç´ çš„ç±»è¿›è¡Œåˆå§‹åŒ–**
>
> ```java
> class Test001 {
>     public static void main(String[] args) {
>         Test002[] test001s = new Test002[10];
>     }
> }
> 
> class Test002 {
>     static {
>         System.out.println("D");
>     }
> }
> ```
>
> **ç­”æ¡ˆï¼šä¸ä¼šæ‰“å°é™æ€ä»£ç å—**

**æ¡ˆä¾‹3:**

> **finalä¿®é¥°çš„å˜é‡å¦‚æœèµ‹å€¼çš„å†…å®¹éœ€è¦æ‰§è¡ŒæŒ‡ä»¤æ‰èƒ½å¾—åˆ°ç»“æœï¼Œä¼šæ‰§è¡Œclinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–**
>
> 
>
> ```java
> class Test001 {
>     public static void main(String[] args) {
>         System.out.println(Test002.a);
>     }
> }
> 
> class Test002 {
>     public static final int a = Integer.valueOf(1);
> 
>     static {
>         System.out.println("é™æ€ä»£ç å—è¿è¡Œ");
>     }
> }
> ```
>
> **ç­”æ¡ˆï¼šæ˜¯1 ç„¶åæ˜¯æ‰“å°æ–‡å­—**



### 4.ç±»åŠ è½½å™¨

ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿ

> ç±»åŠ è½½å™¨ï¼ˆclassLoaderï¼‰æ˜¯Javaè™šæ‹Ÿæœºæä¾›ç»™åº”ç”¨ç¨‹åºåŒºå®ç°è·å–ç±»å’Œæ¥å£å­—èŠ‚ç æ•°æ®çš„æŠ€æœ¯

![image-20240114210334102](./img/43.png)

![image-20240114164002896](./img/44.png)



**ç±»åŠ è½½å™¨çš„åº”ç”¨åœºæ™¯ï¼š**

- ä¼ä¸šçº§åº”ç”¨
  1. SPIæœºåˆ¶
  2. ç±»çš„çƒ­éƒ¨ç½²
  3. Tomcatç±»çš„éš”ç¦»
- å¤§é‡çš„é¢è¯•é¢˜
  1. ä»€ä¹ˆæ˜¯ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶
  2. æ‰“ç ´ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶
  3. è‡ªå®šä¹‰ç±»åŠ è½½å™¨
- è§£å†³çº¿ä¸Šé—®é¢˜
  1. ä½¿ç”¨Arthasä¸åœæœºè§£å†³çº¿ä¸Šæ•…éšœ







#### 1ï¼‰ç±»åŠ è½½å™¨çš„åˆ†ç±»

ç±»åŠ è½½å™¨åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯Javaä»£ç ä¸­å®ç°çš„ï¼Œä¸€ç±»æ˜¯Javaè™šæ‹Ÿæœºåº•å±‚æºç å®ç°çš„

![image-20240114210830514](./img/45.png)

- ç±»åŠ è½½å™¨çš„è®¾è®¡JDK8å’Œ8ä¹‹åçš„ç‰ˆæœ¬å·®åˆ«è¾ƒå¤§ï¼ŒJDK8åŠä¹‹åçš„ç‰ˆæœ¬ä¸­é»˜è®¤çš„ç´¯ç§¯è½½å™¨æœ‰å¦‚ä¸‹å‡ ç§

**è™šæ‹Ÿæœºæ—¶å®ç°çš„ï¼š**

>**Bootstrapï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰**
>
>è™šæ‹Ÿæœºåº•å±‚å®ç°çš„C++ï¼ŒåŠ è½½Javaç±»ä¸­æœ€æ ¸å¿ƒçš„ç±»

**Javaå®ç°çš„ï¼š**

> **Extensionï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰**
>
> å…è®¸æ‰©å±•Javaä¸­æ¯”è¾ƒé€šç”¨çš„ç±»
>
> **Applicationï¼ˆåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼‰**
>
> åŠ è½½åº”ç”¨ä½¿ç”¨çš„ç±»





ç±»åŠ è½½å™¨çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥é€šè¿‡classloaderå‘½ä»¤æŸ¥

> ```shell
> [arthas@60081]$ classloader
> ```
>
> å¯ä»¥çœ‹åˆ°å±‚çº§å…³ç³»ä¸ºæœ€ä¸Šå±‚çš„çˆ¶ç±»ä¸º**BootstrapClassLoader**ï¼Œå…¶æ¬¡**sun.misc.LauncherExtClassLoader**ï¼Œåœ¨å…¶æ¬¡ä¸º**sun.misc.LauncherAppClassLoader**
>
> ![image-20240114215035975](./img/46.png)





##### **Bootstrap ClassLoader**

- Bootstrap ClassLoader æ˜¯ç”±HotSpotè™šæ‹Ÿæœºæä¾›ã€ä½¿ç”¨C++ç¼–å†™çš„ç±»åŠ è½½å™¨

- é»˜è®¤åŠ è½½Javaå®‰è£…ç›®å½•ä¸‹/jre/libä¸‹çš„ç±»æ–‡ä»¶

  > ![image-20240114215637896](./img/47.png)



**å¦‚æœæƒ³ç”¨BootStrap ClassLoader åŠ è½½ç”¨æˆ·è‡ªå·±çš„jaråŒ…ï¼Œæœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- ï¼ˆä¸æ¨èï¼‰æŠŠè‡ªå·±çš„jaråŒ…æ”¾å…¥libç›®å½•ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ–‡ä»¶åä¸åŒ¹é…çš„é—®é¢˜ä¹Ÿä¸ä¼šæ­£å¸¸çš„è¢«åŠ è½½

- **ï¼ˆæ¨èï¼‰**ä½¿ç”¨VMå‚æ•°è¿›è¡Œæ‰©å±•

  > ä½¿ç”¨å‘½ä»¤ï¼š
  >
  > ```
  > -Xbootclasspath/a:jaråŒ…ç›®å½•/jaråŒ…å
  > ```
  >
  > å¯ä»¥è‡ªå·±æ‰‹åŠ¨å†™ä¸€ä¸ªç±» ç„¶åä½¿ç”¨vmå‚æ•°æŠŠè¿™ä¸ªç±»åŠ è½½è¿›å»ï¼Œè¿™ä¸ªç±»å¯ä»¥å†™äº†staticæ–¹æ³• æ‰“å°æ—¥å¿—  ç„¶åè°ƒç”¨çš„è¿™ä¸ª å»æŒ‡å®šå¼•ç”¨è¿™ä¸ªç±» forname ç„¶åçœ‹ç»“æœ ä½†æ˜¯è¿™ä¸ªç±»åŠ è½½å™¨è¿˜æ˜¯null æ˜¯å±äºbootstrapåŠ è½½å™¨



**Javaä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨**

- **Extension ClassLoader**å’Œ**Application ClassLoader**éƒ½æ˜¯JDKä¸­æä¾›çš„ï¼Œä½¿ç”¨Javaç¼–å†™çš„ç±»åŠ è½½å™¨
- å®ƒä»¬çš„æºç éƒ½ä½äºsun.misc,Launcherä¸­ï¼Œæ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ã€‚ç»§æ‰¿è‡ªURLCLlassLoaderã€‚å±€éƒ¨é€šè¿‡ç›®å½•æˆ–è€…æŒ‡å®šjaråŒ…å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚

![image-20240114221554145](./img/48.png)





##### Extension ClassLoader

- Extension ClassLoader æ˜¯JDKä¸­æä¾›çš„ã€ä½¿ç”¨Javaç¼–å†™çš„ç±»åŠ è½½å™¨

- é»˜è®¤åŠ è½½Javaå®‰è£…ç›®å½•/jre/lib/extä¸‹çš„ç±»æ–‡ä»¶

  > ![image-20240114221237025](./img/49.png)

**å¦‚æœæƒ³ç”¨Extension ClassLoader åŠ è½½ç”¨æˆ·è‡ªå·±çš„jaråŒ…ï¼Œæœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- ï¼ˆä¸æ¨èï¼‰æŠŠè‡ªå·±çš„jaråŒ…æ”¾å…¥/j re/lib/ext/ç›®å½•ä¸‹ï¼Œå°½é‡ä¸è¦å»æ”¹JDKå®‰è£…ç›®å½•ä¸­çš„å†…å®¹

- **ï¼ˆæ¨èï¼‰**ä½¿ç”¨VMå‚æ•°è¿›è¡Œæ‰©å±•

  > ä½¿ç”¨å‘½ä»¤ï¼š
  >
  > ```
  > -Djava.ext.dirs=jaråŒ…ç›®å½•è¿›è¡Œæ‰©å±•ï¼Œè¿™ç§æ–¹å¼ä¼šè¦†ç›–åŸæ˜¯ç›®å½•ï¼Œæ‰€ä»¥éœ€è¦ç”¨ ; è¿½åŠ åŸå§‹ç›®å½•
  > ```



##### Application ClassLoader

- è‡ªå·±å†™çš„ä»£ç é»˜è®¤å°±æ˜¯Application ClassLoader



**ä½¿ç”¨ArthasæŸ¥çœ‹ç±»åŠ è½½å™¨**

![image-20240114222734187](./img/50.png)



#### 2ï¼‰åŒäº²å§”æ´¾æœºåˆ¶

> ç”±äºJavaè™šæ‹Ÿæœºä¸­æœ‰å¤šä¸ªç±»åŠ è½½å™¨ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒæ˜¯è§£å†³ä¸€ä¸ªç±»åˆ°åº•ç”±è°æ¥åŠ è½½çš„é—®é¢˜

**åŒäº²å§”æ´¾æœºåˆ¶æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ**

1. ä¿è¯ç±»åŠ è½½çš„å®‰å…¨æ€§

   > é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶é¿å…æ¶æ„ä»£ç æ›¿æ¢JDKçš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§

2. é¿å…é‡å¤åŠ è½½

   > å¯ä»¥é¿å…ä¸€ä¸ªç±»è¢«åå¤å¤šæ¬¡åŠ è½½



**ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ**

> å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°åŠ è½½ç±»å½“ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼š**è‡ªåº•å‘ä¸ŠæŸ¥æ‰¾**æ˜¯å¦åŠ è½½è¿‡ï¼Œå†**ç”±é¡¶å‘ä¸‹è¿›è¡ŒåŠ è½½**
>
> å‘ä¸‹å§”æ´¾åŠ è½½èµ·åˆ°äº†ä¸€ä¸ªåŠ è½½ä¼˜å…ˆçº§çš„ä½œç”¨
>
> ![image-20240114230839019](./img/52.png)

æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»åŠ è½½å™¨ï¼Œ**Application** çš„çˆ¶ç±»æ˜¯**Extension** ï¼Œ**Extension**çš„parentæ˜¯**Null**

- åœ¨ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½ä¼šå…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½ç±»è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå°†åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œé€çº§å‘ä¸Š

> ![image-20240114231300679](./img/53.png)

- å¦‚æœæ‰€æœ‰çš„çˆ¶ç±»åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œé‚£ä¹ˆå°±ä¼šç”±æœ€ä¸Šå±‚çš„ç±»åŠ è½½å™¨å¼€å§‹**è‡ªé¡¶å‘ä¸‹**å°è¯•åŠ è½½ç±»ã€‚

> ![image-20240114231505985](./img/54.png)



**é—®é¢˜ï¼š**

1. å¦‚æœä¸€ä¸ªç±»é‡å¤å‡ºç°åœ¨ä¸‰ä¸ªç±»åŠ è½½å™¨çš„åŠ è½½ä½ç½®ï¼Œåº”è¯¥ç”±è°æ¥åŠ è½½ï¼Ÿ

   > åº”è¯¥ç”±Bootstrap ClassLoaderæ¥åŠ è½½ï¼Œè¯¥Loaderä¼˜å…ˆçº§æœ€é«˜

2. Stringç±»èƒ½è¦†ç›–å˜›ï¼Ÿ

   > Stringç±»ä¸èƒ½é‡å†™ï¼Œä¸ä¼šï¼Œä¸”Stringç±»ç”±Bootstrap ClassLoaderæ¥åŠ è½½

3. å¦‚ä½•åœ¨Javaä¸­ä½¿ç”¨ä»£ç çš„æ–¹å¼å»ä¸»åŠ¨åŠ è½½ä¸€ä¸ªç±»ï¼Ÿ

   > - ä½¿ç”¨Class.forNameæ–¹æ³•ï¼Œä½¿ç”¨å½“å‰çš„ç±»çš„ç±»åŠ è½½å™¨å»åŠ è½½æŒ‡å®šçš„ç±»
   >
   >   ```java
   >   
   >           Class<?> aClass = Class.forName("xxxx.xxxx");
   >           aClass.getClassLoader();
   >   ```
   >
   > - è·å–ç±»åŠ è½½å™¨ï¼Œé€šè¿‡ç±»åŠ è½½å™¨çš„loadClass() æŒ‡å®šæŸä¸ªç±»åŠ è½½å™¨åŠ è½½
   >
   >   ```java
   >   ClassLoader classLoader = Test002.class.getClassLoader();
   >   Class<?> aClass1 = classLoader.loadClass("xxxx.xxx");
   >   ```



**æ¯ä¸ªJavaå®ç°çš„ç±»åŠ è½½å™¨ä¸­ä¿å­˜äº†ä¸€ä¸ªæˆå‘˜å˜é‡ parentç±»åŠ è½½å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸Šä¸€çº§åŠ è½½å™¨ï¼Œä¸æ˜¯Javaä¸­ç»§æ‰¿å…³ç³»å’Œå«ä¹‰**

> ![image-20240114232844794](./img/55.png)





- ApplicationåŠ è½½å™¨çš„parentæ˜¯Extension åŠ è½½å™¨ï¼Œè€Œ**ExtensionåŠ è½½çš„parentæ˜¯Null**ï¼Œä½†æ˜¯åœ¨ä»£ç é€»è¾‘ä¸Šï¼ŒExtension ClassLoaderä¾ç„¶ä¼šæŠŠBootstrap ClassLoaderå½“æˆçˆ¶ç±»åŠ è½½å™¨å¤„ç†
- Bootstrap ClassLoaderä½¿ç”¨C++ç¼–å†™ï¼Œæ²¡æœ‰parentåŠ è½½å™¨

![image-20240114233152391](./img/56.png)

ä½¿ç”¨ArthasæŸ¥çœ‹ClassLoaderçš„çˆ¶å­å…³ç³»ï¼š

> ```shell
> classloader -t
> ```
>
> ![image-20240114233340193](./img/57.png)



##### **é¢è¯•é¢˜**

**ç±»çš„åŒäº²å§”æ´¾æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ**

1. å½“ä¸€ä¸ªç±»åŠ è½½å™¨å»åŠ è½½æŸä¸ªç±»çš„æ—¶å€™ï¼Œä¼šè‡ªåº•å‘ä¸ŠæŸ¥æ‰¾æ˜¯å¦åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸€ç›´åˆ°æœ€é¡¶å±‚çš„ç±»åŠ è½½å™¨éƒ½æ²¡æœ‰åŠ è½½ï¼Œå†ç”±é¡¶å‘ä¸‹è¿›è¡ŒåŠ è½½ã€‚
2. åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œæ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆ**ä¸ºNull**ï¼‰ã€‚
3. åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„æœ‰ä¸¤ç‚¹: ç¬¬ä¸€æ˜¯é¿å…æ¶æ„ä»£ç æ›¿æ¢JDKä¸­çš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.lang.Stringï¼Œç¡®ä¿æ ¸å¿ƒç±»åº“çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚ç¬¬äºŒæ˜¯é¿å…ä¸€ä¸ªç±»é‡å¤åœ°è¢«åŠ è½½ã€‚





#### 3ï¼‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶

**æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶æœ‰å“ªäº›æ–¹å¼ï¼Ÿ**

- è‡ªå®šä¹‰ç±»åŠ è½½å™¨

  > è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶ä¸”é‡å†™loadclassæ–¹æ³•ï¼Œå°±å¯ä»¥å°†åŒäº²å§”æ´¾æœºåˆ¶çš„ä»£ç å»é™¤Tomcaté€šè¿‡è¿™ç§æ–¹å¼å®ç°åº”ç”¨ä¹‹é—´ç±»éš”ç¦»ï¼Œã€Šé¢è¯•ç¯‡ã€‹ä¸­åˆ†äº«å®ƒçš„åšæ³•

- çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨

  > åˆ©ç”¨ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åŠ è½½ç±»ï¼Œæ¯”å¦‚JDBCå’ŒJNDIç­‰

- Osgiæ¡†æ¶çš„ç±»åŠ è½½å™¨

  > å†å²ä¸Šosgiæ¡†æ¶å®ç°äº†ä¸€å¥—æ–°çš„ç±»åŠ è½½å™¨æœºåˆ¶ï¼Œå…è®¸åŒçº§ä¹‹é—´å§”æ‰˜è¿›è¡Œç±»çš„åŠ è½½



**ä¸ºä»€ä¹ˆæœ‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Ÿ**

- ä¸€ä¸ªTomcatç¨‹åºæ˜¯å¯ä»¥è¿è¡Œå¤šä¸ªWebåº”ç”¨çš„ï¼Œå¦‚æœä¸¤ä¸ªåº”ç”¨ä¸­å‡ºç°äº†æƒ³åçš„é™å®šåçš„ç±»ï¼Œæ¯”å¦‚Servetç±»ï¼ŒTomcatè¦ä¿è¯è¿™ä¸¤ä¸ªç±»èƒ½å¤ŸåŠ è½½å¹¶ä¸”å®ƒä»¬åº”è¯¥æ˜¯ä¸åŒçš„ç±»

- å¦‚æœä¸æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå½“åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½Webåº”ç”¨1çš„MyServletä¹‹åï¼ŒWebåº”ç”¨2ä¸­ç›¸åŒé™å®šåçš„MyServletç±»å°±æ— æ³•è¢«åŠ è½½äº†

  > ![image-20240115112852947](./img/58.png)



##### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

- Tomcatä½¿ç”¨äº†è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å®ç°åº”ç”¨ä¹‹é—´ç±»çš„éš”ç¦»ã€‚æ¯ä¸€ä¸ªåº”ç”¨ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åŠ è½½å™¨åŠ è½½ç›¸åº”çš„ç±»ã€‚

![image-20240115113239937](./img/59.png)

- å…ˆæ¥åˆ†æClassLoaderçš„åŸç†ï¼ŒClassLoaderä¸­åŒ…å«äº†4ä¸ªæ ¸å¿ƒæ–¹æ³•

  > ```java
  > // ç±»åŠ è½½çš„å…¥å£ï¼Œæä¾›äº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚å†…éƒ¨ä¼šè°ƒç”¨findClass é‡è¦
  > public Class<?> loadClass(String name) 
  > // ç”±ç±»åŠ è½½å™¨å­ç±»å®ç°,è·å–äºŒè¿›åˆ¶æ•°æ®è°ƒç”¨defineClass ï¼Œæ¯”å¦‚URLClassLoaderä¼šæ ¹æ®æ–‡ä»¶è·¯å¾„å»è·å–ç±»æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®ã€‚é‡è¦
  > protected Class<?> findClass(String name)
  > // åšä¸€äº›ç±»åçš„æ ¡éªŒï¼Œç„¶åè°ƒç”¨è™šæ‹Ÿæœºåº•å±‚çš„æ–¹æ³•å°†å­—èŠ‚ç ä¿¡æ¯åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­
  > protected final Class<?> defineClass(String name, byte[] b, int off, int len)
  > // æ‰§è¡Œç±»ç”Ÿå‘½å‘¨æœŸä¸­çš„è¿æ¥é˜¶æ®µ
  > protected final void resolveClass(Class<?> c)
  > ```
  >
  > 

- åŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒä»£ç å°±æ˜¯ä½äºloadClassæ–¹æ³•ä¸­

- æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„æ ¸å¿ƒå°±æ˜¯å°†ä¸‹é¢loadClassæ–¹æ³•çš„ä»£ç é‡å†™

  > ```java
  > synchronized (getClassLoadingLock(name)) {
  >             // First, check if the class has already been loaded é¦–å…ˆæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½
  >             Class<?> c = findLoadedClass(name);
  >             if (c == null) {
  >                 long t0 = System.nanoTime();
  >                 try {
  >                     if (parent != null) {
  >                       // è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å»åŠ è½½
  >                         c = parent.loadClass(name, false);
  >                     } else {
  >                         c = findBootstrapClassOrNull(name);
  >                     }
  >                 } catch (ClassNotFoundException e) {
  >                     // ClassNotFoundException thrown if class not found
  >                     // from the non-null parent class loader
  >                 }
  >               
  >               if (c == null) {
  >                     // If still not found, then invoke findClass in order
  >                     // to find the class. å¦‚æœçˆ¶ç±»åŠ è½½ä¸äº† å°±è‡ªå·±æ¥åŠ è½½
  >                     long t1 = System.nanoTime();
  >                     c = findClass(name);
  > 
  >                     // this is the defining class loader; record the stats
  >                     sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
  >                     sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
  >                     sun.misc.PerfCounter.getFindClasses().increment();
  >                 }
  > ```

è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»ä¸ºä»€ä¹ˆæ˜¯Application ClassLoaderï¼Ÿ

![image-20240115115419865](./img/60.png)

- JDK8ä¸ºä¾‹ï¼ŒClassLoaderç±»ä¸­æä¾›äº†æ„é€ æ–¹æ³•è®¾ç½®parentå†…å®¹ï¼š

  > ![image-20240115115850304](./img/61.png)
  >
  
- è¿™ä¸ªæ„é€ æ–¹æ³•ç”±å¦ä¸€ä¸ªæ„é€ æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä¸­çˆ¶ç±»åŠ è½½å™¨ç”±get SystemClassLoaderæ–¹æ³•è®¾ç½®ã€‚è¯¥æ–¹æ³•è¿”å›çš„æ˜¯Application ClassLoader

> ![image-20240115120137650](./img/62.png)



**ä¸¤ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ç›¸åŒé™å®šçš„ç±»ï¼Œä¸ä¼šå†²çªï¼Ÿï¼Ÿ**

- ä¸ä¼šå†²çªï¼Œåœ¨åŒä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸­ï¼Œåªæœ‰**ç›¸åŒç±»åŠ è½½å™¨+ç›¸åŒçš„ç±»é™å®šå**æ‰ä¼šè¢«è®¤ä¸ºæ˜¯åŒä¸€ä¸ªç±»

- åœ¨Arthasä¸­ä½¿ç”¨sc -dã€‚classpath å¯ä»¥æŸ¥çœ‹å…·ä½“æƒ…å†µ

  > â€‹	![image-20240115122551265](./img/63.png)

- æ­£ç¡®çš„å»å®ç°ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„æ–¹å¼æ˜¯é‡å†™**findClass**æ–¹æ³•ï¼Œè¿™æ ·ä¸ä¼šç ´ååŒäº²å§”æ´¾æœºåˆ¶ã€‚

  > ![image-20240115122814322](./img/64.png)



##### çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨

- JDBCä½¿ç”¨äº†DriverManageræ¥ç®¡ç†é¡¹ç›®ä¸­å¼•å…¥çš„ä¸åŒæ•°æ®åº“çš„é©±åŠ¨ï¼Œæ¯”å¦‚mysqlé©±åŠ¨ã€oracleé©±åŠ¨

  > ![image-20240115132802106](./img/65.png)

- DriverManagerä½äºrt.jaråŒ…ä¸­ï¼Œç”±Bootstrap ClassLoaderåŠ è½½çš„

  > ![image-20240115133058064](./img/66.png)

- DriverManagerä½äºrt.jaråŒ…ä¸­ï¼Œç”±**Bootstrap ClassLoader**åŠ è½½ã€‚è€Œç”¨æˆ·jaråŒ…ä¸­çš„é©±åŠ¨éœ€è¦ç”¨**Application ClassLoader**æ¥åŠ è½½ï¼Œè¿™ä¸ªå°±è¿åäº†åŒäº²å§”æ´¾æœºåˆ¶ã€‚

  > ![image-20240115133243345](./img/67.png)



###### **SPIæœºåˆ¶**

- SPIå…¨ç§°ä¸ºï¼ˆService Provider Interfaceï¼‰ï¼Œæ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœåŠ¡

- â­ï¸â€¼ï¸SPIçš„**å·¥ä½œåŸç†**ï¼š

  > 1. **é©±åŠ¨jaråŒ…-------åœ¨ClassPathè·¯å¾„ä¸‹çš„META-INFO/servicesæ–‡ä»¶å¤¹ä¸­ï¼Œä»¥æ¥å£çš„å…¨é™åæ¥å‘½åæ–‡ä»¶å¤¹ï¼Œå¯¹åº”çš„æ–‡ä»¶é‡Œé¢å†™è¯¥æ¥å£çš„å®ç°**
  >
  >    ![image-20240115134137351](./img/68.png)
  >
  > 2. **ä½¿ç”¨ServiceLoaderåŠ è½½å®ç°ç±»---- DriverManageråŠ è½½çš„æ˜¯æœ‰ä¸ªé™æ€åˆå§‹åŒ–çš„æ–¹æ³• åŠ è½½é©±åŠ¨**
  >
  >    ![image-20240115134352644](./img/69.png)

- **DriverManagerä½¿ç”¨SPIæœºåˆ¶ï¼Œæœ€ç»ˆåŠ è½½jaråŒ…ä¸­å¯¹åº”çš„é©±åŠ¨ç±»**

  > ![image-20240115135346665](./img/70.png)



**JDBCæ¡ˆä¾‹æ€»ç»“**

- Bootstrap ClassLoader Load DriveManager
- åœ¨åˆå§‹åŒ–DriveManagerçš„æ—¶å€™ï¼Œé€šè¿‡SPIæœºåˆ¶åŠ è½½jaråŒ…ä¸­çš„mysqlé©±åŠ¨
- SPIåˆ©ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThreadContextClassLoaderï¼‰ å»åŠ è½½å¹¶åˆ›å»ºå¯¹è±¡
- è¿™ç§ç”±BootStrap ClassLoaderåŠ è½½çš„ç±»ï¼Œå§”æ´¾Application ClassLoaderå»åŠ è½½ç±»çš„æ–¹å¼ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶

![image-20240115140152864](./img/71.png)

> Java æä¾›äº†å¾ˆå¤šæœåŠ¡æä¾›è€…æ¥å£ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºè¿™äº›æ¥å£æä¾›å®ç°ã€‚å¸¸è§çš„ SPI æœ‰ JDBCã€JCEã€JNDIã€JAXP å’Œ JBI ç­‰ã€‚
>
> è¿™äº› SPI çš„æ¥å£ç”± Java æ ¸å¿ƒåº“æ¥æä¾›ï¼Œè€Œè¿™äº› SPI çš„å®ç°ä»£ç åˆ™æ˜¯ä½œä¸º Java åº”ç”¨æ‰€ä¾èµ–çš„ jar åŒ…è¢«åŒ…å«è¿›ç±»è·¯å¾„ï¼ˆCLASSPATHï¼‰é‡Œã€‚SPIæ¥å£ä¸­çš„ä»£ç ç»å¸¸éœ€è¦åŠ è½½å…·ä½“çš„å®ç°ç±»ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒSPIçš„æ¥å£æ˜¯Javaæ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯ç”±**å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap Classloader)æ¥åŠ è½½çš„ï¼›SPIçš„å®ç°ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨(System ClassLoader)**æ¥åŠ è½½çš„ã€‚å¼•å¯¼ç±»åŠ è½½å™¨æ˜¯æ— æ³•æ‰¾åˆ° SPI çš„å®ç°ç±»çš„ï¼Œå› ä¸ºä¾ç…§åŒäº²å§”æ´¾æ¨¡å‹ï¼ŒBootstrapClassloaderæ— æ³•å§”æ´¾AppClassLoaderæ¥åŠ è½½ç±»ã€‚
>
> è€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ç ´åäº†â€œåŒäº²å§”æ´¾æ¨¡å‹â€ï¼Œå¯ä»¥åœ¨æ‰§è¡Œçº¿ç¨‹ä¸­æŠ›å¼ƒåŒäº²å§”æ´¾åŠ è½½é“¾æ¨¡å¼ï¼Œä½¿ç¨‹åºå¯ä»¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ã€‚



**JDBCæ¡ˆä¾‹ä¸­çœŸçš„æ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶å—ï¼Ÿï¼Ÿ**

- **æ‰“ç ´äº†**

  > è¿™ç§ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œå§”æ´¾åº”ç”¨ç¨‹åºåŠ è½½å™¨å»åŠ è½½ç±»çš„æ–¹å¼ï¼Œæ‰“ç ´äº†åŒäº²å§”æ´¾æœºåˆ¶

- **æ²¡æœ‰æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶**

  > ***JDBCåªæ˜¯åœ¨DriverManageråŠ è½½å®Œä¹‹åï¼Œé€šè¿‡åˆå§‹åŒ–é˜¶æ®µè§¦å‘äº†é©±åŠ¨ç±»çš„åŠ è½½ï¼Œç±»çš„åŠ è½½ä¾ç„¶éµå¾ªåŒäº²å§”æ´¾æœºåˆ¶***





##### Osgiæ¡†æ¶çš„ç±»åŠ è½½å™¨



![image-20240114201023084](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201023084.png)





![image-20240114201150735](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201150735.png)

![image-20240114201441798](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201441798.png)



![image-20240114201525812](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201525812.png)





![image-20240114201613789](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201613789.png)





#### 4ï¼‰JDK9ä»¥åçš„ç±»åŠ è½½å™¨



![image-20240114201711256](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201711256.png)





![image-20240114201802987](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114201802987.png)







![image-20240114202018548](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114202018548.png)





#### è¿è¡Œæ—¶æ•°æ®åŒº

![image-20240114203801964](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114203801964.png)



![image-20240114203923992](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114203923992.png)



![image-20240114203944940](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114203944940.png)



![image-20240114204033675](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204033675.png)



![image-20240114204111445](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204111445.png)

![image-20240114204212388](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204212388.png)

![image-20240114204355273](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204355273.png)

![image-20240114204430887](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204430887.png)



![image-20240114204515458](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204515458.png)



![image-20240114204652931](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204652931.png)



![image-20240114204733753](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114204733753.png)



![image-20240114205010282](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205010282.png)



![image-20240114205048839](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205048839.png)

![image-20240114205058859](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205058859.png)



![image-20240114205243935](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205243935.png)

![image-20240114205424304](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205424304.png)

![image-20240114205511822](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205511822.png)

![image-20240114205706314](/Users/gaoshang/Library/Application Support/typora-user-images/image-20240114205706314.png)

> longç±»å‹ å ç”¨ä¸¤ä¸ªæ§½



##  JVMçš„å†…å­˜åŒºåŸŸ











## JVMçš„åƒåœ¾å›æ”¶





# 2ã€å®æˆ˜ç¯‡



# 3ã€é«˜çº§ç¯‡





# 4ã€åŸç†ç¯‡





# 5ã€é¢è¯•é¢˜
